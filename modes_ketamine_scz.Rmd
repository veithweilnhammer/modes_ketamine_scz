---
bibliography: References/library.bib
csl: References/nature.csl
header-includes:
- \usepackage{setspace}\linespread{1.25}
- \usepackage[fontsize=12pt]{scrextend}
- \usepackage[left]{lineno}
- \usepackage[labelformat=empty]{caption}
- \usepackage{longtable}
- \usepackage{booktabs}
always_allow_html: yes
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
  html_document:
    fig_caption: yes
    force_captions: yes
    highlight: pygments
    number_sections: yes
    theme: cerulean
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      cache = TRUE)

options(scipen = -1, digits = 2)

library(lme4)
library(afex)
library(ppcor)
library(statConfR)
library(optimx)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(effects)
library(quickpsy)
library(pracma)
library(corrplot)
library(Hmisc)

library(ggplot2)
library(ggridges)
library(ggExtra)
library(gridExtra)
library(ggpubr)
#library(kableExtra)

library(tidyr)
library(plyr)

library(e1071)
library(readxl)
source("./Functions/helper_functions.R", local = knitr::knit_global())

# smallest_value = .Machine$double.xmin
# replace p = \(0\) with p < \(\ensuremath{2.2\times 10^{-308}}\)
```

```{r controller}
load_summary_data = TRUE
save_summary_data = FALSE
```

**N-Methyl-D-aspartate receptor hypofunction causes recurrent and transient failures of perceptual inference** \
\

<br/><br/>
**Authors**: 

Veith Weilnhammer$^{1,2, 3,ec}$, Marcus Rothkirch$^{1, 4, ec}$, Deniz Yilmaz$^{1,5,6,7, ec}$, Merve Fritsch$^{1}$, Lena Esther Ptasczynski$^{1,5}$, Katrin Reichenbach$^{1}$, Lukas Rödiger$^{1}$, Philip Corlett$^{8}$, Philipp Sterzer$^{9}$\
\
<br/><br/>
**Affiliations**: 

$^{1}$ Department of Psychiatry, Charité-Universitätsmedizin Berlin, corporate member of Freie Universität Berlin and Humboldt-Universität zu Berlin, Germany \
$^{2}$ Berlin Institute of Health, Charité-Universitätsmedizin Berlin and Max Delbrück Center, Germany \
$^{3}$ Helen Wills Neuroscience Institute, University of California Berkeley, USA\
$^{4}$ Medical School Berlin, Hochschule für Gesundheit und Medizin, Germany\
$^{5}$ Berlin School of Mind and Brain, Humboldt-Universität zu Berlin, Germany\
$^{6}$ Max Planck School of Cognition, Leipzig, Germany\
$^{7}$ Department of Psychiatry and Psychotherapy, LMU University Hospital, Munich, Germany\
$^{8}$ Department of Psychiatry, Yale University School of Medicine, New Haven, USA\
$^{9}$ Department of Psychiatry (UPK), University of Basel, Switzerland\
\
<br/><br/>
**Contributions**: 

$^{ec}$ Equal contribution\
\
<br/><br/>
**Corresponding Author**:

Veith Weilnhammer, Helen Wills Neuroscience Institute, University of California Berkeley, USA, email: veith.weilnhammer@gmail.com \

\newpage

\linenumbers

# Abstract

Perception alternates between an external mode, driven by sensory inputs, and an internal mode, shaped by prior knowledge. We found that the external mode is more prevalent during pharmacologically induced N-Methyl-D-aspartate receptor (NMDAR) hypofunction and in schizophrenia. This NMDAR-dependent increase in external mode suggests that psychotic experiences are caused by recurring dissociations of perception from prior knowledge about the world.

# Main

Imagine a dimly lit room at a crowded party, where unclear visual signals, indistinct sounds, and complex social interactions allow for multiple - and sometimes false - interpretations. In such ambiguity, failures of perceptual inference, the ability to contextualize sensory inputs with prior knowledge about the world, can lead to profound departures from reality: Faces obscured in shadow may appear distorted, random noise could be perceived as a whisper, and friendly smiles might seem derogatory. 

This example illustrates why a disruption of perceptual inference is likely to play a crucial role in schizophrenia (Scz), a chronic and severe mental disorder characterized by psychotic symptoms such as delusions and hallucinations[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. Yet despite considerable progress in the computational understanding of psychosis, two key questions have remained unanswered. 

The first question concerns the neural mechanisms that cause perceptual inference to fail in Scz. Several lines of evidence point to N-Methyl-D-aspartate receptor (NMDAR) hypofunction as a key factor in the pathophysiology of psychosis[@corlett_glutamatergic_2011]. NMDAR antibodies[@Stein2020] and antagonists such as ketamine[@murray_linking_2014] mimic the symptoms of Scz, which is itself associated with a reduction of NMDAR density in prefrontal cortex[@catts_quantitative_2016]. NMDARs control the ratio of neural excitation and inhibition[@wang_nmda_2013], block the release of midbrain dopamine[@nakao_schizophrenia-like_2019], enable cortical feedback[@self_different_2012] and support synaptic short term plasticity[@castro-alamancos_short-term_1996]. While these NMDAR-dependent mechanisms are likely critical for perceptual inference, it is yet to be determined how NMDAR hypofunction may cause the psychotic symptoms that characterize Scz.

The second unresolved question concerns the temporal dynamics of psychotic experiences, which often unfold as short-lived events spanning from seconds to minutes, especially at early stages of Scz[@oorschot_temporal_2012; @hermans_temporal_2020]. The transient nature of psychotic experiences challenges models that assume a constant disruption of perceptual inference[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. A solution to this problem is suggested by the recent observation that perceptual inference is subject to spontaneous fluctuations over time that occur at a timescale compatible with the duration of individual psychotic experiences[@laquitaine_switching_2018; @roy_extracting_2021; @ashwood_mice_2022]. Such fluctuations have been related to two opposing modes of inference, during which perception is driven predominantly either by external inputs or by internal predictions that stem from recent perceptual experiences[@weilnhammer_sensory_2023] (Figure 1A). Although preliminary evidence indicates a tendency toward the external mode in people with Scz[@albert_hierarchical_2017], the neural mechanisms of mode fluctuations and their potential implications in psychosis have remained elusive.

```{r read_main_data}

root_dir = "./Results/"

##
## load and prepare behavior + hmm data
##
Data <- read.csv(paste(root_dir, "Ketamin_Behavior_Full_HMM_Sessions.csv", sep = ""))

Data$RT = NA
RTData <- read.csv(paste(root_dir, "Ketamin_Behavior_Full_RT.csv", sep = ""))
Data$RT = RTData[RTData$Confidence != -2,]$RT
Data$RT[is.nan(Data$RT)] = NA

Data$Q1 = NA
Data$Q2 = NA
Data$Q3 = NA
Data$CADSS = NA
QData <- read.csv(paste(root_dir, "Ketamin_Behavior_Full_Quest.csv", sep = ""))
Data$Q1 = QData[QData$Confidence != -2,]$Q1
Data$Q2 = QData[QData$Confidence != -2,]$Q2
Data$Q3 = QData[QData$Confidence != -2,]$Q3
Data$CADSS = QData[QData$Confidence != -2,]$CADSS
Data[Data == "NaN"] = NA

## 
## Intervention 
##
Data$Intervention = "None"

Placebo_first = c(13, 25, 19, 51, 27, 43, 17, 53, 59, 73, 71, 75, 1, 6, 41)
Verum_first = c(20, 26, 42, 76, 46, 66, 58, 28, 74, 78, 72, 85, 86)

Data[Data$session_id == 4 & Data$ID %in% Placebo_first,]$Intervention = "Placebo"
Data[Data$session_id == 5 & Data$ID %in% Placebo_first,]$Intervention = "Ketamine" 

Data[Data$session_id == 4 & Data$ID %in% Verum_first,]$Intervention = "Ketamine"
Data[Data$session_id == 5 & Data$ID %in% Verum_first,]$Intervention = "Placebo" 

Data$Intervention = factor(Data$Intervention, levels = c("Ketamine", "Placebo", "None"))

##
## Prepare Variables
##
## Data$Percept: 1 for rightward, -1 for leftward,-2 for unclear
## Data$Confidence: 1 for high confidence, -1 for low confidence, -2 for unclear

Data$Stimulus[Data$Stimulus == 0.5] = 0 ## Data$Stimulus: 1 for right, -1 for left, 0 for ambiguous
Data$Stimulus[Data$Disambiguation == 0] = 0

Data$Accuracy = Data$Percept == Data$Stimulus 
Data$Accuracy[Data$Stimulus == 0] = NA
Data$cond_Accuracy = Data$Accuracy
Data$cond_Accuracy[is.na(Data$cond_Accuracy)] = "ambiguous"
Data$cond_Accuracy[Data$cond_Accuracy == "FALSE"] = "stimulus-incongruent"
Data$cond_Accuracy[Data$cond_Accuracy == "TRUE"] = "stimulus-congruent"

Data$cond_Accuracy = factor(Data$cond_Accuracy, levels = c("ambiguous", "stimulus-incongruent", "stimulus-congruent"))

Data$w_Stimulus = Data$Stimulus * Data$Disambiguation ## weighted stimulus

Data$Stability = c(as.integer(diff(Data$Percept) == 0), NA) ## probability of survival of a specific percept
Data[Data$overlap_index == max(Data$overlap_index),]$Stability = NA

Data$uDisambiguation = Data$Disambiguation
Data$Disambiguation = Data$Disambiguation * 100

Data$Percept_minus_1 = c(NA, Data$Percept[1:nrow(Data)-1])
Data$Percept_minus_1[Data$overlap_index] = NA

##
## Define Modes
##
Data$Mode = "internal"
Data$Mode[Data$Session_Sl_Prob_State_ext > Data$Session_Sl_Prob_State_int] = "external"
Data$Mode = as.factor(Data$Mode)

Data$Mode_con = Data$Sl_Prob_State_ext - Data$Sl_Prob_State_int
Data$Mode_switch = c(NA, diff(sign(Data$Mode_con)) != 0)

##
## load HMM betas
##

##
## two-state-data
##
P_Data <- read.csv(paste(root_dir, "Ketamin_Behavior_Individual_Weights_HMM_Sessions.csv", sep = ""))
P_Data = data.frame(rbind(data.matrix(P_Data[, c(1:3, 11:12)]), data.matrix(P_Data[, c(4:6, 11:12)])))
colnames(P_Data) <- c('Stimulus','Bias','PS', 'ID', 'session_id')
P_Data$'Stimulus-PS' = P_Data$Stimulus-P_Data$PS
P_Data$Mode = c(rep("external", nrow(P_Data)/2), rep("internal", nrow(P_Data)/2))

P_Data$Intervention = "None"

P_Data[P_Data$session_id == 4 & P_Data$ID %in% Placebo_first,]$Intervention = "Placebo"
P_Data[P_Data$session_id == 5 & P_Data$ID %in% Placebo_first,]$Intervention = "Ketamine" 

P_Data[P_Data$session_id == 4 & P_Data$ID %in% Verum_first,]$Intervention = "Ketamine"
P_Data[P_Data$session_id == 5 & P_Data$ID %in% Verum_first,]$Intervention = "Placebo" 

P_Data$Intervention = factor(P_Data$Intervention, levels = c("Ketamine", "Placebo", "None"))

gathercol <- colnames(P_Data[, c(1:3,6)])
P_Data_long <- gather(P_Data, "Variable", "value", gathercol, factor_key = TRUE)

P_Data_long$num_states = 2

##
## one-state-data
##
P_Data_os <- read.csv(paste(root_dir, "Ketamin_Behavior_Individual_Weights_one_state_HMM_Sessions.csv", sep = ""))
colnames(P_Data_os) <- c('Stimulus','Bias','PS', 'ID', 'session_id')
P_Data_os$'Stimulus-PS' = P_Data_os$Stimulus-P_Data_os$PS
P_Data_os$Mode = NA

P_Data_os$Intervention = "None"

P_Data_os[P_Data_os$session_id == 4 & P_Data_os$ID %in% Placebo_first,]$Intervention = "Placebo"
P_Data_os[P_Data_os$session_id == 5 & P_Data_os$ID %in% Placebo_first,]$Intervention = "Ketamine" 

P_Data_os[P_Data_os$session_id == 4 & P_Data_os$ID %in% Verum_first,]$Intervention = "Ketamine"
P_Data_os[P_Data_os$session_id == 5 & P_Data_os$ID %in% Verum_first,]$Intervention = "Placebo" 

P_Data_os$Intervention = factor(P_Data_os$Intervention, levels = c("Ketamine", "Placebo", "None"))

gathercol <- colnames(P_Data_os[, c(1:3,6)])
P_Data_os_long <- gather(P_Data_os, "Variable", "value", gathercol, factor_key = TRUE)

P_Data_os_long$num_states = 1

P_Data_long = rbind(P_Data_long, P_Data_os_long)

Group_P_Data_long <-
    ddply(
      P_Data_long,
      .(Variable, Mode, Intervention, num_states),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

##
## HMM Model Comparison 
##
HMM_BIC = read.csv(paste(root_dir, "Ketamin_Behavior_Full_BIC_across_models.csv", sep = ""))
```

```{r exclusion_criteria}
##
## Exclusion Criteria for unimodal analysis
##

## Performance
Summary_Accuracy_ID <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None",],
      .(Disambiguation, Intervention, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE)
    )

include <- unique(Summary_Accuracy_ID[Summary_Accuracy_ID$Disambiguation == 100 & Summary_Accuracy_ID$Accuracy >= 75,]$ID)
exclude <- unique(Summary_Accuracy_ID[Summary_Accuracy_ID$Disambiguation == 100 & Summary_Accuracy_ID$Accuracy < 75,]$ID)
Data$Include = 1
Data[Data$ID %in% exclude,]$Include = 0
```

```{r plot_controls}
alpha_sd = 0.35
alpha_gd = 0.75
dot_size_sd = 0.25
line_size_sd = dot_size_sd/20
dot_size_gd = 4 * dot_size_sd
line_size_gd = 2 * dot_size_sd
dodge_width = 0.0375
```

```{r choices_by_stimulus_ps_treatment_mode}
##
## choice ~ stimulus
##
Summary_Choice <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

gathercol <- colnames(Summary_Choice[, 4:ncol(Summary_Choice)])
Summary_Choice_long <- gather(Summary_Choice, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_long <-
    ddply(
      Summary_Choice_long,
      .(w_Stimulus, Intervention, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + Percept_minus_1
##
Summary_Choice_ps <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Choice_ps$Percept_minus_1 = (Summary_Choice_ps$Percept_minus_1 + 1)/2
Summary_Choice_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(Summary_Choice_ps$Percept_minus_1), sep = " ")

gathercol <- colnames(Summary_Choice_ps[, 5:ncol(Summary_Choice_ps)])
Summary_Choice_ps_long <- gather(Summary_Choice_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_ps_long <-
    ddply(
      Summary_Choice_ps_long,
      .(w_Stimulus, Intervention, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )
Group_Summary_Choice_ps_long$Mode = "unimodal"

##
## choice ~ stimulus + mode
##
Summary_Choice_mode <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, Mode, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

gathercol <- colnames(Summary_Choice_mode[, 5:ncol(Summary_Choice_mode)])
Summary_Choice_mode_long <- gather(Summary_Choice_mode, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_mode_long <-
    ddply(
      Summary_Choice_mode_long,
      .(w_Stimulus, Intervention, Mode, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )
##
## choice ~ stimulus + mode + ps
##
Summary_Choice_mode_ps <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, Mode, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Choice_mode_ps$Percept_minus_1 = (Summary_Choice_mode_ps$Percept_minus_1 + 1)/2
Summary_Choice_mode_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(Summary_Choice_mode_ps$Percept_minus_1), sep = " ")

gathercol <- colnames(Summary_Choice_mode_ps[, 6:ncol(Summary_Choice_mode_ps)])
Summary_Choice_mode_ps_long <- gather(Summary_Choice_mode_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_mode_ps_long <-
    ddply(
      Summary_Choice_mode_ps_long,
      .(w_Stimulus, Intervention, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )


Group_Summary_Choice_mode_ps_no_interv_long <-
    ddply(
      Summary_Choice_mode_ps_long,
      .(w_Stimulus, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## Global variables
##
Summary_Data_no_mode <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE),
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA

gathercol <- colnames(Summary_Data_no_mode[, 4:ncol(Summary_Data_no_mode)])
Summary_Data_no_mode_long <- gather(Summary_Data_no_mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_no_mode_long <-
    ddply(
      Summary_Data_no_mode_long,
      .(uDisambiguation, Intervention, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Summary_Data_no_mode_con <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, cond_Accuracy, ID),
      summarise,
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA

gathercol <- colnames(Summary_Data_no_mode_con[, 5:ncol(Summary_Data_no_mode_con)])
Summary_Data_no_mode_con_long <- gather(Summary_Data_no_mode_con, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_no_mode_con_long <-
    ddply(
      Summary_Data_no_mode_con_long,
      .(uDisambiguation, Intervention, cond_Accuracy, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Summary_Data <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, Mode, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE),
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data[Summary_Data == "NaN"] = NA
gathercol <- colnames(Summary_Data[, 5:ncol(Summary_Data)])
Summary_Data_long <- gather(Summary_Data, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_long <-
    ddply(
      Summary_Data_long,
      .(uDisambiguation, Intervention, Mode, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Summary_Data_con <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, Mode, cond_Accuracy, ID),
      summarise,
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data_con[Summary_Data_con == "NaN"] = NA
gathercol <- colnames(Summary_Data_con[, 6:ncol(Summary_Data_con)])
Summary_Data_con_long <- gather(Summary_Data_con, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_con_long <-
    ddply(
      Summary_Data_con_long,
      .(uDisambiguation, Intervention, Mode, cond_Accuracy, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Uncertainty <-
    ddply(
      RTData,
      .(ID),
      summarise,
      rate = sum(Confidence == -2)/length(Confidence))

##
## STATS
##
if (!load_summary_data) {

##
## no mode
##
accuracy_by_TD = glmer(Accuracy ~ uDisambiguation*Intervention + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.accuracy_by_TD = summary(accuracy_by_TD)

stability_by_TDC = glmer(Stability ~ uDisambiguation*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.stability_by_TDC = summary(stability_by_TDC)

stability_by_Ta = glmer(Stability ~ Intervention  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy == "ambiguous",], family = binomial)
STAT.stability_by_Ta = summary(stability_by_Ta)

high_conf_by_TDC = glmer((Confidence + 1)/2 ~ uDisambiguation*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.high_conf_by_TDC = summary(high_conf_by_TDC)

high_conf_by_Ta = glmer((Confidence + 1)/2 ~ Intervention  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy == "ambiguous",], family = binomial)
STAT.high_conf_by_Ta = summary(high_conf_by_Ta)

RT_by_TDC = lmer(log(RT) ~ uDisambiguation*Intervention*cond_Accuracy + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous",])
STAT.RT_by_TDC = summary(RT_by_TDC)

##
## mode
##
accuracy_by_TDM = glmer(Accuracy ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention + (1  | ID), data = Data[Data$Intervention != "None",], family = binomial)
STAT.accuracy_by_TDM = summary(accuracy_by_TDM)

stability_by_TDMC = glmer(Stability ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous" ,], family = binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
STAT.stability_by_TDMC = summary(stability_by_TDMC)

high_conf_by_TDMC = glmer((Confidence + 1)/2 ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous" ,], family = binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
STAT.high_conf_by_TDMC = summary(high_conf_by_TDMC)

RT_by_TDMC = glmer(log(RT) ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous" ,], family = gaussian)
STAT.RT_by_TDMC = summary(RT_by_TDMC)

ProbS_by_T = glmer(Session_Sl_Prob_State_ext ~ Intervention + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial)
STAT.ProbS_by_T = summary(ProbS_by_T)

##
## Global
##

##
## Choices
##
y_choice_by_STP = glmer(y_choice ~ 1 + w_Stimulus * Intervention * Percept_minus_1 + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.y_choice_by_STP = summary(y_choice_by_STP)

y_choice_by_STPM = glmer(y_choice ~ 1 + w_Stimulus * Intervention * Percept_minus_1 * Mode + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.y_choice_by_STPM = summary(y_choice_by_STPM)

##
## RT
##
RT_by_STP = lmer(RT ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 + (1 | ID), data = Data[Data$Intervention != "None",])
STAT.RT_by_STP = summary(RT_by_STP)

RT_by_STPM = lmer(RT ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 * Mode + (1 | ID), data = Data[Data$Intervention != "None",])
STAT.RT_by_STPM = summary(RT_by_STPM)

##
## Confidence
##
y_conf_by_STP = glmer((Confidence + 1)/2 ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
STAT.y_conf_by_STP  = summary(y_conf_by_STP)

y_conf_by_STPM = glmer((Confidence + 1)/2 ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 * Mode + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
STAT.y_conf_by_STPM  = summary(y_conf_by_STPM)

  if (save_summary_data) {
    save(STAT.accuracy_by_TD, accuracy_by_TD, 
         STAT.stability_by_TDC, stability_by_TD, 
         STAT.high_conf_by_TDC, high_conf_by_TD, 
         STAT.RT_by_TDC, RT_by_TDC,
         STAT.accuracy_by_TDM, accuracy_by_TDM,
         STAT.stability_by_TDMC, stability_by_TDMC,
         STAT.high_conf_by_TDMC, high_conf_by_TDMC,
         STAT.RT_by_TDMC, RT_by_TDMC,
         STAT.ProbS_by_T, ProbS_by_T,
         STAT.stability_by_Ta, stability_by_Ta,
         STAT.high_conf_by_Ta, high_conf_by_Ta,
         STAT.y_choice_by_STP, y_choice_by_STP,
         STAT.y_choice_by_STPM, y_choice_by_STPM,
         STAT.RT_by_STP, RT_by_STP,
         STAT.RT_by_STPM, RT_by_STPM, 
         STAT.y_conf_by_STP, y_conf_by_STP, 
         STAT.y_conf_by_STPM, y_conf_by_STPM,
         file = "./Results/R_summary_ketamine_stats.Rdata")
  }
} else {
  load("./Results/R_summary_ketamine_stats.Rdata")
}
##
## Bonferroni
##
STAT.y_choice_by_STP = bonferroni(STAT.y_choice_by_STP)
STAT.y_choice_by_STPM = bonferroni(STAT.y_choice_by_STPM)

STAT.RT_by_STP = bonferroni(STAT.RT_by_STP)
STAT.RT_by_STPM = bonferroni(STAT.RT_by_STPM)

STAT.y_conf_by_STP = bonferroni(STAT.y_conf_by_STP)
STAT.y_conf_by_STPM = bonferroni(STAT.y_conf_by_STPM)

STAT.accuracy_by_TD = bonferroni(STAT.accuracy_by_TD)
STAT.stability_by_TDC = bonferroni(STAT.stability_by_TDC)
```

```{r mode_summary}
Summary_Mode  <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(Intervention, ID),
      summarise,
      external = mean(Session_Sl_Prob_State_ext, na.rm = TRUE),
      internal = mean(1-Session_Sl_Prob_State_ext, na.rm = TRUE),
      Mode_bool = (sum(Mode == "external", na.rm = TRUE)/length(Mode)),
      Mode_s = (sum(Mode_switch, na.rm = TRUE)/length(Mode)),
      EI = (sum(Mode_switch[Mode == "internal"] == 1, na.rm = TRUE)/length(Mode)),
      IE = (sum(Mode_switch[Mode == "external"] == 1, na.rm = TRUE)/length(Mode)),
      EE = (sum(Mode_switch[Mode == "external"] == 0, na.rm = TRUE)/length(Mode)),
      II = (sum(Mode_switch[Mode == "internal"] == 0, na.rm = TRUE)/length(Mode))
    )

gathercol <- colnames(Summary_Mode[, 3:ncol(Summary_Mode)])
Summary_Mode_long <- gather(Summary_Mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Mode_long <-
    ddply(
      Summary_Mode_long,
      .(Variable, Intervention),
      summarise,
      mean = mean(value[is.finite(value)], na.rm = TRUE),
      error = sd(value[is.finite(value)], na.rm = TRUE)/sqrt(length(value[is.finite(value)]))
    )

EE = (Summary_Mode$EE[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$EE[Summary_Mode$Intervention == "Placebo"])
II =  (Summary_Mode$II[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$II[Summary_Mode$Intervention == "Placebo"])


if (!load_summary_data) {
  
EE = (Summary_Mode$EE[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$EE[Summary_Mode$Intervention == "Placebo"])
II =  (Summary_Mode$II[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$II[Summary_Mode$Intervention == "Placebo"])
EI = (Summary_Mode$EI[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$EI[Summary_Mode$Intervention == "Placebo"])
IE =  (Summary_Mode$IE[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$IE[Summary_Mode$Intervention == "Placebo"])

STAT.Mode_Intervention = wilcox.test(EE-II, alternative = "greater")
STAT.Mode_Intervention_2 = wilcox.test(IE-EI, alternative = "greater")

Mode_by_I = glmer(Session_Sl_Prob_State_ext ~ Intervention + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.Mode_by_I = summary(Mode_by_I)

Stimulus_by_MI = lmer(Stimulus ~ Mode*Intervention + (1  | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.Stimulus_by_MI = summary(Stimulus_by_MI)

Bias_by_MI = lmer(Bias ~ Mode*Intervention + (1  | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.Bias_by_MI = summary(Bias_by_MI)

PS_by_MI = lmer(PS ~ Mode*Intervention + (1  | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.PS_by_MI = summary(PS_by_MI)

Stimulus_PS_by_MI = lmer(Stimulus-PS ~ Mode*Intervention + (1 | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.Stimulus_PS_by_MI = summary(Stimulus_PS_by_MI)


  if (save_summary_data) {
    save(STAT.Mode_Intervention,STAT.Mode_Intervention_2,
         STAT.Mode_by_I, Mode_by_I,
         STAT.Stimulus_by_MI, Stimulus_by_MI,
         STAT.Bias_by_MI, Bias_by_MI,
         STAT.PS_by_MI, PS_by_MI,
         STAT.Stimulus_PS_by_MI, Stimulus_PS_by_MI,
         file = "./Results/R_Summary_P_Modes.Rdata")
  }

} else {
  load("./Results/R_Summary_P_Modes.Rdata")
}

##
## Boneferroni
##
STAT.Mode_by_I = bonferroni(STAT.Mode_by_I)
STAT.Stimulus_by_MI = bonferroni(STAT.Stimulus_by_MI)
STAT.Bias_by_MI = bonferroni(STAT.Bias_by_MI)
STAT.PS_by_MI = bonferroni(STAT.PS_by_MI)
STAT.Stimulus_PS_by_MI = bonferroni(STAT.Stimulus_PS_by_MI)
```

```{r corr_mode_to_intervention}
difference_in_modes = Summary_Mode[Summary_Mode$Intervention == "Ketamine",]$external-Summary_Mode[Summary_Mode$Intervention == "Placebo",]$external
difference_in_os_betas = P_Data_long[P_Data_long$Intervention == "Ketamine" &
                                       P_Data_long$num_states == 1 &
                                       P_Data_long$Variable == "Stimulus-PS",]$value -
  P_Data_long[P_Data_long$Intervention == "Placebo" &
                P_Data_long$num_states == 1 &
                P_Data_long$Variable == "Stimulus-PS",]$value


difference_in_ts_betas = (P_Data_long[P_Data_long$Intervention == "Ketamine" &
                                        P_Data_long$num_states == 2 &
                                        P_Data_long$Variable == "Stimulus-PS" &
                                        P_Data_long$Mode == "external",]$value - P_Data_long[P_Data_long$Intervention == "Ketamine" &
                                                                                               P_Data_long$num_states == 2 &
                                                                                               P_Data_long$Variable == "Stimulus-PS" &
                                                                                               P_Data_long$Mode == "internal",]$value) -
  (P_Data_long[P_Data_long$Intervention == "Placebo" &
                 P_Data_long$num_states == 2 &
                 P_Data_long$Variable == "Stimulus-PS" &
                 P_Data_long$Mode == "external",]$value - P_Data_long[P_Data_long$Intervention == "Placebo" &
                                                                        P_Data_long$num_states == 2 &
                                                                        P_Data_long$Variable == "Stimulus-PS" &
                                                                        P_Data_long$Mode == "internal",]$value)

##
## unimodal vs bimodal
##
STAT.delta_W1 = wilcox.test(difference_in_os_betas)
STAT.bimodal_to_unimodal = cor.test(difference_in_modes, difference_in_os_betas, type = "spearman")
```

```{r sample_and_questionnaires, fig.height = 7}
Logbook_full = read_excel(paste(root_dir,"Participant_Logbook.xlsx", sep = ""))
Logbook_final = Logbook_full[Logbook_full$Incl == 1,]

Logbook_final$ID = as.numeric(gsub("Ketamin_RDK_", "", Logbook_final$ID))
Logbook_final$PDI = as.numeric(Logbook_final$`PDI (sum of all subscales)`)
Logbook_final$CAPS = as.numeric(Logbook_final$`CAPS (sum of all subscales)`)

Logbook_final$ABZ_4 = as.numeric(Logbook_final$`(Global ASC 1) 5D-ABZ Grand Mean Session 1 (%)`)
Logbook_final$ABZ_5 = as.numeric(Logbook_final$`5D-ABZ Grand Mean Session 2 (%)`)

Keta_Thresholds = read.csv(paste(root_dir,"Ketamin_Thresholds.csv", sep = ""))

##
## Integrate global questionnaire data
##
Summary_Mode$PDI = NA
Summary_Mode$CAPS = NA
Summary_Mode$ABZ= NA
Summary_Mode$Threshold = NA

for (idx in unique(Logbook_final$ID)){
Summary_Mode$PDI[Summary_Mode$ID == idx] = Logbook_final$PDI[Logbook_final$ID == idx]
Summary_Mode$CAPS[Summary_Mode$ID == idx] = Logbook_final$CAPS[Logbook_final$ID == idx] 

if (idx %in% Verum_first){
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Logbook_final$ABZ_4[Logbook_final$ID == idx] 
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Logbook_final$ABZ_5[Logbook_final$ID == idx] 

} else if (idx %in% Placebo_first){
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Logbook_final$ABZ_5[Logbook_final$ID == idx] 
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Logbook_final$ABZ_4[Logbook_final$ID == idx]   

}
}
gathercol <- colnames(Summary_Mode[,c(11:13)])
Summary_Mode_corr_long <- gather(Summary_Mode[,c(1,2,3,11:13)], "Variable", "Score", gathercol, factor_key = TRUE)

Quest = data.frame(diff_Mode = Summary_Mode$external [Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$external [Summary_Mode$Intervention == "Placebo"],
                   PDI = Summary_Mode$PDI[Summary_Mode$Intervention == "Ketamine"],
                   CAPS =  Summary_Mode$CAPS[Summary_Mode$Intervention == "Ketamine"],
                   diff_ABZ = Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"])

##
## Dynamic Questionnaire Data
##
Dyn_Quest =  ddply(
  Data[Data$Intervention != "None" & Data$block_id %in% c(1,3,6,9),],
  .(block_id, ID, Intervention),
  summarise,
  Q1 = mean(Q1, na.rm = TRUE),
  Q2 = mean(Q2, na.rm = TRUE),
  Q3 = mean(Q3, na.rm = TRUE),
  CADSS = mean(CADSS, na.rm = TRUE),
  external = mean(Session_Sl_Prob_State_ext)
  )

Dyn_Quest[Dyn_Quest == "NaN"] = NA

gathercol <- colnames(Dyn_Quest[,c(4:7)])
Dyn_Quest_long <- gather(Dyn_Quest, "Variable", "Score", gathercol, factor_key = TRUE)

Group_Dyn_Quest_long <- ddply(
  Dyn_Quest_long,
  .(block_id, Intervention, Variable),
  summarise,
  mean = mean(Score, na.rm = TRUE),
  error = sd(Score, na.rm = TRUE)/sqrt(length(Score))
  )

Dyn_Quest_ID =  ddply(
  Data[Data$Intervention != "None" & Data$block_id %in% c(1,3,6,9),],
  .(ID, Intervention),
  summarise,
  Q1 = mean(Q1, na.rm = TRUE),
  Q2 = mean(Q2, na.rm = TRUE),
  Q3 = mean(Q3, na.rm = TRUE),
  CADSS = mean(CADSS, na.rm = TRUE),
  external = mean(Session_Sl_Prob_State_ext)
  )

##
## Integrate Thresholds
##
Summary_Mode$Threshold = NA

for (idx in unique(Keta_Thresholds$ID)){

if (idx %in% Verum_first){
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 4]*100
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 5]*100
} else if (idx %in% Placebo_first){
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 5]*100
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 4]*100
}
}
Summary_Mode$Threshold[Summary_Mode$Threshold > 1.5] = NA


##
## STATS
##
if (!load_summary_data) {
Quest_to_Mode = glmer(external ~ PDI*Intervention + CAPS*Intervention + ABZ*Intervention + (1|ID), data = Summary_Mode, family = binomial)
STAT.Quest_to_Mode = summary(Quest_to_Mode)

ABZ_Intervention = lmer(
  ABZ ~ Intervention + (1 | ID),
  data = Summary_Mode)
STAT.ABZ_Intervention = summary(ABZ_Intervention)

Dyn_Quest_to_Mode = glmer(
  external ~ block_id*Q1 + block_id*Q2 + block_id*Q3 + block_id*CADSS + (1 |
                                     ID),
  data = Dyn_Quest,
  family = binomial
)
STAT.Dyn_Quest_to_Mode = summary(Dyn_Quest_to_Mode)


Q1_Time_Intervention = glmer(
  Q1 ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q1_Time_Intervention = summary(Q1_Time_Intervention)

Q2_Time_Intervention = glmer(
  Q2 + 0.1 ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q2_Time_Intervention = summary(Q2_Time_Intervention)

Q3_Time_Intervention = glmer(
  Q3 ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q3_Time_Intervention = summary(Q3_Time_Intervention)

CADSS_Time_Intervention = lmer(
  CADSS ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",])
STAT.CADSS_Time_Intervention = summary(CADSS_Time_Intervention)


Q1_Mode_Intervention = glmer(
  Q1 ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q1_Mode_Intervention = summary(Q1_Mode_Intervention)

Q2_Mode_Intervention = glmer(
  Q2 + 0.1 ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q2_Mode_Intervention = summary(Q2_Mode_Intervention)

Q3_Mode_Intervention = glmer(
  Q3 ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q3_Mode_Intervention = summary(Q3_Mode_Intervention)

CADSS_Mode_Intervention = lmer(
  CADSS ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",])
STAT.CADSS_Mode_Intervention = summary(CADSS_Mode_Intervention)

Threshold_to_Mode = glmer(
  external ~ Intervention*Threshold + (1 | ID),
  data = Summary_Mode,
  family = binomial
)
STAT.Threshold_to_Mode = summary(Threshold_to_Mode)
STAT.Mode_Threshold = wilcox.test(Summary_Mode[Summary_Mode$Intervention == "Ketamine",]$Threshold, Summary_Mode[Summary_Mode$Intervention == "Placebo",]$Threshold, paired = TRUE)
if (save_summary_data) {
    save(STAT.ABZ_Intervention, ABZ_Intervention,
         STAT.Dyn_Quest_to_Mode, Dyn_Quest_to_Mode,
         STAT.Q1_Time_Intervention, Q1_Time_Intervention,
         STAT.Q2_Time_Intervention, Q2_Time_Intervention,
         STAT.Q3_Time_Intervention, Q3_Time_Intervention,
         STAT.CADSS_Time_Intervention, CADSS_Time_Intervention,
         STAT.Q1_Mode_Intervention, Q1_Mode_Intervention,
         STAT.Q2_Mode_Intervention, Q2_Mode_Intervention,
         STAT.Q3_Mode_Intervention, Q3_Mode_Intervention,
         STAT.CADSS_Mode_Intervention, CADSS_Mode_Intervention,
         STAT.Threshold_to_Mode, Threshold_to_Mode, STAT.Mode_Threshold, 
         file = "./Results/Quest_stats.Rdata")
  }
} else {
  load("./Results/Quest_stats.Rdata")
}
##
## Bonferroni
##
STAT.Q1_Time_Intervention = bonferroni(STAT.Q1_Time_Intervention)
STAT.Q2_Time_Intervention = bonferroni(STAT.Q2_Time_Intervention)
STAT.Q3_Time_Intervention = bonferroni(STAT.Q3_Time_Intervention)
STAT.CADSS_Time_Intervention = bonferroni(STAT.CADSS_Time_Intervention)

STAT.ABZ_Intervention = bonferroni(STAT.ABZ_Intervention)
```

The objective of the current study was therefore twofold: First, to test whether NMDAR hypofunction causes changes in perceptual inference that characterize Scz; and second, to explore the effect of NMDAR hypofunction on ongoing fluctuations in perceptual inference that may explain the transient nature of psychotic experiences. We addressed these aims in a double-blind placebo-controlled cross-over experiment in `r length(unique(Data$ID))` healthy human participants. The participants attended two experimental sessions during which they received a continuous intravenous infusion of either the NMDAR antagonist S-ketamine at a dose of 0.1 mg/kg/h or a saline placebo. In each session, the participants viewed ten `r round(max(Data$overlap_index) * diff(Data$overlap_timing[1:2]))` sec blocks of an ambiguous structure-from-motion (SFM) stimulus that induced the experience of a sphere rotating around a vertical axis, and reported changes in the perceived direction of rotation (leftward vs. rightward movement of the front surface) as well as their confidence in the choice (Figure 1B and Supplemental Video S1). 

The ambiguity of the display induced the phenomenon of bistable perception, where spontaneous changes in the perceived direction of rotation occurred in average intervals of $`r 1.5/mean(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value)`$ ± 
$`r (1.5/sd(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))/sqrt(length(Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))`$ sec. In line with previous results[@weilnhammer_psychotic_2020; @weilnhammer_active_2021], these changes in perception occurred with a probability of $`r mean(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value)`$ ± 
$`r (sd(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))/sqrt(length(Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))`$ at brief depth-symmetric configurations of the stimulus (see Supplemental Video S1 and Supplemental Figure S1A). We therefore divided the continuous behavioral reports into a sequence of discrete states $t$. Each state was associated with a perceptual experience $y_t$, confidence $c_t$ and the external input $s_t$.

Bistable perception can be conceptualized as an inferential process about the cause of $s_t$, in which previous experiences ($y_{t-1}$) reflect internal predictions that provide prior knowledge about the interpretation $y_t$ of the ambiguous stimulus[@weilnhammer_active_2021] (Figure 1C). To test how NMDAR antagonism altered the balance between external inputs and internal predictions, we attached a 3D signal to a fraction of the stimulus dots. The signal-to-ambiguity ratio (SAR) ranged from complete ambiguity to full disambiguation across five levels and remained constant in each block of the experiment. By changing the direction of rotation enforced by the 3D signal at random in average intervals of 10 sec, we created dynamic conflicts between the SAR-weighted input $s_t$ and the stabilizing internal prediction $y_{t-1}$. As expected, we found that $y_t$ was driven by both $s_t$ ($\beta_S$ = $`r STAT.y_choice_by_STP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[2,2]`$) and $y_{t-1}$ ($\beta_P$ = $`r STAT.y_choice_by_STP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[4,2]`$). Importantly, S-ketamine caused perception to shift toward $s_t$ ($`r -STAT.y_choice_by_STP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[5,4]`$; Figure 2A and Supplemental Figure S2), indicating a stronger weighting of external inputs over internal predictions during pharmacologically induced NMDAR hypofunction.

```{r read_Scz_data}
##
## load and prepare data
##
S_Data <- read.csv(paste(root_dir, "Scz_Full_HMM_Sessions.csv", sep = ""))
SumData <- read.csv(paste(root_dir, "B_Conv_summed_up_excl_P1_P3.csv", sep = ""))
##
## Prepare Variables
##
## Data$Percept: 1 for rightward, -1 for leftward,-2 for unclear
## Data$Confidence: 1 for high confidence, -1 for low confidence, -2 for unclear
S_Data$Group <- factor(S_Data$Group, levels = c("Patients", "Controls"))

S_Data$Stimulus[S_Data$Disambiguation == 0] = 0

S_Data$Accuracy = S_Data$Percept == S_Data$Stimulus 
S_Data$Accuracy[S_Data$Stimulus == 0] = NA
S_Data$cond_Accuracy = S_Data$Accuracy
S_Data$cond_Accuracy[is.na(S_Data$cond_Accuracy)] = "ambiguous"
S_Data$cond_Accuracy[S_Data$cond_Accuracy == "FALSE"] = "stimulus-incongruent"
S_Data$cond_Accuracy[S_Data$cond_Accuracy == "TRUE"] = "stimulus-congruent"

S_Data$w_Stimulus = S_Data$Stimulus*S_Data$Disambiguation

S_Data$Stability = c(as.integer(diff(S_Data$Percept) == 0), NA)
S_Data[S_Data$overlap_index == max(S_Data$overlap_index),]$Stability = NA

S_Data$uDisambiguation = S_Data$Disambiguation
S_Data$Disambiguation = S_Data$Disambiguation * 100

S_Data$Percept_minus_1 = c(NA, S_Data$Percept[1:nrow(S_Data)-1])
S_Data$Percept_minus_1[S_Data$overlap_index] = NA

S_Data = S_Data[S_Data$Exclude == 0,]
##
## add RT
##

S_Data$RT = NA
S_RTData <- read.csv(paste(root_dir, "Scz_Behavior_Full_RT2.csv", sep = ""))
S_RTData = S_RTData[S_RTData$Exclude == 0,]

S_Data$RT = S_RTData$RT
S_Data$RT[is.nan(S_Data$RT)] = NA

##
## Define Modes
##
S_Data$Mode = "internal"
S_Data$Mode[S_Data$Session_Sl_Prob_State_ext > S_Data$Session_Sl_Prob_State_int] = "external"
S_Data$Mode = as.factor(S_Data$Mode)

S_Data$Mode_con = S_Data$Sl_Prob_State_ext - S_Data$Sl_Prob_State_int
S_Data$Mode_switch = c(NA, diff(sign(S_Data$Mode_con)) != 0)

##
## load additional HMM data
##
S_P_Data <- read.csv(paste(root_dir, "Scz_Individual_Weights_HMM.csv", sep = ""))
S_P_Data = data.frame(rbind(data.matrix(S_P_Data[, c(1:3, 11)]), data.matrix(S_P_Data[, c(4:6, 11)])))
colnames(S_P_Data) <- c('Stimulus','Bias','PS', 'ID')
S_P_Data = S_P_Data[S_P_Data$ID %in% unique(S_Data$ID),]

S_P_Data$'Stimulus-PS' = S_P_Data$Stimulus-S_P_Data$PS
S_P_Data$Mode = c(rep("external", nrow(S_P_Data)/2), rep("internal", nrow(S_P_Data)/2))

S_P_Data$Group = "Controls"
S_P_Data$Group[S_P_Data$ID %in% unique(S_Data[S_Data$Group == "Patients",]$ID)] = "Patients"

S_P_Data$Group <- factor(S_P_Data$Group, levels = c("Patients", "Controls"))

gathercol <- colnames(S_P_Data[, c(1:3,5)])
S_P_Data_long <- gather(S_P_Data, "Variable", "value", gathercol, factor_key = TRUE)

S_P_Data_long$num_states = 2

S_Data$ID = as.factor(S_Data$ID)

S_Data = S_Data[!is.na(S_Data$Exclude),]

##
## one-state-data
##
S_P_Data_os <- read.csv(paste(root_dir, "Scz_Individual_Weights_one_state_HMM.csv", sep = ""))
colnames(S_P_Data_os) <- c('Stimulus','Bias','PS', 'ID')
S_P_Data_os = S_P_Data_os[S_P_Data_os$ID %in% unique(S_Data$ID),]

S_P_Data_os$'Stimulus-PS' = S_P_Data_os$Stimulus - S_P_Data_os$PS
S_P_Data_os$Mode = NA

S_P_Data_os$Group = "Controls"
S_P_Data_os$Group[S_P_Data_os$ID %in% unique(S_Data[S_Data$Group == "Patients",]$ID)] = "Patients"

S_P_Data_os$Group <- factor(S_P_Data_os$Group, levels = c("Patients", "Controls"))

gathercol <- colnames(S_P_Data_os[, c(1:3,5)])
S_P_Data_os_long <- gather(S_P_Data_os, "Variable", "value", gathercol, factor_key = TRUE)

S_P_Data_os_long$num_states = 1

S_P_Data_long = rbind(S_P_Data_long, S_P_Data_os_long)

Group_S_P_Data_long <-
    ddply(
      S_P_Data_long,
      .(Variable, Mode, Group, num_states),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

S_difference_in_os_betas = S_P_Data_long[S_P_Data_long$Group == "Patients" &
                                       S_P_Data_long$num_states == 1 &
                                       S_P_Data_long$Variable == "Stimulus-PS",]$value -
 S_P_Data_long[S_P_Data_long$Group == "Controls" &
                                       S_P_Data_long$num_states == 1 &
                                       S_P_Data_long$Variable == "Stimulus-PS",]$value

##
## HMM Model Comparison 
##
S_HMM_BIC = read.csv(paste(root_dir, "Scz_Full_group_BIC_across_models.csv", sep = ""))


##
## Questionnaire_Data
##
Quest = read.csv(paste(root_dir, "Scz_Quest.csv", sep = ""))
Quest  = Quest [Quest$subject %in% unique(S_Data$ID),]

Quest$PDI = Quest$PDI_conviction + Quest$PDI_distress + Quest$PDI_occupation
Quest$CAPS = Quest$CAPS_distress + Quest$CAPS_distress + Quest$CAPS_intrusive
```

```{r Scz_choices_by_stimulus_ps_treatment_mode}
##
## choice ~ stimulus
##
S_Summary_Choice <-
    ddply(
      S_Data,
      .(w_Stimulus, Group,ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

gathercol <- colnames(S_Summary_Choice[, 4:ncol(S_Summary_Choice)])
S_Summary_Choice_long <- gather(S_Summary_Choice, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_long <-
    ddply(
      S_Summary_Choice_long,
      .(w_Stimulus, Group, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + Percept_minus_1
##
S_Summary_Choice_ps <-
    ddply(
      S_Data,
      .(w_Stimulus, Group, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

S_Summary_Choice_ps$Percept_minus_1 = (S_Summary_Choice_ps$Percept_minus_1 + 1)/2
S_Summary_Choice_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(S_Summary_Choice_ps$Percept_minus_1), sep = " ")
S_Summary_Choice_ps= S_Summary_Choice_ps[S_Summary_Choice_ps$Percept_minus_1 != "y(t-1) = NA",]

gathercol <- colnames(S_Summary_Choice_ps[, 5:ncol(S_Summary_Choice_ps)])
S_Summary_Choice_ps_long <- gather(S_Summary_Choice_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_ps_long <-
    ddply(
      S_Summary_Choice_ps_long[!is.na(S_Summary_Choice_ps_long$Percept_minus_1), ],
      .(w_Stimulus, Group, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )
Group_S_Summary_Choice_ps_long$Mode = "unimodal"

##
## choice ~ stimulus + mode
##
S_Summary_Choice_mode <-
    ddply(
       S_Data,
      .(w_Stimulus, Group, Mode, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

gathercol <- colnames(S_Summary_Choice_mode[, 5:ncol(S_Summary_Choice_mode)])
S_Summary_Choice_mode_long <- gather(S_Summary_Choice_mode, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_mode_long <-
    ddply(
      S_Summary_Choice_mode_long,
      .(w_Stimulus, Group, Mode, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + mode + ps
##
S_Summary_Choice_mode_ps <-
    ddply(
       S_Data,
      .(w_Stimulus, Group, Mode, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

S_Summary_Choice_mode_ps$Percept_minus_1 = (S_Summary_Choice_mode_ps$Percept_minus_1 + 1)/2
S_Summary_Choice_mode_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(S_Summary_Choice_mode_ps$Percept_minus_1), sep = " ")
S_Summary_Choice_mode_ps= S_Summary_Choice_mode_ps[S_Summary_Choice_mode_ps$Percept_minus_1 != "y(t-1) = NA",]

gathercol <- colnames(S_Summary_Choice_mode_ps[, 6:ncol(S_Summary_Choice_mode_ps)])
S_Summary_Choice_mode_ps_long <- gather(S_Summary_Choice_mode_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_mode_ps_long <-
    ddply(
      S_Summary_Choice_mode_ps_long,
      .(w_Stimulus, Group, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

Group_S_Summary_Choice_mode_ps_no_group_long <-
    ddply(
      S_Summary_Choice_mode_ps_long,
      .(w_Stimulus, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

S_Summary_Data_no_mode <-
    ddply(
      S_Data,
      .(uDisambiguation, Group, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE),
      Stability = mean(Stability, na.rm = TRUE),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

#Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA
gathercol <- colnames(S_Summary_Data_no_mode[, 4:ncol(S_Summary_Data_no_mode)])
S_Summary_Data_no_mode_long <- gather(S_Summary_Data_no_mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_S_Summary_Data_no_mode_long <-
    ddply(
     S_Summary_Data_no_mode_long,
      .(uDisambiguation, Group, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

S_Summary_Data_no_mode_con <-
    ddply(
      S_Data,
      .(uDisambiguation, Group, cond_Accuracy, ID),
      summarise,
      Stability = mean(Stability, na.rm = TRUE),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

#Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA
gathercol <- colnames(S_Summary_Data_no_mode_con[, 5:ncol(S_Summary_Data_no_mode_con)])
S_Summary_Data_no_mode_con_long <- gather(S_Summary_Data_no_mode_con, "Variable", "value", gathercol, factor_key = TRUE)

Group_S_Summary_Data_no_mode_con_long <-
    ddply(
      S_Summary_Data_no_mode_con_long,
      .(uDisambiguation, Group, cond_Accuracy, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )


##
## STATS
##
S_Data$cond_Accuracy = as.factor(S_Data$cond_Accuracy)
if (!load_summary_data) {
  
accuracy_by_GD = glmer(Accuracy ~ uDisambiguation * Group + (1 | Group/ID), data = S_Data, family = binomial(link = logit))
STAT.accuracy_by_GD = summary(accuracy_by_GD)

stability_by_GDC = glmer(Stability ~ uDisambiguation*Group*cond_Accuracy  + (1  | Group/ID), data = S_Data[S_Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.stability_by_GDC = summary(stability_by_GDC)

accuracy_by_GDM = glmer(Accuracy ~ uDisambiguation * Sl_Prob_State_ext * Group + (1|Group/ID), data = S_Data, family = binomial(link = logit))
STAT.accuracy_by_GDM = summary(accuracy_by_GDM)

stability_by_GDMC = glmer(Stability ~ uDisambiguation * Sl_Prob_State_ext * Group * cond_Accuracy  + (1 | Group/ID), data = S_Data[S_Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.stability_by_GDMC = summary(stability_by_GDMC)

##
## Choices
##
y_choice_by_SGP = glmer(y_choice ~ 1 + w_Stimulus * Group * Percept_minus_1 + (1  | Group/ID), data = S_Data, family = binomial(link = logit))
STAT.y_choice_by_SGP = summary(y_choice_by_SGP)

y_choice_by_SGPM = glmer(y_choice ~ 1 + w_Stimulus * Group * Percept_minus_1 * Mode + (1 | Group/ID), data = S_Data, family = binomial(link = logit))
STAT.y_choice_by_SGPM = summary(y_choice_by_SGPM)

##
## RT
##
RT_by_SGP = lmer(RT ~ 1 + poly(w_Stimulus,2) * Group * Percept_minus_1 + (1 | Group/ID), data = S_Data)
STAT.RT_by_SGP = summary(RT_by_SGP)

RT_by_SGPM = lmer(RT ~ 1 + poly(w_Stimulus,2) * Group * Percept_minus_1 * Mode + (1 | Group/ID), data = S_Data)
STAT.RT_by_SGPM = summary(RT_by_SGPM)

  if (save_summary_data) {
    save(STAT.accuracy_by_GD, accuracy_by_GD, 
         STAT.stability_by_GDC, stability_by_GDC,
         STAT.accuracy_by_GDM, accuracy_by_GDM, 
         STAT.stability_by_GDMC, stability_by_GDMC,
         STAT.y_choice_by_SGP, y_choice_by_SGP,
         STAT.y_choice_by_SGPM, y_choice_by_SGPM,
         STAT.RT_by_SGP, RT_by_SGP,
         STAT.RT_by_SGPM, RT_by_SGPM,
         file = "./Results/R_summary_scz_stats.Rdata")
  }
} else {
  load("./Results/R_summary_scz_stats.Rdata")
}

##
## Bonferroni
##
STAT.y_choice_by_SGP = bonferroni(STAT.y_choice_by_SGP)
STAT.y_choice_by_SGPM = bonferroni(STAT.y_choice_by_SGPM)

STAT.RT_by_SGP = bonferroni(STAT.RT_by_SGP)
STAT.RT_by_SGPM = bonferroni(STAT.RT_by_SGPM)

STAT.accuracy_by_GD = bonferroni(STAT.accuracy_by_GD)
STAT.stability_by_GDC = bonferroni(STAT.stability_by_GDC)
```

```{r Scz_mode_summary}
S_Summary_Mode  <-
    ddply(
      S_Data,
      .(Group, ID),
      summarise,
      external = mean(Sl_Prob_State_ext, na.rm = TRUE),
      internal = mean(1-Sl_Prob_State_ext, na.rm = TRUE),
      Mode_bool = (sum(Mode == "external", na.rm = TRUE)/length(Mode)),
      Mode_s = (sum(Mode_switch, na.rm = TRUE)/length(Mode)),
      EI = (sum(Mode_switch[Mode == "internal"] == 1, na.rm = TRUE)/length(Mode)),
      IE = (sum(Mode_switch[Mode == "external"] == 1, na.rm = TRUE)/length(Mode)),
      EE = (sum(Mode_switch[Mode == "external"] == 0, na.rm = TRUE)/length(Mode)),
      II = (sum(Mode_switch[Mode == "internal"] == 0, na.rm = TRUE)/length(Mode))
    )

gathercol <- colnames(S_Summary_Mode[, 3:ncol(S_Summary_Mode)])
S_Summary_Mode_long <- gather(S_Summary_Mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_S_Summary_Mode_long <-
    ddply(
      S_Summary_Mode_long,
      .(Variable, Group),
      summarise,
      mean = mean(value[is.finite(value)], na.rm = TRUE),
      error = sd(value[is.finite(value)], na.rm = TRUE)/sqrt(length(value[is.finite(value)]))
    )


if (!load_summary_data) {
  
S_EE = (S_Summary_Mode$EE[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$EE[S_Summary_Mode$Group == "Controls"])/100
S_II =  (S_Summary_Mode$II[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$II[S_Summary_Mode$Group == "Controls"])/100
S_EI = (S_Summary_Mode$EI[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$EI[S_Summary_Mode$Group == "Controls"])/100
S_IE =  (S_Summary_Mode$IE[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$IE[S_Summary_Mode$Group == "Controls"])/100

S_STAT.Mode_Group = wilcox.test(S_EE,S_II, paired = FALSE, "greater")
S_STAT.Mode_Group_2 = wilcox.test(S_IE,S_EI, paired = FALSE, "greater")

S_Mode_by_G = glmer(Session_Sl_Prob_State_ext ~ Group + (1 |Group), data = S_Data, family = binomial(link = logit))
S_STAT.Mode_by_G = summary(S_Mode_by_G)

S_Stimulus_by_MI = lmer(Stimulus ~ Mode*Group + (1 | Group/ID), data = S_P_Data)
S_STAT.Stimulus_by_MI = summary(S_Stimulus_by_MI)

S_Bias_by_MI = lmer(Bias ~ Mode*Group + (1 | Group/ID), data = S_P_Data)
S_STAT.Bias_by_MI = summary(S_Bias_by_MI)

S_PS_by_MI = lmer(PS ~ Mode*Group + (1 | Group/ID), data = S_P_Data)
S_STAT.PS_by_MI = summary(S_PS_by_MI)

S_Stimulus_PS_by_MI = lmer(Stimulus-PS ~ Mode*Group + (1 | Group/ID ), data = S_P_Data)
S_STAT.Stimulus_PS_by_MI = summary(S_Stimulus_PS_by_MI)

S_STAT.Mode_s_Group = t.test(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s, S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s)

  if (save_summary_data) {
    save(STAT.Mode_Intervention,
         S_STAT.Mode_by_G, 
         S_STAT.Mode_Group_2,
         S_STAT.Mode_by_G, S_Mode_by_G,
         S_STAT.Stimulus_by_MI, S_Stimulus_by_MI,
         S_STAT.Bias_by_MI, S_Bias_by_MI,
         S_STAT.PS_by_MI, S_PS_by_MI,
         S_STAT.Stimulus_PS_by_MI, S_Stimulus_PS_by_MI, 
         S_STAT.Mode_s_Group,
         S_STAT.Mode_Group,
         file = "./Results/R_Summary_S_P_Modes.Rdata")
  }

} else {
  load("./Results/R_Summary_S_P_Modes.Rdata")
}

##
## Bonferroni correction
##
S_STAT.Mode_by_G = bonferroni(S_STAT.Mode_by_G)
S_STAT.Stimulus_by_MI = bonferroni(S_STAT.Stimulus_by_MI)
S_STAT.Bias_by_MI = bonferroni(S_STAT.Bias_by_MI)
S_STAT.PS_by_MI = bonferroni(S_STAT.PS_by_MI)
S_STAT.Stimulus_PS_by_MI = bonferroni(S_STAT.Stimulus_PS_by_MI)
```

```{r Scz_questionnaire_data, cache = TRUE}
##
## Integrate questionnaire data
##
S_Summary_Mode$PDI = NA
S_Summary_Mode$CAPS = NA
S_Summary_Mode$P1 = NA
S_Summary_Mode$P3 = NA
S_Summary_Mode$Threshold = NA

S_P_Data$PDI = NA
S_P_Data$CAPS = NA
S_P_Data$P1 = NA
S_P_Data$P3 = NA
S_P_Data$Threshold = NA

SumData$subject = Quest$subject
for (idx in unique(Quest$subject)){
S_Summary_Mode$PDI[S_Summary_Mode$ID == idx] = Quest$PDI[Quest$subject == idx]
S_Summary_Mode$CAPS[S_Summary_Mode$ID == idx] = Quest$CAPS[Quest$subject == idx] 
S_Summary_Mode$P1[S_Summary_Mode$ID == idx] = Quest$P1[Quest$subject == idx] 
S_Summary_Mode$P3[S_Summary_Mode$ID == idx] = Quest$P3[Quest$subject == idx]
S_Summary_Mode$Threshold[S_Summary_Mode$ID == idx] = SumData$Acuity[SumData$subject == idx]*100

S_P_Data$PDI[S_P_Data$ID == idx] = Quest$PDI[Quest$subject == idx]
S_P_Data$CAPS[S_P_Data$ID == idx] = Quest$CAPS[Quest$subject == idx] 
S_P_Data$P1[S_P_Data$ID == idx] = Quest$P1[Quest$subject == idx] 
S_P_Data$P3[S_P_Data$ID == idx] = Quest$P3[Quest$subject == idx] 
S_P_Data$Threshold[S_P_Data$ID == idx] = SumData$Acuity[SumData$subject == idx]*100
}

S_Quest_to_Mode = glmer(external ~ PDI*Group + CAPS*Group + (1|ID), data = S_Summary_Mode, family = binomial)
S_STAT.Quest_to_Mode = summary(S_Quest_to_Mode)

SP_Quest_to_Mode = glmer(external ~ P1 + P3 + (1|ID), data = S_Summary_Mode, family = binomial)
SP_STAT.Quest_to_Mode = summary(SP_Quest_to_Mode)

S_STAT.Threshold = wilcox.test(S_P_Data$Threshold[S_P_Data$Group == "Patients"], S_P_Data$Threshold[S_P_Data$Group == "Controls"])
S_Threshold_to_Mode = glmer(external ~ Threshold*Group + (1|ID), data = S_Summary_Mode, family = binomial)
S_STAT.Threshold_to_Mode = summary(S_Threshold_to_Mode)
S_STAT.Threshold_to_Mode = bonferroni(S_STAT.Threshold_to_Mode)
```

Next, we performed the same analysis on data from a previous case-control study using an analogous task in patients with Scz[@weilnhammer_psychotic_2020]. In Scz patients and controls, $y_t$ was influenced by the SAR-weighted input $s_t$ ($\beta_S$ = $`r STAT.y_choice_by_SGP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[2,2]`$) and the stabilizing prediction $y_{t-1}$ ($\beta_{P}$ = $`r STAT.y_choice_by_SGP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[4,2]`$). Similar to S-ketamine, $s_t$ had a larger impact on perception in Scz patients than controls ($`r -STAT.y_choice_by_SGP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[5,4]`$; Figure 2E and Supplemental Figure S3). Together, these results align with the canonical predictive processing theory of Scz[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]: Pharmacologically-induced NMDAR hypofunction and Scz are associated with a shift of perceptual inference toward external inputs, and away from stabilizing internal predictions. NMDAR hypofunction may thus trigger psychotic experiences by causing erratic inferences about ambiguous sensory information.

As a mechanism for symptoms that are transient and recurring, NMDAR-dependent changes in perceptual inference should not be constant, but fluctuate dynamically at a timescale that is compatible with the duration of individual psychotic experiences. We tested this prediction in Hidden Markov Models (HMM) that inferred transitions between two latent states, each linked to an independent general linear model (GLM) that predicted $y_t$ from $s_t$ and $y_{t-1}$. The $\beta$ weights quantified the sensitivity to ambiguous sensory information ($\beta_S \times s_t$) relative to the stabilizing effect of internal predictions provided by preceding experiences ($\beta_{P} \times y_{t-1}$), and allowed us to evaluate dynamic changes in the balance $\Delta_{S-P} = \beta_S - \beta_P$ between the two. 

Consistent with recent findings in humans and mice[@ashwood_mice_2022; @weilnhammer_sensory_2023], Bayesian model comparison indicated a clear superiority of the two-state GLM-HMM over the standard one-state GLM in the S-ketamine experiment ($\delta_{BIC}$ = $`r HMM_BIC[HMM_BIC$num_states == 2,]$BIC - HMM_BIC[HMM_BIC$num_states == 1,]$BIC`$). According to the two-state GLM-HMM, perception fluctuated between an internal mode, shaped by the stabilizing internal prediction $y_{t-1}$, and an external mode, dominated by the SAR-weighted input $s_t$. External mode increased $\Delta_{S-P}$ by $`r  -STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[2,2]`$ (T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[2,5]`$; Figure 2B-C). 
Switches between modes occurred in intervals of $`r 1.5/mean(Summary_Mode$Mode_s, na.rm = TRUE)`$ ±  $`r (1.5/sd(Summary_Mode$Mode_s, na.rm = TRUE))/sqrt(length(Summary_Mode$Mode_s))`$ sec. 

The presence of slow fluctuations between external and internal modes suggests that, instead of causing a constant increase in the sensitivity to external inputs, NMDAR hypofunction may affect perception by shifting the dynamic balance between the two modes. Indeed, S-ketamine did not alter the weights of the two-state GLM-HMM (Figure 2C), but increased the probability of external at the expense of internal mode ($`r -STAT.Mode_by_I$coefficients[2,1]`$ ± $`r STAT.Mode_by_I$coefficients[2,2]`$, z = $`r -STAT.Mode_by_I$coefficients[2,3]`$, p = $`r STAT.Mode_by_I$coefficients[2,4]`$; Figure 2D). This effect was stable over time and present across the full range of SAR (Figure 2D). Inter-individual differences in the effects of S-ketamine confirmed that NMDAR hypofunction raised the sensitivity to sensory information (Figure 2A) by modulating the time participants spent in external and internal modes, respectively ($\rho$ = $`r STAT.bimodal_to_unimodal$estimate`$, T($`r STAT.bimodal_to_unimodal$parameter`$) = $`r STAT.bimodal_to_unimodal$statistic`$, p = $`r STAT.bimodal_to_unimodal$p.value`$).

Strikingly, the data from the Scz-control study mirrored the effect of S-ketamine on the balance between external and internal mode: The two-state GLM-HMM outperformed the standard one-state GLM  (patients: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Patients" & S_HMM_BIC$states == 2,]$BIC - S_HMM_BIC[S_HMM_BIC$Group == "Patients" & S_HMM_BIC$states == 1,]$BIC`$; controls: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Controls" & S_HMM_BIC$states == 2,]$BIC - S_HMM_BIC[S_HMM_BIC$Group == "Controls" & S_HMM_BIC$states == 1,]$BIC`$) and revealed two opposing modes ($\Delta_{S-P}$ = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,5]`$; Figure 2F) 
that alternated in intervals of $`r 3.33/mean(S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s, na.rm = TRUE)`$ ±  $`r (3.33/sd(S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s, na.rm = TRUE))/sqrt(length(S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s))`$ sec for patients 
and $`r 3.33/mean(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s, na.rm = TRUE)`$ ±  $`r (3.33/sd(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s, na.rm = TRUE))/sqrt(length(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s))`$ sec for controls. 
Patients and controls did not differ with respect to the weights of the two-state GLM-HMM (Figure 2G). 
Instead, Scz patients spent more time in external mode ($`r -S_STAT.Mode_by_G$coefficients[2,1]`$ ± $`r S_STAT.Mode_by_G$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_G$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_G$coefficients[2,4]`$; Figure 2H). 

We could not attribute between-mode transitions to fatigue, task difficulty (Figure 2D and H), executive function as reflected by response times (RT, Supplemental Figure S1C and S4), psychotomimetic effects of S-ketamine, global psychosis proneness, the clinical severity of Scz, stereodisparity thresholds, or subjective arousal, intoxication and nervousness (Supplemental Figure S5).

To our knowledge, these results are the first to uncover a neural mechanisms for the slow, task-related fluctuations in perceptual inference that have been observed across variety of tasks in humans and mice[@laquitaine_switching_2018; @roy_extracting_2021; @ashwood_mice_2022; @weilnhammer_sensory_2023]. We found that healthy individuals who receive the NMDAR antagonist S-ketamine and patients diagnosed with Scz are prone to an external mode of perception. The external mode partly decouples perceptual inference from internal predictions that reflect prior knowledge about the world. In health, this may prevent circular inferences in recurrent neural networks, where predictive feedback modulates activity even at early stages of sensory processing[@muckli_contextual_2015; @weilnhammer_neural_2018]. A predominance of external mode, on the other hand, exposes perception to the destabilizing effects of ambiguity. Such transient failures of perceptual inference may cause individuals to be deluded by spurious connections between unrelated events[@Sterzer2018], to attribute the sensory consequences of their actions to an outside force, and to hallucinate signals in noise[@Sterzer2018]. 

During external mode, healthy participants were more confident in their choices ($`r -STAT.y_conf_by_STPM$coefficients[6,1]`$ ± $`r STAT.y_conf_by_STPM$coefficients[6,2]`$, z = $`r -STAT.y_conf_by_STPM$coefficients[6,3]`$, p = $`r STAT.y_conf_by_STPM$coefficients[6,4]`$, Supplemental Figure S1E) and scored higher on the *Clinician-Administered-Dissociative-States-Scale*[@mertens_clinician-administered_2022] (CADSS, $`r STAT.CADSS_Mode_Intervention$coefficients[2,1]`$ ± $`r STAT.CADSS_Mode_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Mode_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Mode_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Mode_Intervention$coefficients[2,5]`$, Supplemental Figure S5B). Given the known association of psychosis with elevated confidence[@schmack_striatal_2021] and dissociative symptoms[@longden_relationship_2020], intervals of external mode may thus reflect the computational correlate of individual psychotic experiences. The dynamic nature of between-mode transitions illustrates how constant and potentially heritable dysfunctions of the NMDAR, such as GRIN2A mutations in Scz[@harrison_grin2a_2023], may produce symptoms of psychosis that are recurrent and transient in nature. 

\newpage
# Methods

## Ressource availability

### Lead contact

Further information and requests for resources should be directed to and will be fulfilled by the lead contact, Veith Weilnhammer (veith.weilnhamer@gmail.de).

### Materials availability

This study did not generate new unique reagents.

### Data and code availability

All data and code associated with this study will be made available on the associated Github repository <https://github.com/veithweilnhammer/Ketamin_RDK> upon publication. Key resources are listed in Supplemental Table S1. 

## S-ketamine vs. placebo

The S-ketamine experiment consisted in a total of three experimental sessions. During the first session, we screened participants for S-ketamine contraindications (arterial hypertension, prior psychiatric or neurological diagnoses including substance use disorder, use of psychoactive medication), and assessed psychosis proneness using the 40-item *Peters Delusion Inventory* (PDI[@Peters1999]) and the 32-item *Cardiff Anomalous Perception Scale* (CAPS[@Bell2006]). Moreover, we conducted three experimental pre-test runs that tested the ability to process stereodisparity (run 1, SAR = 1, cut-off: perceptual accuracy > 0.75), ensured the experience of spontaneous switches during bistable perception (run 2, SAR = 0, cut-off: perceptual stability < 0.96, corresponding to phase durations < 40 sec), and familiarized participants with the main experiment (run 3, see below for details).

In the subsequent two sessions, participants received a continuous intravenous infusion of either S-ketamine at 0.1 mg/kg/h or a saline placebo. Health screenings were repeated before each session to ensure the participants remained eligible. At each day of testing, we checked for alcohol intoxication using a breathalyzer and recent illicit substance use via a urine drug screen. 

Our experimental protocol was double-blinded: The order of S-ketamine and placebo administration was counter-balanced across participants, with at least a two week interval between sessions. The participants, as well as the experimenters tasked with collecting the behavioral and psychometric data, were unaware of whether S-ketamine or placebo was administered by an independent group of clinicians who excluded undiagnosed psychotic illness using the *Brief Psychiatric Rating Scale* (BPRS[@overall_brief_1962]), established the intravenous line, started the infusion 15 min prior to the experiment, monitored the participants for side effects (blood pressure, drowsiness and vasovagal reactions, psychotomimetic effects), and removed the intravenous line at the end of the experiment, after which participants were monitored for at least 30 min. Deblinding occurred after data collection was complete. 

### Sample characteristics

We screened a total of `r nrow(Logbook_full)` right-handed individuals with (corrected-to-) normal vision, who were naive to the purpose of the study and gave written informed consent before participating. All experimental procedures were approved by the ethics committee at Charité Berlin. 

From the group of screened participants, `r nrow(Logbook_full[Logbook_full$Incl == 3,])` did not meet our pretest criteria (6 due to perceptual accuracy < 0.75, 15 due to perceptual stability > 0.96, 8 due to substance use, 1 due to do a diagnosis of ADHD, and 1 due to medication with sertraline). Out of the remaining `r nrow(Logbook_full[Logbook_full$Incl != 3,])` participants who were eligible for the S-ketamine experiment, we aborted the main experiment in 1 participant due to high blood pressure at baseline (RR > 140/80 mmHG), in 2 participants due to strong psychotomimetic effects (micropsia) or dizziness under S-ketamine, and in 1 participant due to a vasovagal syncope during intravenous insertion. 24 participants were not available for the main experiment after successful pre-testing. We therefore report the data from a total of `r nrow(Logbook_final)` participants (mean age: `r mean(Logbook_final$age)` ± `r sd(Logbook_final$age)/sqrt(length(Logbook_final$age))` years, `r sum(Logbook_final$gender == "F")` female) who met all inclusion criteria and completed all experimental sessions.

### Experimental paradigm

We presented the experiment using Psychtoolbox 3[@Brainard1997] running in Matlab R2021b (session 1: CRT-monitor at 85 Hz, 1280 x 1024 pixels, 60 cm viewing distance and 39.12 pixels per degree visual angle; session 2 and 32: CRT-monitor at 85Hz, 1280 x 1024 pixels, 40 cm viewing distance and 26.95 pixels per degree visual angle).

**Procedure**: Throughout the experiment, participants reported their perception of a discontinuous SMF stimulus (Supplemental Video S1). In this stimulus, random dots distributed on two intersecting rings induce the perception of a spherical object (diameter: 15.86°, rotational speed: 12 sec per rotation, rotations per block: 10, individual dot size: 0.12°) that rotates around a vertical axis with the front surface to the left or right[@weilnhammer_active_2021]. Stimuli were presented in 120 sec blocks, separated by 10 sec fixation intervals. 

Participants viewed the stimuli through a custom mirror stereoscope. In the pretest experiment, we presented stimuli at complete disambiguation (run 1, SAR = 1), full ambiguity (run 2, SAR = 0) and across five levels ranging from full ambiguity to complete disambiguation across five levels (run 3-5, $SAR \in \{0, 0.1, 0.25, 0.5, 1\}$). The SAR, which was constant within blocks, defines the fraction of stimulus dots that received a disambiguating 3D signal. Within each block, the direction of rotation enforced by the disambiguating 3D signal changes in average intervals of 10 sec (i.e., at a probability of 0.15 per stimulus overlap, see below). We pseudo-randomized the order of SAR across blocks and the direction of disambiguation within blocks. 

Participants were naive to the potential ambiguity in the visual display, passively experienced the stimulus and reported changes in their perception alongside their confidence via button-presses on a standard USB keyboard (right middle-finger on d: rotation of the front-surface to the right at high confidence; right index-finger on f: rotation of the front-surface to the right at low confidence; left middle-finger on k: rotation of the front-surface to the left at high confidence; left index-finger on j: rotation of the front-surface to the left at low confidence; thumb on space bar: unclear direction of rotation). Unclear perceptual states occurred at a rate of `r mean(Uncertainty$rate, na.rm = TRUE)` ± `r sd(Uncertainty$rate, na.rm = TRUE)/sqrt(length(Uncertainty$rate))` and were excluded from further analyses.

The direction of rotation enforced by $s_t$ (i.e., whether the parametric 3D signal enforced leftward or rightward rotation of the front surface) changed at a rate of 0.15 per overlap (i.e., on average every 10 sec). Changes in $s_t$ and the order of blocks, each corresponding to one level of SAR, were pseudo-random.

In session 1 (pre-test), each run (runs 1 to 3) consisted of six blocks. In session 2 and 3 (main experiment), each run (run 4 and 5) consisted of 10 blocks. After every third block, the main experiment was paused to allow for the monitoring of the participants' vital signs (blood pressure and pulse rate) and dynamic changes in psychotomimetic experiences. The latter was assessed using the 6 item *Clinician-Administered-Dissociative-States-Scale* (CADSS[@mertens_clinician-administered_2022]) and three additional questions (Q1: *How awake do you feel?*, Q2: *How intoxicated do you feel?*, Q3: *How nervous do you feel?*) to which participants responded by clicking on a continuous line that encoded responses from *not at all* to *very much*. To measure global psychotomimetic effects of S-ketamine vs. placebo, participants completed the Questionnaire for the *Assessment of Altered States of Consciousness* (5D-ASC[@dittrich_5d-abz_1999]) at the end of session 2 and 3. In addition, we collected responses on a debriefing questionnaire, in which we asked participants to describe whether they were able to accurately perceive the two directions of rotation induced by the SFM stimulus, whether they noticed any differences between blocks, whether they would guess that they received S-ketamine or placebo, and whether they had experienced any effects that they would attribute to a psychoactive substance. 

**Stereodisparity thresholds:** At the beginning of the session 2 and 3, we conducted an independent stereo-acuity test to detect a potential effect of S-ketamine on stereodisparity thresholds[@weilnhammer_psychotic_2020]. We presented 5000 dots (each at 0.15° visual angle) within a square of 11° x 11° around a central fixation cross (0.10°). We added a stereodisparity signal to all dots on a Landolt C, i.e., a circle (1.37° radius, 2.06° width) with a 90° gap located either at the left, top, right or bottom. Stimuli were presented for 1 sec, after which participants reported the location of the gap by pressing the up-, down-, left- or right-arrow key within a 2 sec response interval, followed by 5 sec of fixation before the next trial.

We adjusted the stereodisparity of the Landolt C in a two-up-one-down staircase across 40 trials (initial stereodisparity: 0.0045°, correct response: decrease in the available stereodisparity by one step; incorrect response: increase by two steps, initial step-size: 0.001°, reduction to 0.0005° after first reversal). Stereodisparity thresholds were defined by the average stereodisparity present at the last 10 trials of the staircase.

**Scores and Questionnaires:** Supplementary Table S2 provides an overview of our psychometric data. 

## Scz patients vs. healthy controls

To test whether Scz patients show similar changes in bimodal inference as healthy participants who receive the NMDAR-antagonist S-ketamine, we re-analyzed data from a previously published case-control study[@weilnhammer_psychotic_2020] that compared Scz patients to healthy participants in paradigm analogous to the S-ketamine experiment described above.

### Sample characteristics

We report data from  `r nrow(SumData[SumData$Group == "Patients",])` patients diagnosed with paranoid Scz (ICD-10: F20.0, `r nrow(SumData[SumData$Group == "Patients" & SumData$Gender == 0,])` male, age = `r mean(SumData[SumData$Group == "Patients",]$Age)`±`r sd(SumData[SumData$Group == "Patients",]$Age)/sqrt(length(SumData[SumData$Group == "Patients",]$Age))`) and `r nrow(SumData[SumData$Group == "Controls",])` controls (`r nrow(SumData[SumData$Group == "Controls" & SumData$Gender == 0,])` male, age = `r sprintf('%.2f', mean(SumData[SumData$Group == "Controls",]$Age))`±`r sd(SumData[SumData$Group == "Controls",]$Age)/sqrt(length(SumData[SumData$Group == "Controls",]$Age))`) that were matched for gender, age and handedness[@weilnhammer_psychotic_2020].

### Experimental paradigm

Stimuli were presented using Psychtoolbox 3[@Brainard1997] running in Matlab R2007b (CRT-Monitor at 60 Hz, 1042x768 pixels, 59.50cm viewing distance, 30.28 pixels per degree visual angle).

**Main Experiment**: Throughout the experiment, participants reported their perception of a discontinuous SFM stimulus (see Supplemental Video S2) via button-presses on a standard USB keyboard. In contrast to the S-ketamine experiment, the 300 dots (0.05°) that composed the stimulus (2.05°x 2.05°) were not placed on rings, but on a Lissajous band defined by the perpendicular intersection of two sinusoids ($x(p) = sin(A*p)$ and $y(p) = cos(B*p + \delta$) with $A=3$, $B=6$, with $\delta$ increasing from $0$ to $2\pi$ at 0.15 Hz. Overlapping configurations of the stimulus occurred in intervals of 3.33 sec. Participants viewed the stimuli through a mirror stereoscope. Fusion was supported by rectangular fusion-frames and a background of random dot noise (700 dots of 0.05° which moved at a speed of 1.98° per sec and changed their direction at a rate of 1 Hz).

We presented participants with `r max(S_Data$session_id)` sessions of the main experiment, each consisting of `r max(S_Data$block_id)` 40.08 sec blocks that were separated by 5 sec of fixation and differed with respect to the SAR, ranging from full ambiguity to complete disambiguation in 8 levels ($SAR \in \{ 0, 0.01, 0.04, 0.9, 0.16, 0.26, 0.50, 1 \}$). The frequency of changes in the direction of the disambiguating signal corresponded to the frequency of spontaneous changes that participants perceived during full ambiguity[@weilnhammer_psychotic_2020] (SAR = 0). In contrast to the S-ketamine experiment, participants only reported the perceived direction of rotation $y_t$ (left vs. rightward movement of the front surface). 

**Stereodisparity thresholds:** We assessed stereodisparity thresholds in Scz patients and controls using the procedure described above. 

**Scores and Questionnaires:** We used the PDI[@Peters1999] and the CAPS[@Bell2006] to measure delusional ideation and perceptual anomalies in Scz patients and controls. Clinical symptom severity was assessed using the *Positive and Negative Syndrome Scale* (PANSS)[@Kay1987].

## Quantification and statistical procedures

This manuscript was written in RMarkdown. All data and summary statistics can be reviewed by cloning the Github respository <https://github.com/veithweilnhammer/Ketamin_RDK> and running the file *ketamine_scz_frmri_modes.Rmd*, which will be made public at the time of publication. 

The SFM stimuli used in the above studies share an important feature: Even though physically ambiguous at all angles of rotation, spontaneous changes in the perceived direction of rotation are limited to overlapping configurations of the stimuli[@weilnhammer_psychotic_2020; @weilnhammer_active_2021] (see also Supplemental Figure S1 and S4). This is because depth-symmetry, which is a prerequisite for changes in subjective experiences during bistable SFM[@weilnhammer_psychotic_2020; @weilnhammer_active_2021], is limited to timepoints when the bands that compose the stimuli overlap (Supplemental Video S1 and S2).

We therefore discretized the perceptual timecourse of all experiments into a sequence of overlaps that occur at times $t$ (1.5 sec inter-overlap interval for the S-ketamine and fMRI experiment, 3.33 sec inter-overlap interval for the case-control experiment). Each inter-overlap interval is characterized by the primary independent variable $s_t = [-1, 1] \times SAR$ (the SAR-weighted input ranging from maximum information for leftward rotation to maximum information for rightward rotation). As secondary independent variables, we considered block and session index (reflecting the time participants were exposed to the experiment), participant identifiers and, if applicable, treatment or group identifiers. Primary dependent variables were $y_t = [0,1]$ (the experience of either leftward or rightward rotation), $r_t$ (the time between the button-press indicating a perceptual event relative to the preceding overlap) and, if applicable, $c_t = [0,1]$ (low vs. high confidence). As secondary dependent variables, we computed perceptual accuracy (the probability of $y_t \cong s_t$) and perceptual stability (the probability of $y_t = y(t - 1)$). We report averages as mean ± s.e.m.

### Conventional statistics

The goal of our conventional statistics was to quantify the effect of NMDAR hypofunction, whether due to an antagonism with S-ketamine or due to a diagnosis of Scz, on the interpretation of ambiguous sensory information. To this end, we performed standard logistic and linear regression by fitting (general) linear effects models using the R-packages lmer, glmer and afex (see Supplemental Table S2). We predicted $y_t$, $c_t$, perceptual accuracy and perceptual stability in logistic regression, and $r_t$ in linear regression. We estimated random intercepts defined within participants in the S-ketamine experiment and nested random intercepts for participants within groups in the case-control experiment. We applied a Bonferroni-correction for the number of main effects and interactions within models. For non-normally distributed secondary dependent variables, we performed rank-based tests to assess correlations (Spearman) and distribution differences (Wilcoxon).

### Computational modeling

Having established the effect of NMDAR hypofunction on the interpretation of ambiguous sensory information, we used computational modeling to arbitrate between two mechanistic explanations on how S-ketamine and schizophrenia may alter perceptual inference. 

**Hypothesis H1: Unimodal inference** In one scenario, NMDAR hypofunction may induce a global increase in the sensitivity to external inputs relative to the stabilizing internal prediction. This unimodal scenario would be reflected by S-ketamine- or Scz-related changes in the weights $w \equiv \{\beta_S, \beta_P, \beta_B\}$ of a GLM that predicts percepts $y_t$ from the input vector $x_t$, which consists in the SAR-weighted external input $s_t$, the stabilizing internal prediction $y_{t-1}$ and a constant bias $b$: 

\begin{equation}
P(y_t = 1 | x_t) = \frac{1}{1 + e^{-x_t \times w}} 
\end{equation}

\begin{equation}
x_t \times w =  s_t \times \beta_S + y_{t-1} \times \beta_P  + b \times \beta_B  
\end{equation}

According to the unimodal hypothesis 1, NMDAR hypofunction increases $\beta_S$ at the expense of $\beta_P$, leading to an increase of $\Delta_{S-P} = \beta_S - \beta_P$.

**Hypothesis H2: Bimodal inference** In an alternative scenario, NMDAR hypofunction does not change the weights of the GLM directly, but modulates the transition between latent modes[@weilnhammer_sensory_2023] or decision-making strategies[@ashwood_mice_2022] that differ with respect to the balance between external inputs $s_t$ and the stabilizing internal prediction provided by $y_{t-1}$. In the bimodal scenario, perceptual inference is characterized by two latent modes $z_t$ (i.e., states in a HMM) that alternate at a probability per overlap that is defined by a 2 x 2 transition matrix $A$:

\begin{equation}
P(z_t = k|z_{t-1} = j) = A_{kj} 
\end{equation}

Each state $z_t$ is associated by an independent GLM defined by the weights $w_k$:

\begin{equation}
P(y_t = 1 | x_t, z_t) = \frac{1}{1 + e^{-x_t \times w_k}} 
\end{equation}

\begin{equation}
x_t \times w_k =  s_t \times \beta_{S,k} + y_{t-1} \times \beta_{P,k}  + b \times \beta_{B,k}  
\end{equation}

The bimodal hypothesis H2 differs from the unimodal hypothesis H1 in two ways: First, bimodal inference is characterized by two (as opposed to one) GLMs that differ with respect to $\Delta_{S-P}$: During external mode, $\beta_S$ is increased relative to $\beta_P$, whereas during internal mode, $\beta_P$ is increased relative to $\beta_S$. Second, during bimodal inference, NMDAR hypofunction does not alter the weights within the external and internal GLMs, but modulates the transition probability between the two. 

**Procedure:** To contrast hypotheses H1 and H2, we fitted unimodal and bimodal GLM-HMMs using SSM[@linderman_ssm_2020] (Supplemental Table S2), compared models via Bayesian Information Criterion (BIC), and assessed the effects of S-ketamine or Scz on the posterior model parameters, i.e., HMM transition probabilities and the mode-dependent GLM weights $w_k$. Model fitting using SSM is governed by the hyperparameters $\sigma^2$ and $\alpha$. $\sigma^2$ denotes the variance of a prior over the GLM weights $w_k$. Smaller values of $\sigma^2$ shrink $w_k$ toward 0, whereas $\sigma = \infty$ leads to flat priors. We set $\sigma^2$ to 100 for GLMs that predicted group-level data, and to 1 for GLMs that predicted participant- or session-level data, which were initialized with group-level estimates of $w_k$. $\alpha$ defines the Dirichlet prior over the transition matrix $A$ and is flat for $\alpha$ = 1. We set $\alpha$ to 1 for all group-level and participant-level fits.

For each experiment, computational modeling was carried out in a sequence of 3 steps: In a first step, we fitted a unimodal GLM initialized with noisy weights to the group-level data (i.e., data pooled across participants within an individual experiment) for a total of n = 100 iterations and computed the average posterior weights $w_n$. In a second step, we fitted the group-level data with the unimodal and the bimodal GLM-HMM initialized by $w_n$, extracted the posterior parameters $w_k$, and compared the models using BIC. 

In a third step, we fitted the unimodal and the bimodal GLM-HMM to session-level data (S-ketamine experiment) and participant-level data (case-control experiment). Models were initialized by the average weights $w_n$ of the corresponding group-level model. For all bimodal group-, participant- and session-level GLM-HMMs, we defined the latent mode associated with the higher posterior $\beta_S$ estimate as external. Our definition of mode is thus agnostic with respect to $\beta_P$ and $\Delta_{S-P}$. This allowed us to contrast external-to-internal bimodal inference (hypothesis H2) with a third alternative where perception fluctuates between latent states that differ with respect to decision noise (**hypothesis H0**). Low decision noise is characterized by higher posterior estimates of $\beta_S$ and $\beta_P$, whereas high decision noise is characterized by lower posterior estimates of $\beta_S$ and $\beta_P$. $\Delta_{S-P}$ therefore discerns fluctuations in decision noise (H0, no changes in $\Delta_{S-P}$) from external-to-internal bimodal inference (H2, mode-associated changes in $\Delta_{S-P}$ with higher estimates during external mode). 

For summary statistics, we extracted the posterior weights $w_k$ (separately for external and internal mode) and the dynamic posterior probability of external mode $z_t = e$.

\newpage
# Figures

## Figure 1

```{r Figure 1}
update <- function(mean1, var1, mean2, var2) {
  # calculates new position as multiplication of two Gaussians:
  # prior probability and new information
  new_mean <- (var2 * mean1 + var1 * mean2) / (var1 + var2)
  new_var <- 1 / (1 / var1 + 1 / var2)
  return(c(new_mean, new_var))
}

predict <- function(mean1, var1, mean2, var2) {
  # Calculates new postion as sum (= convolution) of two Gaussians:
  # prior probability and new information
  new_mean <- mean1 + mean2
  new_var  <- var1 + var2
  return(c(new_mean, new_var))
}

if (!load_summary_data) {

  Settings = expand.grid(
  var_stimulus = 0,
  var_encoding = 1.5,
  var_prior = c(0.1, 1, 9999),
  stability = 0.85
)
levels = seq(0,1, by = 0.1)

set.seed(111)
n_steps = 10000
Sim = data.frame()

stimulus = c()
  stimulus[1] = 2
  for (idx in 2:n_steps){
    if (runif(1) < Settings$stability){
      stimulus[idx] = stimulus[idx-1]
    } else
     stimulus[idx] = -stimulus[idx-1]
  }
  
  stimulus = stimulus * levels[randi(length(levels), 1, n_steps)]
    encoding <-
    stimulus + 
    rnorm(length(stimulus), 0, sqrt(Settings$var_encoding))
    
for (sim_idx in c(1:nrow(Settings))) {
  
  pos <- c(0, Settings$var_prior[sim_idx])

  
  inference = c()
  for (i in 1:n_steps) {
    pos <-
      update(pos[1], pos[2], encoding[i], Settings$var_encoding[sim_idx])
    
    inference <- c(inference, pos[1])
    pos[2] = Settings$var_prior[sim_idx]
  }
  y_choice = rbinom(n_steps, 1, plogis(4*inference))
  y_choice_minus_1 = c(0.5, y_choice[1:length(y_choice)-1])
  
  add_Sim = data.frame(
    stimulus = stimulus,
    delta_stimulus = c(NA, diff(stimulus)),
    encoding = encoding,
    delta_encoding = c(NA, diff(encoding)),
    inference = inference,
    y_choice = y_choice,
    y_choice_minus_1 = y_choice_minus_1,
    delta_inference = c(NA, diff(inference)),
    sample = seq(1, n_steps, 1),
    var_encoding = rep(Settings$var_encoding[sim_idx], n_steps),
    var_prior = rep(Settings$var_prior[sim_idx], n_steps)
  )
  
  Sim = rbind(Sim, add_Sim)
}
Sim$var_prior = as.character(Sim$var_prior)
Sim$var_prior = gsub(as.character(Settings$var_prior[1]), "Strong gating and integration", Sim$var_prior)
Sim$var_prior = gsub(as.character(Settings$var_prior[2]), "Optimal", Sim$var_prior) 
Sim$var_prior = gsub(as.character(Settings$var_prior[3]), "Weak gating and integration", Sim$var_prior) 

gathercol = colnames(Sim[, c(1:8)])
Sim_long  <- gather(Sim,
                    "Variable",
                    "Value",
                    gathercol,
                    factor_key = TRUE)


Sim_average = ddply(
     Sim[Sim$y_choice_minus_1 != 0.5,],
      .(var_prior, stimulus, y_choice_minus_1),
      summarise,
      mean = mean(y_choice, na.rm = TRUE),
      error = sd(y_choice, na.rm = TRUE)/sqrt(length(y_choice))
)
Sim_average$y_choice_minus_1 = as.factor(Sim_average$y_choice_minus_1)
  
  if (save_summary_data) {
    save(Settings, Sim_long, Sim_average,
         file = "./Results/Sim.Rdata")
  }
} else {
  load("./Results/Sim.Rdata")
}
n_to_plot = 80
p_Sim <-
  ggplot() + geom_line(
    data = Sim_long[Sim_long$var_prior != "Strong gating and integration" & Sim_long$sample < n_to_plot &
                      (Sim_long$Variable == "inference" |
                         Sim_long$Variable == "stimulus") , ],
    aes(x = sample, y = plogis(Value), color = Variable),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  geom_point(
    data = Sim_long[Sim_long$var_prior != "Strong gating and integration" & Sim_long$sample < n_to_plot &
                      Sim_long$Variable == "encoding", ],
    aes(x = sample, y = plogis(Value), color = Variable),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  theme_classic(base_size = 6) + labs(
    x = "t",
    y =
      "P(y(t) = 1)",
    linetype = "",
    subtitle = "B"
  ) + geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  theme(legend.position = "top") + facet_wrap(~var_prior, ncol = 1)

p_sim_average <-
  ggplot() +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +  geom_vline(
    xintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
    geom_line(
    data = Sim_average[Sim_average$var_prior != "Strong gating and integration",],
    mapping = aes(
      y = mean,
      x = stimulus/2,
      linetype = y_choice_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd,
    color = "black"
  ) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Dark2", direction = 1) + scale_fill_brewer(palette = "Dark2", direction = 1) + 
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = " ",
   linetype = "y(t-1)",
  ) + 
  theme(legend.position = "top") + facet_wrap( ~ var_prior, ncol = 1) 


Summary_Data$Phase = 1.5/(1-Summary_Data$Stability)
Summary_Data$Phase[!is.finite(Summary_Data$Phase)] = 120
phase_ridges <-
ggplot(Summary_Data,
aes(
x = Phase,
y = as.factor(uDisambiguation),
fill = as.factor(uDisambiguation)
)) + geom_density_ridges(color = "white", rel_min_height = 0.001, bandwidth = 3  , scale = 6, alpha = 0.75, line_size_gd = line_size_sd) + theme_ridges(font_size = 10,
grid = FALSE, center_axis_labels = TRUE) + geom_vline(xintercept = 10,
    linetype = "dashed",
    color = "black",
    size = 0.25) + xlim(0, 60) + labs(x =
"Average phase duration (sec)",  y = "SAR", subtitle = "C") + theme_classic(base_size = 6) + scale_fill_brewer(palette = "Spectral", direction = -1) + theme(
      axis.text.y=element_blank(), 
      axis.ticks.y=element_blank()) 
```

![](./Material/Figure_1.png)

**Figure 1.**

**A.** When inferring whether the world is one state or another ($P(y_t = 1)$ or $P(y_t = 0)$, respectively), the brain integrates ambiguous sensory signals $s_t$ with internal predictions that reflect prior knowledge about the environment. One source of prior knowledge is the temporal autocorrelation of natural stimuli, in which the recent past often predicts the near future. The integration of external inputs and internal predictions depends on the weights assigned to incoming sensory data ($\beta_S \times s_t$) and to internal prediction derived from previous experiences ($\beta_P \times y_{t-1}$, dotted versus solid lines, simulated data), respectively. $\beta_S$ determines the slope, and $\beta_P$ the shift of the psychometric function that links $s_t$ and $y_t$. Importantly, the balance $\Delta_{S-P} = \beta_S - \beta_P$ is known to alternate between two opposing modes: During the external mode (left), perception is largely determined by $\beta_S \times s_t$, which is reflected by a steep slope and a small shift of the psychometric curve. Conversely, during the internal mode (right), perception is shaped by $\beta_P \times y_{t-1}$, resulting in a shallow slope and a large shift of the psychometric curve.

**B.** We conducted a double-blind placebo-controlled experiments in 28 healthy human participants, who received a continuous infusion with either the NMDAR antagonist S-ketamine or saline. During the infusion, the participants viewed an ambiguous SFM stimulus that was compatible with two mutually exclusive subjective experiences (left vs. rightward rotation of the front surface, red arrows). This induced the phenomenon of bistable perception: While the ambiguous stimulus remained constant, participants perceived only one direction of rotation (blue arrow), before switching to the competing alternative.

**C.** Changes in the perceived direction of rotation of the SFM stimulus occur at brief depth-symmetric configurations of the stimulus (Supplemental Video S1). We therefore transformed the behavioral responses into a sequence of states $t$ (80 1.5 sec intervals per block), each associated with a combination of the SAR-weighted input $s_t$ and the perceived direction of rotation $y_t$. We used GLMs to quantify the weights $\beta_S$, $\beta_P$ and $\beta_B$, which reflect how inferences $y_t$ were determined by the external inputs $\beta_S \times s_t$ and internal predictions $\beta_P \times y_{t-1}$.

\newpage
## Figure 2

```{r Figure_2}
# alpha_sd = 0.45
# alpha_gd = 0.65
# dot_size_sd = 0.5
# line_size_sd = dot_size_sd/20
# dot_size_gd = 4 * dot_size_sd
# line_size_gd = 2 * dot_size_sd

##
## S-ketamine
##

##
## Psychometric function
##
dodge_width = 0.5
Variables = c("Accuracy")
p_main_accuracy <- ggplot() + geom_jitter(data = Summary_Data_no_mode_long[Summary_Data_no_mode_long$Intervention != "None" & Summary_Data_no_mode_long$Variable %in% Variables & Summary_Data_no_mode_long$uDisambiguation != 0,],
  aes(
  x = as.factor(uDisambiguation),
  y = value,
  color = Intervention
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_Summary_Data_no_mode_long[Group_Summary_Data_no_mode_long$Intervention != "None" & Group_Summary_Data_no_mode_long$Variable %in% Variables & Group_Summary_Data_no_mode_long$uDisambiguation > 0,],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Intervention
    ),
   width = dodge_width/2,
   position = position_dodge(width = dodge_width*2),
  size = line_size_gd,
  alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + labs(
  x = "Session",
  y = "Value",
  subtitle = NULL,
  color = "Mouse"
  ) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "|s(t)|",  y = paste("P(y(t) = s(t)", sep = " "), subtitle = "A", color = "Intervention") + theme(panel.spacing=unit(1,"lines")) + facet_wrap(~"Accuracy")

dodge_width = 0.05
Variables = c("y_choice")

p_intervention_ps <-
  ggplot() +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention,
      group = interaction(Percept_minus_1, Intervention)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + 
    geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention,
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "A",
    color = "Intervention",
  )  + facet_wrap( ~Mode)

p_intervention_mode_ps <-
  ggplot() + geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention,
      group = interaction(Percept_minus_1, Intervention)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention,
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~Mode, ncol = 1)
##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus-PS")
p_mode_parameters <-
  ggplot() + geom_jitter(
    data = P_Data_long[P_Data_long$Variable %in% Variables &
                         P_Data_long$Intervention != "None" & P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_P_Data_long[Group_P_Data_long$Variable %in% Variables &
                               Group_P_Data_long$Intervention != "None" & Group_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) + scale_y_continuous(breaks=c(-4,-2,0,2)) +
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "C") + facet_wrap( ~ Variable, ncol = length(Variables))


Variables = c("external")
p_mode <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Intervention,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Intervention,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0.50),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Intervention",
    y = "Probability",
    subtitle = "D",
    color = "Intervention"
  ) + facet_wrap(~"Mode Probability")


##
## Patients vs. controls
##
##
## Psychometric function
##
dodge_width = 0.5

Variables = c("Accuracy")
p_s_main_accuracy <- ggplot() + geom_jitter(data = S_Summary_Data_no_mode_long[S_Summary_Data_no_mode_long$Variable %in% Variables & S_Summary_Data_no_mode_long$uDisambiguation > 0,],
  aes(
  x = as.factor(uDisambiguation),
  y = value,
  color = Group
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_S_Summary_Data_no_mode_long[Group_S_Summary_Data_no_mode_long$Variable %in% Variables & Group_S_Summary_Data_no_mode_long$uDisambiguation > 0,],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Group
    ),
    width = dodge_width/2,
    position = position_dodge(width = dodge_width*2),
    size = line_size_gd,
    alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + labs(
  x = "Session",
  y = "Value",
  subtitle = NULL,
  color = "Mouse"
  ) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "|s(t)|",  y = paste("P(y(t) = s(t))", sep = " "), subtitle = "E", color = "Group") + theme(panel.spacing=unit(1,"lines")) + facet_wrap(~"Accuracy")

dodge_width = 0.05
stretch = 0.5
Variables = c("y_choice")

p_s_intervention_ps <-
  ggplot() +  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group,
      group = interaction(Percept_minus_1, Group)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group,
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "E",
    color = "Intervention",
  ) + facet_wrap( ~Mode)

p_s_intervention_mode_ps <-
  ggplot() + geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group,
      group = interaction(Percept_minus_1, Group)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) +  geom_line(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group, 
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "F",
    color = "Group",
  ) + facet_wrap(~Mode, ncol = 1)


##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus-PS")
p_s_mode_parameters <-
  ggplot() + geom_jitter(
    data = S_P_Data_long[S_P_Data_long$Variable %in% Variables & S_P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_P_Data_long[Group_S_P_Data_long$Variable %in% Variables & Group_S_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) + 
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "G") + facet_wrap( ~ Variable, ncol = length(Variables))


Variables = c("external")
p_s_mode <-
  ggplot() + geom_jitter(
    data = S_Summary_Mode_long[S_Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Group,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_Summary_Mode_long[Group_S_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Group,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0.50),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Group",
    y = "Probability",
    subtitle = "H",
    color = "Group"
  ) + facet_wrap(~"Mode Probability")


##
## Time and SAR
##

##
## Ketamine
##
Time_Data = subset(
  Data,
  select = c(
    overlap_index,
    block_id,
    Session_Sl_Prob_State_ext,
    Intervention,
    uDisambiguation,
    ID
  ),
  subset = c(Intervention != "None")
)
Time_Data$t = Time_Data$overlap_index + max(Time_Data$overlap_index) * (Time_Data$block_id - 1)
Time_Data$ut = Time_Data$t/max(Time_Data$t)

gathercol <- colnames(Time_Data[,c(3,5)])
Time_Data_long <- gather(Time_Data, "Variable", "value", gathercol, factor_key = TRUE)

Summary_Time_Data = ddply(
  Time_Data,
  .(t, ID, Intervention),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_Summary_Time_Data = ddply(
  Summary_Time_Data,
  .(t, Intervention),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

Summary_Difficulty_Data = ddply(
  Time_Data,
  .(uDisambiguation, ID, Intervention),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_Summary_Difficulty_Data = ddply(
  Summary_Difficulty_Data,
  .(uDisambiguation, Intervention),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

##
## Schizophrenia
##

S_Time_Data = subset(
  S_Data,
  select = c(
    overlap_index,
    block_id,
    Session_Sl_Prob_State_ext,
    Group,
    uDisambiguation,
    ID
  )
)

S_Time_Data$counter <- NA
unique_ids <- unique(S_Time_Data$ID)
# Loop through each unique ID
for (id in unique_ids) {
  # Filter the data for the current ID
  subset_data <- S_Time_Data[S_Time_Data$ID == id, ]
  
  # Calculate the counter for the current ID
  counter <- cumsum(c(TRUE, diff(subset_data$block_id) != 0))
  
  # Assign the counter back to the original data frame
  S_Time_Data[S_Time_Data$ID == id, "counter"] <- counter
}
S_Time_Data$t = S_Time_Data$overlap_index + max(S_Time_Data$overlap_index) * (S_Time_Data$block_id - 1)
S_Time_Data$ut = S_Time_Data$t/max(S_Time_Data$t)

gathercol <- colnames(S_Time_Data[,c(3,5)])
S_Time_Data_long <- gather(S_Time_Data, "Variable", "value", gathercol, factor_key = TRUE)

S_Summary_Time_Data = ddply(
  S_Time_Data,
  .(t, ID, Group),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_S_Summary_Time_Data = ddply(
  S_Summary_Time_Data,
  .(t, Group),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

S_Summary_Difficulty_Data = ddply(
  S_Time_Data,
  .(uDisambiguation, ID, Group),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_S_Summary_Difficulty_Data = ddply(
  S_Summary_Difficulty_Data,
  .(uDisambiguation, Group),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

if (!load_summary_data) {
Mode_by_time = glmer(
  Session_Sl_Prob_State_ext ~ ut*Intervention + (1 |
                                     ID),
  data = Time_Data,
  family = binomial
)
STAT.Mode_by_time = summary(Mode_by_time)

Mode_by_difficulty = glmer(
  Session_Sl_Prob_State_ext ~ uDisambiguation*Intervention + (1 |
                                     ID),
  data = Time_Data[Time_Data$uDisambiguation,],
  family = binomial
)
STAT.Mode_by_difficulty = summary(Mode_by_difficulty)

S_Mode_by_time = glmer(
  Session_Sl_Prob_State_ext ~ ut*Group + (1 |
                                     ID),
  data = S_Time_Data,
  family = binomial
)
S_STAT.Mode_by_time = summary(S_Mode_by_time)

S_Mode_by_difficulty = glmer(
  Session_Sl_Prob_State_ext ~ uDisambiguation*Group + (1 |
                                     Group),
  data = S_Time_Data,
  family = binomial
)
S_STAT.Mode_by_difficulty = summary(S_Mode_by_difficulty)

  if (save_summary_data) {
    save(STAT.Mode_by_time, Mode_by_time,
         STAT.Mode_by_difficulty, Mode_by_difficulty,
         S_STAT.Mode_by_time, S_Mode_by_time,
         S_STAT.Mode_by_difficulty, S_Mode_by_difficulty,
         file = "./Results/R_summary_mode_time")
  }
} else {
  load("./Results/R_summary_mode_time")
}
STAT.Mode_by_time = bonferroni(STAT.Mode_by_time)
STAT.Mode_by_difficulty = bonferroni(STAT.Mode_by_difficulty)
S_STAT.Mode_by_time = bonferroni(S_STAT.Mode_by_time)
S_STAT.Mode_by_difficulty = bonferroni(S_STAT.Mode_by_difficulty)


dodge_width = 0.05

p_mode_time <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Time_Data[Group_Summary_Time_Data$t %in% seq(1,length(Group_Summary_Time_Data$t), 10),],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (t*1.5)/60,
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Time_Data[Group_Summary_Time_Data$t %in% seq(1,length(Group_Summary_Time_Data$t), 10),],
    mapping = aes(
      y = mean,
      x = (t*1.5)/60,
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  )  + ylim(0.5,1) + xlim(0.1,20) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "t (min) after session onset",
    y = "P(External Mode)",
    subtitle = " "
  ) 

p_mode_difficulty <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_jitter(data = Summary_Difficulty_Data,
  aes(
  x = as.factor(uDisambiguation),
  y = average,
  color = Intervention
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_Summary_Difficulty_Data,
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Intervention
    ),
    width = dodge_width*5,
    position = position_dodge(width = dodge_width*7),
    size = line_size_gd,
    alpha = alpha_gd
  ) + ylim(0.5,1) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "SAR",
    y = "P(External Mode)",
    subtitle = " "
  ) 

s_p_mode_time <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Time_Data,
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (t*3.33)/60,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Time_Data,
    mapping = aes(
      y = mean,
      x = (t*3.33)/60,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) + ylim(0.5,1) + xlim(0.1,9) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "t (min) after session onset",
    y = "P(External Mode)",
    subtitle = " " 
  ) 


s_p_mode_difficulty <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_jitter(data = S_Summary_Difficulty_Data,
  aes(
  x = as.factor(uDisambiguation),
  y = average,
  color = Group
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_S_Summary_Difficulty_Data,
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Group
    ),
    width = dodge_width*5,
    position = position_dodge(width = dodge_width*7),
    size = line_size_gd,
    alpha = alpha_gd
  ) + ylim(0.5,1) +
  theme_classic(base_size = 6) +
  scale_x_discrete(breaks = Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Controls",]$uDisambiguation[seq(1, length(Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Controls",]$uDisambiguation), by = 2)]) +
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "SAR",
    y = "P(External Mode)",
    subtitle = " "
  ) 

lay <- rbind(c(1,2,3,4,9), c(1,2,3,4,10), c(5,6,7,8,11), c(5,6,7,8,12))
grid.arrange(
  p_main_accuracy,
  p_intervention_mode_ps,
  p_mode_parameters,
  p_mode,
  p_s_main_accuracy ,
  p_s_intervention_mode_ps,
  p_s_mode_parameters,
  p_s_mode,
  p_mode_time, p_mode_difficulty,
  s_p_mode_time, s_p_mode_difficulty,
  layout_matrix = lay,
  heights = c(1,1,1,1),
  widths = c(0.8,0.4, 0.3, 0.4, 0.6)
)

```

**Figure 2.**

**A.** The percepts $y_t$ were more likely to match the stimuli $s_t$ at higher levels of SAR ($`r STAT.y_choice_by_STP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[2,4]`$). The positive effect of SAR on $P(y_t \cong s_t)$ was more pronounced under S-ketamine (red) relative to placebo (blue; $`r -STAT.y_choice_by_STP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[5,4]`$).

**B.** In the S-ketamine experiment, the HMM identified two modes that differed with respect to the relative weighting of external sensory data and internal predictions: Perception fluctuated between an external mode, determined by the input $s_t$ (upper panel panel, steep slope and small shift of the psychometric curve), and an internal mode, dominated by a stabilizing prediction that biased perception toward previous experiences $y_{t-1}$ (lower panel, shallow slope and large shift of the psychometric curve). Within modes, there was no significant effect of S-ketamine (red) versus placebo (blue) on the relation of $y(t)$ with $s(t)$ and $y(t-1)$.

**C.** $\Delta_{S-P}$, the balance between the external input and the stabilizing internal predictions, was larger during external than during internal mode ($`r -STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r -STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[2,5]`$). 
Importantly, we found no significant effect of S-ketamine (red) vs. placebo (blue) on $\Delta_{S-P}$ within modes ($`r STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[3,5]`$).

**D.** S-ketamine (red) increased the probability of external mode ($`r -STAT.Mode_by_I$coefficients[2,1]`$ ± $`r STAT.Mode_by_I$coefficients[2,2]`$, z = $`r -STAT.Mode_by_I$coefficients[2,3]`$, p = $`r STAT.Mode_by_I$coefficients[2,4]`$) relative to placebo (blue; left panel). The effect of S-ketamine on mode was present from the start of the session ($`r -STAT.Mode_by_time$coefficients[3,1]`$ ± $`r  STAT.Mode_by_time$coefficients[3,2]`$, z = $`r -STAT.Mode_by_time$coefficients[3,3]`$, p = $`r STAT.Mode_by_time$coefficients[3,4]`$, upper panel), with no significant effect of time ($`r STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  STAT.Mode_by_time$coefficients[2,2]`$, z = $`r STAT.Mode_by_time$coefficients[2,3]`$, p = $`r STAT.Mode_by_time$coefficients[2,4]`$). Relative to placebo, S-ketamine increased the probability of external mode across all SARs ($`r -STAT.Mode_by_difficulty$coefficients[3,1]`$ ± $`r STAT.Mode_by_difficulty$coefficients[3,2]`$, z = $`r -STAT.Mode_by_difficulty$coefficients[3,3]`$, p = $`r STAT.Mode_by_difficulty$coefficients[3,4]`$, lower panel). Higher SARs were associated with an increased probability of external mode ($`r STAT.Mode_by_difficulty$coefficients[2,1]`$ ± $`r  STAT.Mode_by_difficulty$coefficients[2,2]`$, z = $`r STAT.Mode_by_difficulty$coefficients[2,3]`$, p = $`r STAT.Mode_by_difficulty$coefficients[2,4]`$), in particular under S-ketamine ($`r -STAT.Mode_by_difficulty$coefficients[4,1]`$ ± $`r  STAT.Mode_by_difficulty$coefficients[4,2]`$, z = $`r -STAT.Mode_by_difficulty$coefficients[4,3]`$, p = $`r STAT.Mode_by_difficulty$coefficients[4,4]`$). Alternations between external and internal mode were found at all SARs: From from full ambiguity to complete disambiguation, the probability of external mode increased by only `r diff(range(Group_Summary_Difficulty_Data[Group_Summary_Difficulty_Data$Intervention == "Ketamine",]$mean))` under S-ketamine and `r diff(range(Group_Summary_Difficulty_Data[Group_Summary_Difficulty_Data$Intervention == "Placebo",]$mean))` under placebo. 

**E.** In patients (red) and controls (blue), percepts $y_t$ were more likely to match the stimuli $s_t$ at higher levels of SAR ($\beta_S$ = $`r STAT.y_choice_by_SGP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[2,4]`$).
Patients followed the external inputs more closely than controls ($`r -STAT.y_choice_by_SGP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[5,4]`$). 

**F.** In analogy to the S-ketamine experiment, the HMM identified two opposing modes in Scz patients (red) and controls (blue). The external mode increased the sensitivity toward $s_t$ (slope of the psychometric function) and weakened the effect of the stabilizing internal prediction $y_{t-1}$ (shift between the dotted and solid line) relative to the internal mode. Within modes, there was no effect of group on the relation of $y(t)$ with $s(t)$ and $y(t-1)$. 

**G.** The external mode increased $\Delta_{S-P}$, the balance between external inputs and internal predictions, in patients (red) and controls (blue; $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), 
with no significant effect of group ($`r S_STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,5]`$).

**H.** Relative to controls (blue), patients (red) spent more time in external mode ($`r -S_STAT.Mode_by_G$coefficients[2,1]`$ ± $`r S_STAT.Mode_by_G$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_G$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_G$coefficients[2,4]`$, left panel). In both group, biases toward external mode increased over time after session onset ($`r S_STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  S_STAT.Mode_by_time$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_time$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[2,4]`$; upper panel), with a stronger effect in patients ($`r -S_STAT.Mode_by_time$coefficients[4,1]`$ ± $`r S_STAT.Mode_by_time$coefficients[4,2]`$, z = $`r -S_STAT.Mode_by_time$coefficients[4,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[4,4]`$). Patients were more likely than controls to be in external mode across all levels of SAR ($`r -S_STAT.Mode_by_difficulty$coefficients[3,1]`$ ± $`r  S_STAT.Mode_by_difficulty$coefficients[3,2]`$, z = $`r -S_STAT.Mode_by_difficulty$coefficients[3,3]`$, p = $`r S_STAT.Mode_by_difficulty$coefficients[3,4]`$, lower panel). External mode increased with SAR ($`r S_STAT.Mode_by_difficulty$coefficients[2,1]`$ ± $`r  S_STAT.Mode_by_difficulty$coefficients[2,2]`$, z = $`r S_STAT.Mode_by_difficulty$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_difficulty$coefficients[2,4]`$), with no significant difference between groups ($`r -S_STAT.Mode_by_difficulty$coefficients[4,1]`$ ± $`r  S_STAT.Mode_by_difficulty$coefficients[4,2]`$, z = $`r -S_STAT.Mode_by_difficulty$coefficients[4,3]`$, p = $`r S_STAT.Mode_by_difficulty$coefficients[4,4]`$). As in the S-ketamine experiment, alternations between external and internal mode were found at all SARs: From from full ambiguity to complete disambiguation, the probability of external mode increased by only `r diff(range(Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Patients",]$mean))` in patients and `r diff(range(Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Controls",]$mean))` in controls.

\newpage
# Supplemental Information

## Supplemental Figure S1

```{r Supplemental_Figure_S1, fig.height = 7}
p_summary_RT <-
ggplot(Data[Data$Intervention != "None" & Data$Disambiguation == 0,],
aes(
x = RT,
y = as.factor(ID),
fill = Intervention
)) + geom_density_ridges(color = "white", bandwidth = 0.2, scale = 4, alpha = 0.5) + theme_ridges(font_size = 10,
grid = FALSE,
center_axis_labels = TRUE) + xlim(-0.1, 1.6) + xlab("RT (sec)") + labs(x =
"RT (sec)",  y = "Participants", subtitle = "A") + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none", axis.text.y=element_blank())

## collapsed Histogram RT
p_collapsed_RT <- ggplot(Data[Data$Intervention != "None",], aes(x = RT, y=..density.., fill = Intervention))+ geom_density(alpha = 0.5, bw = 0.25, scale = 4, color = "white") +
 labs(x="RT (sec)",  y="Density", subtitle = "B") + xlim(-0.1, 1.6) + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none")


##
## Psychometric function
##
dodge_width = 0.05
Variables = c("RT")

p_intervention_ps_RT <-
  ggplot() + geom_point(
    data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 1.5),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_intervention_mode_ps_RT <-
  ggplot() + geom_point(
    data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 1.5),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "C",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)

Variables = c("confidence")
p_intervention_ps_conf <-
  ggplot() + geom_point(
    data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(high confidence)",
    subtitle = "D",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_intervention_mode_ps_conf <-
  ggplot() + geom_point(
    data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(high confidence)",
    subtitle = "external",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)

lay <- rbind(c(1,2,3),
             c(1,4,5))
grid.arrange(
p_summary_RT,
p_intervention_ps_RT,
p_intervention_mode_ps_RT,
p_intervention_ps_conf,
p_intervention_mode_ps_conf,
layout_matrix = lay,
heights=c(1,1), widths=c(0.25,0.6, 1)
)

ks_test_data = Data[Data$Intervention != "None" & Data$Disambiguation == 0,]$RT
ks_test_data = ks_test_data[!is.na(ks_test_data)]
STAT_uniform = ks.test(ks_test_data, "punif", min = min(ks_test_data), max = max(ks_test_data))
```

**Supplemental Figure S1. The effects of ketamine and bimodal inference on RT.**

**A.** RT were non-uniformly distributed across the inter-overlap interval (D = $`r STAT_uniform$statistic`$, p = $`r STAT_uniform$p.value`$, one-sample Kolmogorov-Smirnov test). This corroborates that changes in perception aligned with the overlapping configurations of the stimulus after S-ketamine (red) and placebo (blue).

**B.** RT showed a quadratic relationship with $s_t$ ($`r STAT.RT_by_STP$coefficients[3,1]`$ ± $`r STAT.RT_by_STP$coefficients[3,2]`$, T($`r STAT.RT_by_STP$coefficients[3,3]`$) = $`r STAT.RT_by_STP$coefficients[3,4]`$, p = $`r STAT.RT_by_STP$coefficients[3,5]`$), 
indicating faster responses when sensory information was reliable ($|s_t| \gg  0$; note that SAR as shown in Figure 2A and 2E is equal to $|s_t|$). We observed no main effect of S-ketamine (red) vs. placebo (blue) on RT ($`r STAT.RT_by_STP$coefficients[4,1]`$ ± $`r STAT.RT_by_STP$coefficients[4,2]`$, T($`r STAT.RT_by_STP$coefficients[4,3]`$) = $`r STAT.RT_by_STP$coefficients[4,4]`$, p = $`r STAT.RT_by_STP$coefficients[4,5]`$).

**C.** We found no additional effect of mode on RT ($`r STAT.RT_by_STPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_STPM$coefficients[6,2]`$, z = $`r STAT.RT_by_STPM$coefficients[6,3]`$, p = $`r STAT.RT_by_STPM$coefficients[6,4]`$).

**D.** Confidence showed a quadratic relationship with $s_t$ ($`r STAT.y_conf_by_STP$coefficients[3,1]`$ ± $`r  STAT.y_conf_by_STP$coefficients[3,2]`$, z = $`r STAT.y_conf_by_STP$coefficients[3,3]`$, p = $`r STAT.y_conf_by_STP$coefficients[3,4]`$), confirming that participants were more confident when sensory information was reliable ($|s_t| = SAR \gg  0$). Relative to placebo (blue), S-ketamine (red) reduced choice confidence ($`r -STAT.y_conf_by_STP$coefficients[4,1]`$ ± $`r  STAT.y_conf_by_STP$coefficients[4,2]`$, z = $`r -STAT.y_conf_by_STP$coefficients[4,3]`$, p = $`r STAT.y_conf_by_STP$coefficients[4,4]`$), and decreased the quadratic effect of  $s_t$ on confidence ($`r -STAT.y_conf_by_STP$coefficients[7,1]`$ ± $`r  STAT.y_conf_by_STP$coefficients[7,2]`$, z = $`r -STAT.y_conf_by_STP$coefficients[7,3]`$, p = $`r STAT.y_conf_by_STP$coefficients[7,4]`$).

**E.** External mode increased confidence globally ($`r -STAT.y_conf_by_STPM$coefficients[6,1]`$ ± $`r STAT.y_conf_by_STPM$coefficients[6,2]`$, z = $`r -STAT.y_conf_by_STPM$coefficients[6,3]`$, p = $`r STAT.y_conf_by_STPM$coefficients[6,4]`$) and by elevating the quadratic effect of $s_t$ on confidence ($`r -STAT.y_conf_by_STPM$coefficients[13,1]`$ ± $`r STAT.y_conf_by_STPM$coefficients[13,2]`$, z = $`r -STAT.y_conf_by_STPM$coefficients[13,3]`$, p = $`r STAT.y_conf_by_STPM$coefficients[13,4]`$). When controlling for mode, the negative effect of S-ketamine (red) vs. placebo (blue) on confidence and on the quadratic relationship of confidence with $s_t$ remained significant.

\newpage
## Supplemental Figure S2

```{r Supplemental_Figure_S2, fig.height = 7}

# alpha_sd = 0.45
# alpha_gd = 0.65
# dot_size_sd = 0.5
# line_size_sd = dot_size_sd/20
# dot_size_gd = 4 * dot_size_sd
# line_size_gd = 2 * dot_size_sd

##
## Psychometric function
##
dodge_width = 0.05
Variables = c("y_choice")

p_intervention_ps <-
  ggplot() + geom_point(
    data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention,
      fill = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + 
    geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "A",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_intervention_mode_ps <-
  ggplot() + geom_point(
    data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)


##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus", "Bias", "PS", "Stimulus-PS")
p_mode_parameters <-
  ggplot() + geom_jitter(
    data = P_Data_long[P_Data_long$Variable %in% Variables &
                         P_Data_long$Intervention != "None" & P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_P_Data_long[Group_P_Data_long$Variable %in% Variables &
                               Group_P_Data_long$Intervention != "None" & Group_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "C") + facet_wrap( ~ Variable, ncol = length(Variables))


Variables = c("EE", "II")
p_mode <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Variable,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Variable,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0.50),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Mode",
    y = "Rate",
    subtitle = "D",
    color = "Intervention"
  ) +facet_wrap(~"Survival")

Variables = c("EI", "IE")
p_mode_2 <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Variable,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Variable,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Mode",
    y = "Rate",
    subtitle = " ",
    color = "Intervention"
  ) + facet_wrap(~"Transition")

lay <- rbind(c(1,2), c(3))
grid.arrange(
  p_intervention_ps,
  p_intervention_mode_ps,
  p_mode_parameters,
  layout_matrix = lay,
  heights = c(2.25,1),
  widths = c(1,1)
)
```

**Supplemental Figure S2. Extended data on the effects of S-ketamine and mode on perceptual inference (related to Figure 2A-C).**

**A.** Here, we show psychometric curves (percept $y_t$ versus input $s_t$) under S-ketamine (red) and placebo (blue). The plot separates times $t$ for which the previous experience was leftward rotation ($y_{t-1} = -1$, upper panel) and rightward rotation ($y_{t-1} = +1$, lower panel). As expected, $y_t$ was driven by both the external input $s_t$ ($\beta_S$ = $`r STAT.y_choice_by_STP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[2,4]`$) and the previous percept $y_{t-1}$ ($\beta_{P}$ = $`r STAT.y_choice_by_STP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[4,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[4,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[4,4]`$). 
We found no significant interaction between the $s_t$ and $y_{t-1}$ ($`r STAT.y_choice_by_STP$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[6,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[6,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[6,4]`$). 
Relative to placebo, S-ketamine caused a shift of $y_t$ toward $s_t$ ($`r -STAT.y_choice_by_STP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[5,4]`$), with no significant effect on $y_{t-1}$ ($`r -STAT.y_choice_by_STP$coefficients[7,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[7,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[7,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[7,4]`$). 
We found no significant three-way-interaction (drug x $s_t$ x $y_{t-1}$, $`r -STAT.y_choice_by_STP$coefficients[8,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[8,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[8,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[8,4]`$).

**B.** This panel shows the data from panel (A) separately for times $t$ where the HMM identified the mode of perceptual inference as external (left panels) or internal (right panels). When the mode of perceptual processing was added to the prediction of $y_t$ from $s_t$ and $y_{t-1}$, the effect S-ketamine (red) vs. placebo (blue) on $s_t$ disappeared ($`r STAT.y_choice_by_STPM$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_STPM$coefficients[6,2]`$, z = $`r STAT.y_choice_by_STPM$coefficients[6,3]`$, p = $`r STAT.y_choice_by_STPM$coefficients[6,4]`$). Instead, changes in the balance between $s_t$ and $y_{t-1}$ were loaded onto fluctuations between external and internal mode, which caused perception to shift away from external inputs $s_t$ ($`r STAT.y_choice_by_STPM$coefficients[9,1]`$ ± $`r  STAT.y_choice_by_STPM$coefficients[9,2]`$, z = $`r STAT.y_choice_by_STPM$coefficients[9,3]`$, p = $`r STAT.y_choice_by_STPM$coefficients[9,4]`$) and toward previous experiences $y{t-1}$ ($`r STAT.y_choice_by_STPM$coefficients[11,1]`$ ± $`r  STAT.y_choice_by_STPM$coefficients[11,2]`$, z = $`r STAT.y_choice_by_STPM$coefficients[11,3]`$, p = $`r STAT.y_choice_by_STPM$coefficients[11,4]`$). 

**C.** Here, we plot the weights from the GLM $y_t = \beta_S \times s_t + \beta_P \times y_{t-1} + \beta_B \times 1$, alongside the balance between external inputs and previous experiences $\Delta_{S-P} = \beta_S - \beta_P$ during external and internal mode. Colors indicate S-ketamine (red) and placebo (blue). $\beta_S$, the weight associated with the external input $s_t$, was positive in external mode, but reduced to zero in internal mode ($`r STAT.Stimulus_by_MI$coefficients[2,1]`$ ± $`r  STAT.Stimulus_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_by_MI$coefficients[2,3]`$) = $`r STAT.Stimulus_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_by_MI$coefficients[2,5]`$). 
We found no additional effect of S-ketamine (red) versus placebo (blue; $`r STAT.Stimulus_by_MI$coefficients[3,1]`$ ± $`r  STAT.Stimulus_by_MI$coefficients[3,2]`$, T($`r STAT.Stimulus_by_MI$coefficients[3,3]`$) = $`r STAT.Stimulus_by_MI$coefficients[3,4]`$, p = $`r STAT.Stimulus_by_MI$coefficients[3,5]`$) 
and no significant interaction ($`r STAT.Stimulus_by_MI$coefficients[4,1]`$ ± $`r  STAT.Stimulus_by_MI$coefficients[4,2]`$, T($`r STAT.Stimulus_by_MI$coefficients[4,3]`$) = $`r STAT.Stimulus_by_MI$coefficients[4,4]`$, p = $`r STAT.Stimulus_by_MI$coefficients[4,5]`$).
$\beta_B$, the weight associated with the constant response bias $b$ toward rightward rotation, was not different from zero ($\beta_B$ = $`r STAT.Bias_by_MI$coefficients[1,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[1,2]`$, T($`r STAT.Bias_by_MI$coefficients[1,3]`$) = $`r STAT.Bias_by_MI$coefficients[1,4]`$, p = $`r STAT.Bias_by_MI$coefficients[1,5]`$). 
We found no effect of drug ($`r STAT.Bias_by_MI$coefficients[3,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[3,2]`$, T($`r STAT.Bias_by_MI$coefficients[3,3]`$) = $`r STAT.Bias_by_MI$coefficients[3,4]`$, p = $`r STAT.Bias_by_MI$coefficients[3,5]`$) 
or mode ($`r STAT.Bias_by_MI$coefficients[2,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[2,2]`$, T($`r STAT.Bias_by_MI$coefficients[2,3]`$) = $`r STAT.Bias_by_MI$coefficients[2,4]`$, p = $`r STAT.Bias_by_MI$coefficients[2,5]`$) on the bias weight $\beta_B$. 
$\beta_P$, the weight associated with the previous percept $y_{t-1}$ was not modulated by S-ketamine ($`r STAT.PS_by_MI$coefficients[3,1]`$ ± $`r  STAT.PS_by_MI$coefficients[3,2]`$, T($`r STAT.PS_by_MI$coefficients[3,3]`$) = $`r STAT.PS_by_MI$coefficients[3,4]`$, p = $`r STAT.PS_by_MI$coefficients[3,5]`$) or mode ($`r STAT.PS_by_MI$coefficients[2,1]`$ ± $`r  STAT.PS_by_MI$coefficients[2,2]`$, T($`r STAT.PS_by_MI$coefficients[2,3]`$) = $`r STAT.PS_by_MI$coefficients[2,4]`$, p = $`r STAT.PS_by_MI$coefficients[2,5]`$). 
There was no significant interaction between drug and mode with respect to $\beta_P$ ($`r STAT.PS_by_MI$coefficients[4,1]`$ ± $`r  STAT.PS_by_MI$coefficients[4,2]`$, T($`r STAT.PS_by_MI$coefficients[4,3]`$) = $`r STAT.PS_by_MI$coefficients[4,4]`$, p = $`r STAT.PS_by_MI$coefficients[4,5]`$).
The balance $\Delta_{S-P}$ between external inputs and internal predictions was determined by mode ($`r -STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), with no significant effect of S-ketamine ($`r -STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[3,5]`$) and no interaction ($`r -STAT.Stimulus_PS_by_MI$coefficients[4,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[4,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[4,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[4,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[4,5]`$).

<!-- \newpage -->
<!-- ## Supplemental Figure S3 -->

```{r Supplemental_Figure_SX0}
dodge_width = 0.5

Variables = c("Stability")

p_main_stab_conf <- ggplot() + geom_jitter(data = Summary_Data_no_mode_con_long[Summary_Data_no_mode_con_long$Intervention != "None" & Summary_Data_no_mode_con_long$Variable %in% Variables,],
  aes(
  x = as.factor(uDisambiguation),
  y = value,
  color = Intervention
  ), alpha = 0.25, size = 0.25, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = 0.25
  ) + 
  geom_errorbar(
    data = Group_Summary_Data_no_mode_con_long[Group_Summary_Data_no_mode_con_long$Intervention != "None" & Group_Summary_Data_no_mode_con_long$Variable %in% Variables,],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Intervention
    ),
    width = dodge_width/2,
    position = position_dodge(width = dodge_width*2),
    size = 0.5
  ) +
  theme_classic(base_size = 6) + labs(
  x = "Session",
  y = "Value",
  subtitle = NULL,
  color = "Mouse"
  ) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "SAR",  y = paste("Stability", sep = " "), subtitle = NULL, color = "Intervention") + facet_wrap(~ cond_Accuracy, ncol = 3, scales = "free") + theme(panel.spacing=unit(1,"lines"))


#p_main_stab_conf

```

<!-- **Supplemental Figure S3. The effects of S-ketamine on perceptual stability.** -->

<!-- Due to the competition between the stabilizing internal prediction $y_{t-1}$ and the sensory input $s_t$, perceptual stability P($y(t) = y_{t-1}$) was reduced at higher levels of SAR ($`r STAT.stability_by_TDC$coefficients[2,1]`$ ± $`r  STAT.stability_by_TDC$coefficients[2,2]`$, z = $`r STAT.stability_by_TDC$coefficients[2,3]`$, p = $`r STAT.stability_by_TDC$coefficients[2,4]`$). The negative effect of SAR on perceptual stability was larger for stimulus-incongruent states ($`r -STAT.stability_by_TDC$coefficients[6,1]`$ ± $`r  STAT.stability_by_TDC$coefficients[6,2]`$, z = $`r -STAT.stability_by_TDC$coefficients[6,3]`$, p = $`r STAT.stability_by_TDC$coefficients[6,4]`$). Numerically, S-ketamine decreased the stability of stimulus-incongruent states P($y(t) \neq s(t)$), and increased the stability of stimulus-congruent states P($y(t) = s(t)$). However, linear mixed effects modeling indicated no significant main effect of S-ketamine on perceptual stability, no interaction of S-ketamine with stimulus-congruence or SAR, and no three-way interaction.  -->

\newpage
## Supplemental Figure S3

```{r Supplemental_Figure_S3, fig.height = 7}

# alpha_sd = 0.45
# alpha_gd = 0.65
# dot_size_sd = 0.5
# line_size_sd = dot_size_sd/20
# dot_size_gd = 4 * dot_size_sd
# line_size_gd = 2 * dot_size_sd

##
## Psychometric function
##
dodge_width = 0.05
stretch = 0.5
Variables = c("y_choice")

p_s_intervention_ps <-
  ggplot() + geom_point(
    data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "A",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_s_intervention_mode_ps <-
  ggplot() + geom_point(
    data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus^stretch),
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) +  geom_line(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "B",
    color = "Group",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)


##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus", "Bias", "PS", "Stimulus-PS")
p_s_mode_parameters <-
  ggplot() + geom_jitter(
    data = S_P_Data_long[S_P_Data_long$Variable %in% Variables & S_P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_P_Data_long[Group_S_P_Data_long$Variable %in% Variables & Group_S_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "C") + facet_wrap( ~ Variable, ncol = length(Variables))



lay <- rbind(c(1,2), c(3))
grid.arrange(
  p_s_intervention_ps,
  p_s_intervention_mode_ps,
  p_s_mode_parameters,
  layout_matrix = lay,
  heights = c(2.25,1),
  widths = c(1,1)
)

# which(STAT.y_choice_by_SGPM$coefficients[,4] * nrow(STAT.y_choice_by_SGPM$coefficients) < 0.05)
```

**Supplemental Figure S3. Extended data on external and internal mode in Scz patients and healthy controls (related to Figure 2E-H).**

**A.** Here, we show psychometric curves (percept $y_t$ versus input $s_t$) in patients (red) and controls (blue). The plot separates times $t$ for which the previous experience was leftward rotation ($y_{t-1} = -1$, upper panel) and rightward rotation ($y_{t-1} = +1$, lower panel). Perception was driven by $s_t$ ($\beta_S$ = $`r STAT.y_choice_by_SGP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[2,4]`$) and $y_{t-1}$ ($\beta_{P}$ = $`r STAT.y_choice_by_SGP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[4,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[4,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[4,4]`$), with no significant interaction between $s_t$ and $y_{t-1}$ ($`r STAT.y_choice_by_SGP$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[6,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[6,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[6,4]`$). Patients were more sensitive to $s_t$ ($`r -STAT.y_choice_by_SGP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[5,4]`$). We found no significant three-way-interaction (group x $s_t$ x $y_{t-1}$, $`r -STAT.y_choice_by_SGP$coefficients[8,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[8,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[8,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[8,4]`$).

**B.** This panel shows the data from panel (A) separately for times $t$ where the HMM identified the mode of perceptual inference as external (left panels) or internal (right panels). When the mode of perceptual processing was added to the prediction of $y_t$ from $s_t$ and $y_{t-1}$, the difference between patients (red) and controls (blue) in the effect of $s_t$ on $y_t$ disappeared ($`r STAT.y_choice_by_SGPM$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_SGPM$coefficients[6,2]`$, z = $`r STAT.y_choice_by_SGPM$coefficients[6,3]`$, p = $`r STAT.y_choice_by_SGPM$coefficients[6,4]`$). Instead, changes in the balance between $s_t$ and $y_{t-1}$ were loaded onto fluctuations between external and internal mode, which caused perception to shift away from external inputs $s_t$ ($`r STAT.y_choice_by_SGPM$coefficients[9,1]`$ ± $`r  STAT.y_choice_by_SGPM$coefficients[9,2]`$, z = $`r STAT.y_choice_by_SGPM$coefficients[9,3]`$, p = $`r STAT.y_choice_by_SGPM$coefficients[9,4]`$) and toward previous experiences $y{t-1}$ ($`r STAT.y_choice_by_SGPM$coefficients[11,1]`$ ± $`r  STAT.y_choice_by_SGPM$coefficients[11,2]`$, z = $`r STAT.y_choice_by_SGPM$coefficients[11,3]`$, p = $`r STAT.y_choice_by_SGPM$coefficients[11,4]`$). 

**C.** Here, we plot the weights from the GLM $y_t = \beta_S \times s_t + \beta_P \times y_{t-1} + \beta_B \times 1$, alongside the balance between external inputs and previous experiences $\Delta_{S-P} = \beta_S - \beta_P$ during external and internal mode. Colors indicate the group (patients in red, controls in blue). $\beta_S$, the weight associated with the external input $s_t$, was positive in external mode, but reduced to zero in internal mode ($`r S_STAT.Stimulus_by_MI$coefficients[2,1]`$ ± $`r  S_STAT.Stimulus_by_MI$coefficients[2,2]`$, T($`r S_STAT.Stimulus_by_MI$coefficients[2,3]`$) = $`r S_STAT.Stimulus_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_by_MI$coefficients[2,5]`$). 
We found no additional effect of group ($`r S_STAT.Stimulus_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.Stimulus_by_MI$coefficients[3,2]`$, T($`r S_STAT.Stimulus_by_MI$coefficients[3,3]`$) = $`r S_STAT.Stimulus_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Stimulus_by_MI$coefficients[3,5]`$) 
and no significant interaction ($`r S_STAT.Stimulus_by_MI$coefficients[4,1]`$ ± $`r  S_STAT.Stimulus_by_MI$coefficients[4,2]`$, T($`r S_STAT.Stimulus_by_MI$coefficients[4,3]`$) = $`r S_STAT.Stimulus_by_MI$coefficients[4,4]`$, p = $`r S_STAT.Stimulus_by_MI$coefficients[4,5]`$).
$\beta_B$, the weight associated with the constant response bias $b$ toward rightward rotation, was not different from zero ($`r S_STAT.Bias_by_MI$coefficients[1,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[1,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[1,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[1,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[1,5]`$). 
We found no effect of group ($`r S_STAT.Bias_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[3,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[3,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[3,5]`$). 
There was a trend for a positive effect of internal mode ($`r S_STAT.Bias_by_MI$coefficients[2,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[2,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[2,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[2,5]`$) on the bias weight $\beta_B$. 
$\beta_P$, the weight associated with the previous percept $y_{t-1}$, was reduced in internal mode ($`r S_STAT.PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.PS_by_MI$coefficients[2,2]`$, T($`r S_STAT.PS_by_MI$coefficients[2,3]`$) = $`r S_STAT.PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.PS_by_MI$coefficients[2,5]`$), but not modulated by group ($`r S_STAT.PS_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.PS_by_MI$coefficients[3,3]`$) = $`r S_STAT.PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.PS_by_MI$coefficients[3,5]`$).
There was no significant interaction between group and mode with respect to $\beta_P$ ($`r S_STAT.PS_by_MI$coefficients[4,1]`$ ± $`r  S_STAT.PS_by_MI$coefficients[4,2]`$, T($`r S_STAT.PS_by_MI$coefficients[4,3]`$) = $`r S_STAT.PS_by_MI$coefficients[4,4]`$, p = $`r STAT.PS_by_MI$coefficients[4,5]`$).
The balance $\Delta_{S-P}$ between external inputs and internal predictions was determined by mode ($`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), with no significant effect of group ($`r -S_STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,5]`$) and no interaction ($`r -S_STAT.Stimulus_PS_by_MI$coefficients[4,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[4,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[4,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[4,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[4,5]`$).

<!-- \newpage -->
<!-- ## Supplemental Figure SX -->
```{r Supplemental_Figure_SX1}
dodge_width = 0.5

Variables = c("Stability")

p_main_stab_conf <- ggplot() + geom_jitter(data = S_Summary_Data_no_mode_con_long[S_Summary_Data_no_mode_con_long$Variable %in% Variables,],
  aes(
  x = as.factor(uDisambiguation),
  y = value,
  color = Group
  ), alpha = 0.25, size = 0.25, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = 0.25
  ) + 
  geom_errorbar(
    data = Group_S_Summary_Data_no_mode_con_long[Group_S_Summary_Data_no_mode_con_long$Variable %in% Variables,],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Group
    ),
    width = dodge_width/2,
    position = position_dodge(width = dodge_width*2),
    size = 0.5
  ) +
  theme_classic(base_size = 6) + labs(
  x = "Session",
  y = "Value",
  subtitle = NULL,
  color = "Mouse"
  ) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "SAR",  y = paste("Stability", sep = " "), subtitle = NULL, color = "Intervention") + facet_wrap(~ cond_Accuracy, ncol = 3, scales = "free") + theme(panel.spacing=unit(1,"lines"))

#p_main_stab_conf

```

<!-- **Supplemental Figure SX. Perceptual stability in Scz patients and controls.** -->

<!-- Due to the competition between stabilizing internal predictions $y_{t-1}$ and sensory inputs $s_t$, perceptual stability P($y_t = y_{t-1}$) was reduced at higher levels of SAR ($`r STAT.stability_by_GDC$coefficients[2,1]`$ ± $`r  STAT.stability_by_GDC$coefficients[2,2]`$, z = $`r STAT.stability_by_GDC$coefficients[2,3]`$, p = $`r STAT.stability_by_GDC$coefficients[2,4]`$) and for stimulus-incongruent states ($`r STAT.stability_by_GDC$coefficients[4,1]`$ ± $`r  STAT.stability_by_GDC$coefficients[4,2]`$, z = $`r STAT.stability_by_GDC$coefficients[4,3]`$, p = $`r STAT.stability_by_GDC$coefficients[4,4]`$). Linear mixed effects modeling indicated no significant main effect of group on perceptual stability, no interaction of group with stimulus-congruence or SAR, and no three-way interaction.  -->

\newpage
## Supplemental Figure S4

```{r Supplemental_Figure_S4, fig.height = 6}

p_s_summary_RT <-
ggplot(S_Data,
aes(
x = RT,
y = as.factor(ID),
fill = Group
)) + geom_density_ridges(color = "white", scale = 4, alpha = 0.5) + theme_ridges(font_size = 10,
grid = FALSE,
center_axis_labels = TRUE) + xlim(-0.1, 3.34) + xlab("RT (sec)") + labs(x =
"RT (sec)",  y = "Participants", subtitle = "A") + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none", axis.text.y=element_blank())

dodge_width = 0.05
stretch = 0.5
Variables = c("RT")

p_s_intervention_ps_RT <-
  ggplot() + geom_point(
    data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 3.33),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_s_intervention_mode_ps_RT <-
  ggplot() + geom_point(
    data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus^stretch),
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 3.33),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) +  geom_line(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "right") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "C",
    color = "Group",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)

lay <- rbind(c(1,2,3),
             c(4,4,5))
grid.arrange(
p_s_summary_RT,
p_s_intervention_ps_RT,
p_s_intervention_mode_ps_RT,
layout_matrix = lay,
heights=c(1), widths=c(0.3,0.6, 1.2)
)

S_ks_test_data = S_Data$RT
S_ks_test_data = S_ks_test_data[!is.na(S_ks_test_data)]
S_STAT_uniform = ks.test(S_ks_test_data, "punif", min = min(S_ks_test_data), max = max(S_ks_test_data))
```

**Supplemental Figure S4. RT and bimodal inference in Scz patients and controls.**

**A.** RT were non-uniformly distributed across the inter-overlap interval (D = $`r S_STAT_uniform$statistic`$, p = $`r S_STAT_uniform$p.value`$, one-sample Kolmogorov-Smirnov test against uniformity) in patients (red) and controls (blue). This confirmed that changes in perception were aligned with the overlapping configurations of the stimulus.

**B.** RT did not differ between patients (red) and controls (blue; $`r STAT.RT_by_SGP$coefficients[4,1]`$ ± $`r STAT.RT_by_SGP$coefficients[4,2]`$, T($`r STAT.RT_by_SGP$coefficients[4,3]`$) = $`r STAT.RT_by_SGP$coefficients[4,4]`$, p = $`r STAT.RT_by_STP$coefficients[4,5]`$).
We found no quadratic relationship between RT and $s_t$ ($`r STAT.RT_by_SGP$coefficients[3,1]`$ ± $`r STAT.RT_by_SGP$coefficients[3,2]`$, T($`r STAT.RT_by_SGP$coefficients[3,3]`$) = $`r STAT.RT_by_SGP$coefficients[3,4]`$, p = $`r STAT.RT_by_SGP$coefficients[3,5]`$).

**C.** We found no effect of mode on RT ($`r STAT.RT_by_SGPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_SGPM$coefficients[6,2]`$, z = $`r STAT.RT_by_SGPM$coefficients[6,3]`$, p = $`r STAT.RT_by_SGPM$coefficients[6,4]`$).


\newpage
## Supplemental Figure S5

```{r Supplemental_Figure_S5, fig.height = 7}

dodge_width = 0.05
Variables = c("Q1","Q2","Q3")
p_dynamic_questionnaire_Q <-
ggplot() + geom_point(
data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ],
aes(
x = block_id,
y = Score,
color = Intervention,
fill = Intervention
),
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) +
geom_line(data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ], aes(
x = block_id,
y = Score,
group = interaction(ID, Intervention)
),
position = position_dodge(
width = dodge_width),
linetype = "18",
alpha = alpha_sd,
size = dot_size_sd/8) +
# geom_hline(
#   yintercept = c(0, 0.5, 1),
#   linetype = "dashed",
#   color = "black",
#   size = dot_size_sd
# ) +
geom_ribbon(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
ymin = mean - error,
ymax = mean + error,
x = (block_id),
fill = Intervention
),
size = line_size_gd,
alpha = alpha_gd/4
) +
geom_line(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
x = block_id,
color = Intervention
),
size = line_size_gd,
alpha = alpha_gd
) +  scale_x_discrete(name ="Block", limits=c(1,3,6,9)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
labs(
y = "Score",
subtitle = "A",
color = "Intervention",
) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines"))
Variables = c("CADSS")
p_dynamic_questionnaire_CADSS <-
ggplot() + geom_point(
data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ],
aes(
x = block_id,
y = Score,
color = Intervention,
fill = Intervention
),
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) +
geom_line(data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ], aes(
x = block_id,
y = Score,
group = interaction(ID, Intervention)
),
position = position_dodge(
width = dodge_width),
linetype = "18",
alpha = alpha_sd,
size = dot_size_sd/8) +
# geom_hline(
#   yintercept = c(0, 0.5, 1),
#   linetype = "dashed",
#   color = "black",
#   size = dot_size_sd
# ) +
geom_ribbon(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
ymin = mean - error,
ymax = mean + error,
x = (block_id),
fill = Intervention
),
size = line_size_gd,
alpha = alpha_gd/4
) +
geom_line(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
x = block_id,
color = Intervention
),
size = line_size_gd,
alpha = alpha_gd
) +  scale_x_discrete(name ="Block", limits=c(1,3,6,9)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
y = "Score",
subtitle = " ",
color = "Intervention",
) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines"))

Dyn_Quest$Mode = NA
Dyn_Quest$Mode[Dyn_Quest$external >= 0.5] = "external"
Dyn_Quest$Mode[Dyn_Quest$external < 0.5] = "internal"

Summary_Quest_mode_global <-
    ddply(
      Dyn_Quest[!is.na(Dyn_Quest$Intervention) & Dyn_Quest$Intervention != "None",],
      .(Intervention, Mode, ID),
      summarise,
      CADSS = mean(CADSS, na.rm = TRUE)
    )

Group_Summary_Quest_mode_global <- 
   ddply(
      Summary_Quest_mode_global,
      .(Intervention, Mode),
      summarise,
      mean = mean(CADSS, na.rm = TRUE),
      error = sd(CADSS, na.rm = TRUE)/sqrt(length(CADSS))
    )

p_gobal_CADSS <-
  ggplot() + geom_jitter(
    data = Summary_Quest_mode_global,
    aes(x = Mode,
        y = CADSS,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Quest_mode_global,
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width*2
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Mode",
    y = "CADSS",
    subtitle = "B",
    color = "Intervention"
  ) + facet_wrap(~Intervention)

p_ABZ <- ggplot(Summary_Mode, aes(x = ABZ, y=..density.., fill = Intervention))+ geom_density(alpha = alpha_gd/2, bw = 2, scale = 4, color = "white") +
labs(x="5D-ASC",  y="Density", subtitle = "C") + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none")
p_dynamic_questionnaire_corr <-
ggplot(data = Summary_Mode_corr_long,
aes(
x = Score,
y = external,
color = Intervention,
fill = Intervention
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
y = "external",
subtitle = "D",
color = "Intervention",
) + facet_wrap( ~ Variable, scales = "free") + ylim(0,1) + theme(panel.spacing = unit(1, "lines"))
gathercol <- colnames(S_Summary_Mode[,c(11:14)])
S_Summary_Mode_corr_long <- gather(S_Summary_Mode[,c(1,2,3,11:14)], "Variable", "Score", gathercol, factor_key = TRUE)
p_s_dynamic_questionnaire_corr <-
ggplot(data = S_Summary_Mode_corr_long,
aes(
x = Score,
y = external,
color = Group,
fill = Group
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
labs(
y = "external",
subtitle = "F",
color = "Group",
) + facet_wrap( ~ Variable, scales = "free", nrow = 1) + ylim(0,1) + theme(panel.spacing = unit(1, "lines"))
p_Threshold_corr <-
ggplot(data = Summary_Mode,
aes(
x = Threshold/100,
y = external,
color = Intervention,
fill = Intervention
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) + xlim(0, 0.015) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
y = "P(E)",
x = "Threshold (°)",
subtitle = "E",
color = "Intervention",
)
p_s_Threshold_corr <-
ggplot(data = S_Summary_Mode,
aes(
x = Threshold/100,
y = external,
color = Group,
fill = Group
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) + xlim(0, 0.015) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
x = "Threshold (°)",
y = "P(E)",
subtitle = "G",
color = "Group",
)
lay <- rbind(c(1,1,1,2,2,8), c(4,3,3,3,3,5), c(6,6,6,6,6,7))
grid.arrange(
p_dynamic_questionnaire_Q,
p_dynamic_questionnaire_CADSS,
p_dynamic_questionnaire_corr,
p_ABZ,
p_Threshold_corr,
p_s_dynamic_questionnaire_corr,
p_s_Threshold_corr,
p_gobal_CADSS,
layout_matrix = lay,
heights = c(1,0.75, 0.75),
widths = c(0.25,0.25,0.25,0.125, 0.125, 0.35)
)
```

**Supplemental Figure S5. Scores and Questionnaires.**

**A.** Responses to Q1 (*How awake do you feel?*) indicated that participants felt more tired under S-ketamine (red) than placebo (blue; $`r -STAT.Q1_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.Q1_Time_Intervention$coefficients[3,2]`$, z = $`r -STAT.Q1_Time_Intervention$coefficients[3,3]`$, p = $`r STAT.Q1_Time_Intervention$coefficients[3,4]`$), with no significant effect of time or a between-factor interaction. Responses to Q2 (*How intoxicated do you feel?*) indicated that participants felt more intoxicated under S-ketamine ($`r -STAT.Q2_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.Q2_Time_Intervention$coefficients[3,2]`$, z = $`r -STAT.Q2_Time_Intervention$coefficients[3,3]`$, p = $`r STAT.Q2_Time_Intervention$coefficients[3,4]`$), with no significant effect of time or a between-factor interaction. Responses to Q3 (*How nervous do you feel?*) revealed no effect of S-ketamine ($`r -STAT.Q3_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.Q3_Time_Intervention$coefficients[3,2]`$, z = $`r -STAT.Q3_Time_Intervention$coefficients[3,3]`$, p = $`r STAT.Q3_Time_Intervention$coefficients[3,4]`$), time, nor a significant between-factor interaction. CADSS scores were elevated under S-ketamine ($`r -STAT.CADSS_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.CADSS_Time_Intervention$coefficients[3,2]`$, T($`r STAT.CADSS_Time_Intervention$coefficients[3,3]`$) = $`r -STAT.CADSS_Time_Intervention$coefficients[3,4]`$, p = $`r STAT.CADSS_Time_Intervention$coefficients[3,5]`$) 
with a borderline trend for an increase over time ($`r STAT.CADSS_Time_Intervention$coefficients[2,1]`$ ± $`r  STAT.CADSS_Time_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Time_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Time_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Time_Intervention$coefficients[2,5]`$) and no significant between-factor interaction.

**B.** Q1-3 and CADSS scores were collected after blocks 1, 3, 6 and 9. To assess how the mode of perceptual inference was linked to dissociative symptoms, we separated the participants ratings according to the mode that dominated perception at the very end of the preceding block. While controlling the effect of S-ketamine (red) vs placebo (blue), we found that external mode increased dissociative symptoms ($`r STAT.CADSS_Mode_Intervention$coefficients[2,1]`$ ± $`r STAT.CADSS_Mode_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Mode_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Mode_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Mode_Intervention$coefficients[2,5]`$), but had no effect on wakefulness (Q1), subjective intoxication (Q2) or nervousness (Q3).

**C.** 5-ASC scores were elevated under S-ketamine (red) relative to placebo (blue; $`r -STAT.ABZ_Intervention$coefficients[2,1]`$ ± $`r  STAT.ABZ_Intervention$coefficients[2,2]`$, T($`r STAT.ABZ_Intervention$coefficients[2,3]`$) = $`r -STAT.ABZ_Intervention$coefficients[2,4]`$, p = $`r STAT.ABZ_Intervention$coefficients[2,5]`$).

**D.** Neither PDI, CAPS, nor 5-ASC scores were predictive of the probability of external mode (shown separately for S-ketamine in red and placebo in blue).

**E.** Stereodisparity thresholds were not predictive of the probability of external mode ($`r STAT.Threshold_to_Mode$coefficients[2,1]`$ ± $`r  STAT.Threshold_to_Mode$coefficients[2,2]`$, z = $`r STAT.Threshold_to_Mode$coefficients[2,3]`$, p = $`r STAT.Threshold_to_Mode$coefficients[2,4]`$). Thresholds did not differ between S-ketamine (red) and placebo (blue; W = $`r STAT.Mode_Threshold$statistic`$, p = $`r STAT.Mode_Threshold$p.value`$).

**F.** Neither PDI, CAPS (patients in red and controls in blue), nor the PANSS items P1 (delusions) or P3 (hallucinations, patients only) predicted the probability of external mode.

**G.** In patients (red) and controls (blue), stereodisparity thresholds were not predictive of the probability of external mode ($`r S_STAT.Threshold_to_Mode$coefficients[2,1]`$ ± $`r  S_STAT.Threshold_to_Mode$coefficients[2,2]`$, z = $`r S_STAT.Threshold_to_Mode$coefficients[2,3]`$, p = $`r S_STAT.Threshold_to_Mode$coefficients[2,4]`$). Thresholds did not differ between groups (V = $`r S_STAT.Threshold$statistic`$, p = $`r S_STAT.Threshold$p.value`$).

\newpage
## Supplemental Table S1

| RESOURCE                                   | SOURCE                                            | IDENTIFIER                |
| ---------------------------------- | ------------------------------------------------- | ------------------------- |
| **Deposited data & code**                         |
| Analyzed data & custom code        | https://github.com/veithweilnhammer/Ketamin_RDK/                                       | N/A    |
| **Software**                       |
| **Matlab**                                 | https://www.mathworks.com/                        | RRID:SCR_001622           |
| Psychtoolbox 3                             | http://psychtoolbox.org/                            | RRID:SCR_002881           |
| **R**                                      | http://www.r-project.org/                         | RRID:SCR_001905           |
| RStudio                                    | https://www.rstudio.com/                          | RRID:SCR_000432           |
| lme4, afex, statConfR, ggplot2, ggridges, gridExtra, tidyr, plyr, readxl | http://cran.r-project.org/          | RRID:SCR_003005            |
| **Python 3**                               | http://www.python.org/                            | RRID:SCR_008394           |
| Jupyter Notebook                           | https://jupyter.org/                              | RRID:SCR_018315           |
| numpy                                      | http://www.numpy.org                              | RRID:SCR_008633           |
| pandas                                     | https://pandas.pydata.org                         | RRID:SCR_018214           |
| SSM                                        | https://github.com/lindermanlab/ssm               | N/A           |

**Supplemental Table S1. Key resources.**

\newpage
## Supplemental Table S2

| Scale  |      Scope |      Condition      |  mean ± s.e.m. |
|:---------|:-----------------------|:---------|:----------
| **PDI**[@Peters1999] | Delusion proneness  | Global | `r mean(Logbook_final$PDI, na.rm = TRUE)` ± `r sd(Logbook_final$PDI, na.rm = TRUE)/sqrt(length(Logbook_final$PDI))` |
| **CAPS**[@Bell2006] | Hallucination proneness  | Global | `r mean(Logbook_final$CAPS, na.rm = TRUE)` ± `r sd(Logbook_final$CAPS, na.rm = TRUE)/sqrt(length(Logbook_final$CAPS))` |
| **BPRS**[@overall_brief_1962] | Screen for psychotic illness   | Global | `r mean(Logbook_final$BPRS, na.rm = TRUE)` ± `r sd(Logbook_final$BPRS, na.rm = TRUE)/sqrt(length(Logbook_final$BPRS))` |
| **5D-ASC**[@dittrich_5d-abz_1999] | Altered states of consciousness | S-ketamine | `r mean(Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"]))`  |
|  | |Placebo | `r mean(Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"]))`  |
| **CADSS**[@mertens_clinician-administered_2022] | Dissociation | S-ketamine | `r mean(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Q1** | Wakefulness | S-ketamine | `r mean(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Q2** | Intoxication | S-ketamine | `r mean(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Q3** |Nervousness | S-ketamine | `r mean(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Stereovision** | Disparity thresholds | S-ketamine | `r mean(Summary_Mode$Threshold[Summary_Mode$Intervention == "Ketamine"]/100, na.rm = TRUE)` ± `r sd(Summary_Mode$Threshold[Summary_Mode$Intervention == "Ketamine"]/100, na.rm = TRUE)/sqrt(length(Summary_Mode$Threshold[Summary_Mode$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Summary_Mode$Threshold[Summary_Mode$Intervention == "Placebo"]/100, na.rm = TRUE)` ± `r sd(Summary_Mode$Threshold[Summary_Mode$Intervention == "Placebo"]/100, na.rm = TRUE)/sqrt(length(Summary_Mode$Threshold[Summary_Mode$Intervention == "Placebo"]))` |

**Supplemental Table S2. Psychometric data for the S-ketamine experiment.**

\newpage
## Supplemental Table S3

| Scale  |      Scope |      Condition      |  mean ± s.e.m. |
|:---------|:-----------------------|:---------|:----------
| **PDI**[@Peters1999] | Delusion proneness  | Patients | `r mean(Quest$PDI[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$PDI[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$PDI[Quest$group == 1]))` |
| |   | Controls | `r mean(Quest$PDI[Quest$group == 0], na.rm = TRUE)` ± `r sd(Quest$PDI[Quest$group == 0], na.rm = TRUE)/sqrt(length(Quest$PDI[Quest$group == 0]))` |
| **CAPS**[@Bell2006]  |  Hallucination proneness  | Patients | `r mean(Quest$CAPS[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$CAPS[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$CAPS[Quest$group == 1]))` |
| |   | Controls | `r mean(Quest$CAPS[Quest$group == 0], na.rm = TRUE)` ± `r sd(Quest$CAPS[Quest$group == 0], na.rm = TRUE)/sqrt(length(Quest$CAPS[Quest$group == 0]))` |
| **P1** | Delusions | Patients | `r mean(Quest$P1[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$P1[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$P1[Quest$group == 1]))` |
| **P3** | Delusions | Patients | `r mean(Quest$P3[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$P3[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$P3[Quest$group == 1]))` |
| **Stereovision** | Disparity thresholds | Patients | `r mean(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Patients"]/100, na.rm = TRUE)` ± `r sd(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Patients"]/100, na.rm = TRUE)/sqrt(length(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Patients"]))` |
|  |  | Controls | `r mean(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Controls"]/100, na.rm = TRUE)` ± `r sd(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Controls"]/100, na.rm = TRUE)/sqrt(length(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Controls"]))` |

**Supplemental Table S3. Psychometric data for Scz-control-study.**

\newpage
# References