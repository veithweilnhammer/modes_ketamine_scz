---
bibliography: References/library.bib
csl: References/nature.csl
header-includes:
- \usepackage{setspace}\linespread{1.25}
- \usepackage[fontsize=12pt]{scrextend}
- \usepackage[left]{lineno}
- \usepackage[labelformat=empty]{caption}
- \usepackage{longtable}
- \usepackage{booktabs}
always_allow_html: yes
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
  html_document:
    fig_caption: yes
    force_captions: yes
    highlight: pygments
    number_sections: yes
    theme: cerulean
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      cache = TRUE)

options(scipen = -1, digits = 2)

library(lme4)
library(afex)
library(ppcor)
library(statConfR)
library(optimx)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(effects)
library(quickpsy)
library(pracma)
library(corrplot)
library(Hmisc)

library(ggplot2)
library(ggridges)
library(ggExtra)
library(gridExtra)
library(ggpubr)
#library(kableExtra)

library(tidyr)
library(plyr)

library(e1071)
library(readxl)
source("./Functions/helper_functions.R", local = knitr::knit_global())

# smallest_value = .Machine$double.xmin
# replace p = \(0\) with p < \(\ensuremath{2.2\times 10^{-308}}\)


# if (!load_summary_data) {
# 
# 
# 
#   if (save_summary_data) {
#     save(x,  file = "./Summary_Data/x.Rdata")
#   }
# 
# } else {
#   load("./Summary_Data/x.Rdata")
# }
```

```{r controller}
load_summary_data = TRUE
save_summary_data = FALSE
```

**N-Methyl-D-aspartate receptor hypofunction causes recurrent and transient failures of perceptual inference** \
\

<br/><br/>
**Authors**: 

Veith Weilnhammer$^{1,2, 3,ec}$, Marcus Rothkirch$^{1, 4, ec}$, Deniz Yilmaz$^{1,5,6,7, ec}$, Merve Fritsch$^{1}$, Lena Esther Ptasczynski$^{1,5}$, Katrin Reichenbach$^{1}$, Lukas Rödiger$^{1}$, Philip Corlett$^{8}$, Philipp Sterzer$^{9}$\
\
<br/><br/>
**Affiliations**: 

$^{1}$ Department of Psychiatry, Charité-Universitätsmedizin Berlin, corporate member of Freie Universität Berlin and Humboldt-Universität zu Berlin, Germany \
$^{2}$ Berlin Institute of Health, Charité-Universitätsmedizin Berlin and Max Delbrück Center, Germany \
$^{3}$ Helen Wills Neuroscience Institute, University of California Berkeley, USA\
$^{4}$ Medical School Berlin, Hochschule für Gesundheit und Medizin, Germany\
$^{5}$ Berlin School of Mind and Brain, Humboldt-Universität zu Berlin, Germany\
$^{6}$ Max Planck School of Cognition, Leipzig, Germany\
$^{7}$ Department of Psychiatry and Psychotherapy, LMU University Hospital, Munich, Germany\
$^{8}$ Department of Psychiatry, Yale University School of Medicine, New Haven, USA\
$^{9}$ Department of Psychiatry (UPK), University of Basel, Switzerland\
\
<br/><br/>
**Contributions**: 

$^{ec}$ Equal contribution\
\
<br/><br/>
**Corresponding Author**:

Veith Weilnhammer, Helen Wills Neuroscience Institute, University of California Berkeley, USA, email: veith.weilnhammer@gmail.com \

\newpage

\linenumbers

# Abstract

Perception integrates external sensory signals with internal predictions that reflect prior knowledge about the world. Previous research suggests that this integration is governed by slow alternations between an external mode, driven by sensory signals, and an internal mode, shaped by prior knowledge. Using a double-blind, placebo-controlled, cross-over experiment in healthy human participants, we investigated the effects of the N-Methyl-D-aspartate receptor (NMDAR) antagonist S-ketamine on the balance between external and internal modes. We found that S-ketamine causes a shift of perception toward the external mode. A case-control study revealed that individuals with paranoid Scz, a disorder repeatedly associated with NMDAR hypofunction, spend more time in the external mode. This NMDAR-dependent increase in the external mode suggests that the symptoms of schizophrenia are caused by recurring dissociations of perception from prior knowledge about the world.

# Introduction

Imagine a dimly lit room at a crowded party, where unclear visual signals, indistinct sounds, and complex social interactions allow for multiple - and sometimes false - interpretations. In such ambiguity, failures of perceptual inference, the ability to contextualize sensory inputs with prior knowledge about the world, can lead to profound departures from reality: Faces obscured in shadow may appear distorted, random noise could be perceived as a whisper, and friendly smiles might seem derogatory. 

According to the canonical predictive processing hypothesis[@Sterzer2018], a disruption of perceptual inference is likely to play a crucial role in schizophrenia (Scz), a severe mental disorder characterized by psychotic symptoms such as delusions and hallucinations[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. People with Scz may fail to apply prior knowledge to the interpretation of ambiguous sensory signals, causing erratic inferences that lead to hallucinatory experiences and delusional beliefs[@Sterzer2018]. Yet despite considerable progress in the computational understanding of psychosis, two key questions have remained unanswered. 

The first question concerns the neural mechanisms that cause perceptual inference to fail in Scz. Formal predictive processing accounts of Scz foreground the role of prediction errors in updating Bayesian beliefs about the causes of sensory input[@Friston2005]. Most accounts focus on a failure to predict or instantiate the precision afforded to prediction errors at various levels of the cortical hierarchy[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. Precision refers to the confidence ascribed to prediction errors, and regulates how prior expectations are updated in response to sensory information[@Friston2005]. Mathematically, precision is equivalent to the (Kalman) gain or the weighting of prediction errors in predictive processing models of perceptual inference[@Rao1999]. Psychologically, the deployment of sensory precision can be understood in terms of selective attention (or sensory attenuation)[@Friston2009a; @feldman_attention_2010]. Physiologically, precision corresponds to the postsynaptic gain or excitability of neuronal populations that report prediction errors, commonly mediated by N-Methyl-D-aspartate receptors[@moran_losing_2015; @muthukumaraswamy_evidence_2015; @powers_iii_ketamine-induced_2015; @ranlund_impaired_2016] (NMDARs).

Beyond predictive processing theory, several lines of evidence point to NMDAR hypofunction as a key factor in the pathophysiology of psychosis[@corlett_glutamatergic_2011]. NMDAR antibodies[@Stein2020] and antagonists such as ketamine[@murray_linking_2014] mimic the symptoms of Scz, which is itself associated with a reduction of NMDAR density in the prefrontal cortex[@catts_quantitative_2016]. In addition to their role in controlling the excitability of prediction error neurons[@moran_losing_2015; @muthukumaraswamy_evidence_2015; @powers_iii_ketamine-induced_2015; @ranlund_impaired_2016] and their general function for maintaining the cortical excitation-inhibition balance[@wang_nmda_2013], NMDARs play a critical role in cortical feedback[@self_different_2012], support synaptic short-term plasticity[@castro-alamancos_short-term_1996], and interact with neuromodulators such as dopamine and serotonin via GABAergic interneurons[@nakazawa_spatial_2017]. While these NMDAR-dependent mechanisms are likely critical for perceptual inference, it is yet to be determined how NMDAR hypofunction may cause the symptoms of Scz.

The second unresolved question concerns the temporal dynamics of psychotic experiences, which often unfold as short-lived events spanning from seconds to minutes, especially at early stages of Scz. The transient nature of psychotic experiences[@jardri_cortical_2011; @zmigrod_neural_2016; @gill_real-time_2022] challenges models that assume a constant disruption of perceptual inference[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. A solution to this problem is suggested by the recent observation that perceptual inference is subject to spontaneous fluctuations over time[@laquitaine_switching_2018; @roy_extracting_2021; @ashwood_mice_2022]. Such fluctuations have been related to two opposing modes of inference, or shifts in attentional sets, during which perception is driven predominantly either by external inputs (external mode) or by internal predictions that stem from recent experiences[@weilnhammer_sensory_2023] (internal mode, Figure 1A). Although preliminary evidence indicates a tendency toward the external mode in people with Scz[@albert_hierarchical_2017], the neural mechanisms of mode fluctuations and their potential implications for computational models of Scz have remained elusive.

The objective of the current study was therefore twofold: First, to test whether NMDAR hypofunction causes changes in perceptual inference that characterize Scz; and second, to explore the effect of NMDAR hypofunction on ongoing fluctuations in perceptual inference that may explain the transient nature of psychotic experiences. We addressed these questions in a double-blind, placebo-controlled, cross-over experiment with S-ketamine in healthy participants, and a case-control study that compared patients with paranoid Scz to matched healthy controls[@weilnhammer_psychotic_2020]. Participants engaged in a task designed to test how internal predictions derived from previous experiences modulate the perception of sensory signals that varied in ambiguity. We found that NMDAR antagonism and Scz were associated with a shift of perception toward the external mode, a minute-long state of the brain during which inference dissociates from prior knowledge. Our results suggest that NMDAR hypofunction shifts the balance between external and internal modes, and may thus contribute to the symptoms of Scz by causing transient and recurring failures of perceptual inference. 

```{r read_main_data}

#root_dir = "/home/veithweilnhammer/Public/Git/Ketamin_RDK/Results/"
#root_dir = "C:/Users/Veith Weilnhammer/Github/Ketamin_RDK/Results/"
root_dir = "/Users/veithweilnhammer/Github/modes_ketamine_scz/Results/"
##
## load and prepare behavior + hmm data
##
Data <- read.csv(paste(root_dir, "Ketamin_Behavior_Full_HMM_Sessions.csv", sep = ""))
u_Data <- read.csv(paste(root_dir, "Ketamin_Behavior_Full.csv", sep = ""))


Data$RT = NA
RTData <- read.csv(paste(root_dir, "Ketamin_Behavior_Full_RT.csv", sep = ""))
Data$RT = RTData[RTData$Confidence != -2,]$RT
Data$RT[is.nan(Data$RT)] = NA

Data$Q1 = NA
Data$Q2 = NA
Data$Q3 = NA
Data$CADSS = NA
QData <- read.csv(paste(root_dir, "Ketamin_Behavior_Full_Quest.csv", sep = ""))
Data$Q1 = QData[QData$Confidence != -2,]$Q1
Data$Q2 = QData[QData$Confidence != -2,]$Q2
Data$Q3 = QData[QData$Confidence != -2,]$Q3
Data$CADSS = QData[QData$Confidence != -2,]$CADSS
Data[Data == "NaN"] = NA

## 
## Intervention 
##
Data$Intervention = "None"

Placebo_first = c(13, 25, 19, 51, 27, 43, 17, 53, 59, 73, 71, 75, 1, 6, 41)
Verum_first = c(20, 26, 42, 76, 46, 66, 58, 28, 74, 78, 72, 85, 86)

Data[Data$session_id == 4 & Data$ID %in% Placebo_first,]$Intervention = "Placebo"
Data[Data$session_id == 5 & Data$ID %in% Placebo_first,]$Intervention = "Ketamine" 

Data[Data$session_id == 4 & Data$ID %in% Verum_first,]$Intervention = "Ketamine"
Data[Data$session_id == 5 & Data$ID %in% Verum_first,]$Intervention = "Placebo" 

Data$Intervention = factor(Data$Intervention, levels = c("Ketamine", "Placebo", "None"))

##
## Prepare Variables
##
## Data$Percept: 1 for rightward, -1 for leftward,-2 for unclear
## Data$Confidence: 1 for high confidence, -1 for low confidence, -2 for unclear

Data$Stimulus[Data$Stimulus == 0.5] = 0 ## Data$Stimulus: 1 for right, -1 for left, 0 for ambiguous
Data$Stimulus[Data$Disambiguation == 0] = 0

Data$Accuracy = Data$Percept == Data$Stimulus 
Data$Accuracy[Data$Stimulus == 0] = NA
Data$cond_Accuracy = Data$Accuracy
Data$cond_Accuracy[is.na(Data$cond_Accuracy)] = "ambiguous"
Data$cond_Accuracy[Data$cond_Accuracy == "FALSE"] = "stimulus-incongruent"
Data$cond_Accuracy[Data$cond_Accuracy == "TRUE"] = "stimulus-congruent"

Data$cond_Accuracy = factor(Data$cond_Accuracy, levels = c("ambiguous", "stimulus-incongruent", "stimulus-congruent"))

Data$w_Stimulus = Data$Stimulus * Data$Disambiguation ## weighted stimulus

Data$Stability = c(as.integer(diff(Data$Percept) == 0), NA) ## probability of survival of a specific percept
Data[Data$overlap_index == max(Data$overlap_index),]$Stability = NA

Data$uDisambiguation = Data$Disambiguation
Data$Disambiguation = Data$Disambiguation * 100

Data$Percept_minus_1 = c(NA, Data$Percept[1:nrow(Data)-1])
Data$Percept_minus_1[Data$overlap_index] = NA

##
## Define Modes
##
Data$Mode = "internal"
Data$Mode[Data$Session_Sl_Prob_State_ext > Data$Session_Sl_Prob_State_int] = "external"
Data$Mode = as.factor(Data$Mode)

Data$Mode_con = Data$Sl_Prob_State_ext - Data$Sl_Prob_State_int
Data$Mode_switch = c(NA, diff(sign(Data$Mode_con)) != 0)

##
## load HMM betas
##

##
## two-state-data
##
P_Data <- read.csv(paste(root_dir, "Ketamin_Behavior_Individual_Weights_HMM_Sessions.csv", sep = ""))
P_Data = data.frame(rbind(data.matrix(P_Data[, c(1:3, 11:12)]), data.matrix(P_Data[, c(4:6, 11:12)])))
colnames(P_Data) <- c('Stimulus','Bias','PS', 'ID', 'session_id')
P_Data$'Stimulus-PS' = P_Data$Stimulus-P_Data$PS
P_Data$Mode = c(rep("external", nrow(P_Data)/2), rep("internal", nrow(P_Data)/2))

P_Data$Intervention = "None"

P_Data[P_Data$session_id == 4 & P_Data$ID %in% Placebo_first,]$Intervention = "Placebo"
P_Data[P_Data$session_id == 5 & P_Data$ID %in% Placebo_first,]$Intervention = "Ketamine" 

P_Data[P_Data$session_id == 4 & P_Data$ID %in% Verum_first,]$Intervention = "Ketamine"
P_Data[P_Data$session_id == 5 & P_Data$ID %in% Verum_first,]$Intervention = "Placebo" 

P_Data$Intervention = factor(P_Data$Intervention, levels = c("Ketamine", "Placebo", "None"))

gathercol <- colnames(P_Data[, c(1:3,6)])
P_Data_long <- gather(P_Data, "Variable", "value", gathercol, factor_key = TRUE)

P_Data_long$num_states = 2

##
## one-state-data
##
P_Data_os <- read.csv(paste(root_dir, "Ketamin_Behavior_Individual_Weights_one_state_HMM_Sessions.csv", sep = ""))
colnames(P_Data_os) <- c('Stimulus','Bias','PS', 'ID', 'session_id')
P_Data_os$'Stimulus-PS' = P_Data_os$Stimulus-P_Data_os$PS
P_Data_os$Mode = NA

P_Data_os$Intervention = "None"

P_Data_os[P_Data_os$session_id == 4 & P_Data_os$ID %in% Placebo_first,]$Intervention = "Placebo"
P_Data_os[P_Data_os$session_id == 5 & P_Data_os$ID %in% Placebo_first,]$Intervention = "Ketamine" 

P_Data_os[P_Data_os$session_id == 4 & P_Data_os$ID %in% Verum_first,]$Intervention = "Ketamine"
P_Data_os[P_Data_os$session_id == 5 & P_Data_os$ID %in% Verum_first,]$Intervention = "Placebo" 

P_Data_os$Intervention = factor(P_Data_os$Intervention, levels = c("Ketamine", "Placebo", "None"))

gathercol <- colnames(P_Data_os[, c(1:3,6)])
P_Data_os_long <- gather(P_Data_os, "Variable", "value", gathercol, factor_key = TRUE)

P_Data_os_long$num_states = 1

P_Data_long = rbind(P_Data_long, P_Data_os_long)

Group_P_Data_long <-
    ddply(
      P_Data_long,
      .(Variable, Mode, Intervention, num_states),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

##
## HMM Model Comparison 
##
HMM_BIC = read.csv(paste(root_dir, "Ketamin_Behavior_Full_BIC_across_models.csv", sep = ""))
Stimulus_HMM_BIC = read.csv(paste(root_dir, "Ketamin_Behavior_Full_BIC_across_models_STIMULUS.csv", sep = ""))
```

```{r exclusion_criteria}
##
## Exclusion Criteria for unimodal analysis
##

## Performance
Summary_Accuracy_ID <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None",],
      .(Disambiguation, Intervention, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE)
    )

include <- unique(Summary_Accuracy_ID[Summary_Accuracy_ID$Disambiguation == 100 & Summary_Accuracy_ID$Accuracy >= 75,]$ID)
exclude <- unique(Summary_Accuracy_ID[Summary_Accuracy_ID$Disambiguation == 100 & Summary_Accuracy_ID$Accuracy < 75,]$ID)
Data$Include = 1
Data[Data$ID %in% exclude,]$Include = 0
```

```{r plot_controls}
alpha_sd = 0.35
alpha_gd = 0.75
dot_size_sd = 0.25
line_size_sd = dot_size_sd/20
dot_size_gd = 4 * dot_size_sd
line_size_gd = 2 * dot_size_sd
dodge_width = 0.0375
```

```{r choices_by_stimulus_ps_treatment_mode}
Summary_ID <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )
##
## choice ~ stimulus
##
Summary_Choice <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

gathercol <- colnames(Summary_Choice[, 4:ncol(Summary_Choice)])
Summary_Choice_long <- gather(Summary_Choice, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_long <-
    ddply(
      Summary_Choice_long,
      .(w_Stimulus, Intervention, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + Percept_minus_1
##
Summary_Choice_ps <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Choice_ps$Percept_minus_1 = (Summary_Choice_ps$Percept_minus_1 + 1)/2
Summary_Choice_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(Summary_Choice_ps$Percept_minus_1), sep = " ")

gathercol <- colnames(Summary_Choice_ps[, 5:ncol(Summary_Choice_ps)])
Summary_Choice_ps_long <- gather(Summary_Choice_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_ps_long <-
    ddply(
      Summary_Choice_ps_long,
      .(w_Stimulus, Intervention, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )
Group_Summary_Choice_ps_long$Mode = "unimodal"

##
## choice ~ stimulus + mode
##
Summary_Choice_mode <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, Mode, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

gathercol <- colnames(Summary_Choice_mode[, 5:ncol(Summary_Choice_mode)])
Summary_Choice_mode_long <- gather(Summary_Choice_mode, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_mode_long <-
    ddply(
      Summary_Choice_mode_long,
      .(w_Stimulus, Intervention, Mode, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )
##
## choice ~ stimulus + mode + ps
##
Summary_Choice_mode_ps <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(w_Stimulus, Intervention, Mode, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = mean(Confidence == 1, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Choice_mode_ps$Percept_minus_1 = (Summary_Choice_mode_ps$Percept_minus_1 + 1)/2
Summary_Choice_mode_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(Summary_Choice_mode_ps$Percept_minus_1), sep = " ")

gathercol <- colnames(Summary_Choice_mode_ps[, 6:ncol(Summary_Choice_mode_ps)])
Summary_Choice_mode_ps_long <- gather(Summary_Choice_mode_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_Summary_Choice_mode_ps_long <-
    ddply(
      Summary_Choice_mode_ps_long,
      .(w_Stimulus, Intervention, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )


Group_Summary_Choice_mode_ps_no_interv_long <-
    ddply(
      Summary_Choice_mode_ps_long,
      .(w_Stimulus, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## Global variables
##
Summary_Data_no_mode <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE),
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA

gathercol <- colnames(Summary_Data_no_mode[, 4:ncol(Summary_Data_no_mode)])
Summary_Data_no_mode_long <- gather(Summary_Data_no_mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_no_mode_long <-
    ddply(
      Summary_Data_no_mode_long,
      .(uDisambiguation, Intervention, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Summary_Data_no_mode_con <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, cond_Accuracy, ID),
      summarise,
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA

gathercol <- colnames(Summary_Data_no_mode_con[, 5:ncol(Summary_Data_no_mode_con)])
Summary_Data_no_mode_con_long <- gather(Summary_Data_no_mode_con, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_no_mode_con_long <-
    ddply(
      Summary_Data_no_mode_con_long,
      .(uDisambiguation, Intervention, cond_Accuracy, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Summary_Data <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, Mode, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE),
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data[Summary_Data == "NaN"] = NA
gathercol <- colnames(Summary_Data[, 5:ncol(Summary_Data)])
Summary_Data_long <- gather(Summary_Data, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_long <-
    ddply(
      Summary_Data_long,
      .(uDisambiguation, Intervention, Mode, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Summary_Data_con <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(uDisambiguation, Intervention, Mode, cond_Accuracy, ID),
      summarise,
      Stability = mean(Stability, na.rm = TRUE),
      Confidence = (sum(Confidence == 1)/length(Confidence)),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

Summary_Data_con[Summary_Data_con == "NaN"] = NA
gathercol <- colnames(Summary_Data_con[, 6:ncol(Summary_Data_con)])
Summary_Data_con_long <- gather(Summary_Data_con, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Data_con_long <-
    ddply(
      Summary_Data_con_long,
      .(uDisambiguation, Intervention, Mode, cond_Accuracy, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

Uncertainty <-
    ddply(
      RTData,
      .(ID),
      summarise,
      rate = sum(Confidence == -2)/length(Confidence))

##
## STATS
##
if (!load_summary_data) {

##
## no mode
##
accuracy_by_TD = glmer(Accuracy ~ uDisambiguation*Intervention + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.accuracy_by_TD = summary(accuracy_by_TD)

stability_by_TDC = glmer(Stability ~ uDisambiguation*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.stability_by_TDC = summary(stability_by_TDC)

stability_by_Ta = glmer(Stability ~ Intervention  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy == "ambiguous",], family = binomial)
STAT.stability_by_Ta = summary(stability_by_Ta)

high_conf_by_TDC = glmer((Confidence + 1)/2 ~ uDisambiguation*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.high_conf_by_TDC = summary(high_conf_by_TDC)

high_conf_by_Ta = glmer((Confidence + 1)/2 ~ Intervention  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy == "ambiguous",], family = binomial)
STAT.high_conf_by_Ta = summary(high_conf_by_Ta)

RT_by_TDC = lmer(log(RT) ~ uDisambiguation*Intervention*cond_Accuracy + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous",])
STAT.RT_by_TDC = summary(RT_by_TDC)

##
## mode
##
accuracy_by_TDM = glmer(Accuracy ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention + (1  | ID), data = Data[Data$Intervention != "None",], family = binomial)
STAT.accuracy_by_TDM = summary(accuracy_by_TDM)

stability_by_TDMC = glmer(Stability ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous" ,], family = binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
STAT.stability_by_TDMC = summary(stability_by_TDMC)

high_conf_by_TDMC = glmer((Confidence + 1)/2 ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous" ,], family = binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
STAT.high_conf_by_TDMC = summary(high_conf_by_TDMC)

RT_by_TDMC = glmer(log(RT) ~ uDisambiguation*Session_Sl_Prob_State_ext*Intervention*cond_Accuracy  + (1 | ID), data = Data[Data$Intervention != "None" & Data$cond_Accuracy != "ambiguous" ,], family = gaussian)
STAT.RT_by_TDMC = summary(RT_by_TDMC)

ProbS_by_T = glmer(Session_Sl_Prob_State_ext ~ Intervention + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial)
STAT.ProbS_by_T = summary(ProbS_by_T)

##
## Global
##

##
## Choices
##
y_choice_by_STP = glmer(y_choice ~ 1 + w_Stimulus * Intervention * Percept_minus_1 + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.y_choice_by_STP = summary(y_choice_by_STP)

y_choice_by_STPM = glmer(y_choice ~ 1 + w_Stimulus * Intervention * Percept_minus_1 * Mode + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.y_choice_by_STPM = summary(y_choice_by_STPM)

##
## RT
##
RT_by_STP = lmer(RT ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 + (1 | ID), data = Data[Data$Intervention != "None",])
STAT.RT_by_STP = summary(RT_by_STP)

RT_by_STPM = lmer(RT ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 * Mode + (1 | ID), data = Data[Data$Intervention != "None",])
STAT.RT_by_STPM = summary(RT_by_STPM)

##
## Confidence
##
y_conf_by_STP = glmer((Confidence + 1)/2 ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
STAT.y_conf_by_STP  = summary(y_conf_by_STP)

y_conf_by_STPM = glmer((Confidence + 1)/2 ~ 1 + poly(w_Stimulus,2) * Intervention * Percept_minus_1 * Mode + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
STAT.y_conf_by_STPM  = summary(y_conf_by_STPM)

  if (save_summary_data) {
    save(STAT.accuracy_by_TD, accuracy_by_TD, 
         STAT.stability_by_TDC, stability_by_TD, 
         STAT.high_conf_by_TDC, high_conf_by_TD, 
         STAT.RT_by_TDC, RT_by_TDC,
         STAT.accuracy_by_TDM, accuracy_by_TDM,
         STAT.stability_by_TDMC, stability_by_TDMC,
         STAT.high_conf_by_TDMC, high_conf_by_TDMC,
         STAT.RT_by_TDMC, RT_by_TDMC,
         STAT.ProbS_by_T, ProbS_by_T,
         STAT.stability_by_Ta, stability_by_Ta,
         STAT.high_conf_by_Ta, high_conf_by_Ta,
         STAT.y_choice_by_STP, y_choice_by_STP,
         STAT.y_choice_by_STPM, y_choice_by_STPM,
         STAT.RT_by_STP, RT_by_STP,
         STAT.RT_by_STPM, RT_by_STPM, 
         STAT.y_conf_by_STP, y_conf_by_STP, 
         STAT.y_conf_by_STPM, y_conf_by_STPM,
         file = "./Results/R_summary_ketamine_stats.Rdata")
  }
} else {
  load("./Results/R_summary_ketamine_stats.Rdata")
}
##
## Bonferroni
##
STAT.y_choice_by_STP = bonferroni(STAT.y_choice_by_STP)
STAT.y_choice_by_STPM = bonferroni(STAT.y_choice_by_STPM)

STAT.RT_by_STP = bonferroni(STAT.RT_by_STP)
STAT.RT_by_STPM = bonferroni(STAT.RT_by_STPM)

STAT.y_conf_by_STP = bonferroni(STAT.y_conf_by_STP)
STAT.y_conf_by_STPM = bonferroni(STAT.y_conf_by_STPM)

STAT.accuracy_by_TD = bonferroni(STAT.accuracy_by_TD)
STAT.stability_by_TDC = bonferroni(STAT.stability_by_TDC)
```

```{r mode_summary}
Summary_Mode  <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(Intervention, ID),
      summarise,
      external = mean(Session_Sl_Prob_State_ext, na.rm = TRUE),
      internal = mean(1-Session_Sl_Prob_State_ext, na.rm = TRUE),
      Mode_bool = (sum(Mode == "external", na.rm = TRUE)/length(Mode)),
      Mode_s = (sum(Mode_switch, na.rm = TRUE)/length(Mode)),
      EI = (sum(Mode_switch[Mode == "internal"] == 1, na.rm = TRUE)/length(Mode)),
      IE = (sum(Mode_switch[Mode == "external"] == 1, na.rm = TRUE)/length(Mode)),
      EE = (sum(Mode_switch[Mode == "external"] == 0, na.rm = TRUE)/length(Mode)),
      II = (sum(Mode_switch[Mode == "internal"] == 0, na.rm = TRUE)/length(Mode))
    )

gathercol <- colnames(Summary_Mode[, 3:ncol(Summary_Mode)])
Summary_Mode_long <- gather(Summary_Mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_Summary_Mode_long <-
    ddply(
      Summary_Mode_long,
      .(Variable, Intervention),
      summarise,
      mean = mean(value[is.finite(value)], na.rm = TRUE),
      error = sd(value[is.finite(value)], na.rm = TRUE)/sqrt(length(value[is.finite(value)]))
    )

EE = (Summary_Mode$EE[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$EE[Summary_Mode$Intervention == "Placebo"])
II =  (Summary_Mode$II[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$II[Summary_Mode$Intervention == "Placebo"])


if (!load_summary_data) {
  
EE = (Summary_Mode$EE[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$EE[Summary_Mode$Intervention == "Placebo"])
II =  (Summary_Mode$II[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$II[Summary_Mode$Intervention == "Placebo"])
EI = (Summary_Mode$EI[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$EI[Summary_Mode$Intervention == "Placebo"])
IE =  (Summary_Mode$IE[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$IE[Summary_Mode$Intervention == "Placebo"])

STAT.Mode_Intervention = wilcox.test(EE-II, alternative = "greater")
STAT.Mode_Intervention_2 = wilcox.test(IE-EI, alternative = "greater")

Mode_by_I = glmer(Session_Sl_Prob_State_ext ~ Intervention + (1 | ID), data = Data[Data$Intervention != "None",], family = binomial(link = logit))
STAT.Mode_by_I = summary(Mode_by_I)

Stimulus_by_MI = lmer(Stimulus ~ Mode*Intervention + (1  | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.Stimulus_by_MI = summary(Stimulus_by_MI)

Bias_by_MI = lmer(Bias ~ Mode*Intervention + (1  | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.Bias_by_MI = summary(Bias_by_MI)

PS_by_MI = lmer(PS ~ Mode*Intervention + (1  | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.PS_by_MI = summary(PS_by_MI)

Stimulus_PS_by_MI = lmer(Stimulus-PS ~ Mode*Intervention + (1 | ID), data = P_Data[P_Data$Intervention != "None",])
STAT.Stimulus_PS_by_MI = summary(Stimulus_PS_by_MI)


  if (save_summary_data) {
    save(STAT.Mode_Intervention,STAT.Mode_Intervention_2,
         STAT.Mode_by_I, Mode_by_I,
         STAT.Stimulus_by_MI, Stimulus_by_MI,
         STAT.Bias_by_MI, Bias_by_MI,
         STAT.PS_by_MI, PS_by_MI,
         STAT.Stimulus_PS_by_MI, Stimulus_PS_by_MI,
         file = "./Results/R_Summary_P_Modes.Rdata")
  }

} else {
  load("./Results/R_Summary_P_Modes.Rdata")
}

##
## Boneferroni
##
STAT.Mode_by_I = bonferroni(STAT.Mode_by_I)
STAT.Stimulus_by_MI = bonferroni(STAT.Stimulus_by_MI)
STAT.Bias_by_MI = bonferroni(STAT.Bias_by_MI)
STAT.PS_by_MI = bonferroni(STAT.PS_by_MI)
STAT.Stimulus_PS_by_MI = bonferroni(STAT.Stimulus_PS_by_MI)
```

```{r corr_mode_to_intervention}
difference_in_modes = Summary_Mode[Summary_Mode$Intervention == "Ketamine",]$external-Summary_Mode[Summary_Mode$Intervention == "Placebo",]$external
difference_in_os_betas = P_Data_long[P_Data_long$Intervention == "Ketamine" &
                                       P_Data_long$num_states == 1 &
                                       P_Data_long$Variable == "Stimulus-PS",]$value -
  P_Data_long[P_Data_long$Intervention == "Placebo" &
                P_Data_long$num_states == 1 &
                P_Data_long$Variable == "Stimulus-PS",]$value


difference_in_ts_betas = (P_Data_long[P_Data_long$Intervention == "Ketamine" &
                                        P_Data_long$num_states == 2 &
                                        P_Data_long$Variable == "Stimulus-PS" &
                                        P_Data_long$Mode == "external",]$value - P_Data_long[P_Data_long$Intervention == "Ketamine" &
                                                                                               P_Data_long$num_states == 2 &
                                                                                               P_Data_long$Variable == "Stimulus-PS" &
                                                                                               P_Data_long$Mode == "internal",]$value) -
  (P_Data_long[P_Data_long$Intervention == "Placebo" &
                 P_Data_long$num_states == 2 &
                 P_Data_long$Variable == "Stimulus-PS" &
                 P_Data_long$Mode == "external",]$value - P_Data_long[P_Data_long$Intervention == "Placebo" &
                                                                        P_Data_long$num_states == 2 &
                                                                        P_Data_long$Variable == "Stimulus-PS" &
                                                                        P_Data_long$Mode == "internal",]$value)

##
## unimodal vs bimodal
##
STAT.delta_W1 = wilcox.test(difference_in_os_betas)
STAT.bimodal_to_unimodal = cor.test(difference_in_modes, difference_in_os_betas, type = "spearman")
```

```{r sample_and_questionnaires, fig.height = 7}
Logbook_full = read_excel(paste(root_dir,"Participant_Logbook.xlsx", sep = ""))
Logbook_final = Logbook_full[Logbook_full$Incl == 1,]

Logbook_final$ID = as.numeric(gsub("Ketamin_RDK_", "", Logbook_final$ID))
Logbook_final$PDI = as.numeric(Logbook_final$`PDI (sum of all subscales)`)
Logbook_final$CAPS = as.numeric(Logbook_final$`CAPS (sum of all subscales)`)

Logbook_final$ABZ_4 = as.numeric(Logbook_final$`(Global ASC 1) 5D-ABZ Grand Mean Session 1 (%)`)
Logbook_final$ABZ_5 = as.numeric(Logbook_final$`5D-ABZ Grand Mean Session 2 (%)`)

Keta_Thresholds = read.csv(paste(root_dir,"Ketamin_Thresholds.csv", sep = ""))

##
## Integrate global questionnaire data
##
Summary_Mode$PDI = NA
Summary_Mode$CAPS = NA
Summary_Mode$ABZ= NA
Summary_Mode$Threshold = NA

for (idx in unique(Logbook_final$ID)){
Summary_Mode$PDI[Summary_Mode$ID == idx] = Logbook_final$PDI[Logbook_final$ID == idx]
Summary_Mode$CAPS[Summary_Mode$ID == idx] = Logbook_final$CAPS[Logbook_final$ID == idx] 

if (idx %in% Verum_first){
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Logbook_final$ABZ_4[Logbook_final$ID == idx] 
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Logbook_final$ABZ_5[Logbook_final$ID == idx] 

} else if (idx %in% Placebo_first){
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Logbook_final$ABZ_5[Logbook_final$ID == idx] 
Summary_Mode$ABZ[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Logbook_final$ABZ_4[Logbook_final$ID == idx]   

}
}
gathercol <- colnames(Summary_Mode[,c(11:13)])
Summary_Mode_corr_long <- gather(Summary_Mode[,c(1,2,3,11:13)], "Variable", "Score", gathercol, factor_key = TRUE)

Quest = data.frame(diff_Mode = Summary_Mode$external [Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$external [Summary_Mode$Intervention == "Placebo"],
                   PDI = Summary_Mode$PDI[Summary_Mode$Intervention == "Ketamine"],
                   CAPS =  Summary_Mode$CAPS[Summary_Mode$Intervention == "Ketamine"],
                   diff_ABZ = Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"] - Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"])

##
## Dynamic Questionnaire Data
##
Dyn_Quest =  ddply(
  Data[Data$Intervention != "None" & Data$block_id %in% c(1,3,6,9),],
  .(block_id, ID, Intervention),
  summarise,
  Q1 = mean(Q1, na.rm = TRUE),
  Q2 = mean(Q2, na.rm = TRUE),
  Q3 = mean(Q3, na.rm = TRUE),
  CADSS = mean(CADSS, na.rm = TRUE),
  external = mean(Session_Sl_Prob_State_ext)
  )

Dyn_Quest[Dyn_Quest == "NaN"] = NA

gathercol <- colnames(Dyn_Quest[,c(4:7)])
Dyn_Quest_long <- gather(Dyn_Quest, "Variable", "Score", gathercol, factor_key = TRUE)

Group_Dyn_Quest_long <- ddply(
  Dyn_Quest_long,
  .(block_id, Intervention, Variable),
  summarise,
  mean = mean(Score, na.rm = TRUE),
  error = sd(Score, na.rm = TRUE)/sqrt(length(Score))
  )

Dyn_Quest_ID =  ddply(
  Data[Data$Intervention != "None" & Data$block_id %in% c(1,3,6,9),],
  .(ID, Intervention),
  summarise,
  Q1 = mean(Q1, na.rm = TRUE),
  Q2 = mean(Q2, na.rm = TRUE),
  Q3 = mean(Q3, na.rm = TRUE),
  CADSS = mean(CADSS, na.rm = TRUE),
  external = mean(Session_Sl_Prob_State_ext)
  )



##
## Integrate Thresholds
##
Summary_Mode$Threshold = NA

for (idx in unique(Keta_Thresholds$ID)){

if (idx %in% Verum_first){
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 4]*100
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 5]*100
} else if (idx %in% Placebo_first){
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Ketamine"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 5]*100
Summary_Mode$Threshold[Summary_Mode$ID == idx & Summary_Mode$Intervention == "Placebo"] = Keta_Thresholds$Threshold[Keta_Thresholds$ID == idx & Keta_Thresholds$Run == 4]*100
}
}
Summary_Mode$Threshold[Summary_Mode$Threshold > 1.5] = NA


##
## STATS
##
if (!load_summary_data) {
Quest_to_Mode = glmer(external ~ PDI*Intervention + CAPS*Intervention + ABZ*Intervention + (1|ID), data = Summary_Mode, family = binomial)
STAT.Quest_to_Mode = summary(Quest_to_Mode)

ABZ_Intervention = lmer(
  ABZ ~ Intervention + (1 | ID),
  data = Summary_Mode)
STAT.ABZ_Intervention = summary(ABZ_Intervention)

Dyn_Quest_to_Mode = glmer(
  external ~ block_id*Q1 + block_id*Q2 + block_id*Q3 + block_id*CADSS + (1 |
                                     ID),
  data = Dyn_Quest,
  family = binomial
)
STAT.Dyn_Quest_to_Mode = summary(Dyn_Quest_to_Mode)


Q1_Time_Intervention = glmer(
  Q1 ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q1_Time_Intervention = summary(Q1_Time_Intervention)

Q2_Time_Intervention = glmer(
  Q2 + 0.1 ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q2_Time_Intervention = summary(Q2_Time_Intervention)

Q3_Time_Intervention = glmer(
  Q3 ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q3_Time_Intervention = summary(Q3_Time_Intervention)

CADSS_Time_Intervention = lmer(
  CADSS ~ block_id*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",])
STAT.CADSS_Time_Intervention = summary(CADSS_Time_Intervention)


Q1_Mode_Intervention = glmer(
  Q1 ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q1_Mode_Intervention = summary(Q1_Mode_Intervention)

Q2_Mode_Intervention = glmer(
  Q2 + 0.1 ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q2_Mode_Intervention = summary(Q2_Mode_Intervention)

Q3_Mode_Intervention = glmer(
  Q3 ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",],
  family = binomial
)
STAT.Q3_Mode_Intervention = summary(Q3_Mode_Intervention)

CADSS_Mode_Intervention = lmer(
  CADSS ~ external*Intervention + (1 | ID),
  data = Dyn_Quest[Dyn_Quest$Intervention != "None",])
STAT.CADSS_Mode_Intervention = summary(CADSS_Mode_Intervention)

Threshold_to_Mode = glmer(
  external ~ Intervention*Threshold + (1 | ID),
  data = Summary_Mode,
  family = binomial
)
STAT.Threshold_to_Mode = summary(Threshold_to_Mode)
STAT.Mode_Threshold = wilcox.test(Summary_Mode[Summary_Mode$Intervention == "Ketamine",]$Threshold, Summary_Mode[Summary_Mode$Intervention == "Placebo",]$Threshold, paired = TRUE)
if (save_summary_data) {
    save(STAT.ABZ_Intervention, ABZ_Intervention,
         STAT.Dyn_Quest_to_Mode, Dyn_Quest_to_Mode,
         STAT.Q1_Time_Intervention, Q1_Time_Intervention,
         STAT.Q2_Time_Intervention, Q2_Time_Intervention,
         STAT.Q3_Time_Intervention, Q3_Time_Intervention,
         STAT.CADSS_Time_Intervention, CADSS_Time_Intervention,
         STAT.Q1_Mode_Intervention, Q1_Mode_Intervention,
         STAT.Q2_Mode_Intervention, Q2_Mode_Intervention,
         STAT.Q3_Mode_Intervention, Q3_Mode_Intervention,
         STAT.CADSS_Mode_Intervention, CADSS_Mode_Intervention,
         STAT.Threshold_to_Mode, Threshold_to_Mode, STAT.Mode_Threshold, 
         file = "./Results/Quest_stats.Rdata")
  }
} else {
  load("./Results/Quest_stats.Rdata")
}
##
## Bonferroni
##
STAT.Q1_Time_Intervention = bonferroni(STAT.Q1_Time_Intervention)
STAT.Q2_Time_Intervention = bonferroni(STAT.Q2_Time_Intervention)
STAT.Q3_Time_Intervention = bonferroni(STAT.Q3_Time_Intervention)
STAT.CADSS_Time_Intervention = bonferroni(STAT.CADSS_Time_Intervention)

STAT.ABZ_Intervention = bonferroni(STAT.ABZ_Intervention)
```

# Materials and Methods

## S-ketamine vs. placebo

The S-ketamine experiment consisted in a total of three experimental sessions. During the first session, we screened participants for S-ketamine contraindications (arterial hypertension, prior psychiatric or neurological diagnoses including substance use disorder, use of psychoactive medication), and assessed psychosis proneness using the 40-item *Peters Delusion Inventory* (PDI[@Peters1999]) and the 32-item *Cardiff Anomalous Perception Scale* (CAPS[@Bell2006]). Moreover, we conducted three experimental pre-test runs that tested the ability to process stereodisparity (run 1, SAR = 1, cut-off: perceptual accuracy > 0.75), ensured the experience of spontaneous switches during bistable perception (run 2, SAR = 0, cut-off: perceptual stability < 0.96, corresponding to phase durations < 40 sec), and familiarized participants with the main experiment (run 3, see below for details).

In the subsequent two sessions, participants received a continuous intravenous infusion of either S-ketamine at 0.1 mg/kg/h or a saline placebo. Health screenings were repeated before each session to ensure the participants remained eligible. At each day of testing, we checked for alcohol intoxication using a breathalyzer and for recent illicit substance use via a urine drug screen. 

Our experimental protocol was double-blinded: The order of S-ketamine and placebo administration was counter-balanced across participants, with at least a two week interval between sessions. The participants, as well as the experimenters tasked with collecting the behavioral and psychometric data, were unaware of whether S-ketamine or placebo was administered by an independent group of clinicians who excluded undiagnosed psychotic illness using the *Brief Psychiatric Rating Scale* (BPRS[@overall_brief_1962]), established the intravenous line, started the infusion 15 min prior to the experiment, monitored the participants for side effects (blood pressure, drowsiness, vasovagal reactions, and psychotomimetic effects), and removed the intravenous line at the end of the experiment, after which participants were monitored for at least 30 min. Deblinding occurred after data collection was complete. 

### Sample characteristics

We screened a total of `r nrow(Logbook_full)` right-handed individuals with (corrected-to-) normal vision, who were naive to the purpose of the study and gave written informed consent before participating. All experimental procedures were approved by the ethics committee at Charité Berlin. 

From the group of screened participants, `r nrow(Logbook_full[Logbook_full$Incl == 3,])` did not meet our pretest criteria (6 due to perceptual accuracy < 0.75, 15 due to perceptual stability > 0.96, 8 due to substance use, 1 due to do a diagnosis of ADHD, and 1 due to medication with sertraline). Out of the remaining `r nrow(Logbook_full[Logbook_full$Incl != 3,])` participants who were eligible for the S-ketamine experiment, we aborted the main experiment in 1 participant due to high blood pressure at baseline (RR > 140/80 mmHG), in 2 participants due to strong psychotomimetic effects (micropsia) or dizziness under S-ketamine, and in 1 participant due to a vasovagal syncope during intravenous insertion. 24 participants were not available for the main experiment after successful pre-testing. We therefore report the data from a total of `r nrow(Logbook_final)` participants (mean age: `r mean(Logbook_final$age)` ± `r sd(Logbook_final$age)/sqrt(length(Logbook_final$age))` years, `r sum(Logbook_final$gender == "F")` female) who met all inclusion criteria and completed all experimental sessions.

### Experimental paradigm

We presented the experiment using Psychtoolbox 3[@Brainard1997] running in Matlab R2021b (session 1: CRT-monitor at 85 Hz, 1280 x 1024 pixels, 60 cm viewing distance and 39.12 pixels per degree visual angle; session 2 and 32: CRT-monitor at 85Hz, 1280 x 1024 pixels, 40 cm viewing distance and 26.95 pixels per degree visual angle).

**Procedure**: Throughout the experiment, participants reported their perception of a structure-from-motion (SFM) stimulus (Supplemental Video S1). In this stimulus, random dots distributed on two intersecting rings induce the perception of a spherical object (diameter: 15.86°, rotational speed: 12 sec per rotation, rotations per block: 10, individual dot size: 0.12°) that rotates around a vertical axis with the front surface to the left or right[@weilnhammer_active_2021]. Stimuli were presented in 120 sec blocks, separated by 10 sec fixation intervals. 

Participants viewed the stimuli through a custom mirror stereoscope. In the pretest experiment, we presented stimuli at complete disambiguation (run 1, SAR = 1), full ambiguity (run 2, SAR = 0) and across five levels ranging from full ambiguity to complete disambiguation across five levels (run 3-5, $SAR \in \{0, 0.1, 0.25, 0.5, 1\}$). The signal-to-ambiguity ratio (SAR), which was constant within blocks, defines the fraction of stimulus dots that carried a disambiguating 3D signal.

Participants were naive to the potential ambiguity in the visual display, passively experienced the stimulus and reported changes in their perception alongside their confidence via button-presses on a standard USB keyboard (right middle-finger on k: rotation of the front-surface to the right at high confidence; right index-finger on j: rotation of the front-surface to the right at low confidence; left middle-finger on s: rotation of the front-surface to the left at high confidence; left index-finger on d: rotation of the front-surface to the left at low confidence; thumb on space bar: unclear direction of rotation). Unclear perceptual states occurred at a rate of `r mean(Uncertainty$rate, na.rm = TRUE)` ± `r sd(Uncertainty$rate, na.rm = TRUE)/sqrt(length(Uncertainty$rate))` and were excluded from further analyses.

The direction of rotation enforced by $s_t$ (i.e., whether the parametric 3D signal enforced leftward or rightward rotation of the front surface) changed at a rate of 0.15 per overlap (i.e., on average every 10 sec). Changes in $s_t$ and the order of blocks, each corresponding to one level of SAR, were pseudo-random.

In session 1 (pre-test), each run (runs 1 to 3) consisted of six blocks. In session 2 and 3 (main experiment), each run (run 4 and 5) consisted of 10 blocks. After every third block, the main experiment was paused to allow for the monitoring of the participants' vital signs (blood pressure and pulse rate) and dynamic changes in psychotomimetic experiences. The latter was assessed using the 6 item *Clinician-Administered-Dissociative-States-Scale* (CADSS[@mertens_clinician-administered_2022]) and three additional questions (Q1: *How awake do you feel?*, Q2: *How intoxicated do you feel?*, Q3: *How nervous do you feel?*) to which participants responded by clicking on a continuous line that encoded responses from *not at all* to *very much*. To measure global psychotomimetic effects of S-ketamine vs. placebo, participants completed the Questionnaire for the *Assessment of Altered States of Consciousness* (5D-ASC[@dittrich_5d-abz_1999]) at the end of session 2 and 3. In addition, we collected responses on a debriefing questionnaire, in which we asked participants to describe whether they were able to accurately perceive the two directions of rotation induced by the SFM stimulus, whether they noticed any differences between blocks, whether they would guess that they received S-ketamine or placebo, and whether they had experienced any effects that they would attribute to a psychoactive substance. 

**Stereodisparity thresholds:** At the beginning of the session 2 and 3, we conducted an independent stereo-acuity test to detect a potential effect of S-ketamine on stereodisparity thresholds[@weilnhammer_psychotic_2020]. We presented 5000 dots (each at 0.15° visual angle) within a square of 11° x 11° around a central fixation cross (0.10°). We added a stereodisparity signal to all dots on a Landolt C, i.e., a circle (1.37° radius, 2.06° width) with a 90° gap located either at the left, top, right or bottom. Stimuli were presented for 1 sec, after which participants reported the location of the gap by pressing the up-, down-, left- or right-arrow key within a 2 sec response interval, followed by 5 sec of fixation before the next trial.

We adjusted the stereodisparity of the Landolt C in a two-up-one-down staircase across 40 trials (initial stereodisparity: 0.0045°, correct response: decrease in the available stereodisparity by one step; incorrect response: increase by two steps, initial step-size: 0.001°, reduction to 0.0005° after first reversal). Stereodisparity thresholds were defined by the average stereodisparity present at the last 10 trials of the staircase.

**Scores and Questionnaires:** Supplementary Table S2 provides an overview of our psychometric data. 

## Scz patients vs. healthy controls

To test whether Scz patients show similar changes in perceptual inference as healthy participants who receive the NMDAR-antagonist S-ketamine, we re-analyzed data from a previously published case-control study[@weilnhammer_psychotic_2020] that compared Scz patients to healthy participants in paradigm analogous to the S-ketamine experiment described above.

### Sample characteristics

```{r read_Sum_Scz_data}
S_Data <- read.csv(paste(root_dir, "Scz_Full_HMM_Sessions.csv", sep = ""))
SumData <- read.csv(paste(root_dir, "B_Conv_summed_up_excl_P1_P3.csv", sep = ""))
```
We report data from  `r nrow(SumData[SumData$Group == "Patients",])` patients diagnosed with paranoid Scz (ICD-10: F20.0, `r nrow(SumData[SumData$Group == "Patients" & SumData$Gender == 0,])` male, age = `r mean(SumData[SumData$Group == "Patients",]$Age)`±`r sd(SumData[SumData$Group == "Patients",]$Age)/sqrt(length(SumData[SumData$Group == "Patients",]$Age))`) and `r nrow(SumData[SumData$Group == "Controls",])` controls (`r nrow(SumData[SumData$Group == "Controls" & SumData$Gender == 0,])` male, age = `r sprintf('%.2f', mean(SumData[SumData$Group == "Controls",]$Age))`±`r sd(SumData[SumData$Group == "Controls",]$Age)/sqrt(length(SumData[SumData$Group == "Controls",]$Age))`) that were matched for gender, age and handedness[@weilnhammer_psychotic_2020].

### Experimental paradigm

Stimuli were presented using Psychtoolbox 3[@Brainard1997] running in Matlab R2007b (CRT-Monitor at 60 Hz, 1042x768 pixels, 59.50cm viewing distance, 30.28 pixels per degree visual angle).

**Main Experiment**: Throughout the experiment, participants reported their perception of a SFM stimulus (see Supplemental Video S2) via button-presses on a standard USB keyboard. In contrast to the S-ketamine experiment, the 300 dots (0.05°) that composed the stimulus (2.05°x 2.05°) were not placed on rings, but on a Lissajous band defined by the perpendicular intersection of two sinusoids ($x(p) = sin(A*p)$ and $y(p) = cos(B*p + \delta$) with $A=3$, $B=6$, with $\delta$ increasing from $0$ to $2\pi$ at 0.15 Hz. Overlapping configurations of the stimulus occurred in intervals of 3.33 sec. Participants viewed the stimuli through a mirror stereoscope. Fusion was supported by rectangular fusion-frames and a background of random dot noise (700 dots of 0.05° which moved at a speed of 1.98° per sec and changed their direction at a rate of 1 Hz).

We presented participants with `r max(S_Data$session_id)` sessions of the main experiment, each consisting of `r max(S_Data$block_id)` 40.08 sec blocks that were separated by 5 sec of fixation and differed with respect to the SAR, ranging from full ambiguity to complete disambiguation in 8 levels ($SAR \in \{ 0, 0.01, 0.04, 0.9, 0.16, 0.26, 0.50, 1 \}$). The frequency of changes in the direction of the disambiguating signal corresponded to the frequency of spontaneous changes that participants perceived during full ambiguity[@weilnhammer_psychotic_2020] (SAR = 0). In contrast to the S-ketamine experiment, participants only reported the perceived direction of rotation $y_t$ (left vs. rightward movement of the front surface), with no additional assessment of confidence.  

**Stereodisparity thresholds:** We measured stereodisparity thresholds in Scz patients and controls using the procedure described above. 

**Scores and Questionnaires:** We used the PDI[@Peters1999] and the CAPS[@Bell2006] to measure delusional ideation and perceptual anomalies in Scz patients and controls. Clinical symptom severity was assessed using the *Positive and Negative Syndrome Scale* (PANSS)[@Kay1987].

## Quantification and statistical procedures

This manuscript was written in RMarkdown. All data and summary statistics can be reviewed by cloning the Github respository <https://github.com/veithweilnhammer/modes_ketamine_scz> and running the file *modes_ketamine_scz.Rmd*. 

The SFM stimuli used in the above studies share an important feature: Even though physically ambiguous at all angles of rotation, spontaneous changes in the perceived direction of rotation are limited to overlapping configurations of the stimuli[@weilnhammer_psychotic_2020; @weilnhammer_active_2021] (see also Supplemental Figure S2 and S4). This is because depth-symmetry, which is a prerequisite for changes in subjective experiences during bistable SFM[@weilnhammer_psychotic_2020; @weilnhammer_active_2021], is limited to timepoints when the bands that compose the stimuli overlap (Supplemental Video S1 and S2).

We therefore discretized the perceptual timecourse of all experiments into a sequence of overlaps that occur at times $t$ (1.5 sec inter-overlap interval for the S-ketamine intervention, 3.33 sec inter-overlap interval for the case-control study). We characterized each inter-overlap interval the primary independent variable $s_t = [-1, 1] \times SAR$ (the SAR-weighted input ranging from maximum information for leftward rotation to maximum information for rightward rotation), and $y_{t-1}$ (the perceptual experience associated with the preceding overlap). As secondary independent variables, we considered block and session index (reflecting the time participants were exposed to the experiment), participant identifiers and, if applicable, treatment or group identifiers. Primary dependent variables were $y_t = [0,1]$ (the experience of either leftward or rightward rotation) and, if applicable, $c_t = [0,1]$ (low vs. high confidence). As secondary dependent variables, we computed perceptual accuracy (the probability of $y_t \cong s_t$) and perceptual stability (the probability of $y_t = y(t - 1)$). 

From the perspective of predictive processing, perceptual stability is induced by internal predictions that bias perception toward previous experiences[@manassi_continuity_2024]. Stabilizing internal predictions are most likely to be adaptive in natural environments, where the recent past predicts the near future (much like successive frames captured by a video camera are temporarily autocorrelated[@manassi_continuity_2024]). Our experiment differed from the temporal autocorrelation of natural environments[@manassi_continuity_2024] in that random changes in the direction of disambiguation (i.e., whether the external stimulus supports left- or rightward rotation of the sphere) occurred in average intervals of 10 sec. We thereby created a situation in which strong stabilizing internal predictions *reduce* performance[@shergill_evidence_2005, @keane_reduced_2013, @Silverstein2013]. In our experiment, a shift of perception away from internal predictions toward the external sensory data, which has been proposed to occur under S-ketamine and in Scz[@Sterzer2018], should therefore manifest as an *increase* in perceptual accuracy. 

For SFM stimuli like those used in this study, changes in experience occur at overlapping configurations of the stimulus[@Pastukhov2012; @weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021] (i.e., when the bands that compose the stimulus overlap; see Supplemental Video S1-2). Following previous approaches[@weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021], we defined response times $r_t$ as the time between a button press that indicates a change in the perceived direction of rotation and the time of the preceding overlapping configuration of the stimulus.

To assess differences in metacognitive performance, we correlated perceptual confidence with perceptual accuracy. We computed meta-d', a measure of metacognitive sensitivity that indicates how well confidence ratings predict perceptual accuracy[@Fleming2014].

For all variables, we report and display averages as mean ± standard error of the mean (s.e.m).

### Conventional statistics

The goal of our conventional statistics was to quantify the effect of NMDAR hypofunction, whether due to pharmacological antagonism with S-ketamine or due to a diagnosis of Scz, on the interpretation of ambiguous sensory information. We performed standard logistic and linear regression by fitting (general) mixed linear effects models using the R-packages lmer, glmer and afex (see Supplemental Table S2). We predicted $y_t$, $c_t$, perceptual accuracy and perceptual stability in logistic regression, and $r_t$ in linear regression. We estimated random intercepts defined within participants in the S-ketamine experiment and nested random intercepts for participants within groups in the case-control study. We applied a Bonferroni-correction for the number of main effects and interactions within models. Mixed effects models are reported with the estimate ($\beta$ without subscript), followed by the T- or z-statistic for linear and logistic models, respectively. Please note that parameter estimates with subscripts refer exclusively to the GLM-HMM weights (see Computational modeling) associated with the external input ($\beta_S$), the constant bias ($\beta_B$), and the previous experience ($\beta_P$). For non-normally distributed secondary dependent variables, we performed rank-based tests to assess correlations (Spearman) and distribution differences (Wilcoxon).

### Computational modeling

Having established the effect of NMDAR hypofunction on the interpretation of ambiguous sensory information, we used computational modeling to arbitrate between two mechanistic explanations on how S-ketamine and Scz may alter perceptual inference.

**Hypothesis H1: Unimodal inference.** In one scenario, NMDAR hypofunction may induce a global increase in the sensitivity to external inputs relative to stabilizing internal predictions. This unimodal scenario, which corresponds to the canocical predictive processing hypothesis of Scz[@Sterzer2018], assumes S-ketamine- or Scz-related changes in the weights $w \equiv \{\beta_S, \beta_P, \beta_B\}$ of a GLM that predicts percepts $y_t$ from the input vector $x_t$, which consists in the SAR-weighted external input $s_t$, the stabilizing internal prediction $y_{t-1}$ and a constant bias $b$: 

$$
P(y_t = 1 | x_t) = \frac{1}{1 + e^{-x_t \times w}} 
$$

$$
x_t \times w =  s_t \times \beta_S + y_{t-1} \times \beta_P  + b \times \beta_B  
$$

According to the unimodal hypothesis H1, NMDAR hypofunction increases $\beta_S$ at the expense of $\beta_P$, leading to an increase of $\Delta_{S-P} = \beta_S - \beta_P$.

**Hypothesis H2: Bimodal inference.** In an alternative scenario, NMDAR hypofunction does not change the weights of the GLM directly, but modulates the transition between latent modes[@weilnhammer_sensory_2023] or decision-making strategies[@ashwood_mice_2022] that differ with respect to the balance between external inputs $s_t$ and the stabilizing internal prediction provided by $y_{t-1}$. In the bimodal scenario, perceptual inference is characterized by two latent modes $z_t$ (i.e., states in a HMM) that alternate at a probability per overlap that is defined by a 2 x 2 transition matrix $A$:

$$
P(z_t = k|z_{t-1} = j) = A_{kj} 
$$

Each state $z_t$ is associated by an independent GLM defined by the weights $w_k$:

$$
P(y_t = 1 | x_t, z_t) = \frac{1}{1 + e^{-x_t \times w_k}} 
$$

$$
x_t \times w_k =  s_t \times \beta_{S,k} + y_{t-1} \times \beta_{P,k}  + b \times \beta_{B,k}  
$$

Hypothesis H2 differs from the unimodal hypothesis H1 in two ways: First, the two-state GLM-HMM is characterized by two (as opposed to one) GLMs that differ with respect to $\Delta_{S-P}$: In the external mode, $\beta_S$ is increased relative to $\beta_P$. Conversely, in the internal mode, $\beta_P$ is increased relative to $\beta_S$. Second, during bimodal inference, NMDAR hypofunction does not alter the weights within the external and internal GLMs, but modulates the transition probability between the two. 

**Procedure:** To contrast hypotheses H1 and H2, we fitted unimodal and bimodal GLM-HMMs using SSM[@linderman_ssm_2020] (Supplemental Table S2), compared models via Bayesian Information Criterion (BIC), and assessed the effects of S-ketamine or Scz on the posterior model parameters, i.e., HMM transition probabilities and the mode-dependent GLM weights $w_k$. Model fitting using SSM is governed by the hyperparameters $\sigma^2$ and $\alpha$. $\sigma^2$ denotes the variance of a prior over the GLM weights $w_k$. Smaller values of $\sigma^2$ shrink $w_k$ toward 0, whereas $\sigma = \infty$ leads to flat priors. We set $\sigma^2$ to 100 for GLMs that predicted group-level data, and to 1 for GLMs that predicted participant- or session-level data, which were initialized with group-level estimates of $w_k$. $\alpha$ defines the Dirichlet prior over the transition matrix $A$ and is flat for $\alpha$ = 1. We set $\alpha$ to 1 for all group-level and participant-level fits.

For each experiment, computational modeling was carried out in a sequence of 3 steps: In a first step, we fitted a unimodal GLM initialized with noisy weights to the group-level data (i.e., data pooled across participants within an individual experiment) for a total of n = 100 iterations and computed the average posterior weights $w_n$. In a second step, we fitted the group-level data with the unimodal and the bimodal GLM-HMM initialized by $w_n$, extracted the posterior parameters $w_k$, and compared the models using BIC. 

In a third step, we fitted the unimodal and the bimodal GLM-HMM to session-level data (S-ketamine experiment) and participant-level data (case-control experiment). Models were initialized by the average weights $w_n$ of the corresponding group-level model. For all bimodal group-, participant- and session-level GLM-HMMs, we defined the latent mode associated with the higher posterior $\beta_S$ estimate as external. For summary statistics, we extracted the posterior weights $w_k$ (separately for external and internal mode) and the dynamic posterior probability of external mode $z_t = e$.

The GLM-HMM used in this study predicts experiences $y_t$ in a GLM defined by the stimulus $s_t$, the preceding experience $y_{t-1}$, and a constant bias $b$. The HMM component of the model identifies alternations between two states that differ with respect to the weights of any combination of $s_t$, $y_{t-1}$, and $b$. We used the GLM-HMM to test our primary hypothesis that ketamine and Scz alter the balance between two states that differ with respect to $\Delta_{S-P} = \beta_S - \beta_P$ (high $\Delta_{S-P}$ in external mode, low $\Delta_{S-P}$ in internal mode: hypothesis H2). However, the GLM-HMM can, in principle, embody dynamic changes in any combination of $\beta_S$, $\beta_B$, and $\beta_P$. Alternative outcomes to external versus internal modes are states that differ with respect to bias (state 1: high $\beta_B$; state 2: low $\beta_B$; hypothesis H3) and randomness (state 1: high $\beta_S$ and $\beta_P$; state 2: low $\beta_S$ and $\beta_P$: no difference in $\Delta_{S-P}$ between modes: hypothesis H4).

**Stimulus- versus experienced-based GLM-HMM.** In our experiment, stabilizing internal predictions bias perception toward preceding overlaps ($t-1$), causing conflicts between the direction of rotation that is consciously experienced ($y$) and the stimuli $s$ presented at the current overlap $t$. If external and internal modes are perceptual in nature, then the stabilization of perception should be driven by the sequence of perceptual experiences $y$, as opposed to the sequence of sensory signals $s$ (hypothesis H5). To test this hypothesis, we compared our *experienced-based* GLM-HMM, in which the stabilizing internal predictions are driven by the participants' perceptual experience at the preceding overlap, with an alternative *stimulus-based* GLM, in which the stabilizing internal predictions are driven by the stimulus presented at the preceding overlap.

**External validation of the GLM-HMM.**  The GLM-HMM generates a perceptual decision variable $P(y_t = 1)$ that is defined by a weighted integration of the external stimulus ($\beta_S \times s_t$), the previous experience ($\beta_P \times y_{t-1}$), and a constant bias ($\beta_P \times 1$). The weights are obtained by fitting the GLM-HMM to the sequence of experiences $y$, irrespective of whether the experience $y$ was made at high or low confidence. This allowed us to test whether the predictions of the two-state GLM-HMM would generalize to metacognitive reports on perception. Importantly, the source of confidence differs between the modes: During the external mode, confidence should depend predominantly on the SAR of the stimulus. Conversely, during the internal mode, confidence should be driven more by the congruency of perception with previous experiences, and less by the external input. To validate our model, we tested whether the perceptual decision variable $P(y_t = 1)$ predicted not only the binary contents of experience $y_t$ (which the GLM-HMM was fitted to), but also perceptual confidence $c_t$ (which the GLM-HMM was not fitted to). To do so, we correlated $c_t$ (as reported by the participants) with the posterior certainty $C_t$ (as provided by the GLM-HMM) at each overlap. The posterior certainty $C_t$ is given by log probability of the actual experience $y$, given the decision variable $P(y_t = 1)$:

$$
C_t = y_t \cdot \log(P(y_t = 1)) + (1 - y_t) \cdot \log(1 - P(y_t = 1)) 
$$

**Recovery of GLM-HMM parameters.** To evaluate the robustness of our GLM-HMM model in estimating mode-dependent weights and transition probabilities, we conducted a parameter recovery analysis. The GLM-HMM is characterized by three weights, $\beta_S$, $\beta_B$, and $\beta_P$, that are defined separately for the external and internal modes. We assessed the model’s ability to estimate individual mode-dependent weights by fitting the model to simulated data that were obtained by sampling from GLM-HMMs in which individual target weights were systematically varied, while all other weights were kept constant at the group-level average obtained from the original data. For each analysis, we selected one of the six weights (3 weights $\times$ 2 modes) and varied its value parametrically from $-1$ to $5$. We then generated synthetic data, simulating $y_{\text{syn}}$ for $n = 78{,}400$ overlaps (corresponding to the number of overlaps observed across all participants in the S-ketamine experiment). The GLM-HMM model was then fitted to these synthetic data.

We repeated the recovery analysis for each weight 10 times, computed the average posterior weights $\beta_S$, $\beta_B$, and $\beta_P$, and then correlated these recovered weights with the synthetic input weights. We applied a similar procedure to evaluate the recovery of the GLM-HMM transition matrix. Transition probabilities were varied parametrically within the range of 0.8 to 1 for on-diagonal cells (external to external, internal to internal) and 0 to 0.2 for off-diagonal cells (external to internal, internal to external). The results of this recovery analysis, which are depicted in Supplemental Figure S1, demonstrate that the GLM-HMM weights and transition probabilities can be recovered with high fidelity across the full range of the synthetic input parameters, and in particular in the parameter region of the group-level estimates obtained from the original data ($w_n$).

# Results

To investigate whether NMDAR hypofunction influences perceptual inference, and how NMDAR hypofunction contributes to the transient nature of psychotic experiences, we conducted a double-blind placebo-controlled cross-over experiment in `r length(unique(Data$ID))` healthy human participants. The participants attended two experimental sessions during which they received a continuous intravenous infusion of either the NMDAR antagonist S-ketamine at a dose of 0.1 mg/kg/h or a saline placebo. In each session, the participants viewed ten `r round(max(Data$overlap_index) * diff(Data$overlap_timing[1:2]))` sec blocks of an ambiguous structure-from-motion (SFM) stimulus that induced the experience of a sphere rotating around a vertical axis, and reported changes in the perceived direction of rotation (leftward vs. rightward movement of the front surface) as well as their confidence in the choice (Figure 1B and Supplemental Video S1). 

The ambiguity of the display induced the phenomenon of bistable perception: Even though the stimulus was physically ambiguous at each frame of the presentation, spontaneous changes in the perceived direction of rotation occurred in average intervals of $`r 1.5/mean(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value)`$ ± 
$`r (1.5/sd(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))/sqrt(length(Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))`$ sec. In line with previous results[@weilnhammer_psychotic_2020; @weilnhammer_active_2021], these changes in perception occurred with a probability of $`r mean(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value)`$ ± 
$`r (sd(1-Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))/sqrt(length(Summary_Data_no_mode_long[Summary_Data_no_mode_long$uDisambiguation == 0 & Summary_Data_no_mode_long$Variable == "Stability",]$value))`$ at brief depth-symmetric configurations of the stimulus (see Supplemental Video S1 and Supplemental Figure S2A). We therefore divided the continuous behavioral reports into a sequence of discrete states $t$. Each state was associated with a perceptual experience $y_t$, confidence $c_t$ and the external input $s_t$.

Predictive processing conceptualizes bistable perception as an inferential process about the cause of $s_t$. The core idea is that previous experiences ($y_{t-1}$) generate internal predictions that bias the interpretation $y_t$ of the ambiguous stimulus[@Hohwy2008; @weilnhammer_active_2021] (Figure 1C). In this view, inferences during bistability mirror the temporal autocorrelation of natural environments, where the recent past typically predicts the near future, much like frames captured by a video camera allow for the prediction of future frames[@manassi_continuity_2024]. The adaptive benefit of this predictive strategy is the stabilization of perception that prevents erratic experiences in natural environments, which are highly autocorrelated and accessible to the brain only via inherently ambiguous sensory signals[@Friston2005; @Hohwy2012]. 

Predictive processing models of bistable perception assume that transitions between the alternative interpretations of (partially) ambiguous stimuli are driven by conflicts between the external input and stabilizing internal predictions[@Hohwy2008; @weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021]. To test how NMDAR antagonism alters the balance between external inputs and internal predictions, we attached a 3D signal to a fraction of the stimulus dots. The signal-to-ambiguity ratio (SAR) ranged from complete ambiguity to full disambiguation across five levels and remained constant in each block of the experiment. By changing the direction of rotation enforced by the 3D signal at random in average intervals of 10 sec, we created dynamic conflicts between the SAR-weighted input $s_t$ and the stabilizing internal prediction $y_{t-1}$. Due to the random changes in $s_t$, a shift of inference away from internal predictions and toward external sensory data, which has repeatedly been associated with NMDAR hypofunction[@Sterzer2018] and may be maladaptive in autocorrelated natural environments[@weilnhammer_sensory_2023], should manifest as an increase in perceptual accuracy in our experiment. 

## NMADR hypofunction shifts perceptual inference toward the external input and away from internal predictions

As expected, we found that $y_t$ was driven by both $s_t$ ($\beta$ = $`r STAT.y_choice_by_STP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[2,4]`$) and $y_{t-1}$ ($\beta$ = $`r STAT.y_choice_by_STP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[4,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[4,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[4,4]`$). Importantly, S-ketamine caused perception to shift toward $s_t$ ($\beta$ = $`r -STAT.y_choice_by_STP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[5,4]`$, Figure 2A and Supplemental Figure S3), indicating a stronger weighting of external inputs over internal predictions during pharmacologically induced NMDAR hypofunction. Under the predictive processing formulation of perceptual inference, one can read the estimates for $s_t$ and $y_{t-1}$ as sensory and prior precision, respectively. This suggests that S-ketamine augments sensory precision by altering the interactions between pyramidal cells and fast-spiking inhibitory interneurons thought to underwrite cortical gain control or excitation-inhibition balance[@adams_computational_2022]. 

```{r read_Scz_data}
##
## load and prepare data
##
S_Data <- read.csv(paste(root_dir, "Scz_Full_HMM_Sessions.csv", sep = ""))
SumData <- read.csv(paste(root_dir, "B_Conv_summed_up_excl_P1_P3.csv", sep = ""))
##
## Prepare Variables
##
## Data$Percept: 1 for rightward, -1 for leftward,-2 for unclear
## Data$Confidence: 1 for high confidence, -1 for low confidence, -2 for unclear
S_Data$Group <- factor(S_Data$Group, levels = c("Patients", "Controls"))

S_Data$Stimulus[S_Data$Disambiguation == 0] = 0

S_Data$Accuracy = S_Data$Percept == S_Data$Stimulus 
S_Data$Accuracy[S_Data$Stimulus == 0] = NA
S_Data$cond_Accuracy = S_Data$Accuracy
S_Data$cond_Accuracy[is.na(S_Data$cond_Accuracy)] = "ambiguous"
S_Data$cond_Accuracy[S_Data$cond_Accuracy == "FALSE"] = "stimulus-incongruent"
S_Data$cond_Accuracy[S_Data$cond_Accuracy == "TRUE"] = "stimulus-congruent"

S_Data$w_Stimulus = S_Data$Stimulus*S_Data$Disambiguation

S_Data$Stability = c(as.integer(diff(S_Data$Percept) == 0), NA)
S_Data[S_Data$overlap_index == max(S_Data$overlap_index),]$Stability = NA

S_Data$uDisambiguation = S_Data$Disambiguation
S_Data$Disambiguation = S_Data$Disambiguation * 100

S_Data$Percept_minus_1 = c(NA, S_Data$Percept[1:nrow(S_Data)-1])
S_Data$Percept_minus_1[S_Data$overlap_index] = NA

S_Data = S_Data[S_Data$Exclude == 0,]
##
## add RT
##

S_Data$RT = NA
S_RTData <- read.csv(paste(root_dir, "Scz_Behavior_Full_RT2.csv", sep = ""))
S_RTData = S_RTData[S_RTData$Exclude == 0,]

S_Data$RT = S_RTData$RT
S_Data$RT[is.nan(S_Data$RT)] = NA

##
## Define Modes
##
S_Data$Mode = "internal"
S_Data$Mode[S_Data$Session_Sl_Prob_State_ext > S_Data$Session_Sl_Prob_State_int] = "external"
S_Data$Mode = as.factor(S_Data$Mode)

S_Data$Mode_con = S_Data$Sl_Prob_State_ext - S_Data$Sl_Prob_State_int
S_Data$Mode_switch = c(NA, diff(sign(S_Data$Mode_con)) != 0)

##
## load additional HMM data
##
S_P_Data <- read.csv(paste(root_dir, "Scz_Individual_Weights_HMM.csv", sep = ""))
S_P_Data = data.frame(rbind(data.matrix(S_P_Data[, c(1:3, 11)]), data.matrix(S_P_Data[, c(4:6, 11)])))
colnames(S_P_Data) <- c('Stimulus','Bias','PS', 'ID')
S_P_Data = S_P_Data[S_P_Data$ID %in% unique(S_Data$ID),]

S_P_Data$'Stimulus-PS' = S_P_Data$Stimulus-S_P_Data$PS
S_P_Data$Mode = c(rep("external", nrow(S_P_Data)/2), rep("internal", nrow(S_P_Data)/2))

S_P_Data$Group = "Controls"
S_P_Data$Group[S_P_Data$ID %in% unique(S_Data[S_Data$Group == "Patients",]$ID)] = "Patients"

S_P_Data$Group <- factor(S_P_Data$Group, levels = c("Patients", "Controls"))

gathercol <- colnames(S_P_Data[, c(1:3,5)])
S_P_Data_long <- gather(S_P_Data, "Variable", "value", gathercol, factor_key = TRUE)

S_P_Data_long$num_states = 2

S_Data$ID = as.factor(S_Data$ID)

S_Data = S_Data[!is.na(S_Data$Exclude),]

##
## one-state-data
##
S_P_Data_os <- read.csv(paste(root_dir, "Scz_Individual_Weights_one_state_HMM.csv", sep = ""))
colnames(S_P_Data_os) <- c('Stimulus','Bias','PS', 'ID')
S_P_Data_os = S_P_Data_os[S_P_Data_os$ID %in% unique(S_Data$ID),]

S_P_Data_os$'Stimulus-PS' = S_P_Data_os$Stimulus - S_P_Data_os$PS
S_P_Data_os$Mode = NA

S_P_Data_os$Group = "Controls"
S_P_Data_os$Group[S_P_Data_os$ID %in% unique(S_Data[S_Data$Group == "Patients",]$ID)] = "Patients"

S_P_Data_os$Group <- factor(S_P_Data_os$Group, levels = c("Patients", "Controls"))

gathercol <- colnames(S_P_Data_os[, c(1:3,5)])
S_P_Data_os_long <- gather(S_P_Data_os, "Variable", "value", gathercol, factor_key = TRUE)

S_P_Data_os_long$num_states = 1

S_P_Data_long = rbind(S_P_Data_long, S_P_Data_os_long)

Group_S_P_Data_long <-
    ddply(
      S_P_Data_long,
      .(Variable, Mode, Group, num_states),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

S_difference_in_os_betas = S_P_Data_long[S_P_Data_long$Group == "Patients" &
                                       S_P_Data_long$num_states == 1 &
                                       S_P_Data_long$Variable == "Stimulus-PS",]$value -
 S_P_Data_long[S_P_Data_long$Group == "Controls" &
                                       S_P_Data_long$num_states == 1 &
                                       S_P_Data_long$Variable == "Stimulus-PS",]$value

##
## HMM Model Comparison 
##
S_HMM_BIC = read.csv(paste(root_dir, "Scz_Full_group_BIC_across_models.csv", sep = ""))
S_Stimulus_HMM_BIC = read.csv(paste(root_dir, "Scz_Full_group_BIC_across_models_STIMULUS.csv", sep = ""))


##
## Questionnaire_Data
##
Quest = read.csv(paste(root_dir, "Scz_Quest.csv", sep = ""))
Quest  = Quest [Quest$subject %in% unique(S_Data$ID),]

Quest$PDI = Quest$PDI_conviction + Quest$PDI_distress + Quest$PDI_occupation
Quest$CAPS = Quest$CAPS_distress + Quest$CAPS_distress + Quest$CAPS_intrusive
```

```{r Scz_choices_by_stimulus_ps_treatment_mode}
##
## choice ~ stimulus
##
S_Summary_Choice <-
    ddply(
      S_Data,
      .(w_Stimulus, Group,ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

gathercol <- colnames(S_Summary_Choice[, 4:ncol(S_Summary_Choice)])
S_Summary_Choice_long <- gather(S_Summary_Choice, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_long <-
    ddply(
      S_Summary_Choice_long,
      .(w_Stimulus, Group, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + Percept_minus_1
##
S_Summary_Choice_ps <-
    ddply(
      S_Data,
      .(w_Stimulus, Group, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

S_Summary_Choice_ps$Percept_minus_1 = (S_Summary_Choice_ps$Percept_minus_1 + 1)/2
S_Summary_Choice_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(S_Summary_Choice_ps$Percept_minus_1), sep = " ")
S_Summary_Choice_ps= S_Summary_Choice_ps[S_Summary_Choice_ps$Percept_minus_1 != "y(t-1) = NA",]

gathercol <- colnames(S_Summary_Choice_ps[, 5:ncol(S_Summary_Choice_ps)])
S_Summary_Choice_ps_long <- gather(S_Summary_Choice_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_ps_long <-
    ddply(
      S_Summary_Choice_ps_long[!is.na(S_Summary_Choice_ps_long$Percept_minus_1), ],
      .(w_Stimulus, Group, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )
Group_S_Summary_Choice_ps_long$Mode = "unimodal"

##
## choice ~ stimulus + mode
##
S_Summary_Choice_mode <-
    ddply(
       S_Data,
      .(w_Stimulus, Group, Mode, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

gathercol <- colnames(S_Summary_Choice_mode[, 5:ncol(S_Summary_Choice_mode)])
S_Summary_Choice_mode_long <- gather(S_Summary_Choice_mode, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_mode_long <-
    ddply(
      S_Summary_Choice_mode_long,
      .(w_Stimulus, Group, Mode, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + mode + ps
##
S_Summary_Choice_mode_ps <-
    ddply(
       S_Data,
      .(w_Stimulus, Group, Mode, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      RT = mean(RT, na.rm = TRUE)
    )

S_Summary_Choice_mode_ps$Percept_minus_1 = (S_Summary_Choice_mode_ps$Percept_minus_1 + 1)/2
S_Summary_Choice_mode_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(S_Summary_Choice_mode_ps$Percept_minus_1), sep = " ")
S_Summary_Choice_mode_ps= S_Summary_Choice_mode_ps[S_Summary_Choice_mode_ps$Percept_minus_1 != "y(t-1) = NA",]

gathercol <- colnames(S_Summary_Choice_mode_ps[, 6:ncol(S_Summary_Choice_mode_ps)])
S_Summary_Choice_mode_ps_long <- gather(S_Summary_Choice_mode_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_S_Summary_Choice_mode_ps_long <-
    ddply(
      S_Summary_Choice_mode_ps_long,
      .(w_Stimulus, Group, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

Group_S_Summary_Choice_mode_ps_no_group_long <-
    ddply(
      S_Summary_Choice_mode_ps_long,
      .(w_Stimulus, Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

S_Summary_Data_no_mode <-
    ddply(
      S_Data,
      .(uDisambiguation, Group, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE),
      Stability = mean(Stability, na.rm = TRUE),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

#Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA
gathercol <- colnames(S_Summary_Data_no_mode[, 4:ncol(S_Summary_Data_no_mode)])
S_Summary_Data_no_mode_long <- gather(S_Summary_Data_no_mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_S_Summary_Data_no_mode_long <-
    ddply(
     S_Summary_Data_no_mode_long,
      .(uDisambiguation, Group, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

S_Summary_Data_no_mode_con <-
    ddply(
      S_Data,
      .(uDisambiguation, Group, cond_Accuracy, ID),
      summarise,
      Stability = mean(Stability, na.rm = TRUE),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

#Summary_Data_no_mode[Summary_Data_no_mode == "NaN"] = NA
gathercol <- colnames(S_Summary_Data_no_mode_con[, 5:ncol(S_Summary_Data_no_mode_con)])
S_Summary_Data_no_mode_con_long <- gather(S_Summary_Data_no_mode_con, "Variable", "value", gathercol, factor_key = TRUE)

Group_S_Summary_Data_no_mode_con_long <-
    ddply(
      S_Summary_Data_no_mode_con_long,
      .(uDisambiguation, Group, cond_Accuracy, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )


##
## STATS
##
S_Data$cond_Accuracy = as.factor(S_Data$cond_Accuracy)
if (!load_summary_data) {
  
accuracy_by_GD = glmer(Accuracy ~ uDisambiguation * Group + (1 | Group/ID), data = S_Data, family = binomial(link = logit))
STAT.accuracy_by_GD = summary(accuracy_by_GD)

stability_by_GDC = glmer(Stability ~ uDisambiguation*Group*cond_Accuracy  + (1  | Group/ID), data = S_Data[S_Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.stability_by_GDC = summary(stability_by_GDC)

accuracy_by_GDM = glmer(Accuracy ~ uDisambiguation * Sl_Prob_State_ext * Group + (1|Group/ID), data = S_Data, family = binomial(link = logit))
STAT.accuracy_by_GDM = summary(accuracy_by_GDM)

stability_by_GDMC = glmer(Stability ~ uDisambiguation * Sl_Prob_State_ext * Group * cond_Accuracy  + (1 | Group/ID), data = S_Data[S_Data$cond_Accuracy != "ambiguous",], family = binomial)
STAT.stability_by_GDMC = summary(stability_by_GDMC)

##
## Choices
##
y_choice_by_SGP = glmer(y_choice ~ 1 + w_Stimulus * Group * Percept_minus_1 + (1  | Group/ID), data = S_Data, family = binomial(link = logit))
STAT.y_choice_by_SGP = summary(y_choice_by_SGP)

y_choice_by_SGPM = glmer(y_choice ~ 1 + w_Stimulus * Group * Percept_minus_1 * Mode + (1 | Group/ID), data = S_Data, family = binomial(link = logit))
STAT.y_choice_by_SGPM = summary(y_choice_by_SGPM)

##
## RT
##
RT_by_SGP = lmer(RT ~ 1 + poly(w_Stimulus,2) * Group * Percept_minus_1 + (1 | Group/ID), data = S_Data)
STAT.RT_by_SGP = summary(RT_by_SGP)

RT_by_SGPM = lmer(RT ~ 1 + poly(w_Stimulus,2) * Group * Percept_minus_1 * Mode + (1 | Group/ID), data = S_Data)
STAT.RT_by_SGPM = summary(RT_by_SGPM)

  if (save_summary_data) {
    save(STAT.accuracy_by_GD, accuracy_by_GD, 
         STAT.stability_by_GDC, stability_by_GDC,
         STAT.accuracy_by_GDM, accuracy_by_GDM, 
         STAT.stability_by_GDMC, stability_by_GDMC,
         STAT.y_choice_by_SGP, y_choice_by_SGP,
         STAT.y_choice_by_SGPM, y_choice_by_SGPM,
         STAT.RT_by_SGP, RT_by_SGP,
         STAT.RT_by_SGPM, RT_by_SGPM,
         file = "./Results/R_summary_scz_stats.Rdata")
  }
} else {
  load("./Results/R_summary_scz_stats.Rdata")
}

##
## Bonferroni
##
STAT.y_choice_by_SGP = bonferroni(STAT.y_choice_by_SGP)
STAT.y_choice_by_SGPM = bonferroni(STAT.y_choice_by_SGPM)

STAT.RT_by_SGP = bonferroni(STAT.RT_by_SGP)
STAT.RT_by_SGPM = bonferroni(STAT.RT_by_SGPM)

STAT.accuracy_by_GD = bonferroni(STAT.accuracy_by_GD)
STAT.stability_by_GDC = bonferroni(STAT.stability_by_GDC)
```

```{r Scz_mode_summary}
S_Summary_Mode  <-
    ddply(
      S_Data,
      .(Group, ID),
      summarise,
      external = mean(Sl_Prob_State_ext, na.rm = TRUE),
      internal = mean(1-Sl_Prob_State_ext, na.rm = TRUE),
      Mode_bool = (sum(Mode == "external", na.rm = TRUE)/length(Mode)),
      Mode_s = (sum(Mode_switch, na.rm = TRUE)/length(Mode)),
      EI = (sum(Mode_switch[Mode == "internal"] == 1, na.rm = TRUE)/length(Mode)),
      IE = (sum(Mode_switch[Mode == "external"] == 1, na.rm = TRUE)/length(Mode)),
      EE = (sum(Mode_switch[Mode == "external"] == 0, na.rm = TRUE)/length(Mode)),
      II = (sum(Mode_switch[Mode == "internal"] == 0, na.rm = TRUE)/length(Mode))
    )

gathercol <- colnames(S_Summary_Mode[, 3:ncol(S_Summary_Mode)])
S_Summary_Mode_long <- gather(S_Summary_Mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_S_Summary_Mode_long <-
    ddply(
      S_Summary_Mode_long,
      .(Variable, Group),
      summarise,
      mean = mean(value[is.finite(value)], na.rm = TRUE),
      error = sd(value[is.finite(value)], na.rm = TRUE)/sqrt(length(value[is.finite(value)]))
    )


if (!load_summary_data) {
  
S_EE = (S_Summary_Mode$EE[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$EE[S_Summary_Mode$Group == "Controls"])/100
S_II =  (S_Summary_Mode$II[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$II[S_Summary_Mode$Group == "Controls"])/100
S_EI = (S_Summary_Mode$EI[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$EI[S_Summary_Mode$Group == "Controls"])/100
S_IE =  (S_Summary_Mode$IE[S_Summary_Mode$Group == "Patients"] - S_Summary_Mode$IE[S_Summary_Mode$Group == "Controls"])/100

S_STAT.Mode_Group = wilcox.test(S_EE,S_II, paired = FALSE, "greater")
S_STAT.Mode_Group_2 = wilcox.test(S_IE,S_EI, paired = FALSE, "greater")

S_Mode_by_G = glmer(Session_Sl_Prob_State_ext ~ Group + (1 |Group), data = S_Data, family = binomial(link = logit))
S_STAT.Mode_by_G = summary(S_Mode_by_G)

S_Stimulus_by_MI = lmer(Stimulus ~ Mode*Group + (1 | Group/ID), data = S_P_Data)
S_STAT.Stimulus_by_MI = summary(S_Stimulus_by_MI)

S_Bias_by_MI = lmer(Bias ~ Mode*Group + (1 | Group/ID), data = S_P_Data)
S_STAT.Bias_by_MI = summary(S_Bias_by_MI)

S_PS_by_MI = lmer(PS ~ Mode*Group + (1 | Group/ID), data = S_P_Data)
S_STAT.PS_by_MI = summary(S_PS_by_MI)

S_Stimulus_PS_by_MI = lmer(Stimulus-PS ~ Mode*Group + (1 | Group/ID ), data = S_P_Data)
S_STAT.Stimulus_PS_by_MI = summary(S_Stimulus_PS_by_MI)

S_STAT.Mode_s_Group = t.test(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s, S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s)

  if (save_summary_data) {
    save(STAT.Mode_Intervention,
         S_STAT.Mode_by_G, 
         S_STAT.Mode_Group_2,
         S_STAT.Mode_by_G, S_Mode_by_G,
         S_STAT.Stimulus_by_MI, S_Stimulus_by_MI,
         S_STAT.Bias_by_MI, S_Bias_by_MI,
         S_STAT.PS_by_MI, S_PS_by_MI,
         S_STAT.Stimulus_PS_by_MI, S_Stimulus_PS_by_MI, 
         S_STAT.Mode_s_Group,
         S_STAT.Mode_Group,
         file = "./Results/R_Summary_S_P_Modes.Rdata")
  }

} else {
  load("./Results/R_Summary_S_P_Modes.Rdata")
}

##
## Bonferroni correction
##
S_STAT.Mode_by_G = bonferroni(S_STAT.Mode_by_G)
S_STAT.Stimulus_by_MI = bonferroni(S_STAT.Stimulus_by_MI)
S_STAT.Bias_by_MI = bonferroni(S_STAT.Bias_by_MI)
S_STAT.PS_by_MI = bonferroni(S_STAT.PS_by_MI)
S_STAT.Stimulus_PS_by_MI = bonferroni(S_STAT.Stimulus_PS_by_MI)
```

```{r Scz_questionnaire_data, cache = TRUE}
##
## Integrate questionnaire data
##
S_Summary_Mode$PDI = NA
S_Summary_Mode$CAPS = NA
S_Summary_Mode$P1 = NA
S_Summary_Mode$P3 = NA
S_Summary_Mode$Threshold = NA

S_P_Data$PDI = NA
S_P_Data$CAPS = NA
S_P_Data$P1 = NA
S_P_Data$P3 = NA
S_P_Data$Threshold = NA

SumData$subject = Quest$subject
for (idx in unique(Quest$subject)){
S_Summary_Mode$PDI[S_Summary_Mode$ID == idx] = Quest$PDI[Quest$subject == idx]
S_Summary_Mode$CAPS[S_Summary_Mode$ID == idx] = Quest$CAPS[Quest$subject == idx] 
S_Summary_Mode$P1[S_Summary_Mode$ID == idx] = Quest$P1[Quest$subject == idx] 
S_Summary_Mode$P3[S_Summary_Mode$ID == idx] = Quest$P3[Quest$subject == idx]
S_Summary_Mode$Threshold[S_Summary_Mode$ID == idx] = SumData$Acuity[SumData$subject == idx]*100

S_P_Data$PDI[S_P_Data$ID == idx] = Quest$PDI[Quest$subject == idx]
S_P_Data$CAPS[S_P_Data$ID == idx] = Quest$CAPS[Quest$subject == idx] 
S_P_Data$P1[S_P_Data$ID == idx] = Quest$P1[Quest$subject == idx] 
S_P_Data$P3[S_P_Data$ID == idx] = Quest$P3[Quest$subject == idx] 
S_P_Data$Threshold[S_P_Data$ID == idx] = SumData$Acuity[SumData$subject == idx]*100
}

S_Quest_to_Mode = glmer(external ~ PDI*Group + CAPS*Group + (1|ID), data = S_Summary_Mode, family = binomial)
S_STAT.Quest_to_Mode = summary(S_Quest_to_Mode)

SP_Quest_to_Mode = glmer(external ~ P1 + P3 + (1|ID), data = S_Summary_Mode, family = binomial)
SP_STAT.Quest_to_Mode = summary(SP_Quest_to_Mode)

S_STAT.Threshold = wilcox.test(S_P_Data$Threshold[S_P_Data$Group == "Patients"], S_P_Data$Threshold[S_P_Data$Group == "Controls"])
S_Threshold_to_Mode = glmer(external ~ Threshold*Group + (1|ID), data = S_Summary_Mode, family = binomial)
S_STAT.Threshold_to_Mode = summary(S_Threshold_to_Mode)
S_STAT.Threshold_to_Mode = bonferroni(S_STAT.Threshold_to_Mode)
```

Next, we performed the same analysis on data from a previous case-control study using an analogous task in patients with Scz[@weilnhammer_psychotic_2020]. In Scz patients and controls, $y_t$ was influenced by the SAR-weighted input $s_t$ ($\beta$ = $`r STAT.y_choice_by_SGP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[2,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[2,4]`$) and the stabilizing prediction $y_{t-1}$ ($\beta$ = $`r STAT.y_choice_by_SGP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[4,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[4,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[4,4]`$). Similar to S-ketamine, $s_t$ had a larger impact on perception in Scz patients than controls ($\beta$ = $`r -STAT.y_choice_by_SGP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[5,4]`$, Figure 2E and Supplemental Figure S4). 

Together, these results align with the canonical predictive processing theory of Scz[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]: Pharmacologically-induced NMDAR hypofunction and Scz are associated with a shift of perceptual inference toward external inputs, and away from stabilizing internal predictions. This increase in sensory precision (relative to prior precision) is often framed as a failure of sensory attenuation, i.e., the inability to attenuate sensory precision or, psychologically, ignore unclear or irrelevant sensations[@blakemore_spatio-temporal_1999; @limanowski_dis-_2017; @oestreich_subnormal_2015; @shergill_evidence_2005]. In the artificial setting of our experiment, where stimuli are random, weak internal predictions under S-ketamine and in Scz lead to *increased* perceptual accuracy. In autocorrelated natural environments, however, NMDAR hypofunction may trigger psychotic experiences by causing erratic inferences about ambiguous sensory information. 

## NMDAR-dependent changes of perceptual inference stem from an altered balance between external and internal modes of perception

As a mechanism for symptoms that are transient and recurring, NMDAR-dependent changes in perceptual inference should not be constant, but fluctuate dynamically at a timescale that is compatible with the duration of individual psychotic experiences. We tested this prediction in Hidden Markov Models (HMM) that inferred transitions between two latent states, each linked to an independent general linear model (GLM) that predicted $y_t$ from $s_t$ and $y_{t-1}$. The $\beta$ weights quantified the sensitivity to ambiguous sensory information ($\beta_S \times s_t$) relative to the stabilizing effect of internal predictions provided by preceding experiences ($\beta_{P} \times y_{t-1}$), and allowed us to evaluate dynamic changes in the balance $\Delta_{S-P} = \beta_S - \beta_P$ between the two. 

Consistent with recent findings in humans and mice[@ashwood_mice_2022; @weilnhammer_sensory_2023], Bayesian model comparison indicated a clear superiority of the two-state GLM-HMM over the standard one-state GLM in the S-ketamine experiment ($\delta_{BIC}$ = $`r HMM_BIC[HMM_BIC$num_states == 2,]$BIC - HMM_BIC[HMM_BIC$num_states == 1,]$BIC`$). According to the two-state GLM-HMM, perception fluctuated between an internal mode, shaped by the stabilizing internal prediction $y_{t-1}$, and an external mode, dominated by the SAR-weighted input $s_t$. External mode increased $\Delta_{S-P}$ by $`r  -STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[2,2]`$ (T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[2,5]`$, Figure 2B-C). 
Switches between modes occurred in intervals of $`r 1.5/mean(Summary_Mode$Mode_s, na.rm = TRUE)`$ ±  $`r (1.5/sd(Summary_Mode$Mode_s, na.rm = TRUE))/sqrt(length(Summary_Mode$Mode_s))`$ sec. 

The presence of slow fluctuations between external and internal modes suggests that, instead of causing a constant increase in the sensitivity to external inputs, NMDAR hypofunction may affect perception by shifting the dynamic balance between the two modes. Indeed, S-ketamine did not alter the weights of the two-state GLM-HMM (Figure 2C), but increased the probability of external at the expense of internal mode ($\beta$ = $`r -STAT.Mode_by_I$coefficients[2,1]`$ ± $`r STAT.Mode_by_I$coefficients[2,2]`$, z = $`r -STAT.Mode_by_I$coefficients[2,3]`$, p = $`r STAT.Mode_by_I$coefficients[2,4]`$, Figure 2D) via an effect on the stay transitions of the HMM (external-to-external and internal-to-internal, Supplemental Figure S3D). This effect was stable over time, and present across the full range of SAR (Figure 2D). Inter-individual differences in the effects of S-ketamine confirmed that NMDAR hypofunction raised the sensitivity to sensory information (Figure 2A) by modulating the time participants spent in external and internal modes, respectively ($\rho$ = $`r STAT.bimodal_to_unimodal$estimate`$, T($`r STAT.bimodal_to_unimodal$parameter`$) = $`r STAT.bimodal_to_unimodal$statistic`$, p = $`r STAT.bimodal_to_unimodal$p.value`$). Our results therefore suggest that the failure of sensory attenuation observed under S-ketamine corresponds to an inability to disengage the external mode of perception. Through the lens of predictive processing, the external mode reflects a state of perception that is characterized by an increase in sensory precision at the expense of prior precision. Crucially, it is this balance between sensory and prior precision that determines the Kalman gain [@mathys_bayesian_2011; @Iglesias2013]. In other words, what matters in terms of perceptual inference are the dynamic changes in relative precision over time.

Strikingly, the data from the Scz-control study mirrored the effect of S-ketamine on the balance between external and internal mode: The two-state GLM-HMM outperformed the standard one-state GLM  (patients: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Patients" & S_HMM_BIC$states == 2,]$BIC - S_HMM_BIC[S_HMM_BIC$Group == "Patients" & S_HMM_BIC$states == 1,]$BIC`$; controls: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Controls" & S_HMM_BIC$states == 2,]$BIC - S_HMM_BIC[S_HMM_BIC$Group == "Controls" & S_HMM_BIC$states == 1,]$BIC`$) and revealed two opposing modes ($\Delta_{S-P}$ = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,5]`$, Figure 2F) 
that alternated in intervals of $`r 3.33/mean(S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s, na.rm = TRUE)`$ ±  $`r (3.33/sd(S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s, na.rm = TRUE))/sqrt(length(S_Summary_Mode[S_Summary_Mode$Group == "Patients",]$Mode_s))`$ sec for patients 
and $`r 3.33/mean(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s, na.rm = TRUE)`$ ±  $`r (3.33/sd(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s, na.rm = TRUE))/sqrt(length(S_Summary_Mode[S_Summary_Mode$Group == "Controls",]$Mode_s))`$ sec for controls. 
Patients and controls did not differ with respect to the weights of the two-state GLM-HMM (Figure 2G). 
Instead, Scz patients spent more time in external mode ($\beta$ = $`r -S_STAT.Mode_by_G$coefficients[2,1]`$ ± $`r S_STAT.Mode_by_G$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_G$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_G$coefficients[2,4]`$, Figure 2H and Supplemental Figure 4D). 

```{r params_versus_quest, fig.height = 7}
Dyn_Quest_long$Mode = "internal"
Dyn_Quest_long[Dyn_Quest_long$external > 0.5,]$Mode = "external"
ID_Dyn_Quest = ddply(
      Dyn_Quest_long,
      .(ID, Mode, Variable),
      summarise,
      avg_score = mean(Score, na.rm = TRUE)
    )

ID_Param = 
  ddply(
      P_Data_long[P_Data_long$Variable == "Stimulus-PS" & P_Data_long$Intervention != "None" & P_Data_long$Mode %in% c("external", "internal"),],
      .(ID, Variable, Mode),
      summarise,
      avg_delta = mean(value, na.rm = TRUE)
    )

ID_ = 
  ddply(
      P_Data_long[P_Data_long$Variable == "Stimulus-PS" & P_Data_long$Intervention != "None" & P_Data_long$Mode %in% c("external", "internal"),],
      .(ID, Variable, Mode),
      summarise,
      avg_delta = mean(value, na.rm = TRUE)
    )

merged_df <- merge(ID_Dyn_Quest[ID_Dyn_Quest$Variable != "Q4",], ID_Param, by = c("ID", "Mode"), suffixes = c("_score", "_delta"))

reshaped_df <- merged_df %>%
  spread(key = Variable_score, value = avg_score)

STAT.delta_mode_controlled = summary(lmer(avg_delta ~ Mode * Q1 + Mode * Q2 + Mode * Q3 + (1 | ID), data = reshaped_df))
STAT.delta_mode_controlled = bonferroni(STAT.delta_mode_controlled)
##
## 
##

ID_Dyn_Quest_Intervention = ddply(
      Dyn_Quest_long,
      .(ID, Intervention, Variable),
      summarise,
      avg_score = mean(scale(Score), na.rm = TRUE)
    )

merged_df_Intervention <- merge(ID_Dyn_Quest_Intervention[ID_Dyn_Quest_Intervention$Variable != "Q4",], Data[Data$Intervention != "None",], by = c("ID", "Intervention"), suffixes = c("_score", "_mode"))
reshaped_df_Intervention <- merged_df_Intervention %>%
  spread(key = Variable, value = avg_score)


if (!load_summary_data) {

model_alternative <- glmer(Session_Sl_Prob_State_ext ~ Intervention + (1 + Q1 | ID), 
                           data = Data[Data$Intervention != "None", ], 
                           family = binomial(link = logit), 
                           control = glmerControl(optimizer = "bobyqa"))
STAT.mode_controlled_Q1 = summary(model_alternative)

model_alternative <- glmer(Session_Sl_Prob_State_ext ~ Intervention + (1 + Q2 | ID), 
                           data = Data[Data$Intervention != "None", ], 
                           family = binomial(link = logit), 
                           control = glmerControl(optimizer = "bobyqa"))
STAT.mode_controlled_Q2 = summary(model_alternative)

model_alternative <- glmer(Session_Sl_Prob_State_ext ~ Intervention + (1 + Q3 | ID), 
                           data = Data[Data$Intervention != "None", ], 
                           family = binomial(link = logit), 
                           control = glmerControl(optimizer = "bobyqa"))
STAT.mode_controlled_Q3 = summary(model_alternative)

  if (save_summary_data) {
    save(STAT.mode_controlled_Q1, STAT.mode_controlled_Q2, STAT.mode_controlled_Q3,
         file = "./Results/R_summary_param_vs_quest.Rdata")
  }
} else {
  load("./Results/R_summary_param_vs_quest.Rdata")
}

```

## External and internal modes are perceptual phenomena that cannot be reduced to fluctuations in arousal, fatigue, task engagement, or task difficulty

Our results suggest that healthy participants under S-ketamine and Scz patients spend more time in the external mode. As a dynamic mechanism for psychotic experiences, alternations between external and internal mode should have an effect at the level of perception. This means that between-mode alternations should modulate a perceptual decision variable that determines not only what is consciously experienced, but also how the contents of perception are evaluated by downstream cognition. The hypothesis that external and internal modes are perceptual phenomena needs to be contrasted against alternative scenarios in which external and internal modes are driven primarily by fluctuations in arousal, high-level cognition, or executive function. 

```{r posterior_certainty}
# Load required packages
library(dplyr)

# Step 1: Shift the Percept column back by one
Data <- Data %>%
  group_by(ID, session_id) %>%
  mutate(Percept_minus_1 = lag(Percept, default = 0)) %>%
  mutate(w_Stimulus_minus_1 = lag(w_Stimulus, default = 0)) %>%
  ungroup()

# Compute p_os without joining the dataframes
Data <- Data %>%
  mutate(
    p = (Stimulus * P_Data$Stimulus[match(interaction(ID, session_id, Mode), 
                                           interaction(P_Data$ID, P_Data$session_id, P_Data$Mode))]) +
        (P_Data$Bias[match(interaction(ID, session_id, Mode), 
                           interaction(P_Data$ID, P_Data$session_id, P_Data$Mode))]) +
        (P_Data$PS[match(interaction(ID, session_id, Mode), 
                         interaction(P_Data$ID, P_Data$session_id, P_Data$Mode))] * Percept_minus_1),
    
    p_os = (Stimulus * P_Data_os$Stimulus[match(interaction(ID, session_id), 
                                                interaction(P_Data_os$ID, P_Data_os$session_id))]) +
           (P_Data_os$Bias[match(interaction(ID, session_id), 
                                 interaction(P_Data_os$ID, P_Data_os$session_id))]) +
           (P_Data_os$PS[match(interaction(ID, session_id), 
                               interaction(P_Data_os$ID, P_Data_os$session_id))] * Percept_minus_1)
  )


# Compute C for p
Data <- Data %>%
  mutate(
    C_p = y_choice * log(sigmoid(p)) + (1 - y_choice) * log(1 - sigmoid(p)),
    
    C_p_os = y_choice * log(sigmoid(p_os)) + (1 - y_choice) * log(1 - sigmoid(p_os))
  )


if (!load_summary_data) {



corr_certainty_p = glmer(Confidence == 1 ~ C_p*Mode + (1 | ID), 
                           data = Data[Data$Intervention != "None", ], 
                           family = binomial(link = logit), 
                           control = glmerControl(optimizer = "bobyqa"))
STAT.corr_certainty_p = summary(corr_certainty_p)
BIC.corr_certainty_p = BIC(corr_certainty_p)

corr_certainty_p_os = glmer(Confidence == 1 ~ C_p_os + (1 | ID), 
                           data = Data[Data$Intervention != "None", ], 
                           family = binomial(link = logit), 
                           control = glmerControl(optimizer = "bobyqa"))
STAT.corr_certainty_p_os = summary(corr_certainty_p_os)
BIC.corr_certainty_p_os = BIC(corr_certainty_p_os)

corr_certainty_p_stim = glmer(Confidence == 1 ~ w_Stimulus + (1 | ID), 
                           data = Data[Data$Intervention != "None", ], 
                           family = binomial(link = logit), 
                           control = glmerControl(optimizer = "bobyqa"))
STAT.corr_certainty_p_stim = summary(corr_certainty_p_stim)
BIC.corr_certainty_p_stim = BIC(corr_certainty_p_stim)


  if (save_summary_data) {
    save(STAT.corr_certainty_p, BIC.corr_certainty_p,
         STAT.corr_certainty_p_os, BIC.corr_certainty_p_os,
         STAT.corr_certainty_p_stim, BIC.corr_certainty_p_stim,
          file = "./Results/posterior_certainty.Rdata")
  }

} else {
  load( "./Results/posterior_certainty.Rdata")
}
```

```{r metacognition, cache = TRUE}

Summary_Mode_Confidence <-
    ddply(
      Data[!is.na(Data$Intervention) & Data$Intervention != "None" & Data$Include > -1,],
      .(Mode, ID),
      summarise,
      confidence = mean(Confidence == 1, na.rm = TRUE)
    )



if (!load_summary_data) {

 source("./Functions/f_compute_metacognition_ketamine.R", local = knitr::knit_global())
  Metacognitive = data.frame()
  for (id in unique(Data$ID)) {
    print(id)
    for (int_id in unique(Data[Data$Intervention != "None",]$Intervention)) {
      for (mode_id in unique(Data$Mode)) {
        index = (Data$ID == id & Data$Intervention == int_id & Data$Mode == mode_id & Data$Stimulus != 0)
        
        Add_Metacognitive = data.frame(
          ID = id,
          Intervention = int_id,
          Mode = mode_id,
          sensitivity = NA,
          bias = NA,
          dprime = NA,
          meta_dprime = NA,
          meta_dprime_ratio = NA
        )
        
        if (length(unique(Data[index,]$Confidence)) > 1){
          ##
          ## metacognitive sensitivity
          ##
          
          Add_Metacognitive$sensitivity <-
            glm((Data$Confidence + 1) / 2 ~ as.numeric(Data$Congruency),
                data = Data[index,])$coefficients[2]
          Add_Metacognitive$bias <-
            glm((Data$Confidence + 1) / 2 ~ as.numeric(Data$Congruency),
                data = Data[index,])$coefficients[1]
          
          
          ##
          ## Model-based
          ##
          
          Meta_Input = data.frame(
            rating = as.factor(Data[index, ]$Confidence),
            stimulus = as.factor(Data[index, ]$Stimulus),
            correct = as.numeric(Data[index, ]$Congruency),
            participant = Data[index, ]$ID
          )
          
          #Meta_Input = Meta_Input[!is.na(Meta_Input$correct), ]
          
          Meta_Output = fitMetaDprime(
            Meta_Input,
            model = "ML",
            nInits = 5,
            nRestart = 3,
            .parallel = FALSE,
            n.cores = NULL
          )
          Add_Metacognitive$dprime = Meta_Output$dprime
          Add_Metacognitive$meta_dprime = Meta_Output$metaD
          Add_Metacognitive$meta_dprime_ratio = Meta_Output$Ratio
        }
        
        Metacognitive = rbind(Metacognitive, Add_Metacognitive)
      }
    }
  }
  
gathercol <- colnames(Metacognitive[, c(4:ncol(Metacognitive))])
Metacognitive_long = gather(Metacognitive, "Variable", "value", gathercol, factor_key = TRUE)
  
Group_Metacognitive <-
    ddply(
      Metacognitive_long,
      .(Intervention, Mode, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

meta_dprime = lmer(meta_dprime ~ Mode*Intervention + (1|ID), data = Metacognitive)
STAT.meta_dprime = summary(meta_dprime)

##
##
##
Data$reformat_Confidence = 0
Data$reformat_Confidence[Data$Confidence == 1] = 1
Data$reformat_Accuracy = as.numeric(Data$Accuracy)
Data$Congruency <- ifelse(Data$Congruency == "True", TRUE, 
                          ifelse(Data$Congruency == "False", FALSE, NaN))
Data$reformat_Congruency = as.numeric(Data$Congruency)

STAT.phi_corr = summary(glmer(reformat_Confidence ~ reformat_Accuracy*Mode + (1 | ID), 
                           data = Data[Data$Intervention != "None", ], 
                           family = binomial(link = logit), 
                           control = glmerControl(optimizer = "bobyqa")))

  if (save_summary_data) {
    save(Metacognitive, Metacognitive_long, Group_Metacognitive, STAT.phi_corr,
         STAT.meta_dprime, meta_dprime,
         file = "./Results/R_Metacognition.Rdata")
  }

} else {
  load("./Results/R_Metacognition.Rdata")
}

##
## Bonferroni
##
STAT.meta_dprime = bonferroni(STAT.meta_dprime)
```

To address these alternative accounts, we first performed additional tests to support our claim that external and internal mode operate at the level of perception. External and internal modes are states of a GLM-HMM that integrates the external stimulus $s_t$ with the previous experience $y_{t-1}$ into a perceptual decision variable $P(y_t = 1)$. The parameters of the GLM-HMM are optimized to predict the sequence of perceptual experiences $y_t$ from $P(y_t = 1)$. If external and internal modes are perceptual phenomena, then the stabilization of perception should be driven by the sequence of experiences $y_t$, as opposed to the sequence of stimuli $s_t$. To test this hypothesis, we compared our *experienced-based* GLM-HMM, in which the stabilizing internal predictions are driven by the participants' perceptual experience at the preceding overlap, with an alternative *stimulus-based* GLM, in which the stabilizing internal predictions are driven by the stimulus presented at the preceding overlap. Bayesian model comparison indicated that the experienced-based GLM-HMM was better at explaining our data than a stimulus-based GLM-HMM in the S-ketamine experiment ($\delta_{BIC}$ = $`r HMM_BIC$BIC[2] - Stimulus_HMM_BIC$BIC[2]`$) and the case-control study (patients: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Patients",]$BIC[2] - S_HMM_BIC[S_HMM_BIC$Group == "Patients",]$BIC[1]`$; controls: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Controls",]$BIC[2] - S_HMM_BIC[S_HMM_BIC$Group == "Controls",]$BIC[1]`$).

Moreover, if external and internal modes are perceptual phenomena, then the decision variable $P(y_t = 1)$ should not only determine the contents of perception, but also metacognitive processes that depend on them. To assess this prediction, we tested whether the posterior certainty $C_t$ at which the GLM-HMM predicted the content of perception, i.e., the log probability of the experience $y_t$ given the decision variable $P(y_t = 1)$ ($C_t = y_t \cdot \log(P(y_t = 1)) + (1 - y_t) \cdot \log(1 - P(y_t = 1))$), would correlate with the confidence reports $c_t$ in the S-ketamine experiment. This test is a powerful validation of our approach, since the GLM-HMM was only fitted to binary perceptual states $y_t$, and not to the confidence $c_t$ at which they were reported. Indeed, $C_t$ predicted the confidence reports $c_t$($\beta$ = $`r STAT.corr_certainty_p$coefficients[2,1]`$ ± $`r  STAT.corr_certainty_p$coefficients[2,2]`$, z = $`r STAT.corr_certainty_p$coefficients[2,3]`$, p = $`r STAT.corr_certainty_p$coefficients[2,4]`$) without an interaction with mode ($\beta$ = $`r STAT.corr_certainty_p$coefficients[4,1]`$ ± $`r  STAT.corr_certainty_p$coefficients[4,2]`$, z = $`r STAT.corr_certainty_p$coefficients[4,3]`$, p = $`r STAT.corr_certainty_p$coefficients[4,4]`$), confirming that the positive correlation between posterior certainty and confidence was present in both external and internal modes. $C_t$ extracted from the two-state GLM-HMM was better at explaining confidence than the one-state control GLM ($\delta_{BIC}$ = `r BIC.corr_certainty_p - BIC.corr_certainty_p_os`), and the one-state stimulus GLM ($\delta_{BIC}$ = `r BIC.corr_certainty_p - BIC.corr_certainty_p_stim`).

As a consequence, internal mode should be associated with lower metacognitive performance (i.e., the degree to which confidence correlates accuracy), since stabilizing internal predictions have a larger effect on perception in the internal mode, and cause experiences $y_t$ to be less constrained by the external input $s_t$. Indeed, accuracy was predictive of high confidence ($\beta$ = $`r STAT.phi_corr$coefficients[2,1]`$ ± $`r  STAT.phi_corr$coefficients[2,2]`$, z = $`r STAT.phi_corr$coefficients[2,3]`$, p = $`r STAT.phi_corr$coefficients[2,4]`$), but to a lesser degree during the internal mode ($\beta$ = $`r STAT.phi_corr$coefficients[4,1]`$ ± $`r  STAT.phi_corr$coefficients[4,2]`$, z = $`r STAT.phi_corr$coefficients[4,3]`$, p = $`r STAT.phi_corr$coefficients[4,4]`$). In line with this, metacognitive sensitivity, as measured by meta-d', was significantly lower in the internal mode ($\beta$ = $`r  STAT.meta_dprime$coefficients[2,1]`$ ± $`r STAT.meta_dprime$coefficients[2,2]`$, T($`r STAT.meta_dprime$coefficients[2,3]`$) = $`r STAT.meta_dprime$coefficients[2,4]`$, p = $`r STAT.meta_dprime$coefficients[2,5]`$). 
Together, these findings support the hypothesis that external and internal modes modulate a low-level decision variable $P(y_t = 1)$ that determines the content of perception and their metacognitive evaluation.

Second, we asked whether fluctuations in global brain states can provide an alternative explanation for external and internal modes. One could assume that mode alternations could in fact reflect dynamic states of arousal, with high arousal and engaged behavior corresponding to the external mode, and low arousal and disengaged behavior corresponding to the internal mode. Our time-resolved assessment of internal states revealed reduced wakefulness (Q1) under S-ketamine (Supplemental Figure S6). This observation is clearly incompatible with the hypothesis that changes in the dynamics of mode are driven by low arousal under S-ketamine, since NMDAR antagonism increased the prevalence of the external mode, improving behavioral performance in the artificial setting of our experiment. When controlling for dynamic changes in wakefulness (Q1), subjective intoxication (Q2) and nervousness (Q3), the effect of S-ketamine on mode (p = $`r STAT.mode_controlled_Q1$coefficients[2,4]`$) and the effect of mode on $\Delta_{S-P}$ remained significant (p = $`r STAT.delta_mode_controlled$coefficients[2,5]`$). We observed no additional effects of or interactions with Q1-3 that could explain the observed relations between S-ketamine, mode, and $\Delta_{S-P}$. Despite its positive effect on perceptual accuracy, external mode was associated with higher levels of dissociation in the S-ketamine experiment as measured by the  *Clinician-Administered-Dissociative-States-Scale*[@mertens_clinician-administered_2022] (CADSS, $\beta$ = $`r STAT.CADSS_Mode_Intervention$coefficients[2,1]`$ ± $`r STAT.CADSS_Mode_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Mode_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Mode_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Mode_Intervention$coefficients[2,5]`$, Supplemental Figure S6B). 

```{r RT_duration_sd_fatigue}
# Compute the variability (e.g., standard deviation) of RT within each ID for each mode

##
## Ketamine
##
variability_data <- 
    ddply(
      Data[Data$Intervention != "None",],
      .(Mode, ID),
      summarise,
      RT_sd = sd(RT, na.rm = TRUE)
    )

# Perform a paired Wilcoxon test to test the difference between external and internal mode
# First, reshape the data to have one row per ID and columns for each Mode's RT_sd
variability_wide <- variability_data %>%
  spread(key = Mode, value = RT_sd)

# Perform the Wilcoxon signed-rank test
variability_rt <- wilcox.test(variability_wide$external, variability_wide$internal, paired = TRUE)

##
## Scz
##
S_variability_data <- 
    ddply(
      S_Data,
      .(Mode, ID),
      summarise,
      RT_sd = sd(RT, na.rm = TRUE)
    )

# Perform a paired Wilcoxon test to test the difference between external and internal mode
# First, reshape the data to have one row per ID and columns for each Mode's RT_sd
S_variability_wide <- S_variability_data %>%
  spread(key = Mode, value = RT_sd)

# Perform the Wilcoxon signed-rank test
S_variability_rt <- wilcox.test(S_variability_wide$external, S_variability_wide$internal, paired = FALSE)


##
## Time and RT
##

##
## Ketamine
##
RT_Time_Data = subset(
  Data,
  select = c(
    overlap_index,
    block_id,
    RT,
    Intervention,
    uDisambiguation,
    ID
  ),
  subset = c(Intervention != "None")
)
RT_Time_Data$t = RT_Time_Data$overlap_index + max(RT_Time_Data$overlap_index) * (RT_Time_Data$block_id - 1)
RT_Time_Data$ut = RT_Time_Data$t/max(RT_Time_Data$t)

gathercol <- colnames(RT_Time_Data[,c(3,5)])
RT_Time_Data_long <- gather(RT_Time_Data, "Variable", "value", gathercol, factor_key = TRUE)

Summary_RT_Time_Data = ddply(
  RT_Time_Data,
  .(t, ID, Intervention),
  summarise,
  average = mean(RT, na.rm = TRUE))

Group_Summary_RT_Time_Data = ddply(
  Summary_RT_Time_Data,
  .(t, Intervention),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)


##
## Schizophrenia
##

S_RT_Time_Data = subset(
  S_Data,
  select = c(
    overlap_index,
    block_id,
    RT,
    Group,
    uDisambiguation,
    ID
  )
)

S_RT_Time_Data$counter <- NA
unique_ids <- unique(S_RT_Time_Data$ID)
# Loop through each unique ID
for (id in unique_ids) {
  # Filter the data for the current ID
  subset_data <- S_RT_Time_Data[S_RT_Time_Data$ID == id, ]
  
  # Calculate the counter for the current ID
  counter <- cumsum(c(TRUE, diff(subset_data$block_id) != 0))
  
  # Assign the counter back to the original data frame
  S_RT_Time_Data[S_RT_Time_Data$ID == id, "counter"] <- counter
}
S_RT_Time_Data$t = S_RT_Time_Data$overlap_index + max(S_RT_Time_Data$overlap_index) * (S_RT_Time_Data$block_id - 1)
S_RT_Time_Data$ut = S_RT_Time_Data$t/max(S_RT_Time_Data$t)

gathercol <- colnames(S_RT_Time_Data[,c(3,5)])
S_RT_Time_Data_long <- gather(S_RT_Time_Data, "Variable", "value", gathercol, factor_key = TRUE)

S_Summary_RT_Time_Data = ddply(
  S_RT_Time_Data,
  .(t, ID, Group),
  summarise,
  average = mean(RT, na.rm = TRUE))

Group_S_Summary_RT_Time_Data = ddply(
  S_Summary_RT_Time_Data,
  .(t, Group),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)


if (!load_summary_data) {
RT_by_time = lmer(
  log(RT) ~ ut*Intervention + (1 | ID),
  data = RT_Time_Data
)
STAT.RT_by_time = summary(RT_by_time)


S_RT_by_time = lmer(
  log(RT) ~ ut*Group + (1 | ID),
  data = S_RT_Time_Data
)
S_STAT.RT_by_time = summary(S_RT_by_time)

  if (save_summary_data) {
    save(RT_by_time, STAT.RT_by_time,
         S_RT_by_time, S_STAT.RT_by_time,
         file = "./Results/R_summary_RT_time")
  }
} else {
  load("./Results/R_summary_RT_time")
}
STAT.RT_by_time = bonferroni(STAT.RT_by_time)
S_STAT.RT_by_time = bonferroni(S_STAT.RT_by_time)

```

In addition to the time-resolved subjective reports on wakefulness obtained under S-ketamine and placebo (Supplemental Figure S6), response times ($r_t$) can provide an indirect measure of task engagement, with longer $r_t$ and higher RT variability as indicators of fatigue or disengagement[@kucyi_spontaneous_2016; @yamashita_variable_2021]. We found no significant effect of mode on $r_t$ in either the S-ketamine experiment ($\beta$ = $`r STAT.RT_by_STPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_STPM$coefficients[6,2]`$, z = $`r STAT.RT_by_STPM$coefficients[6,3]`$, p = $`r STAT.RT_by_STPM$coefficients[6,4]`$) or in the case-control study ($\beta$ = $`r STAT.RT_by_SGPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_SGPM$coefficients[6,2]`$, z = $`r STAT.RT_by_SGPM$coefficients[6,3]`$, p = $`r STAT.RT_by_SGPM$coefficients[6,4]`$). $r_t$ variability did not differ significantly between modes in the S-ketamine intervention (V = `r variability_rt$statistic`, p = `r variability_rt$p.value`) or in the case-control study (W = `r S_variability_rt$statistic`, p = `r S_variability_rt$p.value`). In both experiments, there was no main effect of time on $r_t$ (S-ketamine intervention: $\beta$ = $`r STAT.RT_by_time$coefficients[2,1]`$ ± $`r STAT.RT_by_time$coefficients[2,2]`$, T($`r STAT.RT_by_time$coefficients[2,3]`$) = $`r STAT.RT_by_time$coefficients[2,4]`$, p = $`r STAT.RT_by_time$coefficients[2,5]`$; case-control study: $\beta$ = $`r S_STAT.RT_by_time$coefficients[2,1]`$ ± $`r S_STAT.RT_by_time$coefficients[2,2]`$, T($`r S_STAT.RT_by_time$coefficients[2,3]`$) = $`r S_STAT.RT_by_time$coefficients[2,4]`$, p = $`r S_STAT.RT_by_time$coefficients[2,5]`$). We observed no time-by-intervention interaction ($\beta$ = $`r STAT.RT_by_time$coefficients[4,1]`$ ± $`r STAT.RT_by_time$coefficients[4,2]`$, T($`r STAT.RT_by_time$coefficients[4,3]`$) = $`r STAT.RT_by_time$coefficients[4,4]`$, p = $`r STAT.RT_by_time$coefficients[4,5]`$) nor a time-by-group interaction ($\beta$ = $`r S_STAT.RT_by_time$coefficients[4,1]`$ ± $`r S_STAT.RT_by_time$coefficients[4,2]`$, T($`r S_STAT.RT_by_time$coefficients[4,3]`$) = $`r S_STAT.RT_by_time$coefficients[4,4]`$, p = $`r S_STAT.RT_by_time$coefficients[4,5]`$), suggesting that interventions and groups did not differ with respect to fatigue.

```{r mode_by_time}
if (!load_summary_data) {
Mode_by_time = glmer(
  Session_Sl_Prob_State_ext ~ ut*Intervention + (1 |
                                     ID),
  data = Time_Data,
  family = binomial
)
STAT.Mode_by_time = summary(Mode_by_time)

Mode_by_difficulty = glmer(
  Session_Sl_Prob_State_ext ~ uDisambiguation*Intervention + (1 |
                                     ID),
  data = Time_Data[Time_Data$uDisambiguation,],
  family = binomial
)
STAT.Mode_by_difficulty = summary(Mode_by_difficulty)

S_Mode_by_time = glmer(
  Session_Sl_Prob_State_ext ~ ut*Group + (1 |
                                     ID),
  data = S_Time_Data,
  family = binomial
)
S_STAT.Mode_by_time = summary(S_Mode_by_time)

S_Mode_by_difficulty = glmer(
  Session_Sl_Prob_State_ext ~ uDisambiguation*Group + (1 |
                                     Group),
  data = S_Time_Data,
  family = binomial
)
S_STAT.Mode_by_difficulty = summary(S_Mode_by_difficulty)

  if (save_summary_data) {
    save(STAT.Mode_by_time, Mode_by_time,
         STAT.Mode_by_difficulty, Mode_by_difficulty,
         S_STAT.Mode_by_time, S_Mode_by_time,
         S_STAT.Mode_by_difficulty, S_Mode_by_difficulty,
         file = "./Results/R_summary_mode_time")
  }
} else {
  load("./Results/R_summary_mode_time")
}
STAT.Mode_by_time = bonferroni(STAT.Mode_by_time)
STAT.Mode_by_difficulty = bonferroni(STAT.Mode_by_difficulty)
S_STAT.Mode_by_time = bonferroni(S_STAT.Mode_by_time)
S_STAT.Mode_by_difficulty = bonferroni(S_STAT.Mode_by_difficulty)
```

Contrary to the natural dynamic of fatigue in psychophysical experiments, which increases over time, we observed no effect of time on the balance between modes in the S-ketamine experiment ($\beta$ = $`r STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  STAT.Mode_by_time$coefficients[2,2]`$, z = $`r STAT.Mode_by_time$coefficients[2,3]`$, p = $`r STAT.Mode_by_time$coefficients[2,4]`$, Figure 2D). In the case-control study, external mode even became more prevalent over time ($\beta$ = $`r S_STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  S_STAT.Mode_by_time$coefficients[2,2]`$, z = $`r S_STAT.Mode_by_time$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[2,4]`$), with a stronger effect in patients ($\beta$ = $`r -S_STAT.Mode_by_time$coefficients[4,1]`$ ± $`r S_STAT.Mode_by_time$coefficients[4,2]`$, z = $`r -S_STAT.Mode_by_time$coefficients[4,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[4,4]`$, Figure 2H). 

Furthermore, we found no evidence that external and internal modes reflect behavioral strategies that depend on task difficulty, such as using internal predictions only when the sensory information is unreliable: Individual stereodisparity thresholds were not correlated with inter-individual differences in mode (Supplemental Figure S6). Within participants, the balance between external and internal mode was only marginally modulated by the SAR of the stimulus (Figure 2D and H).

In sum, these findings suggest that the effect of S-ketamine on mode, and the effects of mode on the integration of external inputs with internal predictions ($\Delta_{S-P}$), are unlikely to be mediated by dynamic changes in arousal, fatigue, task engagement, or task difficulty. Rather, they indicate the NMDAR hypofunction under S-ketamine and in Scz has a direct impact on perceptual processing via its effect on mode.

```{r read_prepare_fMRI_behavior, cache = TRUE}
##
## load and prepare data
##
F_Data <- read.csv(paste(root_dir, "PE_fMRI_Full_HMM_Sessions.csv", sep = ""))
E2.Participants <- read_excel(paste(root_dir, "PE_Bistability_Participants.xlsx", sep = ""))
##
## Prepare Variables
##
## Data$Percept: 1 for rightward, -1 for leftward,-2 for unclear
## Data$Confidence: 1 for high confidence, -1 for low confidence, -2 for unclear

F_Data$Accuracy = F_Data$Percept == F_Data$Stimulus 
F_Data$Accuracy[F_Data$Stimulus == 0] = NA
F_Data$cond_Accuracy = F_Data$Accuracy
F_Data$cond_Accuracy[is.na(F_Data$cond_Accuracy)] = "ambiguous"
F_Data$cond_Accuracy[F_Data$cond_Accuracy == "FALSE"] = "stimulus-incongruent"
F_Data$cond_Accuracy[F_Data$cond_Accuracy == "TRUE"] = "stimulus-congruent"

F_Data$Stability = c(as.integer(diff(F_Data$Percept) == 0), NA)
F_Data[F_Data$overlap_index == max(F_Data$overlap_index),]$Stability = NA

F_Data$uDisambiguation = F_Data$Disambiguation
F_Data$Disambiguation = F_Data$Disambiguation * 100

F_Data$Percept_minus_1 = c(NA, F_Data$Percept[1:nrow(F_Data)-1])
F_Data$Percept_minus_1[F_Data$overlap_index] = NA

##
## Define Modes
##
F_Data$Mode = "internal"
F_Data$Mode[F_Data$Sl_Prob_State_ext > F_Data$Sl_Prob_State_int] = "external"
F_Data$Mode = as.factor(F_Data$Mode)

F_Data$Mode_con = F_Data$Sl_Prob_State_ext - F_Data$Sl_Prob_State_int
F_Data$Mode_switch = c(NA, diff(sign(F_Data$Mode_con)) != 0)

##
## load additional HMM data
##

F_P_Data <- read.csv(paste(root_dir, "PE_fMRI_Individual_Weights_HMM.csv", sep = ""))
F_P_Data = data.frame(rbind(data.matrix(F_P_Data[, c(1:3, 11)]), data.matrix(F_P_Data[, c(4:6, 11)])))
colnames(F_P_Data) <- c('Stimulus','Bias','PS', 'ID')
F_P_Data$'Stimulus-PS' = F_P_Data$Stimulus - F_P_Data$PS
F_P_Data$Mode = c(rep("external", nrow(F_P_Data)/2), rep("internal", nrow(F_P_Data)/2))

gathercol <- colnames(F_P_Data[, c(1:3,5)])
F_P_Data_long <- gather(F_P_Data, "Variable", "value", gathercol, factor_key = TRUE)
F_P_Data_long$num_states = 2

Group_F_P_Data_long <-
    ddply(
      F_P_Data_long,
      .(Variable, Mode, num_states),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )
```

```{r fMRI_choices_by_stimulus_ps, cache = TRUE}
##
## choice ~ stimulus
##
F_Summary_Choice <-
    ddply(
      F_Data,
      .(w_Stimulus,ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

gathercol <- colnames(F_Summary_Choice[, 3:ncol(F_Summary_Choice)])
F_Summary_Choice_long <- gather(F_Summary_Choice, "Variable", "Value", gathercol, factor_key = TRUE)

Group_F_Summary_Choice_long <-
    ddply(
      F_Summary_Choice_long,
      .(w_Stimulus, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + Percept_minus_1
##
F_Summary_Choice_ps <-
    ddply(
      F_Data,
      .(w_Stimulus, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

F_Summary_Choice_ps$Percept_minus_1 = (F_Summary_Choice_ps$Percept_minus_1 + 1)/2
F_Summary_Choice_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(F_Summary_Choice_ps$Percept_minus_1), sep = " ")
F_Summary_Choice_ps= F_Summary_Choice_ps[F_Summary_Choice_ps$Percept_minus_1 != "y(t-1) = NA",]

gathercol <- colnames(F_Summary_Choice_ps[, 4:ncol(F_Summary_Choice_ps)])
F_Summary_Choice_ps_long <- gather(F_Summary_Choice_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_F_Summary_Choice_ps_long <-
    ddply(
      F_Summary_Choice_ps_long[!is.na(F_Summary_Choice_ps_long$Percept_minus_1), ],
      .(w_Stimulus, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )
Group_F_Summary_Choice_ps_long$Mode = "unimodal"
##
## choice ~ stimulus + mode
##
F_Summary_Choice_mode <-
    ddply(
       F_Data,
      .(w_Stimulus, Mode, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

gathercol <- colnames(F_Summary_Choice_mode[, 4:ncol(F_Summary_Choice_mode)])
F_Summary_Choice_mode_long <- gather(F_Summary_Choice_mode, "Variable", "Value", gathercol, factor_key = TRUE)

Group_F_Summary_Choice_mode_long <-
    ddply(
      F_Summary_Choice_mode_long,
      .(w_Stimulus, Mode, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## choice ~ stimulus + mode + ps
##
F_Summary_Choice_mode_ps <-
    ddply(
       F_Data,
      .(w_Stimulus, Mode, Percept_minus_1, ID),
      summarise,
      y_choice = mean(y_choice, na.rm = TRUE),
      confidence = NA
    )

F_Summary_Choice_mode_ps$Percept_minus_1 = (F_Summary_Choice_mode_ps$Percept_minus_1 + 1)/2
F_Summary_Choice_mode_ps$Percept_minus_1 = paste("y(t-1) =",  as.character(F_Summary_Choice_mode_ps$Percept_minus_1), sep = " ")
F_Summary_Choice_mode_ps = F_Summary_Choice_mode_ps[F_Summary_Choice_mode_ps$Percept_minus_1 != "y(t-1) = NA",]

gathercol <- colnames(F_Summary_Choice_mode_ps[, 5:ncol(F_Summary_Choice_mode_ps)])
F_Summary_Choice_mode_ps_long <- gather(F_Summary_Choice_mode_ps, "Variable", "Value", gathercol, factor_key = TRUE)

Group_F_Summary_Choice_mode_ps_long <-
    ddply(
      F_Summary_Choice_mode_ps_long,
      .(w_Stimulus,Mode, Percept_minus_1, Variable),
      summarise,
      mean = mean(Value, na.rm = TRUE),
      error = sd(Value, na.rm = TRUE)/sqrt(length(Value))
    )

##
## Global variables
##
F_Summary_Data <-
    ddply(
      F_Data,
      .(uDisambiguation, Mode, ID),
      summarise,
      Accuracy = mean(Accuracy, na.rm = TRUE),
      Stability = mean(Stability, na.rm = TRUE),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

F_Summary_Data[F_Summary_Data == "NaN"] = NA
gathercol <- colnames(F_Summary_Data[, 4:ncol(F_Summary_Data)])
F_Summary_Data_long <- gather(F_Summary_Data, "Variable", "value", gathercol, factor_key = TRUE)

Group_F_Summary_Data_long <-
    ddply(
      F_Summary_Data_long,
      .(uDisambiguation, Mode, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

F_Summary_Data_con <-
    ddply(
      F_Data,
      .(uDisambiguation, Mode, cond_Accuracy, ID),
      summarise,
      Stability = mean(Stability, na.rm = TRUE),
      rBias = sum(Percept == 1)/length(Percept),
      absBias = abs(sum(Percept == 1)/length(Percept) - 0.5),
      RT = mean(RT, na.rm = TRUE)
    )

F_Summary_Data_con[F_Summary_Data_con == "NaN"] = NA
gathercol <- colnames(F_Summary_Data_con[, 5:ncol(F_Summary_Data_con)])
F_Summary_Data_con_long <- gather(F_Summary_Data_con, "Variable", "value", gathercol, factor_key = TRUE)

Group_F_Summary_Data_con_long <-
    ddply(
      F_Summary_Data_con_long,
      .(uDisambiguation, Mode, cond_Accuracy, Variable),
      summarise,
      mean = mean(value, na.rm = TRUE),
      error = sd(value, na.rm = TRUE)/sqrt(length(value))
    )

##
## STATS
##

if (!load_summary_data) {

accuracy_by_DM = glmer(Accuracy ~ uDisambiguation*Session_Sl_Prob_State_ext + (1 | ID), data = F_Data, family = binomial)
STAT.accuracy_by_DM = summary(accuracy_by_DM)

stability_by_DMC = glmer(Stability ~ uDisambiguation*Session_Sl_Prob_State_ext*cond_Accuracy  + (1 | ID), data = F_Data, family = binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
STAT.stability_by_DMC = summary(stability_by_DMC)

RT_by_DMC = glmer(log(RT) ~ uDisambiguation*Session_Sl_Prob_State_ext*cond_Accuracy  + (1 | ID), data = F_Data, family = gaussian)
STAT.RT_by_DMC = summary(RT_by_DMC)

y_choice_by_SP = glmer(y_choice ~ 1 + w_Stimulus * Percept_minus_1 + (1 | ID), data = F_Data, family = binomial(link = logit))
STAT.y_choice_by_SP = summary(y_choice_by_SP)

y_choice_by_SPM = glmer(y_choice ~ 1 + w_Stimulus *  Percept_minus_1 * Mode + (1 | ID), data = F_Data, family = binomial(link = logit))
STAT.y_choice_by_SPM = summary(y_choice_by_SPM)

  if (save_summary_data) {
    save(STAT.accuracy_by_DM, accuracy_by_DM,
         STAT.stability_by_DMC, stability_by_DMC,
         STAT.RT_by_DMC, RT_by_DMC,
         STAT.y_choice_by_SP, y_choice_by_SP,
         STAT.y_choice_by_SPM, y_choice_by_SPM,
         file = "./Results/R_summary_fMRI_stats.Rdata")
  }
} else {
  load("./Results/R_summary_fMRI_stats.Rdata")
}

##
## Bonferroni
##
STAT.y_choice_by_SP = bonferroni(STAT.y_choice_by_SP)
STAT.y_choice_by_SPM = bonferroni(STAT.y_choice_by_SPM)
```

```{r fMRI_mode_summary}
F_Summary_Mode  <-
    ddply(
      F_Data,
      .(ID),
      summarise,
      external = mean(Sl_Prob_State_ext, na.rm = TRUE),
      Mode_bool = (sum(Mode == "external", na.rm = TRUE)/length(Mode)),
      Mode_s = (sum(Mode_switch, na.rm = TRUE)/length(Mode)),
      EI = (sum(Mode_switch[Mode == "internal"] == 1, na.rm = TRUE)/length(Mode)),
      IE = (sum(Mode_switch[Mode == "external"] == 1, na.rm = TRUE)/length(Mode)),
      EE = (sum(Mode_switch[Mode == "external"] == 0, na.rm = TRUE)/length(Mode)),
      II = (sum(Mode_switch[Mode == "internal"] == 0, na.rm = TRUE)/length(Mode))
    )

gathercol <- colnames(F_Summary_Mode[, 2:ncol(F_Summary_Mode)])
F_Summary_Mode_long <- gather(F_Summary_Mode, "Variable", "value", gathercol, factor_key = TRUE)

Group_F_Summary_Mode_long <-
    ddply(
      F_Summary_Mode_long,
      .(Variable),
      summarise,
      mean = mean(value[is.finite(value)], na.rm = TRUE),
      error = sd(value[is.finite(value)], na.rm = TRUE)/sqrt(length(value[is.finite(value)]))
    )

F_Stimulus_by_MI = lm(Stimulus ~ Mode , data = F_P_Data)
F_STAT.Stimulus_by_MI = summary(F_Stimulus_by_MI)

F_Bias_by_MI = lm(Bias ~ Mode, data = F_P_Data)
F_STAT.Bias_by_MI = summary(F_Bias_by_MI)

F_PS_by_MI = lm(PS ~ Mode, data = F_P_Data)
F_STAT.PS_by_MI = summary(F_PS_by_MI)

F_Stimulus_PS_by_MI = lm(Stimulus-PS ~ Mode, data = F_P_Data)
F_STAT.Stimulus_PS_by_MI = summary(F_Stimulus_PS_by_MI)

##
## Bonferroni
##
F_STAT.Stimulus_by_MI = bonferroni(F_STAT.Stimulus_by_MI)
F_STAT.Bias_by_MI = bonferroni(F_STAT.Bias_by_MI)
F_STAT.PS_by_MI = bonferroni(F_STAT.PS_by_MI)
F_STAT.Stimulus_PS_by_MI = bonferroni(F_STAT.Stimulus_PS_by_MI)
```

```{r prepare_regressors_for_fMRI}
F_Data$PE = NA
for (subj_idx in unique(F_Data$ID)){
  
  Stimulus = F_Data[F_Data$ID == subj_idx,]$w_Stimulus
  Bias = rep(1,length(Stimulus))
  PS = c(0, F_Data[F_Data$ID == subj_idx,]$y_choice[1:length(Stimulus)-1])
  Mode = F_Data[F_Data$ID == subj_idx,]$Mode
  y_choice = F_Data[F_Data$ID == subj_idx,]$y_choice
  
  PE_external = abs(y_choice[Mode == "external"] - plogis(F_P_Data[F_P_Data$ID == subj_idx & F_P_Data$Mode == "external",]$Stimulus * Stimulus[Mode == "external"] + F_P_Data[F_P_Data$ID == subj_idx & F_P_Data$Mode == "external",]$Bias * Bias[Mode == "external"] + F_P_Data[F_P_Data$ID == subj_idx & F_P_Data$Mode == "external",]$PS * PS[Mode == "external"]))
    
  PE_internal = abs(y_choice[Mode == "internal"] - plogis(F_P_Data[F_P_Data$ID == subj_idx & F_P_Data$Mode == "internal",]$Stimulus * Stimulus[Mode == "internal"] + F_P_Data[F_P_Data$ID == subj_idx & F_P_Data$Mode == "internal",]$Bias * Bias[Mode == "internal"] + F_P_Data[F_P_Data$ID == subj_idx & F_P_Data$Mode == "internal",]$PS * PS[Mode == "internal"]))
  
  F_Data[F_Data$ID == subj_idx & F_Data$Mode == "external",]$PE = PE_external
  F_Data[F_Data$ID == subj_idx & F_Data$Mode == "internal",]$PE = PE_internal
}

F_Data$Mode_switch_IE = 0
F_Data[F_Data$Mode_switch == 1 & F_Data$Mode == "external" & !is.na(F_Data$Mode_switch),]$Mode_switch_IE = 1

F_Data$Mode_switch_EI = 0
F_Data[F_Data$Mode_switch == 1 & F_Data$Mode == "internal" & !is.na(F_Data$Mode_switch),]$Mode_switch_EI = 1

F_Data$Mode_switch = as.numeric(F_Data$Mode_switch)
F_Data$Mode_switch[is.na(F_Data$Mode_switch)] = 0


F_Data$P_Switch = -(F_Data$Stability-1)
F_Data$P_Switch[is.na(F_Data$P_Switch)] = 0
write.csv(F_Data, "./Results/PE_fMRI_prepared.csv", row.names = FALSE)
```

```{r read_MRI_data}
ROI = read.csv("./Results/IFG_MT.csv")
gathercol <- colnames(ROI[, 1:2])
ROI_long <- gather(ROI, "Region", "Beta", gathercol, factor_key = TRUE)
ROI_long$Beta = -ROI_long$Beta
Group_ROI_long = ddply(
      ROI_long,
      .(Region),
      summarise,
      mean = mean(Beta, na.rm = TRUE),
      error = sd(Beta, na.rm = TRUE)/sqrt(length(Beta))
    )

F_STAT.IFG = t.test(ROI$IFG)
F_STAT.MT = t.test(ROI$MT)
```

# Discussion

Perception integrates incoming signals with internal predictions that reflect prior knowledge about the world[@Friston2005]. Our results indicate that this integration is subject to dynamic changes over time, alternating between an external mode, where perception closely follows the external input, and an internal mode, where perception is shaped by internal predictions[@weilnhammer_bistable_2021; @weilnhammer_sensory_2023; @weilnhammer_dynamic_2024]. The internal mode enables the brain to use prior knowledge about the statistics of natural environment, such as their temporal autocorrelation, for efficient perception[@weilnhammer_sensory_2023]. Intermittent episodes of external mode processing decouple perception from prior knowledge. The balance between external and internal mode may prevent circular inferences within recurrent neural networks, where predictive feedback influences early sensory processing stages[@muckli_contextual_2015; @weilnhammer_neural_2018]. We found that healthy individuals receiving the NMDAR antagonist S-ketamine, as well as patients diagnosed with Scz, are more prone to an external mode of perception. This NMDAR-dependent change in the balance between modes may expose perception to the destabilizing effects of sensory ambiguity, causing afflicted individuals to be deluded by spurious connections between unrelated events, to attribute the sensory consequences of their actions to an outside force, and to hallucinate signals in noise[@Sterzer2018].

## External and internal mode explain dynamic failures of perceptual inference in Scz

During bistable perception, previous experiences provide the predictive context in which incoming sensory data are interpreted, and lead to prolonged periods of perceptual stability despite the ambiguity of the external input[@weilnhammer_active_2021]. Our results suggest that NMDAR hypofunction, whether due to pharmacological antagonism or as a potential endophenotype of Scz, causes a shift of bistable perception toward the external input, and away from stabilizing internal prediction that stem from previous experiences. These findings bear similarity with prior work on perceptual illusions, where prior knowledge biases perception in ways that may be adaptive in natural environments but reduce perceptual accuracy in experimental settings[@Notredame2014; @costa_systematic_2023]. Weak predictions may explain why people with Scz are, for example, less susceptible to the hollow-mask illusion, where knowledge about faces is thought to induce the experience of a convex face on the concave surface of a human mask[@keane_reduced_2013]; the Ebbinghaus illusion, where larger circles make a smaller central circle appear bigger[@Silverstein2013]; or the force-matching illusion, where humans apply less force when matching an externally applied force with their own[@shergill_evidence_2005].

Our findings therefore align with the canonical predictive processing account of psychosis[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. According to this model, NMDAR hypofunction[@Stein2020] and Scz[@weilnhammer_psychotic_2020] are associated with weak priors that cause erratic inferences in perception and cognition, ultimately leading to psychotic symptoms such as delusions and hallucinations. At the same time, they seem at odds with the observation that psychotic experiences, and in particular false alarms that serve as an experimental proxy for hallucinations, correlate with strong priors[@cassidy_perceptual_2018; @schmack_striatal_2021; @bansal_association_2022]. So far, attempts to reconcile these disparate sets of findings suggest that priors may vary in strength depending on the phase of psychotic illness, with weak priors in early stages and strong priors in later stages, or depending on their position within the cognitive hierarchy, with weak priors at the perceptual level and strong priors at the cognitive level[@Sterzer2018]. As an alternative to predictive processing, circular inference accounts of Scz posit that psychotic symptoms depend on an over-counting of sensory data that are reverberated multiple times due to an imbalance of excitation and inhibition in feedforward-feedback loops of the cortical hierarchy[@Jardri2016; @Jardri2017]. 

In line with the general principles of predictive processing, the GLM-HMM proposed here predicts the experiences $y_t$ in a weighted integration the external input $\beta_S \times s_t$ with internal predictions that embody the temporal autocorrelation of natural environments and are defined by the preceding experiences $\beta_p \times y_{t-1}$. The critical advance provided by the GLM-HMM is that the model allows for dynamic changes in the balance between external and internal sources of information ($\Delta_{S-P} = \beta_S - \beta_P$). In the data presented here, the GLM-HMM revealed that the general shift of perception toward the external input and away from internal predictions observed under S-ketamine and in Scz is in fact driven by changes in the balance between two opposing modes of inference: an external mode, during which priors are weak, and an internal mode, during which priors are strong. The failures of perceptual inference, which are hypothesized to characterize Scz[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018], may thus be transient and recurring.

To our knowledge, our results are the first to uncover a neural mechanism underlying the slow, task-related fluctuations in perceptual inference observed in both humans and mice[@laquitaine_switching_2018; @roy_extracting_2021; @ashwood_mice_2022; @weilnhammer_sensory_2023]. In the context of Scz, this extends previous predictive processing accounts by suggesting an alternative explanation for the apparent discrepancy between strong and weak priors: an imbalance between the modes may cause the brain to make erratic inferences during the external mode, when the influence of previously learned priors is weak, generating a distorted or inaccurate model of the world, which is then used maladaptively during the internal mode, when priors are strong[@weilnhammer_dynamic_2024]. Furthermore, the dynamic nature of between-mode transitions illustrates how constant and potentially heritable dysfunctions of the NMDAR, such as GRIN2A mutations in Scz[@harrison_grin2a_2023], may produce symptoms of psychosis that are recurrent and transient in nature.  

## How are external and internal modes linked to trait-like alterations in Scz and to psychosis-related states of perceptual inference?

In the present data, we did not find a correlation of the balance between external and internal mode with either global psychosis proneness or the clinical severity of Scz (Supplemental Figure S6). Our study was optimized for within-participant power and not designed to detect correlations between inter-individual differences in Scz-related traits and the balance between external and internal modes. One key question moving forward is whether the shift toward external mode represents a general trait-like phenomenon in Scz, potentially linked to cognitive alterations that are also present to some degree under ketamine[@morgan_ketamine_2012], or whether external and internal modes are associated with psychosis-related, state-dependent changes in inference.

Future research could address these questions by correlating the balance between modes with both positive and negative symptoms, as well as with measures of cognitive performance such as IQ in larger samples. Another promising approach to distinguish between trait and state effects, which can manifest differently or even with opposite phenotypes[@Adams2013], could involve real-time symptom tracking combined with functional imaging. Such analyses could help to examine whether shifts between external and internal modes align with the on- and offset of individual psychotic experiences[@weilnhammer_dynamic_2024], both at the behavioral level and in terms of their neural correlates.

## Are external and internal mode perceptual or behavioral phenomena?

Previous studies have used GLM-HMMs to identify engaged and disengaged behavior in mice tasked with discriminating the location of a visual stimulus[@ashwood_mice_2022; @mohammadi_identifying_2024]. While this terminology may suggest that GLM-HMM states reflect dynamic changes in rodent behavior, evidence from human psychophysics indicates that external and internal modes may in fact reflect perceptual (as opposed to behavioral) states[@weilnhammer_sensory_2023; @weilnhammer_dynamic_2024]. Specifically, when humans detect gratings in white noise, false alarms are more likely when the noise contains more power at the orientation and spatial frequency of the preceding grating, suggesting that detection relies on a predictive perceptual template[@manassi_continuity_2024; @weilnhammer_dynamic_2024]. If these detection events were purely behavioral, no correlation between false alarms and the noise power spectrum would be expected[@murai_serial_2021]. Critically, recent work demonstrates that these predictive perceptual templates are confined to the internal mode, supporting the hypothesis that the internal mode is indeed predictive and perceptual[@weilnhammer_dynamic_2024]. Moreover, an analysis of 66 experiments on human two-alterantive forced-choice decision-making revealed a quadratic relationship of confidence with mode[@weilnhammer_sensory_2023]. The observation that confidence remains high for strong biases toward both external and internal modes[@weilnhammer_sensory_2023] argues against the interpretation of internal mode as disengaged behavior.

Our present analyses of confidence and response times, as well as our time-resolved assessment of wakefulness, subjective intoxication, and nervousness, strongly support the idea that external and internal modes are perceptual phenomena, cannot be reduced to processes occurring solely at the level of task engagement, and are not mere reflections of fluctuations in arousal. These observations do not, however, rule out the possibility that external and internal modes have multiple and potentially independent effects on the brain, including influences on high-level cognition and response behavior, or that they are, to some degree, dependent on global brain states. No-report functional imaging experiments, where the content of experiences is decoded without overt behavioral signals[@Tsuchiya2015], alongside pupillometry, manipulations of neuromodulators that regulate global brain states, or non-invasive brain stimulation, could help illuminate the causes and consequences of these modes across the cortical hierarchy. Mapping the neurocomputational dynamics of mode alternations will be crucial to testing whether adjusting the balance between modes can mitigate psychotic experiences and ultimately improve the lives of people living with Scz.

# Data availability

## Lead contact

Further information and requests for resources should be directed to and will be fulfilled by the lead contact, Veith Weilnhammer (veith.weilnhamer@gmail.de).

## Materials availability

This study did not generate new unique reagents.

## Data and code

All data and code associated with this study will be made available on the associated Github repository <https://github.com/veithweilnhammer/modes_ketamine_scz> upon publication. Key resources are listed in Supplemental Table S1. 

# Acknowledgements

This work was funded by the Leopoldina Academy of Sciences (grant number: LDPS2022-16, [https://www.leopoldina.org/en/leopoldina-home/](https://www.leopoldina.org/en/leopoldina-home/)), the German Research Foundation DFG (grant number: STE 1430/9-1, [https://www.dfg.de](https://www.dfg.de)), the Berlin Institute of Health Clinician Scientist Program ([https://www.bihealth.org/en/translation/innovation-enabler/academy/bih-charite-clinician-scientist-program](https://www.bihealth.org/en/translation/innovation-enabler/academy/bih-charite-clinician-scientist-program)), and the German Ministry for Research and Education (ERA-NET NEURON program, grant number: 01EW2007A, [https://www.neuron-eranet.eu/](https://www.neuron-eranet.eu/)). The funders had no role in study design, data collection, data analysis, decision to publish, or preparation of the manuscript.

# Competing Interests

The authors report no competing interests.

\newpage
# Figures

## Figure 1

```{r Figure 1}
update <- function(mean1, var1, mean2, var2) {
  # calculates new position as multiplication of two Gaussians:
  # prior probability and new information
  new_mean <- (var2 * mean1 + var1 * mean2) / (var1 + var2)
  new_var <- 1 / (1 / var1 + 1 / var2)
  return(c(new_mean, new_var))
}

predict <- function(mean1, var1, mean2, var2) {
  # Calculates new postion as sum (= convolution) of two Gaussians:
  # prior probability and new information
  new_mean <- mean1 + mean2
  new_var  <- var1 + var2
  return(c(new_mean, new_var))
}

if (!load_summary_data) {

  Settings = expand.grid(
  var_stimulus = 0,
  var_encoding = 1.5,
  var_prior = c(0.1, 1, 9999),
  stability = 0.85
)
levels = seq(0,1, by = 0.1)

set.seed(111)
n_steps = 10000
Sim = data.frame()

stimulus = c()
  stimulus[1] = 2
  for (idx in 2:n_steps){
    if (runif(1) < Settings$stability){
      stimulus[idx] = stimulus[idx-1]
    } else
     stimulus[idx] = -stimulus[idx-1]
  }
  
  stimulus = stimulus * levels[randi(length(levels), 1, n_steps)]
    encoding <-
    stimulus + 
    rnorm(length(stimulus), 0, sqrt(Settings$var_encoding))
    
for (sim_idx in c(1:nrow(Settings))) {
  
  pos <- c(0, Settings$var_prior[sim_idx])

  
  inference = c()
  for (i in 1:n_steps) {
    pos <-
      update(pos[1], pos[2], encoding[i], Settings$var_encoding[sim_idx])
    
    inference <- c(inference, pos[1])
    pos[2] = Settings$var_prior[sim_idx]
  }
  y_choice = rbinom(n_steps, 1, plogis(4*inference))
  y_choice_minus_1 = c(0.5, y_choice[1:length(y_choice)-1])
  
  add_Sim = data.frame(
    stimulus = stimulus,
    delta_stimulus = c(NA, diff(stimulus)),
    encoding = encoding,
    delta_encoding = c(NA, diff(encoding)),
    inference = inference,
    y_choice = y_choice,
    y_choice_minus_1 = y_choice_minus_1,
    delta_inference = c(NA, diff(inference)),
    sample = seq(1, n_steps, 1),
    var_encoding = rep(Settings$var_encoding[sim_idx], n_steps),
    var_prior = rep(Settings$var_prior[sim_idx], n_steps)
  )
  
  Sim = rbind(Sim, add_Sim)
}
Sim$var_prior = as.character(Sim$var_prior)
Sim$var_prior = gsub(as.character(Settings$var_prior[1]), "Strong gating and integration", Sim$var_prior)
Sim$var_prior = gsub(as.character(Settings$var_prior[2]), "Optimal", Sim$var_prior) 
Sim$var_prior = gsub(as.character(Settings$var_prior[3]), "Weak gating and integration", Sim$var_prior) 

gathercol = colnames(Sim[, c(1:8)])
Sim_long  <- gather(Sim,
                    "Variable",
                    "Value",
                    gathercol,
                    factor_key = TRUE)


Sim_average = ddply(
     Sim[Sim$y_choice_minus_1 != 0.5,],
      .(var_prior, stimulus, y_choice_minus_1),
      summarise,
      mean = mean(y_choice, na.rm = TRUE),
      error = sd(y_choice, na.rm = TRUE)/sqrt(length(y_choice))
)
Sim_average$y_choice_minus_1 = as.factor(Sim_average$y_choice_minus_1)
  
  if (save_summary_data) {
    save(Settings, Sim_long, Sim_average,
         file = "./Results/Sim.Rdata")
  }
} else {
  load("./Results/Sim.Rdata")
}
n_to_plot = 80
p_Sim <-
  ggplot() + geom_line(
    data = Sim_long[Sim_long$var_prior != "Strong gating and integration" & Sim_long$sample < n_to_plot &
                      (Sim_long$Variable == "inference" |
                         Sim_long$Variable == "stimulus") , ],
    aes(x = sample, y = plogis(Value), color = Variable),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  geom_point(
    data = Sim_long[Sim_long$var_prior != "Strong gating and integration" & Sim_long$sample < n_to_plot &
                      Sim_long$Variable == "encoding", ],
    aes(x = sample, y = plogis(Value), color = Variable),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  theme_classic(base_size = 6) + labs(
    x = "t",
    y =
      "P(y(t) = 1)",
    linetype = "",
    subtitle = "B"
  ) + geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  theme(legend.position = "top") + facet_wrap(~var_prior, ncol = 1)

p_sim_average <-
  ggplot() +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +  geom_vline(
    xintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
    geom_line(
    data = Sim_average[Sim_average$var_prior != "Strong gating and integration",],
    mapping = aes(
      y = mean,
      x = stimulus/2,
      linetype = y_choice_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd,
    color = "black"
  ) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Dark2", direction = 1) + scale_fill_brewer(palette = "Dark2", direction = 1) + 
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = " ",
   linetype = "y(t-1)",
  ) + 
  theme(legend.position = "top") + facet_wrap( ~ var_prior, ncol = 1) 


Summary_Data$Phase = 1.5/(1-Summary_Data$Stability)
Summary_Data$Phase[!is.finite(Summary_Data$Phase)] = 120
phase_ridges <-
ggplot(Summary_Data,
aes(
x = Phase,
y = as.factor(uDisambiguation),
fill = as.factor(uDisambiguation)
)) + geom_density_ridges(color = "white", rel_min_height = 0.001, bandwidth = 3  , scale = 6, alpha = 0.75, line_size_gd = line_size_sd) + theme_ridges(font_size = 10,
grid = FALSE, center_axis_labels = TRUE) + geom_vline(xintercept = 10,
    linetype = "dashed",
    color = "black",
    size = 0.25) + xlim(0, 60) + labs(x =
"Average phase duration (sec)",  y = "SAR", subtitle = "C") + theme_classic(base_size = 6) + scale_fill_brewer(palette = "Spectral", direction = -1) + theme(
      axis.text.y=element_blank(), 
      axis.ticks.y=element_blank()) 
```

![](./Material/Figure_1.png)

**Figure 1.**

**A.** When inferring whether the world is one state or another ($P(y_t = 1)$ or $P(y_t = 0)$, respectively), the brain integrates ambiguous sensory signals $s_t$ with internal predictions that reflect prior knowledge about the environment. One source of prior knowledge is the temporal autocorrelation of natural stimuli, in which the recent past often predicts the near future. The integration of external inputs and internal predictions depends on the weights assigned to incoming sensory data ($\beta_S \times s_t$) and to internal prediction derived from previous experiences ($\beta_P \times y_{t-1}$, dotted versus solid lines, simulated data), respectively. $\beta_S$ determines the slope, and $\beta_P$ the shift of the psychometric function that links $s_t$ and $y_t$. Importantly, the balance $\Delta_{S-P} = \beta_S - \beta_P$ is known to alternate between two opposing modes: During the external mode (left), perception is largely determined by $\beta_S \times s_t$, which is reflected by a steep slope and a small shift of the psychometric curve. Conversely, during the internal mode (right), perception is shaped by $\beta_P \times y_{t-1}$, resulting in a shallow slope and a large shift of the psychometric curve.

**B.** We conducted a double-blind placebo-controlled experiments in 28 healthy human participants, who received a continuous infusion with either the NMDAR antagonist S-ketamine or saline. During the infusion, the participants viewed an ambiguous SFM stimulus that was compatible with two mutually exclusive subjective experiences (left vs. rightward rotation of the front surface, red arrows). This induced the phenomenon of bistable perception: While the ambiguous stimulus remained constant, participants perceived only one direction of rotation (blue arrow), before switching to the competing alternative.

**C.** Changes in the perceived direction of rotation of the SFM stimulus occur at brief depth-symmetric configurations of the stimulus (Supplemental Video S1). We therefore transformed the behavioral responses into a sequence of states $t$ (80 1.5 sec intervals per block), each associated with a combination of the SAR-weighted input $s_t$ and the perceived direction of rotation $y_t$. We used GLMs to quantify the weights $\beta_S$, $\beta_P$ and $\beta_B$, which reflect how inferences $y_t$ were determined by the external inputs $\beta_S \times s_t$, internal predictions $\beta_P \times y_{t-1}$ and the constant bias $\beta_B \times 1$.

\newpage
## Figure 2

```{r Figure_2}
# alpha_sd = 0.45
# alpha_gd = 0.65
# dot_size_sd = 0.5
# line_size_sd = dot_size_sd/20
# dot_size_gd = 4 * dot_size_sd
# line_size_gd = 2 * dot_size_sd

##
## S-ketamine
##

##
## Psychometric function
##
dodge_width = 0.5
Variables = c("Accuracy")
p_main_accuracy <- ggplot() + geom_jitter(data = Summary_Data_no_mode_long[Summary_Data_no_mode_long$Intervention != "None" & Summary_Data_no_mode_long$Variable %in% Variables & Summary_Data_no_mode_long$uDisambiguation != 0,],
  aes(
  x = as.factor(uDisambiguation),
  y = value,
  color = Intervention
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_Summary_Data_no_mode_long[Group_Summary_Data_no_mode_long$Intervention != "None" & Group_Summary_Data_no_mode_long$Variable %in% Variables & Group_Summary_Data_no_mode_long$uDisambiguation > 0,],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Intervention
    ),
   width = dodge_width/2,
   position = position_dodge(width = dodge_width*2),
  size = line_size_gd,
  alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + labs(
  x = "Session",
  y = "Value",
  subtitle = NULL,
  color = "Mouse"
  ) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "|s(t)|",  y = paste("P(y(t) = s(t)", sep = " "), subtitle = "A", color = "Intervention") + theme(panel.spacing=unit(1,"lines")) + facet_wrap(~"Accuracy")

dodge_width = 0.05
Variables = c("y_choice")

p_intervention_ps <-
  ggplot() +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention,
      group = interaction(Percept_minus_1, Intervention)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + 
    geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention,
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "A",
    color = "Intervention",
  )  + facet_wrap( ~Mode)

p_intervention_mode_ps <-
  ggplot() + geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention,
      group = interaction(Percept_minus_1, Intervention)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention,
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~Mode, ncol = 1)
##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus-PS")
p_mode_parameters <-
  ggplot() + geom_jitter(
    data = P_Data_long[P_Data_long$Variable %in% Variables &
                         P_Data_long$Intervention != "None" & P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_P_Data_long[Group_P_Data_long$Variable %in% Variables &
                               Group_P_Data_long$Intervention != "None" & Group_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) + scale_y_continuous(breaks=c(-4,-2,0,2)) +
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "C") + facet_wrap( ~ Variable, ncol = length(Variables))


Variables = c("external")
p_mode <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Intervention,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Intervention,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0.50),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Intervention",
    y = "Probability",
    subtitle = "D",
    color = "Intervention"
  ) + facet_wrap(~"Mode Probability")


##
## Patients vs. controls
##
##
## Psychometric function
##
dodge_width = 0.5

Variables = c("Accuracy")
p_s_main_accuracy <- ggplot() + geom_jitter(data = S_Summary_Data_no_mode_long[S_Summary_Data_no_mode_long$Variable %in% Variables & S_Summary_Data_no_mode_long$uDisambiguation > 0,],
  aes(
  x = as.factor(uDisambiguation),
  y = value,
  color = Group
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_S_Summary_Data_no_mode_long[Group_S_Summary_Data_no_mode_long$Variable %in% Variables & Group_S_Summary_Data_no_mode_long$uDisambiguation > 0,],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Group
    ),
    width = dodge_width/2,
    position = position_dodge(width = dodge_width*2),
    size = line_size_gd,
    alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + labs(
  x = "Session",
  y = "Value",
  subtitle = NULL,
  color = "Mouse"
  ) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "|s(t)|",  y = paste("P(y(t) = s(t))", sep = " "), subtitle = "E", color = "Group") + theme(panel.spacing=unit(1,"lines")) + facet_wrap(~"Accuracy")

dodge_width = 0.05
stretch = 0.5
Variables = c("y_choice")

p_s_intervention_ps <-
  ggplot() +  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group,
      group = interaction(Percept_minus_1, Group)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group,
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "E",
    color = "Intervention",
  ) + facet_wrap( ~Mode)

p_s_intervention_mode_ps <-
  ggplot() + geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) +
  geom_ribbon(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group,
      group = interaction(Percept_minus_1, Group)
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) +  geom_line(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group, 
      linetype = Percept_minus_1
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "F",
    color = "Group",
  ) + facet_wrap(~Mode, ncol = 1)


##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus-PS")
p_s_mode_parameters <-
  ggplot() + geom_jitter(
    data = S_P_Data_long[S_P_Data_long$Variable %in% Variables & S_P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_P_Data_long[Group_S_P_Data_long$Variable %in% Variables & Group_S_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) + 
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "G") + facet_wrap( ~ Variable, ncol = length(Variables))


Variables = c("external")
p_s_mode <-
  ggplot() + geom_jitter(
    data = S_Summary_Mode_long[S_Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Group,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_Summary_Mode_long[Group_S_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Group,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0.50),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Group",
    y = "Probability",
    subtitle = "H",
    color = "Group"
  ) + facet_wrap(~"Mode Probability")


##
## Time and SAR
##

##
## Ketamine
##
Time_Data = subset(
  Data,
  select = c(
    overlap_index,
    block_id,
    Session_Sl_Prob_State_ext,
    Intervention,
    uDisambiguation,
    ID
  ),
  subset = c(Intervention != "None")
)
Time_Data$t = Time_Data$overlap_index + max(Time_Data$overlap_index) * (Time_Data$block_id - 1)
Time_Data$ut = Time_Data$t/max(Time_Data$t)

gathercol <- colnames(Time_Data[,c(3,5)])
Time_Data_long <- gather(Time_Data, "Variable", "value", gathercol, factor_key = TRUE)

Summary_Time_Data = ddply(
  Time_Data,
  .(t, ID, Intervention),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_Summary_Time_Data = ddply(
  Summary_Time_Data,
  .(t, Intervention),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

Summary_Difficulty_Data = ddply(
  Time_Data,
  .(uDisambiguation, ID, Intervention),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_Summary_Difficulty_Data = ddply(
  Summary_Difficulty_Data,
  .(uDisambiguation, Intervention),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

##
## Schizophrenia
##

S_Time_Data = subset(
  S_Data,
  select = c(
    overlap_index,
    block_id,
    Session_Sl_Prob_State_ext,
    Group,
    uDisambiguation,
    ID
  )
)

S_Time_Data$counter <- NA
unique_ids <- unique(S_Time_Data$ID)
# Loop through each unique ID
for (id in unique_ids) {
  # Filter the data for the current ID
  subset_data <- S_Time_Data[S_Time_Data$ID == id, ]
  
  # Calculate the counter for the current ID
  counter <- cumsum(c(TRUE, diff(subset_data$block_id) != 0))
  
  # Assign the counter back to the original data frame
  S_Time_Data[S_Time_Data$ID == id, "counter"] <- counter
}
S_Time_Data$t = S_Time_Data$overlap_index + max(S_Time_Data$overlap_index) * (S_Time_Data$block_id - 1)
S_Time_Data$ut = S_Time_Data$t/max(S_Time_Data$t)

gathercol <- colnames(S_Time_Data[,c(3,5)])
S_Time_Data_long <- gather(S_Time_Data, "Variable", "value", gathercol, factor_key = TRUE)

S_Summary_Time_Data = ddply(
  S_Time_Data,
  .(t, ID, Group),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_S_Summary_Time_Data = ddply(
  S_Summary_Time_Data,
  .(t, Group),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

S_Summary_Difficulty_Data = ddply(
  S_Time_Data,
  .(uDisambiguation, ID, Group),
  summarise,
  average = mean(Session_Sl_Prob_State_ext, na.rm = TRUE))

Group_S_Summary_Difficulty_Data = ddply(
  S_Summary_Difficulty_Data,
  .(uDisambiguation, Group),
  summarise,
  mean = mean(average, na.rm = TRUE),
  error = sd(average, na.rm = TRUE) / sqrt(length(average))
)

if (!load_summary_data) {
Mode_by_time = glmer(
  Session_Sl_Prob_State_ext ~ ut*Intervention + (1 |
                                     ID),
  data = Time_Data,
  family = binomial
)
STAT.Mode_by_time = summary(Mode_by_time)

Mode_by_difficulty = glmer(
  Session_Sl_Prob_State_ext ~ uDisambiguation*Intervention + (1 |
                                     ID),
  data = Time_Data[Time_Data$uDisambiguation,],
  family = binomial
)
STAT.Mode_by_difficulty = summary(Mode_by_difficulty)

S_Mode_by_time = glmer(
  Session_Sl_Prob_State_ext ~ ut*Group + (1 |
                                     ID),
  data = S_Time_Data,
  family = binomial
)
S_STAT.Mode_by_time = summary(S_Mode_by_time)

S_Mode_by_difficulty = glmer(
  Session_Sl_Prob_State_ext ~ uDisambiguation*Group + (1 |
                                     Group),
  data = S_Time_Data,
  family = binomial
)
S_STAT.Mode_by_difficulty = summary(S_Mode_by_difficulty)

  if (save_summary_data) {
    save(STAT.Mode_by_time, Mode_by_time,
         STAT.Mode_by_difficulty, Mode_by_difficulty,
         S_STAT.Mode_by_time, S_Mode_by_time,
         S_STAT.Mode_by_difficulty, S_Mode_by_difficulty,
         file = "./Results/R_summary_mode_time")
  }
} else {
  load("./Results/R_summary_mode_time")
}
STAT.Mode_by_time = bonferroni(STAT.Mode_by_time)
STAT.Mode_by_difficulty = bonferroni(STAT.Mode_by_difficulty)
S_STAT.Mode_by_time = bonferroni(S_STAT.Mode_by_time)
S_STAT.Mode_by_difficulty = bonferroni(S_STAT.Mode_by_difficulty)


dodge_width = 0.05

p_mode_time <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Time_Data[Group_Summary_Time_Data$t %in% seq(1,length(Group_Summary_Time_Data$t), 10),],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (t*1.5)/60,
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Time_Data[Group_Summary_Time_Data$t %in% seq(1,length(Group_Summary_Time_Data$t), 10),],
    mapping = aes(
      y = mean,
      x = (t*1.5)/60,
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  )  + ylim(0.5,1) + xlim(0.1,20) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "t (min) after session onset",
    y = "P(External Mode)",
    subtitle = " "
  ) 

p_mode_difficulty <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_jitter(data = Summary_Difficulty_Data,
  aes(
  x = as.factor(uDisambiguation),
  y = average,
  color = Intervention
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_Summary_Difficulty_Data,
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Intervention
    ),
    width = dodge_width*5,
    position = position_dodge(width = dodge_width*7),
    size = line_size_gd,
    alpha = alpha_gd
  ) + ylim(0.5,1) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "SAR",
    y = "P(External Mode)",
    subtitle = " "
  ) 

s_p_mode_time <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Time_Data,
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (t*3.33)/60,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Time_Data,
    mapping = aes(
      y = mean,
      x = (t*3.33)/60,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) + ylim(0.5,1) + xlim(0.1,9) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "t (min) after session onset",
    y = "P(External Mode)",
    subtitle = " " 
  ) 


s_p_mode_difficulty <-
  ggplot() + 
  geom_hline(
    yintercept = c(0, 0.5,1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_jitter(data = S_Summary_Difficulty_Data,
  aes(
  x = as.factor(uDisambiguation),
  y = average,
  color = Group
  ), alpha = alpha_sd, size = dot_size_sd, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = dot_size_sd
  ) +
  geom_errorbar(
    data = Group_S_Summary_Difficulty_Data,
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Group
    ),
    width = dodge_width*5,
    position = position_dodge(width = dodge_width*7),
    size = line_size_gd,
    alpha = alpha_gd
  ) + ylim(0.5,1) +
  theme_classic(base_size = 6) +
  scale_x_discrete(breaks = Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Controls",]$uDisambiguation[seq(1, length(Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Controls",]$uDisambiguation), by = 2)]) +
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "SAR",
    y = "P(External Mode)",
    subtitle = " "
  ) 

lay <- rbind(c(1,2,3,4,9), c(1,2,3,4,10), c(5,6,7,8,11), c(5,6,7,8,12))
grid.arrange(
  p_main_accuracy,
  p_intervention_mode_ps,
  p_mode_parameters,
  p_mode,
  p_s_main_accuracy ,
  p_s_intervention_mode_ps,
  p_s_mode_parameters,
  p_s_mode,
  p_mode_time, p_mode_difficulty,
  s_p_mode_time, s_p_mode_difficulty,
  layout_matrix = lay,
  heights = c(1,1,1,1),
  widths = c(0.8,0.4, 0.3, 0.4, 0.6)
)

```

**Figure 2.**

**A.** The percepts $y_t$ were more likely to match the stimuli $s_t$ at higher levels of SAR ($\beta$ = $`r STAT.y_choice_by_STP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[2,4]`$). The positive effect of SAR on $P(y_t \cong s_t)$ was more pronounced under S-ketamine (red) relative to placebo (blue; $\beta$ = $`r -STAT.y_choice_by_STP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[5,4]`$).

**B.** In the S-ketamine experiment, the HMM identified two modes that differed with respect to the relative weighting of external sensory data and internal predictions: Perception fluctuated between an external mode, determined by the input $s_t$ (upper panel panel, steep slope and small shift of the psychometric curve), and an internal mode, dominated by a stabilizing prediction that biased perception toward previous experiences $y_{t-1}$ (lower panel, shallow slope and large shift of the psychometric curve). Within modes, there was no significant effect of S-ketamine (red) versus placebo (blue) on the relation of $y(t)$ with $s(t)$ and $y(t-1)$.

**C.** $\Delta_{S-P}$, the balance between the external input and the stabilizing internal predictions, was larger during external than during internal mode ($\beta$ = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r -STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[2,5]`$). 
Importantly, we found no significant effect of S-ketamine (red) vs. placebo (blue) on $\Delta_{S-P}$ within modes ($\beta$ = $`r STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[3,5]`$).

**D.** S-ketamine (red) increased the probability of external mode ($\beta$ = $`r -STAT.Mode_by_I$coefficients[2,1]`$ ± $`r STAT.Mode_by_I$coefficients[2,2]`$, z = $`r -STAT.Mode_by_I$coefficients[2,3]`$, p = $`r STAT.Mode_by_I$coefficients[2,4]`$) relative to placebo (blue). The effect of S-ketamine on mode was present from the start of the session ($\beta$ = $`r -STAT.Mode_by_time$coefficients[3,1]`$ ± $`r  STAT.Mode_by_time$coefficients[3,2]`$, z = $`r -STAT.Mode_by_time$coefficients[3,3]`$, p = $`r STAT.Mode_by_time$coefficients[3,4]`$, upper right panel), with no significant effect of time ($\beta$ = $`r STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  STAT.Mode_by_time$coefficients[2,2]`$, z = $`r STAT.Mode_by_time$coefficients[2,3]`$, p = $`r STAT.Mode_by_time$coefficients[2,4]`$). Relative to placebo, S-ketamine increased the probability of external mode across all SARs ($\beta$ = $`r -STAT.Mode_by_difficulty$coefficients[3,1]`$ ± $`r STAT.Mode_by_difficulty$coefficients[3,2]`$, z = $`r -STAT.Mode_by_difficulty$coefficients[3,3]`$, p = $`r STAT.Mode_by_difficulty$coefficients[3,4]`$, lower right panel). Higher SARs were associated with an increased probability of external mode ($\beta$ = $`r STAT.Mode_by_difficulty$coefficients[2,1]`$ ± $`r  STAT.Mode_by_difficulty$coefficients[2,2]`$, z = $`r STAT.Mode_by_difficulty$coefficients[2,3]`$, p = $`r STAT.Mode_by_difficulty$coefficients[2,4]`$), in particular under S-ketamine ($\beta$ = $`r -STAT.Mode_by_difficulty$coefficients[4,1]`$ ± $`r  STAT.Mode_by_difficulty$coefficients[4,2]`$, z = $`r -STAT.Mode_by_difficulty$coefficients[4,3]`$, p = $`r STAT.Mode_by_difficulty$coefficients[4,4]`$). Alternations between external and internal mode were found at all SARs: From from full ambiguity to complete disambiguation, the probability of external mode increased by only `r diff(range(Group_Summary_Difficulty_Data[Group_Summary_Difficulty_Data$Intervention == "Ketamine",]$mean))` under S-ketamine and `r diff(range(Group_Summary_Difficulty_Data[Group_Summary_Difficulty_Data$Intervention == "Placebo",]$mean))` under placebo. 

**E.** In patients (red) and controls (blue), percepts $y_t$ were more likely to match the stimuli $s_t$ at higher levels of SAR ($\beta$ = $`r STAT.y_choice_by_SGP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[2,4]`$).
Patients followed the external inputs more closely than controls ($\beta$ = $`r -STAT.y_choice_by_SGP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[5,4]`$). 

**F.** In analogy to the S-ketamine experiment, the HMM identified two opposing modes in Scz patients (red) and controls (blue). The external mode increased the sensitivity toward $s_t$ (slope of the psychometric function) and weakened the effect of the stabilizing internal prediction $y_{t-1}$ (shift between the dotted and solid line) relative to the internal mode. Within modes, there was no effect of group on the relation of $y(t)$ with $s(t)$ and $y(t-1)$. 

**G.** The external mode increased $\Delta_{S-P}$, the balance between external inputs and internal predictions, in patients (red) and controls (blue; $\beta$ = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), 
with no significant effect of group ($\beta$ = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,5]`$).

**H.** Relative to controls (blue), patients (red) spent more time in external mode ($\beta$ = $`r -S_STAT.Mode_by_G$coefficients[2,1]`$ ± $`r S_STAT.Mode_by_G$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_G$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_G$coefficients[2,4]`$). In both group, biases toward external mode increased over time after session onset ($\beta$ = $`r S_STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  S_STAT.Mode_by_time$coefficients[2,2]`$, z = $`r S_STAT.Mode_by_time$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[2,4]`$; upper right panel), with a stronger effect in patients ($\beta$ = $`r S_STAT.Mode_by_time$coefficients[4,1]`$ ± $`r S_STAT.Mode_by_time$coefficients[4,2]`$, z = $`r S_STAT.Mode_by_time$coefficients[4,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[4,4]`$). Patients were more likely than controls to be in external mode across all levels of SAR ($\beta$ = $`r -S_STAT.Mode_by_difficulty$coefficients[3,1]`$ ± $`r  S_STAT.Mode_by_difficulty$coefficients[3,2]`$, z = $`r -S_STAT.Mode_by_difficulty$coefficients[3,3]`$, p = $`r S_STAT.Mode_by_difficulty$coefficients[3,4]`$, lower right panel). External mode increased with SAR ($\beta$ = $`r S_STAT.Mode_by_difficulty$coefficients[2,1]`$ ± $`r  S_STAT.Mode_by_difficulty$coefficients[2,2]`$, z = $`r S_STAT.Mode_by_difficulty$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_difficulty$coefficients[2,4]`$), with no significant difference between groups ($\beta$ = $`r -S_STAT.Mode_by_difficulty$coefficients[4,1]`$ ± $`r  S_STAT.Mode_by_difficulty$coefficients[4,2]`$, z = $`r -S_STAT.Mode_by_difficulty$coefficients[4,3]`$, p = $`r S_STAT.Mode_by_difficulty$coefficients[4,4]`$). As in the S-ketamine experiment, alternations between external and internal mode were found at all SARs: From from full ambiguity to complete disambiguation, the probability of external mode increased by only `r diff(range(Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Patients",]$mean))` in patients and `r diff(range(Group_S_Summary_Difficulty_Data[Group_S_Summary_Difficulty_Data$Group == "Controls",]$mean))` in controls.

\newpage
# Supplemental Information

## Supplemental Figure S1

```{r Supplemental_Figure_S1}
library(ggplot2)
library(dplyr)

# Define parameter names and their corresponding x-locations
param_names <- c(
  "0, 0, 0" = "S(ext)",
  "0, 0, 1" = "B(ext)",
  "0, 0, 2" = "P(ext)",
  "1, 0, 0" = "S(int)",
  "1, 0, 1" = "B(int)",
  "1, 0, 2" = "P(int)"
)

# Calculate the x-locations based on the means in P_Data_long
x_locations <- data.frame(
  Param = c("S(ext)", "B(ext)", "P(ext)", "S(int)", "B(int)", "P(int)"),
  xintercept = c(
    mean(P_Data_long[P_Data_long$Mode == "external" & P_Data_long$Variable == "Stimulus",]$value, na.rm = TRUE),
    mean(P_Data_long[P_Data_long$Mode == "external" & P_Data_long$Variable == "Bias",]$value, na.rm = TRUE),
    mean(P_Data_long[P_Data_long$Mode == "external" & P_Data_long$Variable == "PS",]$value, na.rm = TRUE),
    mean(P_Data_long[P_Data_long$Mode == "internal" & P_Data_long$Variable == "Stimulus",]$value, na.rm = TRUE),
    mean(P_Data_long[P_Data_long$Mode == "internal" & P_Data_long$Variable == "Bias",]$value, na.rm = TRUE),
    mean(P_Data_long[P_Data_long$Mode == "internal" & P_Data_long$Variable == "PS",]$value, na.rm = TRUE)
  )
)

# Initialize an empty list to store data frames
all_data <- list()

# Iterate over parameter files and concatenate
for (param_key in names(param_names)) {
  # Construct the file name
  file_name <- paste(root_dir, "step_results_param_(", param_key, ").csv", sep = "")
  
  # Read the data
  param_recovery <- read.csv(file_name)
  
  # Assign the corresponding parameter name
  param_recovery$Param <- param_names[[param_key]]
  
  # Store the data frame in the list
  all_data[[param_key]] <- param_recovery
}

# Concatenate all data frames
final_data <- bind_rows(all_data)

# Merge x_locations into final_data to have xintercept values for each Param
final_data <- merge(final_data, x_locations, by = "Param")

# Set the order of Param based on param_names
final_data$Param <- factor(final_data$Param, levels = param_names)

# Plotting
library('ggthemes')
p_recovery_corr <- ggplot(data = final_data,
                          aes(x = Input_Param, y = Recovered_Param)) +
  geom_point(alpha = alpha_gd, size = dot_size_gd, 
             position = position_dodge(width = dodge_width)) +
  #geom_smooth(method = "lm", se = TRUE, alpha = alpha_sd, size = dot_size_gd, 
  #            position = position_dodge(width = dodge_width)) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +  # Add diagonal line
  geom_vline(aes(xintercept = xintercept), color = "black", linetype = "dashed") +  # Add vertical lines
  geom_hline(aes(yintercept = xintercept), color = "black", linetype = "dashed") +  # Add vertical lines
  theme_classic(base_size = 6) +
  scale_color_brewer(palette = "Set1", direction = 1) +
  scale_fill_brewer(palette = "Set1", direction = 1) +
  theme(legend.position = "top") +
  labs(x = "Input", y = "Recovery", subtitle = "A") +
  facet_wrap(~ Param, scales = "free") +
  ylim(-1, 5) + xlim(-1, 5) +
  theme(panel.spacing = unit(1, "lines"))



transition_matrix = read.csv(paste(root_dir, "step_trans_matrix_recovery.csv", sep = ""))

# Load necessary library
library(stringr)
library(dplyr)

# Function to safely extract specific values based on the order
extract_values_by_order <- function(row) {
  values <- as.numeric(strsplit(gsub("\\[|\\]", "", row), " ")[[1]])
  if (length(values) == 4) {
    return(values)
  } else {
    return(rep(NaN, 4))  # Fill with NaN if extraction fails
  }
}

# Apply extraction to both generated and recovered matrices
gen_matrix <- t(sapply(transition_matrix$gen_log_trans_mats, extract_values_by_order))
recovered_matrix <- t(sapply(transition_matrix$recovered_trans_mats, extract_values_by_order))

# Combine into a long-format data frame, with each row corresponding to the correct parameter
final_df <- data.frame(
  Param = rep(c("E to E", "E to I", "I to E", "I to I"), each = nrow(gen_matrix)),
  Input_Param = c(gen_matrix[, 1], gen_matrix[, 2], gen_matrix[, 3], gen_matrix[, 4]),
  Recovered_Param = c(recovered_matrix[, 1], recovered_matrix[, 2], recovered_matrix[, 3], recovered_matrix[, 4])
)

# Calculate the mean for each transition type


# Create a data frame with the means for easy use in geom_hline
mean_lines <- data.frame(
  Param = c("E to E", "E to I", "I to E", "I to I"),
  Mean_Value = c(0.99, 0.01, 0.01, 0.99)
)

# Plotting
p_recovery_corr_matrix <- ggplot(data = final_df,
                          aes(x = Input_Param, y = Recovered_Param)) +
  geom_point(alpha = alpha_gd, size = dot_size_gd, 
             position = position_dodge(width = dodge_width)) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +  # Add diagonal line
  geom_vline(data = mean_lines, aes(xintercept = Mean_Value), 
             color = "black", linetype = "dashed") +  # Add horizontal lines
  geom_hline(data = mean_lines, aes(yintercept = Mean_Value), 
             color = "black", linetype = "dashed") +  # Add horizontal line
  theme_classic(base_size = 6) +
  scale_color_brewer(palette = "Set1", direction = 1) +
  scale_fill_brewer(palette = "Set1", direction = 1) +
  labs(x = "Input", y = "Recovery", subtitle = "B") +
  facet_wrap(~ Param, scales = "free") 

lay <- rbind(c(1,2))
grid.arrange(
  p_recovery_corr,
  p_recovery_corr_matrix,
  layout_matrix = lay,
  heights = c(1),
  widths = c(3,2)
)
```
**Supplemental Figure S1. GLM-HMM parameter recovery**

**A**. The GLM-HMM is defined by the mode-dependent weights $\beta_S$, $\beta_B$, and $\beta_P$. To test how well our GLM-HMM can recover changes in individual weights, we selected one of the six weights (3 weights x 2 modes) and varied its value parametrically from -1 to 5. For each inversion, we kept all other weights at the group-level average obtained from the original data. For each of the six recovery analyses, we simulated synthetic experiences $y_{syn}$ for n = 78400 overlaps (number of overlaps across participants in the S-ketamine experiment). We then fitted a randomly initialized GLM-HMM to the synthetic experiences, and extracted the weights recovered from the synthetic experiences $y_{syn}$. We performed each recovery for 10 iterations, computed the average posterior weights $\beta_S$, $\beta_B$, and $\beta_P$, and correlated them with the synthetic input weights. The correlation with the parametric input weights and the posterior weights recovered from the simulated data were close to 1 for all weights ($\beta_S$, $\beta_B$, and $\beta_P$, columns) and modes (external and internal, rows). Weights were recovered with high fidelity across a broad range of weights (average r = 0.99), and in particular at the group-level weights $w_n$ obtained from the original data (black dotted line). The red dashed line represents the identity line (slope = 1, intercept = 0), indicating perfect recovery.

**B**. We repeated the above procedure for each cell of the GLM-HMM transition matrix. We initialized models with parametric transition probabilities ranging from 0.8 to 1 (on-diagonal cells, external to external, internal to internal) and 0 to 0.2 (off-diagonal cells, external to internal, internal to external). Transition probabilities were recovered with high fidelity across a broad range of parameters (average r = 0.99), and in particular at the group-level estimates obtained from the original data (black dotted line). The red dashed line represents the identity line (slope = 1, intercept = 0), indicating perfect recovery.

\newpage
## Supplemental Figure S2

```{r Supplemental_Figure_S2, fig.height = 7}
p_summary_RT <-
ggplot(Data[Data$Intervention != "None" & Data$Disambiguation == 0,],
aes(
x = RT,
y = as.factor(ID),
fill = Intervention
)) + geom_density_ridges(color = "white", bandwidth = 0.2, scale = 4, alpha = 0.5) + theme_ridges(font_size = 10,
grid = FALSE,
center_axis_labels = TRUE) + xlim(-0.1, 1.6) + xlab("RT (sec)") + labs(x =
"RT (sec)",  y = "Participants", subtitle = "A") + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none", axis.text.y=element_blank())

## collapsed Histogram RT
p_collapsed_RT <- ggplot(Data[Data$Intervention != "None",], aes(x = RT, y=..density.., fill = Intervention))+ geom_density(alpha = 0.5, bw = 0.25, scale = 4, color = "white") +
 labs(x="RT (sec)",  y="Density", subtitle = "B") + xlim(-0.1, 1.6) + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none")


##
## Psychometric function
##
dodge_width = 0.05
Variables = c("RT")

p_intervention_ps_RT <-
  ggplot() + geom_point(
    data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 1.5),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_intervention_mode_ps_RT <-
  ggplot() + geom_point(
    data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 1.5),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "C",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)

Variables = c("confidence")
p_intervention_ps_conf <-
  ggplot() + geom_point(
    data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(high confidence)",
    subtitle = "D",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_intervention_mode_ps_conf <-
  ggplot() + geom_point(
    data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(high confidence)",
    subtitle = "external",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)

lay <- rbind(c(1,2,3),
             c(1,4,5))
grid.arrange(
p_summary_RT,
p_intervention_ps_RT,
p_intervention_mode_ps_RT,
p_intervention_ps_conf,
p_intervention_mode_ps_conf,
layout_matrix = lay,
heights=c(1,1), widths=c(0.25,0.6, 1)
)

ks_test_data = Data[Data$Intervention != "None" & Data$Disambiguation == 0,]$RT
ks_test_data = ks_test_data[!is.na(ks_test_data)]
STAT_uniform = ks.test(ks_test_data, "punif", min = min(ks_test_data), max = max(ks_test_data))
```

**Supplemental Figure S2. The effects of ketamine and bimodal inference on RT.**

**A.** RT were non-uniformly distributed across the inter-overlap interval (D = $`r STAT_uniform$statistic`$, p = $`r STAT_uniform$p.value`$, one-sample Kolmogorov-Smirnov test). This corroborates that changes in perception aligned with the overlapping configurations of the stimulus after S-ketamine (red) and placebo (blue).

**B.** RT showed a quadratic relationship with $s_t$ ($\beta$ = $`r STAT.RT_by_STP$coefficients[3,1]`$ ± $`r STAT.RT_by_STP$coefficients[3,2]`$, T($`r STAT.RT_by_STP$coefficients[3,3]`$) = $`r STAT.RT_by_STP$coefficients[3,4]`$, p = $`r STAT.RT_by_STP$coefficients[3,5]`$), 
indicating faster responses when sensory information was reliable ($|s_t| \gg  0$; note that SAR as shown in Figure 2A and 2E is equal to $|s_t|$). We observed no main effect of S-ketamine (red) vs. placebo (blue) on RT ($\beta$ = $`r STAT.RT_by_STP$coefficients[4,1]`$ ± $`r STAT.RT_by_STP$coefficients[4,2]`$, T($`r STAT.RT_by_STP$coefficients[4,3]`$) = $`r STAT.RT_by_STP$coefficients[4,4]`$, p = $`r STAT.RT_by_STP$coefficients[4,5]`$).

**C.** We found no additional effect of mode on RT ($\beta$ = $`r STAT.RT_by_STPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_STPM$coefficients[6,2]`$, z = $`r STAT.RT_by_STPM$coefficients[6,3]`$, p = $`r STAT.RT_by_STPM$coefficients[6,4]`$).

**D.** Confidence showed a quadratic relationship with $s_t$ ($\beta$ = $`r STAT.y_conf_by_STP$coefficients[3,1]`$ ± $`r  STAT.y_conf_by_STP$coefficients[3,2]`$, z = $`r STAT.y_conf_by_STP$coefficients[3,3]`$, p = $`r STAT.y_conf_by_STP$coefficients[3,4]`$), confirming that participants were more confident when sensory information was reliable ($|s_t| = SAR \gg  0$). Relative to placebo (blue), S-ketamine (red) reduced choice confidence ($\beta$ = $`r -STAT.y_conf_by_STP$coefficients[4,1]`$ ± $`r  STAT.y_conf_by_STP$coefficients[4,2]`$, z = $`r -STAT.y_conf_by_STP$coefficients[4,3]`$, p = $`r STAT.y_conf_by_STP$coefficients[4,4]`$), and decreased the quadratic effect of  $s_t$ on confidence ($\beta$ = $`r -STAT.y_conf_by_STP$coefficients[7,1]`$ ± $`r  STAT.y_conf_by_STP$coefficients[7,2]`$, z = $`r -STAT.y_conf_by_STP$coefficients[7,3]`$, p = $`r STAT.y_conf_by_STP$coefficients[7,4]`$).

**E.** External mode increased confidence globally ($\beta$ = $`r -STAT.y_conf_by_STPM$coefficients[6,1]`$ ± $`r STAT.y_conf_by_STPM$coefficients[6,2]`$, z = $`r -STAT.y_conf_by_STPM$coefficients[6,3]`$, p = $`r STAT.y_conf_by_STPM$coefficients[6,4]`$) and by elevating the quadratic effect of $s_t$ on confidence ($\beta$ = $`r -STAT.y_conf_by_STPM$coefficients[13,1]`$ ± $`r STAT.y_conf_by_STPM$coefficients[13,2]`$, z = $`r -STAT.y_conf_by_STPM$coefficients[13,3]`$, p = $`r STAT.y_conf_by_STPM$coefficients[13,4]`$). When controlling for mode, the negative effect of S-ketamine (red) vs. placebo (blue) on confidence and on the quadratic relationship of confidence with $s_t$ remained significant.

\newpage
## Supplemental Figure S3

```{r Supplemental_Figure_S3, fig.height = 7}

# alpha_sd = 0.45
# alpha_gd = 0.65
# dot_size_sd = 0.5
# line_size_sd = dot_size_sd/20
# dot_size_gd = 4 * dot_size_sd
# line_size_gd = 2 * dot_size_sd

##
## Psychometric function
##
dodge_width = 0.05
Variables = c("y_choice")

p_intervention_ps <-
  ggplot() + geom_point(
    data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention,
      fill = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = Summary_Choice_ps_long[Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + 
    geom_line(
    data = Group_Summary_Choice_ps_long[Group_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) + 
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "A",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_intervention_mode_ps <-
  ggplot() + geom_point(
    data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = (w_Stimulus),
      y = Value,
      color = Intervention
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = Summary_Choice_mode_ps_long[Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = (w_Stimulus),
      y = Value,
      group = interaction(ID, Intervention)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = (w_Stimulus),
      fill = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_Summary_Choice_mode_ps_long[Group_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = (w_Stimulus),
      color = Intervention
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)


##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus", "Bias", "PS", "Stimulus-PS")
p_mode_parameters <-
  ggplot() + geom_jitter(
    data = P_Data_long[P_Data_long$Variable %in% Variables &
                         P_Data_long$Intervention != "None" & P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_P_Data_long[Group_P_Data_long$Variable %in% Variables &
                               Group_P_Data_long$Intervention != "None" & Group_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "C") + facet_wrap( ~ Variable, ncol = length(Variables))


Variables = c("EE", "II")
p_mode <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Variable,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Variable,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0.50),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Mode",
    y = "Rate",
    subtitle = "D",
    color = "Intervention"
  ) +facet_wrap(~"Survival")

Variables = c("EI", "IE")
p_mode_2 <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Variable,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Variable,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Mode",
    y = "Rate",
    subtitle = " ",
    color = "Intervention"
  ) + facet_wrap(~"Transition")

Summary_Mode_long$Variable <- factor(Summary_Mode_long$Variable, levels = c("EE", "II", "EI", "IE"))
Group_Summary_Mode_long$Variable <- factor(Group_Summary_Mode_long$Variable, levels = c("EE", "II", "EI", "IE"))

Variables = c("EE", "II")
# Create the plot
p_mode_stability <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Intervention,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Intervention,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + 
  scale_fill_brewer(palette = "Set1", direction = 1) + 
  theme(legend.position = "none") +
  labs(
    x = "Intervention",
    y = "Probability",
    subtitle = "D",
    color = "Intervention"
  ) + 
  facet_wrap(~Variable, nrow = 1, scales = "free")

Variables = c("EI", "IE")
# Create the plot
p_mode_transition <-
  ggplot() + geom_jitter(
    data = Summary_Mode_long[Summary_Mode_long$Intervention != "None" &
                               Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Intervention,
        y = value,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Mode_long[Group_Summary_Mode_long$Intervention != "None" &
                                     Group_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Intervention,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + 
  scale_fill_brewer(palette = "Set1", direction = 1) + 
  theme(legend.position = "none") +
  labs(
    x = "Intervention",
    y = "Probability",
    subtitle = NULL,
    color = "Intervention"
  ) + 
  facet_wrap(~Variable, nrow = 1, scales = "free")

lay <- rbind(c(1,2), c(3), c(4,5))
grid.arrange(
  p_intervention_ps,
  p_intervention_mode_ps,
  p_mode_parameters,
  p_mode_stability,
  p_mode_transition,
  layout_matrix = lay,
  heights = c(2.25,1,1),
  widths = c(1,1)
)
```

**Supplemental Figure S3. Extended data on the effects of S-ketamine and mode on perceptual inference (related to Figure 2A-C).**

**A.** Here, we show psychometric curves (percept $y_t$ versus input $s_t$) under S-ketamine (red) and placebo (blue). The plot separates times $t$ for which the previous experience was leftward rotation ($y_{t-1} = -1$, upper panel) and rightward rotation ($y_{t-1} = +1$, lower panel). As expected, $y_t$ was driven by both the external input $s_t$ ($\beta_S$ = $`r STAT.y_choice_by_STP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[2,4]`$) and the previous percept $y_{t-1}$ ($\beta_{P}$ = $`r STAT.y_choice_by_STP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[4,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[4,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[4,4]`$). 
We found no significant interaction between the $s_t$ and $y_{t-1}$ ($\beta$ = $`r STAT.y_choice_by_STP$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[6,2]`$, z = $`r STAT.y_choice_by_STP$coefficients[6,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[6,4]`$). 
Relative to placebo, S-ketamine caused a shift of $y_t$ toward $s_t$ ($\beta$ = $`r -STAT.y_choice_by_STP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[5,4]`$), with no significant effect on $y_{t-1}$ ($\beta$ = $`r -STAT.y_choice_by_STP$coefficients[7,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[7,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[7,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[7,4]`$). 
We found no significant three-way-interaction (drug x $s_t$ x $y_{t-1}$, $\beta$ = $`r -STAT.y_choice_by_STP$coefficients[8,1]`$ ± $`r  STAT.y_choice_by_STP$coefficients[8,2]`$, z = $`r -STAT.y_choice_by_STP$coefficients[8,3]`$, p = $`r STAT.y_choice_by_STP$coefficients[8,4]`$).

**B.** This panel shows the data from panel (A) separately for times $t$ where the HMM identified the mode of perceptual inference as external (left panels) or internal (right panels). When the mode of perceptual processing was added to the prediction of $y_t$ from $s_t$ and $y_{t-1}$, the effect S-ketamine (red) vs. placebo (blue) on $s_t$ disappeared ($\beta$ = $`r STAT.y_choice_by_STPM$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_STPM$coefficients[6,2]`$, z = $`r STAT.y_choice_by_STPM$coefficients[6,3]`$, p = $`r STAT.y_choice_by_STPM$coefficients[6,4]`$). Instead, changes in the balance between $s_t$ and $y_{t-1}$ were loaded onto fluctuations between external and internal mode, which caused perception to shift away from external inputs $s_t$ ($\beta$ = $`r STAT.y_choice_by_STPM$coefficients[9,1]`$ ± $`r  STAT.y_choice_by_STPM$coefficients[9,2]`$, z = $`r STAT.y_choice_by_STPM$coefficients[9,3]`$, p = $`r STAT.y_choice_by_STPM$coefficients[9,4]`$) and toward previous experiences $y{t-1}$ ($\beta$ = $`r STAT.y_choice_by_STPM$coefficients[11,1]`$ ± $`r  STAT.y_choice_by_STPM$coefficients[11,2]`$, z = $`r STAT.y_choice_by_STPM$coefficients[11,3]`$, p = $`r STAT.y_choice_by_STPM$coefficients[11,4]`$). 

**C.** Here, we plot the weights from the GLM $y_t = \beta_S \times s_t + \beta_P \times y_{t-1} + \beta_B \times 1$, alongside the balance between external inputs and previous experiences $\Delta_{S-P} = \beta_S - \beta_P$ during external and internal mode. Colors indicate S-ketamine (red) and placebo (blue). $\beta_S$, the weight associated with the external input $s_t$, was positive in external mode, but reduced to zero in internal mode ($\beta$ = $`r STAT.Stimulus_by_MI$coefficients[2,1]`$ ± $`r  STAT.Stimulus_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_by_MI$coefficients[2,3]`$) = $`r STAT.Stimulus_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_by_MI$coefficients[2,5]`$). 
We found no additional effect of S-ketamine (red) versus placebo (blue; $\beta$ = $`r STAT.Stimulus_by_MI$coefficients[3,1]`$ ± $`r  STAT.Stimulus_by_MI$coefficients[3,2]`$, T($`r STAT.Stimulus_by_MI$coefficients[3,3]`$) = $`r STAT.Stimulus_by_MI$coefficients[3,4]`$, p = $`r STAT.Stimulus_by_MI$coefficients[3,5]`$) 
and no significant interaction ($\beta$ = $`r STAT.Stimulus_by_MI$coefficients[4,1]`$ ± $`r  STAT.Stimulus_by_MI$coefficients[4,2]`$, T($`r STAT.Stimulus_by_MI$coefficients[4,3]`$) = $`r STAT.Stimulus_by_MI$coefficients[4,4]`$, p = $`r STAT.Stimulus_by_MI$coefficients[4,5]`$).
$\beta_B$, the weight associated with the constant response bias $b$ toward rightward rotation, was not different from zero ($\beta_B$ = $`r STAT.Bias_by_MI$coefficients[1,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[1,2]`$, T($`r STAT.Bias_by_MI$coefficients[1,3]`$) = $`r STAT.Bias_by_MI$coefficients[1,4]`$, p = $`r STAT.Bias_by_MI$coefficients[1,5]`$). 
We found no effect of drug ($\beta$ = $`r STAT.Bias_by_MI$coefficients[3,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[3,2]`$, T($`r STAT.Bias_by_MI$coefficients[3,3]`$) = $`r STAT.Bias_by_MI$coefficients[3,4]`$, p = $`r STAT.Bias_by_MI$coefficients[3,5]`$) 
or mode ($\beta$ = $`r STAT.Bias_by_MI$coefficients[2,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[2,2]`$, T($`r STAT.Bias_by_MI$coefficients[2,3]`$) = $`r STAT.Bias_by_MI$coefficients[2,4]`$, p = $`r STAT.Bias_by_MI$coefficients[2,5]`$) on the bias weight $\beta_B$. 
$\beta_P$, the weight associated with the previous percept $y_{t-1}$ was not modulated by S-ketamine ($\beta$ = $`r STAT.PS_by_MI$coefficients[3,1]`$ ± $`r  STAT.PS_by_MI$coefficients[3,2]`$, T($`r STAT.PS_by_MI$coefficients[3,3]`$) = $`r STAT.PS_by_MI$coefficients[3,4]`$, p = $`r STAT.PS_by_MI$coefficients[3,5]`$) or mode ($\beta$ = $`r STAT.PS_by_MI$coefficients[2,1]`$ ± $`r  STAT.PS_by_MI$coefficients[2,2]`$, T($`r STAT.PS_by_MI$coefficients[2,3]`$) = $`r STAT.PS_by_MI$coefficients[2,4]`$, p = $`r STAT.PS_by_MI$coefficients[2,5]`$). 
There was no significant interaction between drug and mode with respect to $\beta_P$ ($\beta$ = $`r STAT.PS_by_MI$coefficients[4,1]`$ ± $`r  STAT.PS_by_MI$coefficients[4,2]`$, T($`r STAT.PS_by_MI$coefficients[4,3]`$) = $`r STAT.PS_by_MI$coefficients[4,4]`$, p = $`r STAT.PS_by_MI$coefficients[4,5]`$).
The balance $\Delta_{S-P}$ between external inputs and internal predictions was determined by mode ($\beta$ = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), with no significant effect of S-ketamine ($\beta$ = $`r -STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[3,5]`$) and no interaction ($\beta$ = $`r -STAT.Stimulus_PS_by_MI$coefficients[4,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[4,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[4,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[4,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[4,5]`$). 
These posterior GLM-HMM weights argue against the alternative hypotheses that the primary effect of S-ketamine is related to changes in dynamics of bias (state 1: high $\beta_B$; state 2: low $\beta_B$; hypothesis H3) or the randomness of experience (state 1: high $\beta_S$ and $\beta_P$; state 2: low $\beta_S$ and $\beta_P$ with no difference in $\Delta_{S-P}$ between modes: hypothesis H4).

**D.** S-ketamine (red) increased the probability of external mode ($\beta$ = $`r -STAT.Mode_by_I$coefficients[2,1]`$ ± $`r STAT.Mode_by_I$coefficients[2,2]`$, z = $`r -STAT.Mode_by_I$coefficients[2,3]`$, p = $`r STAT.Mode_by_I$coefficients[2,4]`$) relative to placebo (blue) by elevating the stability of external at the expense of internal mode (EE versus II; left panels; V = `r STAT.Mode_Intervention$statistic`, p = `r STAT.Mode_Intervention$p.value`), with no effect on the transition probabilities between modes (EI versus IE; right panels; V = `r STAT.Mode_Intervention_2$statistic`, p = `r STAT.Mode_Intervention_2$p.value`).

<!-- \newpage -->
<!-- ## Supplemental Figure S4 -->

```{r Supplemental_Figure_SX0}
dodge_width = 0.5

Variables = c("Stability")

p_main_stab_conf <- ggplot() + geom_jitter(data = Summary_Data_no_mode_con_long[Summary_Data_no_mode_con_long$Intervention != "None" & Summary_Data_no_mode_con_long$Variable %in% Variables,],
  aes(
  x = as.factor(uDisambiguation),
  y = value,
  color = Intervention
  ), alpha = 0.25, size = 0.25, position = position_jitterdodge(dodge.width = dodge_width, jitter.width = 0,
  jitter.height = 0)) +
  geom_hline(
  yintercept = c(0,0.5,1),
  linetype = "dashed",
  color = "black",
  size = 0.25
  ) + 
  geom_errorbar(
    data = Group_Summary_Data_no_mode_con_long[Group_Summary_Data_no_mode_con_long$Intervention != "None" & Group_Summary_Data_no_mode_con_long$Variable %in% Variables,],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = as.factor(uDisambiguation),
      color = Intervention
    ),
    width = dodge_width/2,
    position = position_dodge(width = dodge_width*2),
    size = 0.5
  ) +
  theme_classic(base_size = 6) + labs(
  x = "Session",
  y = "Value",
  subtitle = NULL,
  color = "Mouse"
  ) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "SAR",  y = paste("Stability", sep = " "), subtitle = NULL, color = "Intervention") + facet_wrap(~ cond_Accuracy, ncol = 3, scales = "free") + theme(panel.spacing=unit(1,"lines"))


#p_main_stab_conf

```

<!-- **Supplemental Figure S4. The effects of S-ketamine on perceptual stability.** -->

<!-- Due to the competition between the stabilizing internal prediction $y_{t-1}$ and the sensory input $s_t$, perceptual stability P($y(t) = y_{t-1}$) was reduced at higher levels of SAR ($`r STAT.stability_by_TDC$coefficients[2,1]`$ ± $`r  STAT.stability_by_TDC$coefficients[2,2]`$, z = $`r STAT.stability_by_TDC$coefficients[2,3]`$, p = $`r STAT.stability_by_TDC$coefficients[2,4]`$). The negative effect of SAR on perceptual stability was larger for stimulus-incongruent states ($`r -STAT.stability_by_TDC$coefficients[6,1]`$ ± $`r  STAT.stability_by_TDC$coefficients[6,2]`$, z = $`r -STAT.stability_by_TDC$coefficients[6,3]`$, p = $`r STAT.stability_by_TDC$coefficients[6,4]`$). Numerically, S-ketamine decreased the stability of stimulus-incongruent states P($y(t) \neq s(t)$), and increased the stability of stimulus-congruent states P($y(t) = s(t)$). However, linear mixed effects modeling indicated no significant main effect of S-ketamine on perceptual stability, no interaction of S-ketamine with stimulus-congruence or SAR, and no three-way interaction.  -->

\newpage
## Supplemental Figure S4

```{r Supplemental_Figure_S4, fig.height = 7}

# alpha_sd = 0.45
# alpha_gd = 0.65
# dot_size_sd = 0.5
# line_size_sd = dot_size_sd/20
# dot_size_gd = 4 * dot_size_sd
# line_size_gd = 2 * dot_size_sd

##
## Psychometric function
##
dodge_width = 0.05
stretch = 0.5
Variables = c("y_choice")

p_s_intervention_ps <-
  ggplot() + geom_point(
    data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "A",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_s_intervention_mode_ps <-
  ggplot() + geom_point(
    data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus^stretch),
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 0.5, 1),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) +  geom_line(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
  labs(
    x = "s(t)",
    y = "P(y(t) = 1)",
    subtitle = "B",
    color = "Group",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)


##
## Mode
##

dodge_width = 0.25
Variables = c("Stimulus", "Bias", "PS", "Stimulus-PS")
p_s_mode_parameters <-
  ggplot() + geom_jitter(
    data = S_P_Data_long[S_P_Data_long$Variable %in% Variables & S_P_Data_long$num_states == 2, ],
    aes(x = Mode,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_P_Data_long[Group_S_P_Data_long$Variable %in% Variables & Group_S_P_Data_long$num_states == 2, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  geom_hline(
    yintercept = c(0),
    linetype = "dashed",
    color = "black",
    size = 0.25
  ) +
  theme_classic(base_size = 6) + scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(x = "Mode",
       y = paste("Estimate"),
       subtitle = "C") + facet_wrap( ~ Variable, ncol = length(Variables))

Summary_Mode_long$Variable <- factor(Summary_Mode_long$Variable, levels = c("EE", "II", "EI", "IE"))
Group_Summary_Mode_long$Variable <- factor(Group_Summary_Mode_long$Variable, levels = c("EE", "II", "EI", "IE"))

Variables = c("EE", "II")
p_s_mode_stability <-
  ggplot() + geom_jitter(
    data = S_Summary_Mode_long[S_Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Group,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_Summary_Mode_long[Group_S_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Group,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Group",
    y = "Probability",
    subtitle = "D",
    color = "Group"
  ) + facet_wrap(~Variable)

Variables = c("EI", "IE")
p_s_mode_transition <-
  ggplot() + geom_jitter(
    data = S_Summary_Mode_long[S_Summary_Mode_long$Variable %in% Variables , ],
    aes(x = Group,
        y = value,
        color = Group),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_S_Summary_Mode_long[Group_S_Summary_Mode_long$Variable %in% Variables, ],
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Group,
      color = Group
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Group",
    y = "Probability",
    subtitle =  NULL,
    color = "Group"
  ) + facet_wrap(~Variable)


lay <- rbind(c(1,2), c(3), c(4,5))
grid.arrange(
  p_s_intervention_ps,
  p_s_intervention_mode_ps,
  p_s_mode_parameters,
  p_s_mode_stability,
  p_s_mode_transition,
  layout_matrix = lay,
  heights = c(2.25,1,1),
  widths = c(1,1)
)

# which(STAT.y_choice_by_SGPM$coefficients[,4] * nrow(STAT.y_choice_by_SGPM$coefficients) < 0.05)
```

**Supplemental Figure S4. Extended data on external and internal mode in Scz patients and healthy controls (related to Figure 2E-H).**

**A.** Here, we show psychometric curves (percept $y_t$ versus input $s_t$) in patients (red) and controls (blue). The plot separates times $t$ for which the previous experience was leftward rotation ($y_{t-1} = -1$, upper panel) and rightward rotation ($y_{t-1} = +1$, lower panel). Perception was driven by $s_t$ ($\beta_S$ = $`r STAT.y_choice_by_SGP$coefficients[2,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[2,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[2,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[2,4]`$) and $y_{t-1}$ ($\beta_{P}$ = $`r STAT.y_choice_by_SGP$coefficients[4,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[4,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[4,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[4,4]`$), with no significant interaction between $s_t$ and $y_{t-1}$ ($\beta$ = $`r STAT.y_choice_by_SGP$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[6,2]`$, z = $`r STAT.y_choice_by_SGP$coefficients[6,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[6,4]`$). Patients were more sensitive to $s_t$ ($\beta$ = $`r -STAT.y_choice_by_SGP$coefficients[5,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[5,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[5,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[5,4]`$). We found no significant three-way-interaction (group x $s_t$ x $y_{t-1}$, $\beta$ = $`r -STAT.y_choice_by_SGP$coefficients[8,1]`$ ± $`r  STAT.y_choice_by_SGP$coefficients[8,2]`$, z = $`r -STAT.y_choice_by_SGP$coefficients[8,3]`$, p = $`r STAT.y_choice_by_SGP$coefficients[8,4]`$).

**B.** This panel shows the data from panel (A) separately for times $t$ where the HMM identified the mode of perceptual inference as external (left panels) or internal (right panels). When the mode of perceptual processing was added to the prediction of $y_t$ from $s_t$ and $y_{t-1}$, the difference between patients (red) and controls (blue) in the effect of $s_t$ on $y_t$ disappeared ($\beta$ = $`r STAT.y_choice_by_SGPM$coefficients[6,1]`$ ± $`r  STAT.y_choice_by_SGPM$coefficients[6,2]`$, z = $`r STAT.y_choice_by_SGPM$coefficients[6,3]`$, p = $`r STAT.y_choice_by_SGPM$coefficients[6,4]`$). Instead, changes in the balance between $s_t$ and $y_{t-1}$ were loaded onto fluctuations between external and internal mode, which caused perception to shift away from external inputs $s_t$ ($\beta$ = $`r STAT.y_choice_by_SGPM$coefficients[9,1]`$ ± $`r  STAT.y_choice_by_SGPM$coefficients[9,2]`$, z = $`r STAT.y_choice_by_SGPM$coefficients[9,3]`$, p = $`r STAT.y_choice_by_SGPM$coefficients[9,4]`$) and toward previous experiences $y{t-1}$ ($\beta$ = $`r STAT.y_choice_by_SGPM$coefficients[11,1]`$ ± $`r  STAT.y_choice_by_SGPM$coefficients[11,2]`$, z = $`r STAT.y_choice_by_SGPM$coefficients[11,3]`$, p = $`r STAT.y_choice_by_SGPM$coefficients[11,4]`$). 

**C.** Here, we plot the weights from the GLM $y_t = \beta_S \times s_t + \beta_P \times y_{t-1} + \beta_B \times 1$, alongside the balance between external inputs and previous experiences $\Delta_{S-P} = \beta_S - \beta_P$ during external and internal mode. Colors indicate the group (patients in red, controls in blue). $\beta_S$, the weight associated with the external input $s_t$, was positive in external mode, but reduced to zero in internal mode ($\beta$ = $`r S_STAT.Stimulus_by_MI$coefficients[2,1]`$ ± $`r  S_STAT.Stimulus_by_MI$coefficients[2,2]`$, T($`r S_STAT.Stimulus_by_MI$coefficients[2,3]`$) = $`r S_STAT.Stimulus_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_by_MI$coefficients[2,5]`$). 
We found no additional effect of group ($\beta$ = $`r S_STAT.Stimulus_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.Stimulus_by_MI$coefficients[3,2]`$, T($`r S_STAT.Stimulus_by_MI$coefficients[3,3]`$) = $`r S_STAT.Stimulus_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Stimulus_by_MI$coefficients[3,5]`$) 
and no significant interaction ($\beta$ = $`r S_STAT.Stimulus_by_MI$coefficients[4,1]`$ ± $`r  S_STAT.Stimulus_by_MI$coefficients[4,2]`$, T($`r S_STAT.Stimulus_by_MI$coefficients[4,3]`$) = $`r S_STAT.Stimulus_by_MI$coefficients[4,4]`$, p = $`r S_STAT.Stimulus_by_MI$coefficients[4,5]`$).
$\beta_B$, the weight associated with the constant response bias $b$ toward rightward rotation, was not different from zero ($\beta$ = $`r S_STAT.Bias_by_MI$coefficients[1,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[1,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[1,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[1,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[1,5]`$). 
We found no effect of group ($\beta$ = $`r S_STAT.Bias_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[3,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[3,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[3,5]`$). 
There was a trend for a positive effect of internal mode ($\beta$ = $`r S_STAT.Bias_by_MI$coefficients[2,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[2,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[2,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[2,5]`$) on the bias weight $\beta_B$. 
$\beta_P$, the weight associated with the previous percept $y_{t-1}$, was reduced in internal mode ($\beta$ = $`r S_STAT.PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.PS_by_MI$coefficients[2,2]`$, T($`r S_STAT.PS_by_MI$coefficients[2,3]`$) = $`r S_STAT.PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.PS_by_MI$coefficients[2,5]`$), but not modulated by group ($\beta$ = $`r S_STAT.PS_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.PS_by_MI$coefficients[3,3]`$) = $`r S_STAT.PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.PS_by_MI$coefficients[3,5]`$).
There was no significant interaction between group and mode with respect to $\beta_P$ ($\beta$ = $`r S_STAT.PS_by_MI$coefficients[4,1]`$ ± $`r  S_STAT.PS_by_MI$coefficients[4,2]`$, T($`r S_STAT.PS_by_MI$coefficients[4,3]`$) = $`r S_STAT.PS_by_MI$coefficients[4,4]`$, p = $`r STAT.PS_by_MI$coefficients[4,5]`$).
The balance $\Delta_{S-P}$ between external inputs and internal predictions was determined by mode ($\beta$ = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), with no significant effect of group ($\beta$ = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,5]`$) and no interaction ($\beta$ = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[4,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[4,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[4,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[4,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[4,5]`$).
These posterior GLM-HMM weights argue against the alternative hypotheses that the primary effect of S-ketamine is related to changes in dynamics of bias (state 1: high $\beta_B$; state 2: low $\beta_B$; hypothesis H3) or the randomness of experience (state 1: high $\beta_S$ and $\beta_P$; state 2: low $\beta_S$ and $\beta_P$ with no difference in $\Delta_{S-P}$ between modes: hypothesis H4).

**D.** Relative to controls (blue), patients (red) spent more time in external mode ($\beta$ = $`r -S_STAT.Mode_by_G$coefficients[2,1]`$ ± $`r S_STAT.Mode_by_G$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_G$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_G$coefficients[2,4]`$). This effect was driven by an increase in the stability of external mode at the expense of internal mode (EE versus II; left panels; W = `r S_STAT.Mode_Group$statistic`, p = `r S_STAT.Mode_Group$p.value`). There was no effect of group on the transition probabilities between modes (EI versus IE; right panels; W = `r S_STAT.Mode_Group_2$statistic`, p = `r S_STAT.Mode_Group_2$p.value`).

\newpage
## Supplemental Figure S5

```{r Supplemental_Figure_S5, fig.height = 6}

p_s_summary_RT <-
ggplot(S_Data,
aes(
x = RT,
y = as.factor(ID),
fill = Group
)) + geom_density_ridges(color = "white", scale = 4, alpha = 0.5) + theme_ridges(font_size = 10,
grid = FALSE,
center_axis_labels = TRUE) + xlim(-0.1, 3.34) + xlab("RT (sec)") + labs(x =
"RT (sec)",  y = "Participants", subtitle = "A") + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none", axis.text.y=element_blank())

dodge_width = 0.05
stretch = 0.5
Variables = c("RT")

p_s_intervention_ps_RT <-
  ggplot() + geom_point(
    data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + 
  geom_line(data = S_Summary_Choice_ps_long[S_Summary_Choice_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 3.33),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) + geom_line(
    data = Group_S_Summary_Choice_ps_long[Group_S_Summary_Choice_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "B",
    color = "Intervention",
  ) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines")) + facet_wrap(~Percept_minus_1, nrow = 2)

p_s_intervention_mode_ps_RT <-
  ggplot() + geom_point(
    data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    aes(
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      y = Value,
      color = Group
    ),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_dodge(
      width = dodge_width
      )
  ) + geom_line(data = S_Summary_Choice_mode_ps_long[S_Summary_Choice_mode_ps_long$Variable %in% Variables, ], aes(
      x = sign(w_Stimulus) * abs(w_Stimulus^stretch),
      y = Value,
      group = interaction(ID, Group)
    ),
    position = position_dodge(
      width = dodge_width),
    linetype = "18",
    alpha = alpha_sd,
    size = dot_size_sd/8) +
  geom_hline(
    yintercept = c(0, 3.33),
    linetype = "dashed",
    color = "black",
    size = dot_size_sd
  ) + 
  geom_ribbon(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      ymin = mean - error,
      ymax = mean + error,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      fill = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd/4
  ) +  geom_line(
    data = Group_S_Summary_Choice_mode_ps_long[Group_S_Summary_Choice_mode_ps_long$Variable %in% Variables, ],
    mapping = aes(
      y = mean,
      x = sign(w_Stimulus) * abs(w_Stimulus)^stretch,
      color = Group
    ),
    size = line_size_gd,
    alpha = alpha_gd
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "right") +
  labs(
    x = "s(t)",
    y = "RT (sec)",
    subtitle = "C",
    color = "Group",
  ) + facet_wrap( ~ Variable) + facet_grid(Percept_minus_1 ~ Mode)

lay <- rbind(c(1,2,3),
             c(4,4,5))
grid.arrange(
p_s_summary_RT,
p_s_intervention_ps_RT,
p_s_intervention_mode_ps_RT,
layout_matrix = lay,
heights=c(1), widths=c(0.3,0.6, 1.2)
)

S_ks_test_data = S_Data$RT
S_ks_test_data = S_ks_test_data[!is.na(S_ks_test_data)]
S_STAT_uniform = ks.test(S_ks_test_data, "punif", min = min(S_ks_test_data), max = max(S_ks_test_data))
```

**Supplemental Figure S5. RT and bimodal inference in Scz patients and controls.**

**A.** RT were non-uniformly distributed across the inter-overlap interval (D = $`r S_STAT_uniform$statistic`$, p = $`r S_STAT_uniform$p.value`$, one-sample Kolmogorov-Smirnov test against uniformity) in patients (red) and controls (blue). This confirmed that changes in perception were aligned with the overlapping configurations of the stimulus.

**B.** RT did not differ between patients (red) and controls (blue; $\beta$ = $`r STAT.RT_by_SGP$coefficients[4,1]`$ ± $`r STAT.RT_by_SGP$coefficients[4,2]`$, T($`r STAT.RT_by_SGP$coefficients[4,3]`$) = $`r STAT.RT_by_SGP$coefficients[4,4]`$, p = $`r STAT.RT_by_STP$coefficients[4,5]`$).
We found no quadratic relationship between RT and $s_t$ ($\beta$ = $`r STAT.RT_by_SGP$coefficients[3,1]`$ ± $`r STAT.RT_by_SGP$coefficients[3,2]`$, T($`r STAT.RT_by_SGP$coefficients[3,3]`$) = $`r STAT.RT_by_SGP$coefficients[3,4]`$, p = $`r STAT.RT_by_SGP$coefficients[3,5]`$).

**C.** We found no effect of mode on RT ($\beta$ = $`r STAT.RT_by_SGPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_SGPM$coefficients[6,2]`$, z = $`r STAT.RT_by_SGPM$coefficients[6,3]`$, p = $`r STAT.RT_by_SGPM$coefficients[6,4]`$).


\newpage
## Supplemental Figure S6

```{r Supplemental_Figure_S6, fig.height = 7}

dodge_width = 0.05
Variables = c("Q1","Q2","Q3")
p_dynamic_questionnaire_Q <-
ggplot() + geom_point(
data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ],
aes(
x = block_id,
y = Score,
color = Intervention,
fill = Intervention
),
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) +
geom_line(data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ], aes(
x = block_id,
y = Score,
group = interaction(ID, Intervention)
),
position = position_dodge(
width = dodge_width),
linetype = "18",
alpha = alpha_sd,
size = dot_size_sd/8) +
# geom_hline(
#   yintercept = c(0, 0.5, 1),
#   linetype = "dashed",
#   color = "black",
#   size = dot_size_sd
# ) +
geom_ribbon(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
ymin = mean - error,
ymax = mean + error,
x = (block_id),
fill = Intervention
),
size = line_size_gd,
alpha = alpha_gd/4
) +
geom_line(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
x = block_id,
color = Intervention
),
size = line_size_gd,
alpha = alpha_gd
) +  scale_x_discrete(name ="Block", limits=c(1,3,6,9)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
labs(
y = "Score",
subtitle = "A",
color = "Intervention",
) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines"))
Variables = c("CADSS")
p_dynamic_questionnaire_CADSS <-
ggplot() + geom_point(
data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ],
aes(
x = block_id,
y = Score,
color = Intervention,
fill = Intervention
),
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) +
geom_line(data = Dyn_Quest_long[Dyn_Quest_long$Variable %in% Variables, ], aes(
x = block_id,
y = Score,
group = interaction(ID, Intervention)
),
position = position_dodge(
width = dodge_width),
linetype = "18",
alpha = alpha_sd,
size = dot_size_sd/8) +
# geom_hline(
#   yintercept = c(0, 0.5, 1),
#   linetype = "dashed",
#   color = "black",
#   size = dot_size_sd
# ) +
geom_ribbon(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
ymin = mean - error,
ymax = mean + error,
x = (block_id),
fill = Intervention
),
size = line_size_gd,
alpha = alpha_gd/4
) +
geom_line(
data = Group_Dyn_Quest_long[Group_Dyn_Quest_long$Variable %in% Variables, ],
mapping = aes(
y = mean,
x = block_id,
color = Intervention
),
size = line_size_gd,
alpha = alpha_gd
) +  scale_x_discrete(name ="Block", limits=c(1,3,6,9)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
y = "Score",
subtitle = " ",
color = "Intervention",
) + facet_wrap( ~ Variable) + theme(panel.spacing = unit(1, "lines"))

Dyn_Quest$Mode = NA
Dyn_Quest$Mode[Dyn_Quest$external >= 0.5] = "external"
Dyn_Quest$Mode[Dyn_Quest$external < 0.5] = "internal"

Summary_Quest_mode_global <-
    ddply(
      Dyn_Quest[!is.na(Dyn_Quest$Intervention) & Dyn_Quest$Intervention != "None",],
      .(Intervention, Mode, ID),
      summarise,
      CADSS = mean(CADSS, na.rm = TRUE)
    )

Group_Summary_Quest_mode_global <- 
   ddply(
      Summary_Quest_mode_global,
      .(Intervention, Mode),
      summarise,
      mean = mean(CADSS, na.rm = TRUE),
      error = sd(CADSS, na.rm = TRUE)/sqrt(length(CADSS))
    )

p_gobal_CADSS <-
  ggplot() + geom_jitter(
    data = Summary_Quest_mode_global,
    aes(x = Mode,
        y = CADSS,
        color = Intervention),
    alpha = alpha_sd,
    size = dot_size_sd,
    position = position_jitterdodge(
      dodge.width = dodge_width,
      jitter.width = 0,
      jitter.height = 0
    )
  ) +
  geom_errorbar(
    data = Group_Summary_Quest_mode_global,
    mapping = aes(
      ymin = mean - error,
      ymax = mean + error,
      x = Mode,
      color = Intervention
    ),
    size = line_size_gd,
    position = position_dodge(width = dodge_width*4),
    alpha = alpha_gd,
    width = dodge_width*2
  ) +
  theme_classic(base_size = 6) + 
  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
  labs(
    x = "Mode",
    y = "CADSS",
    subtitle = "B",
    color = "Intervention"
  ) + facet_wrap(~Intervention)

p_ABZ <- ggplot(Summary_Mode, aes(x = ABZ, y=..density.., fill = Intervention))+ geom_density(alpha = alpha_gd/2, bw = 2, scale = 4, color = "white") +
labs(x="5D-ASC",  y="Density", subtitle = "C") + theme_classic(base_size = 6) +  scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none")
p_dynamic_questionnaire_corr <-
ggplot(data = Summary_Mode_corr_long,
aes(
x = Score,
y = external,
color = Intervention,
fill = Intervention
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
y = "external",
subtitle = "D",
color = "Intervention",
) + facet_wrap( ~ Variable, scales = "free") + ylim(0,1) + theme(panel.spacing = unit(1, "lines"))
gathercol <- colnames(S_Summary_Mode[,c(11:14)])
S_Summary_Mode_corr_long <- gather(S_Summary_Mode[,c(1,2,3,11:14)], "Variable", "Score", gathercol, factor_key = TRUE)
p_s_dynamic_questionnaire_corr <-
ggplot(data = S_Summary_Mode_corr_long,
aes(
x = Score,
y = external,
color = Group,
fill = Group
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "top") +
labs(
y = "external",
subtitle = "F",
color = "Group",
) + facet_wrap( ~ Variable, scales = "free", nrow = 1) + ylim(0,1) + theme(panel.spacing = unit(1, "lines"))
p_Threshold_corr <-
ggplot(data = Summary_Mode,
aes(
x = Threshold/100,
y = external,
color = Intervention,
fill = Intervention
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) + xlim(0, 0.015) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
y = "P(E)",
x = "Threshold (°)",
subtitle = "E",
color = "Intervention",
)
p_s_Threshold_corr <-
ggplot(data = S_Summary_Mode,
aes(
x = Threshold/100,
y = external,
color = Group,
fill = Group
)) + geom_point(
alpha = alpha_sd,
size = dot_size_sd,
position = position_dodge(
width = dodge_width
)
) + geom_smooth(method="glm",
method.args=list(family="binomial"), se = TRUE, alpha = alpha_sd,
size = dot_size_gd/2,
position = position_dodge(
width = dodge_width
)) + xlim(0, 0.015) +
theme_classic(base_size = 6) +
scale_color_brewer(palette = "Set1", direction = 1) + scale_fill_brewer(palette = "Set1", direction = 1) + theme(legend.position = "none") +
labs(
x = "Threshold (°)",
y = "P(E)",
subtitle = "G",
color = "Group",
)
lay <- rbind(c(1,1,1,2,2,8), c(4,3,3,3,3,5), c(6,6,6,6,6,7))
grid.arrange(
p_dynamic_questionnaire_Q,
p_dynamic_questionnaire_CADSS,
p_dynamic_questionnaire_corr,
p_ABZ,
p_Threshold_corr,
p_s_dynamic_questionnaire_corr,
p_s_Threshold_corr,
p_gobal_CADSS,
layout_matrix = lay,
heights = c(1,0.75, 0.75),
widths = c(0.25,0.25,0.25,0.125, 0.125, 0.35)
)
```

**Supplemental Figure S6. Scores and Questionnaires.**

**A.** Responses to Q1 (*How awake do you feel?*) indicated that participants felt more tired under S-ketamine (red) than placebo (blue; $\beta$ = $`r -STAT.Q1_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.Q1_Time_Intervention$coefficients[3,2]`$, z = $`r -STAT.Q1_Time_Intervention$coefficients[3,3]`$, p = $`r STAT.Q1_Time_Intervention$coefficients[3,4]`$), with no significant effect of time or a between-factor interaction. Responses to Q2 (*How intoxicated do you feel?*) indicated that participants felt more intoxicated under S-ketamine ($\beta$ = $`r -STAT.Q2_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.Q2_Time_Intervention$coefficients[3,2]`$, z = $`r -STAT.Q2_Time_Intervention$coefficients[3,3]`$, p = $`r STAT.Q2_Time_Intervention$coefficients[3,4]`$), with no significant effect of time or a between-factor interaction. Responses to Q3 (*How nervous do you feel?*) revealed no effect of S-ketamine ($\beta$ = $`r -STAT.Q3_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.Q3_Time_Intervention$coefficients[3,2]`$, z = $`r -STAT.Q3_Time_Intervention$coefficients[3,3]`$, p = $`r STAT.Q3_Time_Intervention$coefficients[3,4]`$), time, nor a significant between-factor interaction. CADSS scores were elevated under S-ketamine ($\beta$ = $`r -STAT.CADSS_Time_Intervention$coefficients[3,1]`$ ± $`r  STAT.CADSS_Time_Intervention$coefficients[3,2]`$, T($`r STAT.CADSS_Time_Intervention$coefficients[3,3]`$) = $`r -STAT.CADSS_Time_Intervention$coefficients[3,4]`$, p = $`r STAT.CADSS_Time_Intervention$coefficients[3,5]`$) 
with a borderline trend for an increase over time ($`r STAT.CADSS_Time_Intervention$coefficients[2,1]`$ ± $`r  STAT.CADSS_Time_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Time_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Time_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Time_Intervention$coefficients[2,5]`$) and no significant between-factor interaction.

**B.** Q1-3 and CADSS scores were collected after blocks 1, 3, 6 and 9. To assess how the mode of perceptual inference was linked to dissociative symptoms, we separated the participants ratings according to the mode that dominated perception at the very end of the preceding block. While controlling the effect of S-ketamine (red) vs placebo (blue), we found that external mode increased dissociative symptoms ($\beta$ = $`r STAT.CADSS_Mode_Intervention$coefficients[2,1]`$ ± $`r STAT.CADSS_Mode_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Mode_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Mode_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Mode_Intervention$coefficients[2,5]`$), but had no effect on wakefulness (Q1), subjective intoxication (Q2) or nervousness (Q3).

**C.** 5-ASC scores were elevated under S-ketamine (red) relative to placebo (blue; $\beta$ = $`r -STAT.ABZ_Intervention$coefficients[2,1]`$ ± $`r  STAT.ABZ_Intervention$coefficients[2,2]`$, T($`r STAT.ABZ_Intervention$coefficients[2,3]`$) = $`r -STAT.ABZ_Intervention$coefficients[2,4]`$, p = $`r STAT.ABZ_Intervention$coefficients[2,5]`$).

**D.** Neither PDI, CAPS, nor 5-ASC scores were predictive of the probability of external mode (shown separately for S-ketamine in red and placebo in blue).

**E.** Stereodisparity thresholds were not predictive of the probability of external mode ($\beta$ = $`r STAT.Threshold_to_Mode$coefficients[2,1]`$ ± $`r  STAT.Threshold_to_Mode$coefficients[2,2]`$, z = $`r STAT.Threshold_to_Mode$coefficients[2,3]`$, p = $`r STAT.Threshold_to_Mode$coefficients[2,4]`$). Thresholds did not differ between S-ketamine (red) and placebo (blue; W = $`r STAT.Mode_Threshold$statistic`$, p = $`r STAT.Mode_Threshold$p.value`$).

**F.** Neither PDI, CAPS (patients in red and controls in blue), nor the PANSS items P1 (delusions) or P3 (hallucinations, patients only) predicted the probability of external mode.

**G.** In patients (red) and controls (blue), stereodisparity thresholds were not predictive of the probability of external mode ($\beta$ = $`r S_STAT.Threshold_to_Mode$coefficients[2,1]`$ ± $`r  S_STAT.Threshold_to_Mode$coefficients[2,2]`$, z = $`r S_STAT.Threshold_to_Mode$coefficients[2,3]`$, p = $`r S_STAT.Threshold_to_Mode$coefficients[2,4]`$). Thresholds did not differ between groups (V = $`r S_STAT.Threshold$statistic`$, p = $`r S_STAT.Threshold$p.value`$).

\newpage
## Supplemental Table S1

| RESOURCE                                   | SOURCE                                            | IDENTIFIER                |
| ---------------------------------- | ------------------------------------------------- | ------------------------- |
| **Deposited data & code**                         |
| Analyzed data & custom code        | https://github.com/veithweilnhammer/modes_ketamine_scz/                                       | N/A    |
| **Software**                       |
| **Matlab**                                 | https://www.mathworks.com/                        | RRID:SCR_001622           |
| Psychtoolbox 3                             | http://psychtoolbox.org/                            | RRID:SCR_002881           |
| **R**                                      | http://www.r-project.org/                         | RRID:SCR_001905           |
| RStudio                                    | https://www.rstudio.com/                          | RRID:SCR_000432           |
| lme4, afex, statConfR, ggplot2, ggridges, gridExtra, tidyr, plyr, readxl | http://cran.r-project.org/          | RRID:SCR_003005            |
| **Python 3**                               | http://www.python.org/                            | RRID:SCR_008394           |
| Jupyter Notebook                           | https://jupyter.org/                              | RRID:SCR_018315           |
| numpy                                      | http://www.numpy.org                              | RRID:SCR_008633           |
| pandas                                     | https://pandas.pydata.org                         | RRID:SCR_018214           |
| SSM                                        | https://github.com/lindermanlab/ssm               | N/A           |

**Supplemental Table S1. Key resources.**

\newpage
## Supplemental Table S2

| Scale  |      Scope |      Condition      |  mean ± s.e.m. |
|:---------|:-----------------------|:---------|:----------
| **PDI**[@Peters1999] | Delusion proneness  | Global | `r mean(Logbook_final$PDI, na.rm = TRUE)` ± `r sd(Logbook_final$PDI, na.rm = TRUE)/sqrt(length(Logbook_final$PDI))` |
| **CAPS**[@Bell2006] | Hallucination proneness  | Global | `r mean(Logbook_final$CAPS, na.rm = TRUE)` ± `r sd(Logbook_final$CAPS, na.rm = TRUE)/sqrt(length(Logbook_final$CAPS))` |
| **BPRS**[@overall_brief_1962] | Screen for psychotic illness   | Global | `r mean(Logbook_final$BPRS, na.rm = TRUE)` ± `r sd(Logbook_final$BPRS, na.rm = TRUE)/sqrt(length(Logbook_final$BPRS))` |
| **5D-ASC**[@dittrich_5d-abz_1999] | Altered states of consciousness | S-ketamine | `r mean(Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Summary_Mode$ABZ[Summary_Mode$Intervention == "Ketamine"]))`  |
|  | |Placebo | `r mean(Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Summary_Mode$ABZ[Summary_Mode$Intervention == "Placebo"]))`  |
| **CADSS**[@mertens_clinician-administered_2022] | Dissociation | S-ketamine | `r mean(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$CADSS[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Q1** | Wakefulness | S-ketamine | `r mean(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q1[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Q2** | Intoxication | S-ketamine | `r mean(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q2[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Q3** |Nervousness | S-ketamine | `r mean(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Ketamine"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)` ± `r sd(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Placebo"], na.rm = TRUE)/sqrt(length(Dyn_Quest_ID$Q3[Dyn_Quest_ID$Intervention == "Placebo"]))` |
| **Stereovision** | Disparity thresholds | S-ketamine | `r mean(Summary_Mode$Threshold[Summary_Mode$Intervention == "Ketamine"]/100, na.rm = TRUE)` ± `r sd(Summary_Mode$Threshold[Summary_Mode$Intervention == "Ketamine"]/100, na.rm = TRUE)/sqrt(length(Summary_Mode$Threshold[Summary_Mode$Intervention == "Ketamine"]))` |
|  |  | Placebo | `r mean(Summary_Mode$Threshold[Summary_Mode$Intervention == "Placebo"]/100, na.rm = TRUE)` ± `r sd(Summary_Mode$Threshold[Summary_Mode$Intervention == "Placebo"]/100, na.rm = TRUE)/sqrt(length(Summary_Mode$Threshold[Summary_Mode$Intervention == "Placebo"]))` |

**Supplemental Table S2. Psychometric data for the S-ketamine experiment.**

\newpage
## Supplemental Table S3

| Scale  |      Scope |      Condition      |  mean ± s.e.m. |
|:---------|:-----------------------|:---------|:----------
| **PDI**[@Peters1999] | Delusion proneness  | Patients | `r mean(Quest$PDI[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$PDI[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$PDI[Quest$group == 1]))` |
| |   | Controls | `r mean(Quest$PDI[Quest$group == 0], na.rm = TRUE)` ± `r sd(Quest$PDI[Quest$group == 0], na.rm = TRUE)/sqrt(length(Quest$PDI[Quest$group == 0]))` |
| **CAPS**[@Bell2006]  |  Hallucination proneness  | Patients | `r mean(Quest$CAPS[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$CAPS[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$CAPS[Quest$group == 1]))` |
| |   | Controls | `r mean(Quest$CAPS[Quest$group == 0], na.rm = TRUE)` ± `r sd(Quest$CAPS[Quest$group == 0], na.rm = TRUE)/sqrt(length(Quest$CAPS[Quest$group == 0]))` |
| **P1** | Delusions | Patients | `r mean(Quest$P1[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$P1[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$P1[Quest$group == 1]))` |
| **P3** | Delusions | Patients | `r mean(Quest$P3[Quest$group == 1], na.rm = TRUE)` ± `r sd(Quest$P3[Quest$group == 1], na.rm = TRUE)/sqrt(length(Quest$P3[Quest$group == 1]))` |
| **Stereovision** | Disparity thresholds | Patients | `r mean(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Patients"]/100, na.rm = TRUE)` ± `r sd(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Patients"]/100, na.rm = TRUE)/sqrt(length(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Patients"]))` |
|  |  | Controls | `r mean(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Controls"]/100, na.rm = TRUE)` ± `r sd(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Controls"]/100, na.rm = TRUE)/sqrt(length(S_Summary_Mode$Threshold[S_Summary_Mode$Group == "Controls"]))` |

**Supplemental Table S3. Psychometric data for Scz-control-study.**


\newpage
# Review

We would like to thank the referees and the editorial team at Brain for the very helpful and constructive review of our work. In response to the comments raised by the editors and the reviewers, we have fundamentally revised our manuscript. In particular, we have extended the introduction and discussion to provide more links to the existing literature on predictive processing, circular inference, and trait-versus-state. We now show robust parameter recovery in the GLM-HMM framework, and provide additional control analyses that support the hypothesis that external and internal modes are perceptual as opposed to high-level behavioral or cognitive phenomena. We hope that with these changes, our manuscript can be accepted for publication in Brain. 

Please find our point-by-point responses below. All changes are highlighted in BOLD font in the main manuscript.

## Editorial comments

We have changed the format of our paper to adhere with the Brain article template we received. We have separated the *Main* section of our previous version in *Introduction*, *Results*, and *Discussion*. The *Method* section now appears after the *Introduction*. These required two minor changes to the text of the manuscript, which are highlighted in the revised manuscript:

We added a brief summary of our methods, results, and interpretation at the end of the introduction: 

- The objective of the current study was therefore twofold: First, to test whether NMDAR hypofunction causes changes in perceptual inference that characterize Scz; and second, to explore the effect of NMDAR hypofunction on ongoing fluctuations in perceptual inference that may explain the transient nature of psychotic experiences. We addressed these questions in a double-blind, placebo-controlled, cross-over experiment with S-ketamine in healthy participants, and a case-control study that compared patients with paranoid Scz to matched healthy controls[@weilnhammer_psychotic_2020]. Participants engaged in a task designed to test how internal predictions derived from previous experiences modulate the perception of sensory signals that varied in ambiguity. We found that NMDAR antagonism and Scz were associated with a shift of perception toward the external mode, a minute-long state of the brain during which inference dissociates from prior knowledge. Our results suggest that NMDAR hypofunction shifts the balance between external and internal modes, and may thus contribute to the symptoms of Scz by causing transient and recurring failures of perceptual inference.

At the beginning of the discussion, we have added a brief summary of our findings: 

- Perception integrates incoming signals with internal predictions that reflect prior knowledge about the world[@Friston2005]. Our results indicate that this integration is subject to dynamic changes over time, alternating between an external mode, where perception closely follows the external input, and an internal mode, where perception is shaped by internal predictions[@weilnhammer_bistable_2021; @weilnhammer_sensory_2023; @weilnhammer_dynamic_2024]. The internal mode enables the brain to use prior knowledge about the statistics of natural environment, such as their temporal autocorrelation, for efficient perception[@weilnhammer_sensory_2023]. Intermittent episodes of external mode processing decouple perception from prior knowledge. The balance between external and internal mode may prevent circular inferences within recurrent neural networks, where predictive feedback influences early sensory processing stages[@muckli_contextual_2015; @weilnhammer_neural_2018]. We found that healthy individuals receiving the NMDAR antagonist S-ketamine, as well as patients diagnosed with Scz, are more prone to an external mode of perception. This NMDAR-dependent change in the balance between modes may expose perception to the destabilizing effects of sensory ambiguity, causing afflicted individuals to be deluded by spurious connections between unrelated events, to attribute the sensory consequences of their actions to an outside force, and to hallucinate signals in noise[@Sterzer2018].

## Referee: 1

**I enjoyed reading this excellent report of a study crossing bistable perception with ketamine infusion. I thought the motivation and description of your paradigm (and results) was concise, clear and accessible. The only suggestion I have — to increase the impact of this work – is to provide the reader with a more formal account of your "canonical predictive processing" hypothesis, to establish a clear link between the weighting of sensory evidence, NMDAR function and the role of synaptic gain in setting the precision of prediction errors. At present, your account of predictive processing is a bit anecdotal and misses some opportunities to connect with the literature on excitation and inhibition balance in schizophrenia and formal predictive processing accounts.**

**Perhaps you could consider the following:**

### Comment 1

**To set the scene for interpreting your model parameters (theta_s and theta_p) you can add the following:**

**“Formal predictive processing accounts of schizophrenia foreground the role of precision-weighted prediction errors in updating (Bayesian) beliefs about the causes of sensory input. Most accounts of schizophrenia focus on a failure to predict or instantiate the precision afforded prediction errors at various levels in cortical hierarchies. Precision corresponds to the confidence ascribed to prediction errors reporting sensory information and prior expectations. Mathematically, precision corresponds to the (Kalman) gain or weighting of prediction errors in predictive coding (a.k.a., Kalman filtering) models of perceptual inference (Rao, 1999). Psychologically, the deployment of sensory precision can be thought of in terms of selective attention (or sensory attenuation). Physiologically, precision corresponds to the postsynaptic gain or excitability of neuronal populations reporting prediction errors, commonly thought to be mediated NMDA receptor function (Moran et al., 2015; Muthukumaraswamy et al., 2015; Powers et al., 2015; Ranlund et al., 2016)."**

We would like to thank the reviewer for this excellent suggestion. We have inserted the suggested text in the introduction:

- (...) Formal predictive processing accounts of Scz foreground the role of prediction errors in updating Bayesian beliefs about the causes of sensory input[@Friston2005]. Most accounts focus on a failure to predict or instantiate the precision afforded to prediction errors at various levels of the cortical hierarchy[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. Precision refers to the confidence ascribed to prediction errors, and regulates how prior expectations are updated in response to sensory information[@Friston2005]. Mathematically, precision is equivalent to the (Kalman) gain or the weighting of prediction errors in predictive processing models of perceptual inference[@Rao1999]. Psychologically, the deployment of sensory precision can be understood in terms of selective attention (or sensory attenuation)[@Friston2009a; @feldman_attention_2010]. Physiologically, precision corresponds to the postsynaptic gain or excitability of neuronal populations that report prediction errors, commonly mediated by N-Methyl-D-aspartate receptor (NMDAR) function[@moran_losing_2015; @muthukumaraswamy_evidence_2015; @powers_iii_ketamine-induced_2015; @ranlund_impaired_2016].

### Comment 2

**With these three perspectives in place, you can now unpack some of your interpretations intuitively. For example, in the abstract, you can now associate modes with attentional set: e.g.:**

**"… between external and internal modes, or shifts in attentional set."**

We would like to thank the reviewer for this comment, and agree that the reference to attentional set will provide a better connect the concept of modes to predictive processing. Following the comments 1 from Reviewer 3, we have rewritten the abstract, providing a more nuanced view of role of external and internal modes in perception: 

- Abstract: Perception integrates external sensory signals with internal predictions that reflect prior knowledge about the world. Previous research suggests that this integration is governed by slow alternations between an external mode, driven by sensory signals, and an internal mode, shaped by prior knowledge. Using a double-blind, placebo-controlled, cross-over experiment in healthy human participants, we investigated the effects of the N-Methyl-D-aspartate receptor (NMDAR) antagonist S-ketamine on the balance between external and internal modes. We found that S-ketamine causes a shift of perception toward the external mode. A case-control study revealed that individuals with paranoid Scz, a disorder repeatedly associated with NMDAR hypofunction, spend more time in the external mode. This NMDAR-dependent increase in the external mode suggests that the symptoms of schizophrenia are caused by recurring dissociations of perception from prior knowledge about the world.

We would like to suggest including the reference to shifts in attentional set when external and internal modes are first introduced in the main text. The reason for this suggestion is that it might be confusing to introduce attention as an additional concept in the abstract, since the notion of prediction errors and their connection to  attention is unpacked only in the main text (see Comment 2, Reviewer 1). We therefore propose to modify the introduction as follows:

- (...) Such fluctuations have been related to two opposing modes of inference, or shifts in attentional sets, during which perception is driven predominantly either by external inputs (external mode) or by internal predictions that stem from recent perceptual experiences[@weilnhammer_sensory_2023] (internal mode, Figure 1A). Although preliminary evidence indicates a tendency toward the external mode in people with Scz[@albert_hierarchical_2017], the neural mechanisms of mode fluctuations and their potential implications for computational models of psychosis have remained elusive.

### Comment 3

**More importantly, you can now interpret your parameters as follows:**

**"… internal predictions during pharmacologically induced NMDAR hypofunction. Under the predictive coding formulation of false inference in schizophrenia, one can read theta_s and theta_p as sensory and prior precision, respectively. This suggests that ketamine augments sensory precision via altering the interactions between pyramidal cells and fast spiking inhibitory interneurons thought to underwrite cortical gain control or excitation-inhibition balance (Adams et al., 2022)."**

We would like to thank the reviewer for this excellent suggestion. We have added this paragraph to the results section: 

- (...) internal predictions during pharmacologically induced NMDAR hypofunction. Under the predictive processing formulation of perceptual inference, one can read the estimates for $s_t$ and $y_{t-1}$ as sensory and prior precision, respectively. This suggests that S-ketamine augments sensory precision by altering the interactions between pyramidal cells and fast-spiking inhibitory interneurons thought to underwrite cortical gain control or excitation-inhibition balance[@adams_computational_2022].

### Comment 4

**In the next paragraph you can then say:**

**“Together, these results align with the canonical predictive coding theory of schizophrenia. In particular, they speak to an increase in sensory precision (relative to prior precision) that is often framed in terms of a failure of sensory attenuation; i.e., the ability to attenuate sensory precision or, psychologically, ignore ambiguous or irrelevant sensations (Blakemore et al., 1999; Limanowski, 2017; Oestreich et al., 2015; Shergill et al., 2005). This failure of sensory attenuation corresponds to an inability to disengage the external mode of perception."**

Thanks a lot for this. We have added the text to the results section: 

- Together, these results align with the canonical predictive processing theory of Scz[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]: Pharmacologically-induced NMDAR hypofunction and Scz are associated with a shift of perceptual inference toward external inputs, and away from stabilizing internal predictions. This increase in sensory precision (relative to prior precision) is often framed as a failure of sensory attenuation, i.e., the inability to attenuate sensory precision or, psychologically, ignore unclear or irrelevant sensations[@blakemore_spatio-temporal_1999; @limanowski_dis-_2017; @oestreich_subnormal_2015; @shergill_evidence_2005]. In the artificial setting of our experiment, where stimuli are random, weak internal predictions under S-ketamine and in Scz lead to *increased* perceptual accuracy. In autocorrelated natural environments, however, NMDAR hypofunction may trigger psychotic experiences by causing erratic inferences about ambiguous sensory information.

Since, at this point in the manuscript, external and internal modes have not been introduced, we added the last sentence suggested above two paragraphs later:

- (...) Our results therefore suggest that the failure of sensory attenuation observed under S-ketamine corresponds to an inability to disengage the external mode of perception.

### Comment 5

**You might also add the following:**

**“… NMDAR hypofunction may affect perception by shifting the dynamic balance between the two modes. In terms of predictive coding, this corresponds to shifting the balance between sensory and prior precision. Crucially, it is this balance or ratio that determines the Kalman gain (Iglesias et al., 2013; Mathys et al., 2011). In other words, the only thing that matters — in terms of perceptual inference — is the relative precisions that change dynamically in a context-sensitive fashion.**

We would like to thank the reviewer for this excellent suggestion. We have slightly modified the text and linked it to the external mode. It was added to the result section: 

- Our results therefore suggest that the failure of sensory attenuation observed under S-ketamine corresponds to an inability to disengage the external mode of perception. Through the lens of predictive processing, the external mode reflects a state of perception that is characterized by an increase in sensory precision at the expense of prior precision. Crucially, it is this balance between sensory and prior precision that determines the Kalman gain [@mathys_bayesian_2011; @Iglesias2013]. In other words, what matters in terms of perceptual inference are the dynamic changes in relative precision over time.

### Comment 6

**You can find a review of these computational perspectives in (Friston, 2022), which may contain some useful references; especially those that link postsynaptic gain control, precision, fast synchronous neuronal dynamics and, crucially, NMDA receptor function. I hope that these comments help should any revision be required.**

Thanks a lot for these suggestions, which we have included to our paper in full.  

- Adams, R.A., et al., 2022. Computational Modeling of Electroencephalography and Functional Magnetic Resonance Imaging Paradigms Indicates a Consistent Loss of Pyramidal Cell Synaptic Gain in Schizophrenia. Biol Psychiatry. 91, 202-215.
- Blakemore, S.J., Frith, C.D., Wolpert, D.M., 1999. Spatio-temporal prediction modulates the perception of self-produced stimuli. J Cogn Neurosci. 11, 551-9.
- Friston, K., 2022. Computational psychiatry: from synapses to sentience. Molecular Psychiatry.
- Iglesias, S., et al., 2013. Hierarchical prediction errors in midbrain and basal forebrain during sensory learning. Neuron. 80, 519-30.
- Limanowski, J., 2017. (Dis-)Attending to the Body. In: Philosophy and Predictive Processing. Vol., T.K. Metzinger, W. Wiese, ed.^eds. MIND Group, Frankfurt am Main.
- Mathys, C., et al., 2011. A bayesian foundation for individual learning under uncertainty. Front Hum Neurosci. 5, 39.
- Moran, R.J., et al., 2015. Losing control under ketamine: suppressed cortico-hippocampal drive following acute ketamine in rats. Neuropsychopharmacology. 40, 268-77.
- Muthukumaraswamy, S.D., et al., 2015. Evidence that Subanesthetic Doses of Ketamine Cause Sustained Disruptions of NMDA and AMPA-Mediated Frontoparietal Connectivity in Humans. J Neurosci. 35, 11694-706.
- Oestreich, L.K., et al., 2015. Subnormal sensory attenuation to self-generated speech in schizotypy: Electrophysiological evidence for a 'continuum of psychosis'. Int J Psychophysiol. 97, 131-8.
- Powers, A.R., 3rd, et al., 2015. Ketamine-Induced Hallucinations. Psychopathology. 48, 376-85.
- Ranlund, S., et al., 2016. Impaired prefrontal synaptic gain in people with psychosis and their relatives during the mismatch negativity. Hum Brain Mapp. 37, 351-65.
- Rao, R.P., 1999. An optimal estimation approach to visual perception and learning. Vision Res. 39, 1963-89.
- Shergill, S.S., et al., 2005. Evidence for sensory prediction deficits in schizophrenia. Am J Psychiatry. 162, 2384-6.


## Referee: 2

**Using both psychopharmacological (ketamine) and clinical studies, combined with an elegant design to determine the effect of systematically varied ambiguity of sensory evidence on perceptual inference, Weilnhammer and colleagues explored whether there was an increased reliance on sensory evidence (“external mode”) compared to prior expectation (“internal mode”) associated with both schizophrenia (data from a previously published study) and the ketamine model. They used an initial “conventional” analysis, which sought to test drug and illness effects on the perceptual inference associated with sensory evidence of varying levels of ambiguity.  This was complemented by a computational model seeking to discriminate between whether such an effect might arise from a global increase in reliance on sensory input as opposed to a varying tendency to switch between different modes or strategies drawing on evidence and expectations respectively.**

**I enjoyed reading this paper – it is hypothesis-led, elegantly designed and very well-written. I have two main questions and also raise a few minor points.**

### Comment 1

**My main query is that it's not clear to me what the source of internal predictions would be within this experimental design. That is, why would a person generate and use a prior expectation of rotational direction? This does not seem to have been encouraged, or manipulated, by the design in which, as far as I understand it, an optimal strategy would be to have - as far as possible – no expectations and to rely solely on sensory evidence. This would of course be neither helpful nor unhelpful in a maximally ambiguous condition but would become more useful as soon as ambiguity was reduced. Indeed, looking at figure 2, I get the impression that the patients and ketamine-treated participants are showing some performance benefit once ambiguity is reduced. I assume that, if the mirror image manipulation was made, and there were varying levels of (helpful) expectations generated, then the patient/drug groups might be penalized by failing to switch into internal mode, but, as I understand the present results, these groups seem to be adopting the strategy that is appropriate to the experimental structure? Perhaps I am misunderstanding this but, if I have not misunderstood, then it does seem important to entertain the possibility that the apparent deficit in patients/ketamine are actually reasonable strategies for the context and, as such, it perhaps questions the conclusion that the “increase in the external mode suggests that the symptoms of schizophrenia are caused by recurring dissociations of perception from prior knowledge about the world.” The question, in a nutshell, is what prior knowledge about the world would be helpful in this task?**

We would like to thank the reviewer for raising this very important point, and apologize for not making our thinking clearer in the previous version of our manuscript. The reviewer is correct in stating that, in our design, the use of priors is not encouraged or manipulated. 

Previous research has shown that the brain uses anticipatory predictions to infer the most likely cause of ambiguous sensory signals[@manassi_continuity_2024]. This predictive strategy mirrors the temporal autocorrelation of natural environments, where the recent past typically predicts the near future (much like frames captured by a video camera are predictive of each other[@weilnhammer_sensory_2023; @manassi_continuity_2024]). Indeed, it is well established that perception is biased toward previously perceived stimuli, and that this effect is particularly strong when sensory signals are ambiguous[@manassi_continuity_2024]. The adaptive benefit of this strategy is a stabilization of perception that prevents erratic experiences in natural environments, which are highly autocorrelated and accessible to the brain only via inherently ambiguous sensory signals[@Friston2005; @Hohwy2012].

Such stabilizing internal predictions are, however, suboptimal in the artificial setting of psychophysical experiments such as ours, where stimuli change at random: Our design induced random changes in the direction of disambiguation (i.e., whether the external stimulus supports left- or rightward rotation of the sphere) that occurred in average intervals of 10 sec. A shift of precision away from internal predictions toward external sensory data, which has been proposed to occur under S-ketamine and in Scz[@Sterzer2018] (and is likely to be maladaptive in natural environments), should therefore manifest as an increase in perceptual accuracy.

In sum, a reduced reliance on internal predictions, which may occur during S-ketamine or in Scz, causes performance benefits in psychophysical experiments, but is likely to be mal-adaptive in the real world. This aligns with previous findings that have shown a reduced susceptibility of patients with Scz to perceptual illusions that depend on prior knowledge about the statistics of the natural environment (e.g., hollow mask illusion[@keane_reduced_2013], Ebbinghaus illusions[@Silverstein2013], force matching illusions[@shergill_evidence_2005]). 

In light of the above, we have made three changes to the manuscript: 

- Method section: (...) From the perspective of predictive processing, perceptual stability is induced by internal predictions that bias perception toward previous experiences[@manassi_continuity_2024]. Stabilizing internal predictions are most likely to be adaptive in natural environments, where the recent past predicts the near future (much like successive frames captured by a video camera are temporarily autocorrelated[@manassi_continuity_2024]). Our experiment differed from the temporal autocorrelation of natural environments[@manassi_continuity_2024] in that random changes in the direction of disambiguation (i.e., whether the external stimulus supports left- or rightward rotation of the sphere) occurred in average intervals of 10 sec. We thereby created a situation in which strong stabilizing internal predictions *reduce* performance[@shergill_evidence_2005, @keane_reduced_2013, @Silverstein2013]. In our experiment, a shift of perception away from internal predictions toward the external sensory data, which has been proposed to occur under S-ketamine and in Scz[@Sterzer2018], should therefore manifest as an *increase* in perceptual accuracy.

- Result section: (...) Predictive processing conceptualizes bistable perception as an inferential process about the cause of $s_t$. The core idea is that previous experiences ($y_{t-1}$) generate internal predictions that bias the interpretation $y_t$ of the ambiguous stimulus[@Hohwy2008; @weilnhammer_active_2021] (Figure 1C). In this view, inferences during bistability mirror the temporal autocorrelation of natural environments, where the recent past typically predicts the near future, much like frames captured by a video camera allow for the prediction of future frames[@manassi_continuity_2024]. The adaptive benefit of this predictive strategy is the stabilization of perception that prevents erratic experiences in natural environments, which are highly autocorrelated and accessible to the brain only via inherently ambiguous sensory signals[@Friston2005; @Hohwy2012].

- Result section: (...) Predictive processing models of bistable perception assume that transitions between the alternative interpretations of (partially) ambiguous stimuli are driven by conflicts between the external input and stabilizing internal predictions[@Hohwy2008; @weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021]. To test how NMDAR antagonism alters the balance between external inputs and internal predictions, we attached a 3D signal to a fraction of the stimulus dots. The signal-to-ambiguity ratio (SAR) ranged from complete ambiguity to full disambiguation across five levels and remained constant in each block of the experiment. By changing the direction of rotation enforced by the 3D signal at random in average intervals of 10 sec, we created dynamic conflicts between the SAR-weighted input $s_t$ and the stabilizing internal prediction $y_{t-1}$. Due to the random changes in $s_t$, a shift of inference away from internal predictions and toward external sensory data, which has repeatedly been associated with NMDAR hypofunction[@Sterzer2018] and may be maladaptive in autocorrelated natural environments[@weilnhammer_sensory_2023], should manifest as an increase in perceptual accuracy in our experiment.

- Result section: (...) Together, these results align with the canonical predictive processing theory of Scz[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]: Pharmacologically-induced NMDAR hypofunction and Scz are associated with a shift of perceptual inference toward external inputs, and away from stabilizing internal predictions. This increase in sensory precision (relative to prior precision) is often framed as a failure of sensory attenuation, i.e., the inability to attenuate sensory precision or, psychologically, ignore unclear or irrelevant sensations[@blakemore_spatio-temporal_1999; @limanowski_dis-_2017; @oestreich_subnormal_2015; @shergill_evidence_2005]. In the artificial setting of our experiment, where stimuli are random, weak internal predictions under S-ketamine and in Scz lead to increased perceptual accuracy. In autocorrelated natural environments, however, NMDAR hypofunction may trigger psychotic experiences by causing erratic inferences about ambiguous sensory information.

- Discussion section: (...) During bistable perception, previous experiences provide the predictive context in which incoming sensory data are interpreted, and lead to prolonged periods of perceptual stability despite the ambiguity of the external input[@weilnhammer_active_2021]. Our results suggest that NMDAR hypofunction, whether due to pharmacological antagonism or as a potential endophenotype of Scz, causes a shift of bistable perception toward the external input, and away from stabilizing internal prediction that stem from previous experiences. These findings bear similarity with prior work on perceptual illusions, where prior knowledge biases perception in ways that may be adaptive in natural environments but reduce perceptual accuracy in experimental settings[@Notredame2014; @costa_systematic_2023]. Weak predictions may explain why people with Scz are, for example, less susceptible to the hollow-mask illusion, where knowledge about faces is thought to induce the experience of a convex face on the concave surface of a human mask[@keane_reduced_2013]; the Ebbinghaus illusion, where larger circles make a smaller central circle appear bigger[@Silverstein2013]; or the force-matching illusion, where humans apply less force when matching an externally applied force with their own[@shergill_evidence_2005].

### Comment 2

**I wonder if the authors could provide the key details that are increasingly required in computational modelling studies – particularly regarding use of simulation and parameter recovery?**

We would like to thank the reviewer for this important suggestion. In response to this comment, we have stimulated perceptual experience $y_t$ from GLM-HMMs initialized across an exhaustive sweep through the space of parameters (analysis 2), fit the GLM-HMM to the synthetic data, and compared the input parameters with the recovered parameters. Our results, which are now included as Supplemental Figure S1, confirm that the GLM-HMM reliably recovers a broad range of input parameters, and in particular in the vicinity of the average posterior parameters obtained from the original data. 

We have added the following text to the Method section:

- **Recovery of GLM-HMM parameters.** To evaluate the robustness of our GLM-HMM model in estimating mode-dependent weights and transition probabilities, we conducted a parameter recovery analysis. The GLM-HMM is characterized by three weights, $\beta_S$, $\beta_B$, and $\beta_P$, that are defined separately for the external and internal modes. We assessed the model’s ability to estimate individual mode-dependent weights by fitting the model to simulated data that were obtained by sampling from GLM-HMMs in which individual target weights were systematically varied, while all other weights were kept constant at the group-level average obtained from the original data. For each analysis, we selected one of the six weights (3 weights $\times$ 2 modes) and varied its value parametrically from $-1$ to $5$. We then generated synthetic data, simulating $y_{\text{syn}}$ for $n = 78{,}400$ overlaps (corresponding to the number of overlaps observed across all participants in the S-ketamine experiment). The GLM-HMM model was then fitted to these synthetic data.

- We repeated the recovery analysis for each weight 10 times, computed the average posterior weights $\beta_S$, $\beta_B$, and $\beta_P$, and then correlated these recovered weights with the synthetic input weights. We applied a similar procedure to evaluate the recovery of the GLM-HMM transition matrix. Transition probabilities were varied parametrically within the range of 0.8 to 1 for on-diagonal cells (external to external, internal to internal) and 0 to 0.2 for off-diagonal cells (external to internal, internal to external). The results of this recovery analysis, which are depicted in Supplemental Figure S1, demonstrate that the GLM-HMM weights and transition probabilities can be recovered with high fidelity across the full range of the synthetic input parameters, and in particular in the parameter region of the group-level esimates obtained from the original data ($w_n$).

We added Supplemental Figure S1 to the Supplement: 

```{r recovery_plot}
lay <- rbind(c(1,2))
grid.arrange(
  p_recovery_corr,
  p_recovery_corr_matrix,
  layout_matrix = lay,
  heights = c(1),
  widths = c(3,2)
)
```
- **Supplemental Figure S1. GLM-HMM parameter recovery**

- **A. Weight recovery from simulated data: GLM weights.** The GLM-HMM is defined by the mode-dependent weights $\beta_S$, $\beta_B$, and $\beta_P$. To test how well our GLM-HMM can recover changes in individual weights, we selected one of the six weights (3 weights x 2 modes) and varied its value parametrically from -1 to 5. For each inversion, we kept all other weights at the group-level average obtained from the original data. For each of the six recovery analyses, we simulated synthetic experiences $y_{syn}$ for n = 78400 overlaps (number of overlaps across participants in the S-ketamine experiment). We then fitted a randomly initialized GLM-HMM to the synthetic experiences, and extracted the weights recovered from the synthetic experiences $y_{syn}$. We performed each recovery for 10 iterations, computed the average posterior weights $\beta_S$, $\beta_B$, and $\beta_P$, and correlated them with the synthetic input weights. The correlation with the parametric input weights and the posterior weights recovered from the simulated data were close to 1 for all weights ($\beta_S$, $\beta_B$, and $\beta_P$, columns) and modes (external and internal, rows). Weights were recovered with high fidelity across a broad range of weights, and in particular at the group-level weights $w_n$ obtained from the original data (black dotted line). The red dashed line represents the identity line (slope = 1, intercept = 0), indicating perfect recovery.

- **B. Weight recovery from simulated data: transition matrix.** We repeated the above procedure for each cell of the GLM-HMM transition matrix. We initialized models with parametric transition probabilities ranging from 0.8 to 1 (on-diagonal cells, external to external, internal to internal) and 0 to 0.2 (off-diagonal cells, external to internal, internal to external). Transition probabilities were recovered with high fidelity across a broad range of parameters, and in particular at the group-level estimates obtained from the original data (black dotted line). The red dashed line represents the identity line (slope = 1, intercept = 0), indicating perfect recovery.

### Comment 3

**I’m not entirely sure about the logic of the first two paragraphs. While the point that reductions in precision of sensory evidence (as may occur at the party) render us prone to making errors in perceptual inference, this can’t show why disrupted perceptual inference plays a crucial role in schizophrenia. Rather, the party phenomenon that they describe tentatively suggests that one of the possible mechanisms by which the known perceptual inference disruption in schizophrenia may occur. Apologies for the pedantry, but in essence the introductory section  seems to be saying that X may cause Y and this proves that Y is crucial to schizophrenia. Or maybe I’m misunderstanding the point.**

We fully agree with the reviewer that the weak prediction in the party example, which may induce erratic and surprising perceptual experiences, are only one way perceptual inference may be altered in Scz. Our intention was to illustrate the consequences of impaired perceptual inference with an example, and to point to the canonical predictive processing hypothesis of Scz, which assumes that impaired inference is implicated in the pathophysiology of Scz. 

To make our point more clear, we extended the introduction in the following way: 

- Imagine a dimly lit room at a crowded party, where unclear visual signals, indistinct sounds, and complex social interactions allow for multiple - and sometimes false - interpretations. In such ambiguity, failures of perceptual inference, the ability to contextualize sensory inputs with prior knowledge about the world, can lead to profound departures from reality: Faces obscured in shadow may appear distorted, random noise could be perceived as a whisper, and friendly smiles might seem derogatory. According to the canonical predictive processing hypothesis[@Sterzer2018], a disruption of perceptual inference is likely to play a crucial role in schizophrenia (Scz), a severe mental disorder characterized by psychotic symptoms such as delusions and hallucinations[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. People with Scz may fail to apply prior knowledge to the interpretation of ambiguous sensory signals, causing erratic inferences that lead to hallucinatory experiences and delusional beliefs[@Sterzer2018].

### Comment 4

**The assertion that NMDA receptors block midbrain dopamine seems to be a great simplification of the findings from the reference that they cite to support this statement. The study cited examined amphetamine-induced DA release in a NMDAR hypofunction model and the findings were more complex and do not, in my view, support this simple statement.**

We apologize for the imprecision in referencing what is known about the role of NMDARs in dopamine. In response to Comment 1 of Reviewer 1, we have rephrased the role of NMDARs in perceptual inference. 

- (...) Physiologically, precision corresponds to the postsynaptic gain or excitability of neuronal populations that report prediction errors, commonly mediated by NMDA receptor function[@moran_losing_2015; @muthukumaraswamy_evidence_2015; @powers_iii_ketamine-induced_2015; @ranlund_impaired_2016].

In addition, we now provide a more nuanced description of the additional pathways through which NMDARs may impact perceptual inference: 

- Beyond predictive processing theory, several lines of evidence point to NMDAR hypofunction as a key factor in the pathophysiology of psychosis[@corlett_glutamatergic_2011]. NMDAR antibodies[@Stein2020] and antagonists such as ketamine[@murray_linking_2014] mimic the symptoms of Scz, which is itself associated with a reduction of NMDAR density in the prefrontal cortex[@catts_quantitative_2016]. In addition to their role in controlling the excitability of prediction error neurons[@moran_losing_2015; @muthukumaraswamy_evidence_2015; @powers_iii_ketamine-induced_2015; @ranlund_impaired_2016] and their general function for maintaining the cortical excitation-inhibition balance[@wang_nmda_2013], NMDARs play a critical role in cortical feedback[@self_different_2012], support synaptic short-term plasticity[@castro-alamancos_short-term_1996], and interact with neuromodulators such as dopamine and serotonin via GABAergic interneurons[@nakazawa_spatial_2017]. While these NMDAR-dependent mechanisms are likely critical for perceptual inference, it is yet to be determined how NMDAR hypofunction may cause the symptoms of Scz.

### Comment 5

**I was unsure about the argument that was advanced in lines 32 to 43 in the introductory section: the idea that hallucinations that occur as discrete events with an onset and offset separated by seconds to minutes is fine but the cited studies (refs 12 and 13) used an experience sampling approach that really can’t say much about these the period of these fluctuations and I’m therefore not clear on how the current authors make the assertion that “spontaneous fluctuations over time  … occur at a timescale compatible with the duration of individual psychotic experiences”.**

We fully agree, and apologize for the imprecision. We believe that it is general clinical knowledge that psychotic experiences are discrete events with an on- and offset, especially in early psychosis. To our knowledge, precise measurements of the duration of individual delusional and hallucinatory experiences are still lacking. We agree that the experience-sampling papers we cited in the previous version do not speak to the duration of individual hallucination[@oorschot_temporal_2012; @hermans_temporal_2020]. They do suggest, however, that there are considerable fluctuations in psychotic symptoms over time. Real-time symptom capture, which may be more adept at characterizing the temporal duration of individual psychotic experiences, suggests that hallucinations can be brief enough for patients to report their start and end during an experimental session[@jardri_cortical_2011; @zmigrod_neural_2016; @gill_real-time_2022].

In light of these uncertainties, we have now to refer to temporal fluctuations in the experience of hallucinations in the introduction, without making a strong statement about their expected duration, and stress that temporal fluctuations of any sort (i.e., irrespective of their precise duration) challenge models that assume a constant change in perceptual inference: 

- The second unresolved question concerns the temporal dynamics of psychotic experiences, which often unfold as short-lived events spanning from seconds to minutes, especially at early stages of Scz. The transient nature of psychotic experiences[@jardri_cortical_2011; @zmigrod_neural_2016; @gill_real-time_2022] challenges models that assume a constant disruption of perceptual inference[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. A solution to this problem is suggested by the recent observation that perceptual inference is subject to spontaneous fluctuations over time[@laquitaine_switching_2018; @roy_extracting_2021; @ashwood_mice_2022].

In addition, we have added a paragraph to the discussion about future experiments on the correlation between the duration of modes, and the duration of individual psychotic experiences: 

- (...) Further insights into the relationship between neural modes and Scz symptoms could be obtained by correlating the temporal dynamics of psychotic experiences with the timing of mode alternations in individual patients. Future research could leverage real-time symptom capture and functional imaging to investigate whether shifts in neural modes coincide with the onset and offset of psychotic symptoms. This approach may illuminate the dynamic mechanisms that drive these experiences, offering a deeper understanding of the neural processes involved in psychosis.

### Comment 6

**Lines 219-221 in the methods section – the authors should check the description of finger placement as there may be a mix up between left and right.**

Thanks a lot for pointing this out, we apologize for the mix up. Indeed, keys d and f were for the left hand, and k and j were for the right hand. We corrected the text accordingly:

- (...) (right middle-finger on k: rotation of the front-surface to the right at high confidence; right index-finger on j: rotation of the front-surface to the right at low confidence; left middle-finger on s: rotation of the front-surface to the left at high confidence; left index-finger on d: rotation of the front-surface to the left at low confidence; thumb on space bar: unclear direction of rotation).

## Referee: 3

**In this study, Weilnhammer et al. investigate if and how NMDA hypofunction relates to perceptual decision-making and psychosis in schizophrenia. By fitting a GLM-HMM model to perceptual reports in a bistable perception paradigm, they identify two modes of perceptual inference differing in terms of the influence of prior expectations – external (weak prior) and internal (strong prior). They find that S-ketamine increases the fraction of time healthy participants spend in the external mode. They find a similar tendency in patients with schizophrenia and conclude that NMDA hypofunction might cause psychosis by shifting the dynamic balance between the two modes of perception.**

**The study design and statistical modeling are sound and novel, and the effects of S-ketamine are very interesting. But the link to psychosis (vs. general cognitive factors and trait-like effects in schizophrenia) is somewhat tenuous due to several assumptions that are not yet supported by the data.**

### Comment 1

**The abstract begins with a rather strong claim: “Perception is known to alternate between an external mode, driven by sensory inputs, and an internal mode, shaped by prior knowledge about the world”. While data-driven methods like GLM-HMM are increasingly being applied to identify different modes of behavior, to my knowledge it is not established that they correspond to modes of perceptual processing. The interpretation of the HMM modes is necessarily limited by the hypotheses embodied by the GLM. The GLM here is constrained to arbitrate between prior and likelihood, and therefore not designed to falsify alternative hypotheses pertaining to changes in task engagement, or other downstream decision variables.**

We would like to thank the reviewer for this very insightful comment. We agree that the statement in the previous version is too strong a claim and have rephrased the absract accordingly (see below). If we understand correctly, the above comments asks two questions: (i) what is the evidence that external and internal modes are modes of perception, as opposed to modes of behavior?; and (ii), what are the hypotheses embodied by the GLM-HMM proposed here? 

(i): GLM-HMMs are typically fitted to behavioral responses during trial-based 2AFC decision-making experiments[@ashwood_mice_2022; @mohammadi_identifying_2024; @weilnhammer_dynamic_2024]. Some authors have labeled the states identified by the GLM-HMM as *engaged* (high stimulus-weight, low history weight) and *disengaged* (low stimulus weight, high history weight)[@ashwood_mice_2022; @mohammadi_identifying_2024]. This interpretation suggests that the states identified by the GLM-HMM may be behavioral. 

However, there is also recent evidence from 2AFC decision-making suggesting that the GLM-HMM states have a perceptual quality: When humans detect gratings in white noise, false alarm trials are more likely after trials in which people experienced a high-contrast grating. Moreover, false alarm trials are associated with increased power at the orientation and spatial frequency of the preceding grating, indicating that detection unfolds within a predictive perceptual template[@manassi_continuity_2024; @weilnhammer_dynamic_2024]. If false alarms were purely behavioral, one would expect no correlation between orientation and power at the spatial frequency of the target grating[@murai_serial_2021]. Recent work shows that predictive perceptual templates are particularly strong in the internal mode[@weilnhammer_dynamic_2024], supporting the hypothesis that the internal mode is indeed predictive and perceptual[@weilnhammer_dynamic_2024]. Moreover, an analysis that identified external and internal modes in human 2AFC decision-making[@Rahnev2015] based on the autocorrelation of stimulus-congruent and history-congruent responses suggested that confidence has a quadratic relationship with mode[@weilnhammer_sensory_2023]. The observation that confidence is high for strong biases toward both external and internal mode[@weilnhammer_sensory_2023] speaks against the idea that internal mode processing can be reduced completely to disengaged behavior.

However, we acknowledge that more data are needed to better understand the level at which external and internal mode operate. Promising avenues for future research could be no-report paradigms and comparisons between neural activity during external and internal mode in low-level visual areas.

We have rephrased the abstract as follows:

- Perception integrates external sensory signals with internal predictions that reflect prior knowledge about the world. Previous research suggests that this integration is governed by slow alternations between an external mode, driven by sensory signals, and an internal mode, shaped by prior knowledge. Using a double-blind, placebo-controlled, cross-over experiment in healthy human participants, we investigated the effects of the N-Methyl-D-aspartate receptor (NMDAR) antagonist S-ketamine on the balance between external and internal modes. We found that S-ketamine causes a shift of perception toward the external mode. A case-control study revealed that individuals with paranoid Scz, a disorder repeatedly associated with NMDAR hypofunction, spend more time in the external mode. This NMDAR-dependent increase in the external mode suggests that the symptoms of schizophrenia are caused by recurring dissociations of perception from prior knowledge about the world.

We have also added a paragraph to the Discussion: 

- External and internal modes reflect GLM-HMM states informed by behavioral responses during psychophysical experiments. If mode alternations are linked to perceptual inference and its alteration in Scz, then external and internal modes should capture dynamic changes in perception rather than merely ongoing fluctuations in task engagement. 

- Previous studies have used GLM-HMMs to identify engaged and disengaged behavior in mice tasked with discriminating the location of a visual stimulus[@ashwood_mice_2022; @mohammadi_identifying_2024]. While this terminology may suggest that GLM-HMM states reflect dynamic changes in rodent behavior, evidence from human psychophysics indicates that external and internal modes may in fact reflect perceptual (as opposed to behavioral) states[@weilnhammer_sensory_2023; @weilnhammer_dynamic_2024]. Specifically, when humans detect gratings in white noise, false alarms are more likely when the noise contains more power at the orientation and spatial frequency of the preceding grating, suggesting that detection relies on a predictive perceptual template[@manassi_continuity_2024; @weilnhammer_dynamic_2024]. If these detection events were purely behavioral, no correlation between false alarms and the noise power spectrum would be expected[@murai_serial_2021]. Critically, recent work demonstrates that these predictive perceptual templates are confined to the internal mode, supporting the hypothesis that the internal mode is indeed predictive and perceptual[@weilnhammer_dynamic_2024]. Moreover, an analysis of 66 experiments on human two-alterantive forced-choice decision-making revealed a quadratic relationship of confidence with mode[@weilnhammer_sensory_2023]. The observation that confidence remains high for strong biases toward both external and internal modes[@weilnhammer_sensory_2023] argues against the interpretation of internal mode as disengaged behavior.

- Despite these findings, further research is necessary to identify where in the cognitive hierarchy external and internal mode take effect. No-report paradigms and functional imaging in low-level visual areas could provide more definitive evidence on how external and internal modes modulate perception[@weilnhammer_dynamic_2024], and whether there are additional effect on cognitive processes that occur downstream[@ashwood_mice_2022; @mohammadi_identifying_2024]. 

(ii): The GLM-HMM used in this study predicts experiences $y_t$ in a GLM that is defined by the stimulus $\beta_S \times s_t$, the preceding experience $\beta_P \times y_{t-1}$, and the constant bias $\beta_B \times b$. The HMM component of the model identified two states that differ with respect to the weights on any combination of the predictors. We chose the GLM-HMM to test whether the computational mechanism of Scz (an imbalance between internal predictions and external sensory data, according to the prevailing hypothesis[@Sterzer2018]) is dynamic. This hypothesis is represented by a change in $\Delta{S-P}$ (high $\beta_S$ and low $\beta_P$ in external mode; low $\beta_S$ and high $\beta_P$ in internal mode). However, beyond our primary hypothesis, the GLM-HMM can in principle embody dynamic changes in any combination of weights. Alternative outcomes to external versus internal modes are therefore states that differ with respect to bias (state 1: high $\beta_B$ for strong bias, state 2: low $\beta_B$ for weak bias) and randomness of predictability of perception (state 1: high $\beta_S$ and high $\beta_P$ for low choice randomness; state 2: low $\beta_S$ and low $\beta_P$ for high choices randomness).

In the S-ketamine experiment, $\beta_B$, the weight associated with the constant response bias $b$ toward rightward rotation, was not different from zero ($\beta_B$ = $`r STAT.Bias_by_MI$coefficients[1,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[1,2]`$, T($`r STAT.Bias_by_MI$coefficients[1,3]`$) = $`r STAT.Bias_by_MI$coefficients[1,4]`$, p = $`r STAT.Bias_by_MI$coefficients[1,5]`$). 
We found no effect of drug ($`r STAT.Bias_by_MI$coefficients[3,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[3,2]`$, T($`r STAT.Bias_by_MI$coefficients[3,3]`$) = $`r STAT.Bias_by_MI$coefficients[3,4]`$, p = $`r STAT.Bias_by_MI$coefficients[3,5]`$) 
or mode ($`r STAT.Bias_by_MI$coefficients[2,1]`$ ± $`r  STAT.Bias_by_MI$coefficients[2,2]`$, T($`r STAT.Bias_by_MI$coefficients[2,3]`$) = $`r STAT.Bias_by_MI$coefficients[2,4]`$, p = $`r STAT.Bias_by_MI$coefficients[2,5]`$) on the bias weight $\beta_B$. $\beta_P$, the weight associated with the previous percept $y_{t-1}$ was not modulated by S-ketamine ($`r STAT.PS_by_MI$coefficients[3,1]`$ ± $`r  STAT.PS_by_MI$coefficients[3,2]`$, T($`r STAT.PS_by_MI$coefficients[3,3]`$) = $`r STAT.PS_by_MI$coefficients[3,4]`$, p = $`r STAT.PS_by_MI$coefficients[3,5]`$) or mode ($`r STAT.PS_by_MI$coefficients[2,1]`$ ± $`r  STAT.PS_by_MI$coefficients[2,2]`$, T($`r STAT.PS_by_MI$coefficients[2,3]`$) = $`r STAT.PS_by_MI$coefficients[2,4]`$, p = $`r STAT.PS_by_MI$coefficients[2,5]`$). There was no significant interaction between drug and mode with respect to $\beta_P$ ($`r STAT.PS_by_MI$coefficients[4,1]`$ ± $`r  STAT.PS_by_MI$coefficients[4,2]`$, T($`r STAT.PS_by_MI$coefficients[4,3]`$) = $`r STAT.PS_by_MI$coefficients[4,4]`$, p = $`r STAT.PS_by_MI$coefficients[4,5]`$).
The balance $\Delta_{S-P} = \beta_S - \beta_p$ between external inputs and internal predictions was determined by mode ($`r -STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), with no significant effect of S-ketamine ($`r -STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[3,5]`$) and no interaction ($`r -STAT.Stimulus_PS_by_MI$coefficients[4,1]`$ ± $`r STAT.Stimulus_PS_by_MI$coefficients[4,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[4,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[4,4]`$, p = $`r STAT.Stimulus_PS_by_MI$coefficients[4,5]`$).

In the case-control study, $\beta_B$, the weight associated with the constant response bias $b$ toward rightward rotation, was not different from zero ($`r S_STAT.Bias_by_MI$coefficients[1,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[1,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[1,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[1,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[1,5]`$). 
We found no effect of group ($`r S_STAT.Bias_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[3,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[3,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[3,5]`$). 
There was a trend for a positive effect of internal mode ($`r S_STAT.Bias_by_MI$coefficients[2,1]`$ ± $`r  S_STAT.Bias_by_MI$coefficients[2,2]`$, T($`r S_STAT.Bias_by_MI$coefficients[2,3]`$) = $`r S_STAT.Bias_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Bias_by_MI$coefficients[2,5]`$) on the bias weight $\beta_B$. 
$\beta_P$, the weight associated with the previous percept $y_{t-1}$, was reduced in internal mode ($`r S_STAT.PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.PS_by_MI$coefficients[2,2]`$, T($`r S_STAT.PS_by_MI$coefficients[2,3]`$) = $`r S_STAT.PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.PS_by_MI$coefficients[2,5]`$), but not modulated by group ($`r S_STAT.PS_by_MI$coefficients[3,1]`$ ± $`r  S_STAT.PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.PS_by_MI$coefficients[3,3]`$) = $`r S_STAT.PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.PS_by_MI$coefficients[3,5]`$).
There was no significant interaction between group and mode with respect to $\beta_P$ ($`r S_STAT.PS_by_MI$coefficients[4,1]`$ ± $`r  S_STAT.PS_by_MI$coefficients[4,2]`$, T($`r S_STAT.PS_by_MI$coefficients[4,3]`$) = $`r S_STAT.PS_by_MI$coefficients[4,4]`$, p = $`r STAT.PS_by_MI$coefficients[4,5]`$).
The balance $\Delta_{S-P} = \beta_S - \beta_p$ between external inputs and internal predictions was determined by mode ($`r -S_STAT.Stimulus_PS_by_MI$coefficients[2,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,2]`$, T($`r STAT.Stimulus_PS_by_MI$coefficients[2,3]`$) = $`r -STAT.Stimulus_PS_by_MI$coefficients[2,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[2,5]`$), with no significant effect of group ($`r -S_STAT.Stimulus_PS_by_MI$coefficients[3,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[3,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[3,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[3,5]`$) and no interaction ($`r -S_STAT.Stimulus_PS_by_MI$coefficients[4,1]`$ ± $`r S_STAT.Stimulus_PS_by_MI$coefficients[4,2]`$, T($`r S_STAT.Stimulus_PS_by_MI$coefficients[4,3]`$) = $`r -S_STAT.Stimulus_PS_by_MI$coefficients[4,4]`$, p = $`r S_STAT.Stimulus_PS_by_MI$coefficients[4,5]`$).

The above data, which are summarized Supplemental Figure S3 and 4, therefore speak in favor of the modes hypothesis (high $\beta_S$ and low $\beta_P$ in external mode; low $\beta_S$ and high $\beta_P$ in internal mode), and against the hypothesis that the dominant state changes are driven by the dynamics of bias or randomness. We have added a description of the state changes compatible with the GLM-HMM in the Methods and Supplemental Figures S2-3.

- Methods: (...) The GLM-HMM used in this study predicts experiences $y_t$ in a GLM defined by the stimulus $s_t$, the preceding experience $y_{t-1}$, and a constant bias $b$. The HMM component of the model identifies alternations between two states that differ with respect to the weights of any combination of $s_t$, $y_{t-1}$, and $b$. We used the GLM-HMM to test our primary hypothesis that ketamine and Scz alter the balance between two states that differ with respect to $\Delta_{S-P} = \beta_S - \beta_P$ (high $\Delta_{S-P}$ in external mode, low $\Delta_{S-P}$ in internal mode: hypothesis H2). However, the GLM-HMM can, in principle, embody dynamic changes in any combination of $\beta_S$, $\beta_B$, and $\beta_P$. Alternative outcomes to external versus internal modes are states that differ with respect to bias (state 1: high $\beta_B$; state 2: low $\beta_B$; hypothesis H3) and randomness (state 1: high $\beta_S$ and $\beta_P$; state 2: low $\beta_S$ and $\beta_P$: no difference in $\Delta_{S-P}$ between modes: hypothesis H4).

- Supplemental Figure S3: (...) These posterior GLM-HMM weights argue against the alternative hypotheses that the primary effect of S-ketamine is related to changes in dynamics of bias (state 1: high $\beta_B$; state 2: low $\beta_B$; hypothesis H3) or the randomness of experience (state 1: high $\beta_S$ and $\beta_P$; state 2: low $\beta_S$ and $\beta_P$ with no difference in $\Delta_{S-P}$ between modes: hypothesis H4).

- Supplemental Figure S4: (...) These posterior GLM-HMM weights argue against the alternative hypotheses that the primary effect of Scz is related to changes in dynamics of bias (state 1: high $\beta_B$; state 2: low $\beta_B$; hypothesis H3) or the randomness of experience (state 1: high $\beta_S$ and $\beta_P$; state 2: low $\beta_S$ and $\beta_P$ with no difference in $\Delta_{S-P}$ between modes: hypothesis H4).

### Comment 2

**Both patients and healthy participants on S-ketamine reportedly spend more time in the external mode. The authors take this to imply an alteration in perceptual processing without ruling out alternative explanations. First, since model parameters are fit to participants’ choices, the results may stem from alterations in choice persistence. Specifically, spending more time in the external mode likely results in more response switches and therefore decreased choice persistence. This confound needs to be addressed, if possible, by analyzing the data by including confidence reports which may help decouple stimulus-history and choice-history effects – perhaps the authors can make model-based predictions they can test in the data using the confidence data to speak to this point.** 

We would like to thank the reviewer for pointing out this important point. Our paradigm relies on explicit perceptual choices that we take as indicators of the participants' perceptual experience of the stimulus. Participants were instructed to report changes in conscious experience (often referred to as switches in bistable perception). For structure-from-motion stimuli like those used in this study, switches are most likely to occur at overlapping configurations of the stimulus[@Pastukhov2012; @weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021] (i.e., when the bands that compose the stimulus overlap, see Supplemental Video S1-2). This effect, which was replicated in the S-ketamine experiment (Supplemental Figure S2A) and the case-control study (Supplemental Figure S5A), allowed us to discretize the behavioral data and label each overlap with an experience $y_t$, the stimulus $s_t$, and the preceding experience $y_{t-1}$ (see Methods and Figure 1C). However, participants did not report their choice at every overlap, but only when they experienced a change in the direction of rotation. RTs in our study are defined by the time at which a participant indicates a change in conscious experience, relative the time at which the last preceding overlap occurred[@weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021].

Our paradigm therefore differs from classic 2AFC decision-making experiments, where explicit choices are available for every trial. Slow alternations between external and internal modes have been identified as a general phenomenon in 2AFC perceptual decision-making, occurring across a wide variety of tasks and modalities[@weilnhammer_sensory_2023]. Prior work has shown that stabilizing internal predictions, which are particularly strong in the internal mode, are better explained by the effects of choice history, as opposed to the effects of stimulus history (S1 Text[@weilnhammer_sensory_2023]). 

Since our paradigm does not require choices at every overlap, choice persistence is unlikely to be the primary driver of what we identified as internal mode. However, we fully agree that it is important to provide additional justification for the interpretation that external and internal modes are perceptual phenomena. We have performed three additional analyses:

(i) In our experiment, stabilizing internal predictions biased perception toward preceding overlaps ($t-1$), creating conflicts between the consciously experienced rotation direction ($y$) and the current stimulus ($s$). If external and internal modes are perceptual phenomena, perception stabilization should be driven by the sequence of experiences ($y$) rather than stimuli ($s$). To test this, we compared an experienced-based GLM-HMM, where internal predictions are driven by the previous perceptual experience, with a stimulus-based GLM-HMM, where predictions are driven by the previous stimulus. Consistent with prior findings[@weilnhammer_sensory_2023], we observed a lower BIC for the experienced-based GLM-HMM in both the S-ketamine experiment ($\delta_{BIC}$ = $`r HMM_BIC$BIC[2] - Stimulus_HMM_BIC$BIC[2]`$) and the case-control study (patients: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Patients",]$BIC[2] - S_HMM_BIC[S_HMM_BIC$Group == "Patients",]$BIC[1]`$; controls: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Controls",]$BIC[2] - S_HMM_BIC[S_HMM_BIC$Group == "Controls",]$BIC[1]`$), indicating that our data were better explained by dynamic fluctuations in the balance between the current stimulus $s_t$ and the previous experience $y_{t-1}$ (experience history), as opposed to dynamic fluctuations in the balance between the current stimulus $s_t$ and the previous stimulus $s_{t-1}$ (stimulus history).

ii) Our GLM-HMM generates a perceptual decision variable $P(y_t = 1)$ that is defined by a weighted integration of the current external stimulus ($\beta_S \times s_t$) and the previous experience ($\beta_P \times y_{t-1}$). The weights are obtained by fitting the GLM-HMM to the sequence of experiences $y$. If external and internal modes are perceptual phenomena, the GLM-HMM perceptual decision variable should not only explain the contents of experience (which the model is fitted to), but also predict metacognitive processes that occur downstream of perception, such as reports of perceptual confidence (which the model was not fitted to). This generates two testable hypotheses for the confidence reports obtained in our experiment: 

iia) The posterior certainty of the GLM should correlate with subjective confidence reports. The posterior certainty can be represented by log probability of the actual experience $y$, given the decision variable $P(y_t = 1)$: 

$$
C_t = y_t \cdot \log(P(y_t = 1)) + (1 - y_t) \cdot \log(1 - P(y_t = 1)) 
$$

Importantly, any correlation between the posterior certainty $C_t$ and confidence provides an independent validation of our GLM-HMM, since the model was not fitted to the trial-wise confidence ratings. Indeed, the posterior certainty extracted from the two-state GLM-HMM predicted trial-wise confidence reports ($`r STAT.corr_certainty_p$coefficients[2,1]`$ ± $`r  STAT.corr_certainty_p$coefficients[2,2]`$, z = $`r STAT.corr_certainty_p$coefficients[2,3]`$, p = $`r STAT.corr_certainty_p$coefficients[2,4]`$). Importantly, there was no interaction with mode ($`r STAT.corr_certainty_p$coefficients[4,1]`$ ± $`r  STAT.corr_certainty_p$coefficients[4,2]`$, z = $`r STAT.corr_certainty_p$coefficients[4,3]`$, p = $`r STAT.corr_certainty_p$coefficients[4,4]`$), confirming that the positive correlation between posterior certainty and confidence was present in both external and internal modes. The posterior certainty extracted from the two-state GLM-HMM was better at explaining confidence than the one-state control GLM ($\delta_{BIC}$ = `r BIC.corr_certainty_p - BIC.corr_certainty_p_os`), and the one-state stimulus GLM ($\delta_{BIC}$ = `r BIC.corr_certainty_p - BIC.corr_certainty_p_stim`). The superiority of the two-state GLM over the control GLMs in predicting the out-of-training confidence reports validates that perception is indeed modulated by slow alternations between external and internal modes. 

iib) If external and internal modes are perceptual phenomena, internal mode should be associated with lower metacognitive performance (i.e., the degree to which confidence reports reflect perceptual accuracy). This is because, in the internal mode, stabilizing internal predictions have a larger effect on perception, causing subjective experiences that are less constrained by the external input. If, by contrast, external and internal modes occur at the level of response behavior (i.e., choice persistence), metacognitive performance should not be affected by mode. Indeed, in our data, accuracy was predictive of high confidence across modes ($`r STAT.phi_corr$coefficients[2,1]`$ ± $`r  STAT.phi_corr$coefficients[2,2]`$, z = $`r STAT.phi_corr$coefficients[2,3]`$, p = $`r STAT.phi_corr$coefficients[2,4]`$), but to a lesser degree during the internal mode ($`r STAT.phi_corr$coefficients[4,1]`$ ± $`r  STAT.phi_corr$coefficients[4,2]`$, z = $`r STAT.phi_corr$coefficients[4,3]`$, p = $`r STAT.phi_corr$coefficients[4,4]`$). In line with this, metacognitive sensitivity, as measured by meta-d'[@Fleming2014], was significantly lower in the internal mode ($`r  STAT.meta_dprime$coefficients[2,1]`$ ± $`r STAT.meta_dprime$coefficients[2,2]`$, T($`r STAT.meta_dprime$coefficients[2,3]`$) = $`r STAT.meta_dprime$coefficients[2,4]`$, p = $`r STAT.meta_dprime$coefficients[2,5]`$).

<!-- c) During the external mode, perception is more likely to follow input, and less likely to be stabilized by preceding experiences. In the bistable display here, external mode increases the frequency of switches ($`r STAT.stability_by_TDC$coefficients[3,1]`$ ± $`r  STAT.stability_by_TDC$coefficients[3,2]`$, z = $`r STAT.stability_by_TDC$coefficients[3,3]`$, p = $`r STAT.stability_by_TDC$coefficients[3,4]`$). If external and internal modes are perceptual phenomena, confidence should be lower in the internal mode due to the reduction in the stimulus-weight $\beta_S$. Alternatively, if external and internal mode were behavioral states that reflect dynamic changes in choice persistence, confidence should be unaffected by mode or even lower in external mode, given the positive association between persistent (i.e., *serial*) choices and confidence. In our data,  -->
<!-- external mode (average confidence: $`r mean(Summary_Mode_Confidence[Summary_Mode_Confidence$Mode == "external",]$confidence)`$ ± $`r sd(Summary_Mode_Confidence[Summary_Mode_Confidence$Mode == "external",]$confidence)/sqrt(length(Summary_Mode_Confidence[Summary_Mode_Confidence$Mode == "external",]$confidence))`$) was associated with higher confidence than  -->
<!-- internal mode (average confidence: $`r mean(Summary_Mode_Confidence[Summary_Mode_Confidence$Mode == "internal",]$confidence)`$ ± $`r sd(Summary_Mode_Confidence[Summary_Mode_Confidence$Mode == "internal",]$confidence)/sqrt(length(Summary_Mode_Confidence[Summary_Mode_Confidence$Mode == "internal",]$confidence))`$; $`r -STAT.y_conf_by_STPM$coefficients[6,1]`$ ± $`r STAT.y_conf_by_STPM$coefficients[6,2]`$, z = $`r -STAT.y_conf_by_STPM$coefficients[6,3]`$, p = $`r STAT.y_conf_by_STPM$coefficients[6,4]`$). An extensive analysis of confidence in relation to SAR, S-ketamine, and mode can be found in Supplemental Figure S2.  -->

In light of these results, we have made the following changes to the manuscript: 

We have added the above analyses to the methods: 

- **Stimulus- versus experienced-based GLM-HMM.** In our experiment, stabilizing internal predictions bias perception toward preceding overlaps ($t-1$), causing conflicts between the direction of rotation that is consciously experienced ($y$) and the stimuli $s$ presented at the current overlap $t$. If external and internal modes are perceptual in nature, then the stabilization of perception should be driven by the sequence of perceptual experiences $y$, as opposed to the sequence of sensory signals $s$ (hypothesis H5). To test this hypothesis, we compared our *experienced-based* GLM-HMM, in which the stabilizing internal predictions are driven by the participants' perceptual experience at the preceding overlap, with an alternative *stimulus-based* GLM, in which the stabilizing internal predictions are driven by the stimulus presented at the preceding overlap.

- **External validation of the GLM-HMM.** The GLM-HMM generates a perceptual decision variable $P(y_t = 1)$ that is defined by a weighted integration of the external stimulus ($\beta_S \times s_t$), the previous experience ($\beta_P \times y_{t-1}$), and a constant bias ($\beta_P \times 1$). The weights are obtained by fitting the GLM-HMM to the sequence of experiences $y$, irrespective of whether the experience $y$ was made at high or low confidence. This allowed us to test whether the predictions of the two-state GLM-HMM would generalize to metacognitive reports on perception. Importantly, the source of confidence differs between the modes: During the external mode, confidence should depend predominantly on the SAR of the stimulus. Conversely, during the internal mode, confidence should be driven more by the congruency of perception with previous experiences, and less by the external input. To validate our model, we tested whether the perceptual decision variable $P(y_t = 1)$ predicted not only the binary contents of experience $y_t$ (which the GLM-HMM was fitted to), but also perceptual confidence $c_t$ (which the GLM-HMM was not fitted to). To do so, we correlated $c_t$ (as reported by the participants) with the posterior certainty $C_t$ (as provided by the GLM-HMM) at each overlap. The posterior certainty $C_t$ is given by log probability of the actual experience $y$, given the decision variable $P(y_t = 1)$:

$$
C_t = y_t \cdot \log(P(y_t = 1)) + (1 - y_t) \cdot \log(1 - P(y_t = 1))  
$$

- To assess differences in metacognitive performance, we correlated perceptual confidence with perceptual accuracy. We computed meta-d', a measure of metacognitive sensitivity that indicates how well confidence ratings predict perceptual accuracy[@Fleming2014].

We have added the following analyses to the results:

- Our results suggest that healthy participants under S-ketamine and Scz patients spend more time in the external mode. As a dynamic mechanism for psychotic experiences, alternations between external and internal mode should have an effect at the level of perception. This means that between-mode alternations should modulate a perceptual decision variable that determines not only what is consciously experienced, but also how the contents of perception are evaluated by downstream cognition. The hypothesis that external and internal modes are perceptual phenomena needs to be contrasted against alternative scenarios in which external and internal modes are driven primarily by fluctuations in arousal, high-level cognition, or executive function.

- To address these alternative accounts, we first performed additional tests to support our claim that external and internal mode operate at the level of perception. External and internal modes are states of a GLM-HMM that integrates the external stimulus $s_t$ with the previous experience $y_{t-1}$ into a perceptual decision variable $P(y_t = 1)$. The parameters of the GLM-HMM are optimized to predict the sequence of perceptual experiences $y_t$ from $P(y_t = 1)$. If external and internal modes are perceptual phenomena, then the stabilization of perception should be driven by the sequence of experiences $y_t$, as opposed to the sequence of stimuli $s_t$. To test this hypothesis, we compared our *experienced-based* GLM-HMM, in which the stabilizing internal predictions are driven by the participants' perceptual experience at the preceding overlap, with an alternative *stimulus-based* GLM, in which the stabilizing internal predictions are driven by the stimulus presented at the preceding overlap. Bayesian model comparison indicated that the experienced-based GLM-HMM was better at explaining our data than a stimulus-based GLM-HMM in the S-ketamine experiment ($\delta_{BIC}$ = $`r HMM_BIC$BIC[2] - Stimulus_HMM_BIC$BIC[2]`$) and the case-control study (patients: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Patients",]$BIC[2] - S_HMM_BIC[S_HMM_BIC$Group == "Patients",]$BIC[1]`$; controls: $\delta_{BIC}$ = $`r S_HMM_BIC[S_HMM_BIC$Group == "Controls",]$BIC[2] - S_HMM_BIC[S_HMM_BIC$Group == "Controls",]$BIC[1]`$).

- Moreover, if external and internal modes are perceptual phenomena, then the decision variable $P(y_t = 1)$ should not only determine the contents of perception, but also metacognitive processes that depend on them. To assess this prediction, we tested whether the posterior certainty $C_t$ at which the GLM-HMM predicted the content of perception, i.e., the log probability of the experience $y_t$ given the decision variable $P(y_t = 1)$ ($C_t = y_t \cdot \log(P(y_t = 1)) + (1 - y_t) \cdot \log(1 - P(y_t = 1))$), would correlate with the confidence reports $c_t$ in the S-ketamine experiment. This test is a powerful validation of our approach, since the GLM-HMM was only fitted to binary perceptual states $y_t$, and not to the confidence $c_t$ at which they were reported. Indeed, $C_t$ predicted the confidence reports $c_t$($\beta$ = $`r STAT.corr_certainty_p$coefficients[2,1]`$ ± $`r  STAT.corr_certainty_p$coefficients[2,2]`$, z = $`r STAT.corr_certainty_p$coefficients[2,3]`$, p = $`r STAT.corr_certainty_p$coefficients[2,4]`$) without an interaction with mode ($\beta$ = $`r STAT.corr_certainty_p$coefficients[4,1]`$ ± $`r  STAT.corr_certainty_p$coefficients[4,2]`$, z = $`r STAT.corr_certainty_p$coefficients[4,3]`$, p = $`r STAT.corr_certainty_p$coefficients[4,4]`$), confirming that the positive correlation between posterior certainty and confidence was present in both external and internal modes. $C_t$ extracted from the two-state GLM-HMM was better at explaining confidence than the one-state control GLM ($\delta_{BIC}$ = `r BIC.corr_certainty_p - BIC.corr_certainty_p_os`), and the one-state stimulus GLM ($\delta_{BIC}$ = `r BIC.corr_certainty_p - BIC.corr_certainty_p_stim`).

- As a consequence, internal mode should be associated with lower metacognitive performance (i.e., the degree to which confidence correlates accuracy), since stabilizing internal predictions have a larger effect on perception in the internal mode, and cause experiences $y_t$ to be less constrained by the external input $s_t$. Indeed, accuracy was predictive of high confidence ($\beta$ = $`r STAT.phi_corr$coefficients[2,1]`$ ± $`r  STAT.phi_corr$coefficients[2,2]`$, z = $`r STAT.phi_corr$coefficients[2,3]`$, p = $`r STAT.phi_corr$coefficients[2,4]`$), but to a lesser degree during the internal mode ($\beta$ = $`r STAT.phi_corr$coefficients[4,1]`$ ± $`r  STAT.phi_corr$coefficients[4,2]`$, z = $`r STAT.phi_corr$coefficients[4,3]`$, p = $`r STAT.phi_corr$coefficients[4,4]`$). In line with this, metacognitive sensitivity, as measured by meta-d', was significantly lower in the internal mode ($\beta$ = $`r  STAT.meta_dprime$coefficients[2,1]`$ ± $`r STAT.meta_dprime$coefficients[2,2]`$, T($`r STAT.meta_dprime$coefficients[2,3]`$) = $`r STAT.meta_dprime$coefficients[2,4]`$, p = $`r STAT.meta_dprime$coefficients[2,5]`$). 
Together, these findings support the hypothesis that external and internal modes modulate a low-level decision variable $P(y_t = 1)$ that determines the content of perception and their metacognitive evaluation.

We briefly refer to these results in the discussion: 

- Beyond predicting the contents of perception, the GLM-HMM is capable of predicting confidence, a cognitive variable to which the model was not fitted. In line with previous results[@weilnhammer_sensory_2023], this observation suggests that external and internal modes modulate a perceptual decision variable that influences not only what is consciously experienced, but also downstream processes such as metacognition.

### Comment 3

**Second, S-ketamine clearly affects wakefulness and nervousness as shown in figure S5. These are very useful findings, but again it is possible that these internal states alter the level of motor or general task engagement, and in turn, the model parameters. Can the authors demonstrate that S-ketamine induced changes in the model parameters are conditionally independent of its effect on these internal states?**

We would like to thank the reviewer for pointing out this important caveat. We addressed this concern in two steps. We show that over and above dynamic changes in wakefulness (Q1), subjective intoxication (Q2), and nervousness (Q3), S-ketamine has an effect on mode (i), and mode has an effect on how perception integrates internal predictions with external inputs (ii).

(i): Our results show that S-ketamine *increased* external mode, *reduced* wakefulness (Q1), and *increased* feelings of intoxication (Q2) as well as nervousness (Q3). If changes in these states were to explain the effects of s-ketamine on mode fluctuations through changes in general task engagement, one would expect a *decrease* rather than an *increase* in external mode. However, to make sure that the effect of S-ketamine is not driven by drug-related effects on Q1, Q2, and Q3, we added these time-resolved subjective reports to the random effects structure of the mixed effects model that tests the effect of S-ketamine on the balance between modes. The effect of mode remained highly significant when controlling for these variables (p < $`r STAT.mode_controlled_Q3$coefficients[2,4]`$).

(ii): Our analyses indicate that S-ketamine has an effect on perception via its effect on mode. We therefore performed additional anlayses to rule out that the effects of mode on the model parameters are driven dynamic changes in Q1-3. To this end, we tested the effect of mode on $\Delta_{S-P} = \beta_S - \beta_P$, i.e., the difference in the weight associated with the stimulus ($\beta_S$) and the weight associated with the previous percept ($\beta_S$), while controlling for our time-resolved measures of Q1-Q3. In line with the hypothesis that the mode-dependent changes in $\Delta_{S-P}$ are conditionally independent of wakefulness, subjective intoxication and nervousness, we observed a main effect of mode on $\Delta_{S-P}$ (p = $`r STAT.delta_mode_controlled$coefficients[2,5]`$). We also found a significant *negative* effect of subjective intoxication on $\Delta_{S-P}$. This effect does not explain the effects of S-ketamine, since S-ketamine *increased* subjective intoxikation (Supplemental Figure S5) and, via its effect on mode, $\Delta_{S-P}$. There were no additional main effects of Q1 or Q3, nor any interactions of Q1-3 with mode. 

We have added these analyses to the result section: 

- Second, we asked whether fluctuations in global brain states can provide an alternative explanation for external and internal modes. One could assume that mode alternations could in fact reflect dynamic states of arousal, with high arousal and engaged behavior corresponding to the external mode, and low arousal and disengaged behavior corresponding to the internal mode. Our time-resolved assessment of internal states revealed reduced wakefulness (Q1) under S-ketamine (Supplemental Figure S6). This observation is clearly incompatible with the hypothesis that changes in the dynamics of mode are driven by low arousal under S-ketamine, since NMDAR antagonism increased the prevalence of the external mode, improving behavioral performance in the artificial setting of our experiment. When controlling for dynamic changes in wakefulness (Q1), subjective intoxication (Q2) and nervousness (Q3), the effect of S-ketamine on mode (p = $`r STAT.mode_controlled_Q1$coefficients[2,4]`$) and the effect of mode on $\Delta_{S-P}$ remained significant (p = $`r STAT.delta_mode_controlled$coefficients[2,5]`$). We observed no additional effects of or interactions with Q1-3 that could explain the observed relations between S-ketamine, mode, and $\Delta_{S-P}$. Despite its positive effect on perceptual accuracy, external mode was associated with higher levels of dissociation in the S-ketamine experiment as measured by the  *Clinician-Administered-Dissociative-States-Scale*[@mertens_clinician-administered_2022] (CADSS, $\beta$ = $`r STAT.CADSS_Mode_Intervention$coefficients[2,1]`$ ± $`r STAT.CADSS_Mode_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Mode_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Mode_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Mode_Intervention$coefficients[2,5]`$, Supplemental Figure S6B). 


### Comment 4

**Even if the effects of S-ketamine are perceptual, it is unclear whether it reflects the pathophysiology of psychotic symptoms. If I understood correctly, on average, S-ketamine improves (!) behavioral accuracy by making participants more responsive to actual changes in motion structure. It is not immediately obvious that this captures the phenomenology of psychosis since the latter typically results in seeing phantom structures in stimuli. Although both individuals on S-ketamine and patients with schizophrenia spend more time in the external mode in this task, this similarity could stem from factors unrelated to psychosis. Both ketamine and schizophrenia as a whole (vs. severity of psychotic symptoms specifically) are known to be associated with general cognitive dysfunction, which are likely to produce general alterations in cognitive performance (vs. specific psychosis-related alterations in perceptual inference) explaining observed behaviors. Therefore, it is especially jarring that the absence of any correlation between mode transition dynamics and psychosis proneness/severity measures is given short shrift (line 121 and caption S5F). Does the external mode correlate with IQ or other cognitive measures in healthy participants? Ideally the authors should demonstrate that general cognitive impairment or lower cognitive performance in healthy individuals does not manifest as increased external mode and that therefore their observations cannot be attributed to domain-general alterations. Ketamine is also known to recapitulate negative symptoms and induce cognitive impairment, which cannot be clearly ruled out based on these data as it stands. Similarly, the cited papers such as the Adams paper clearly separate trait-like alterations in schizophrenia from psychosis-related state-dependent changes, which can manifest differently or even with opposite phenotypes: the key question is whether what is reported here is a general trait-like phenomenon in schizophrenia (presumably linked to general cognitive impairment also present to some degree under ketamine) or to psychotic states. The default would be to assume the former unless the authors can show psychosis-severity dependence and lack of dependence on broader cognitive impairment (e.g., attentional or executive function impairment). Both would be interesting findings but this distinction is key to ongoing debates.**

Thanks a lot for pointing out this important question. Regarding the assertion that our behavioural findings to not seem to capture the phenomenology of psychosis, we would like to point out that improved behavioral accuracy, which is what we observed not only in healthy subjects under s-ketamine but also in patients with Scz, is precisely what one would expect based on the existing literature on perceptual alterations in Scz. Prior work has indeed shown that patients with schizoprenia are less susceptible to a number of perceptual illusions, where prior knowledge biases perception in ways that may be adaptive in natural environments but reduce perceptual accuracy in experimental settings[@Notredame2014; @costa_systematic_2023]. 

However, we fully agree with the reviexwer that, based on our data, we cannot make a strong claim about whether the balance of external and internal mode is a trait, or is (also) related to the state of psychosis. Our experiments maximized intra-subject power, and were not designed to detect inter-individual differences, for which much larger samples would be required. Likewise, we did not monitor psychotic experience in real time during our experiments, which were unlikely to occur given the dose of S-ketamine in the S-ketamine intervention study, and the clinical status of the patients in the case-control study. In addition to recent work on the role of mode for false alarms[@weilnhammer_dynamic_2024], we believe that more research is needed to determine whether the balance between modes is a mere trait, potentially linked to aspects of cognition, or whether either of the modes (or their interaction) has a particular role to play for individual psychotic experiences. 

We have modified the discussion accordingly: 

- (...) These findings bear similarity with prior work on perceptual illusions, where prior knowledge biases perception in ways that may be adaptive in natural environments but reduce perceptual accuracy in experimental settings[@Notredame2014; @costa_systematic_2023]: Weak predictions may therefore explain why people with Scz are, for example, less susceptible to the hollow-mask illusion, where knowledge about faces is thought to induce the experience of a convex face on the concave surface of a human mask[@keane_reduced_2013], the Ebbinghaus illusion, where larger circles make a smaller central circle appear bigger[@Silverstein2013], or the force-matching illusion, where humans apply less force when matching an externally applied force with their own[@shergill_evidence_2005].

- (...) In the present data, we did not find a correlation of the balance between external and internal mode with either global psychosis proneness or the clinical severity of Scz (Supplemental Figure S6). Our study was optimized for within-participant power and not designed to detect correlations between inter-individual differences in Scz-related traits and the balance between external and internal modes. One key question moving forward is whether the shift toward external mode represents a general trait-like phenomenon in Scz, potentially linked to cognitive alterations that are also present to some degree under ketamine[@morgan_ketamine_2012], or whether external and internal modes are associated with psychosis-related, state-dependent changes in inference. Future research could address these questions by correlating the balance between modes with both positive and negative symptoms, as well as with measures of cognitive performance such as IQ in larger samples. Another promising approach to distinguish between trait and state effects, which can manifest differently or even with opposite phenotypes[@Adams2013], could involve real-time symptom tracking combined with functional imaging. Such analyses could help to examine whether shifts between external and internal modes align with the on- and offset of individual psychotic experiences[@weilnhammer_dynamic_2024], both at the behavioral level and in terms of their neural correlates.

- Previous studies have used GLM-HMMs to identify engaged and disengaged behavior in mice tasked with discriminating the location of a visual stimulus[@ashwood_mice_2022; @mohammadi_identifying_2024]. While this terminology may suggest that GLM-HMM states reflect dynamic changes in rodent behavior, evidence from human psychophysics indicates that external and internal modes may in fact reflect perceptual (as opposed to behavioral) states[@weilnhammer_sensory_2023; @weilnhammer_dynamic_2024]. Specifically, when humans detect gratings in white noise, false alarms are more likely when the noise contains more power at the orientation and spatial frequency of the preceding grating, suggesting that detection relies on a predictive perceptual template[@manassi_continuity_2024; @weilnhammer_dynamic_2024]. If these detection events were purely behavioral, no correlation between false alarms and the noise power spectrum would be expected[@murai_serial_2021]. Critically, recent work demonstrates that these predictive perceptual templates are confined to the internal mode, supporting the hypothesis that the internal mode is indeed predictive and perceptual[@weilnhammer_dynamic_2024]. Moreover, an analysis of 66 experiments on human 2AFC decision-making revealed a quadratic relationship of confidence with mode[@weilnhammer_sensory_2023]. The observation that confidence remains high for strong biases toward both external and internal modes[@weilnhammer_sensory_2023] argues against reducing internal mode processing to disengaged behavior.

- Our present analyses of confidence and response times, as well as our time-resolved assessment of wakefulness, subjective intoxication, and nervousness, strongly support the idea that external and internal modes are perceptual phenomena, cannot be reduced to processes occurring solely at the level of task engagement, and are not mere reflections of fluctuations in arousal. These observations do not, however, rule out the possibility that external and internal modes have multiple and potentially independent effects on the brain, including influences on high-level cognition and response behavior, or that they are, to some degree, dependent on global brain states. No-report functional imaging experiments, where the content of experiences is decoded without overt behavioral signals[@Tsuchiya2015], alongside pupillometry, manipulations of neuromodulators that regulate global brain states, or non-invasive brain stimulation, could help illuminate the causes and consequences of these modes across the cortical hierarchy. Mapping the neurocomputational dynamics of mode alternations will be crucial to testing whether adjusting the balance between modes can mitigate psychotic experiences and ultimately improve the lives of people living with Scz.

### Comment 5

**A 2-state GLM-HMM would have 4 transition probabilities (2 stay and 2 switch). The probability of external mode reported here is a marginal probability that reflects the contribution of both E->E (stay) and I->E (switch) transitions, and an increase either parameter would manifest as an increase in the external mode. It wasn’t clear which of these parameters was primarily affected by S-ketamine, and how this compares to patients in schizophrenia. Plotting all 4 parameters of the HMM would provide a better characterization of the changes induced by S-ketamine and how it compares to alterations in schizophrenia.**

We have updated the Supplemental Figure S3 and S4 accordingly, referring to EE and II as mode stay, and EI and IE as switch transitions. S-ketamine and Scz both increase the stability of external mode at the expense of internal mode, with no effect on the transitions between modes. We made the following changes to the Figure legend:

- Supplemental Figure S3D. (...) S-ketamine (red) increased the probability of external mode ($`r -STAT.Mode_by_I$coefficients[2,1]`$ ± $`r STAT.Mode_by_I$coefficients[2,2]`$, z = $`r -STAT.Mode_by_I$coefficients[2,3]`$, p = $`r STAT.Mode_by_I$coefficients[2,4]`$) relative to placebo (blue) by modulating the stability of external and internal mode (EE versus II; left panels; V = `r STAT.Mode_Intervention$statistic`, p = `r STAT.Mode_Intervention$p.value`), with no effect on the transition probabilities between modes (EI versus IE; right panels; V = `r STAT.Mode_Intervention_2$statistic`, p = `r STAT.Mode_Intervention_2$p.value`). (...)

- Supplemental Figure S4D. (...) Relative to controls (blue), patients (red) spent more time in external mode ($`r -S_STAT.Mode_by_G$coefficients[2,1]`$ ± $`r S_STAT.Mode_by_G$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_G$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_G$coefficients[2,4]`$). This effect was driven by an increase in the stability of external mode at the expense of internal mode (EE versus II; left panels; W = `r S_STAT.Mode_Group$statistic`, p = `r S_STAT.Mode_Group$p.value`). There was no effect of group on the transition probabilities between modes (EI versus IE; right panels; W = `r S_STAT.Mode_Group_2$statistic`, p = `r S_STAT.Mode_Group_2$p.value`).

The results now refer to this result: 

- Indeed, S-ketamine did not alter the weights of the two-state GLM-HMM (Figure 2C), but increased the probability of external at the expense of internal mode ($\beta$ = $`r -STAT.Mode_by_I$coefficients[2,1]`$ ± $`r STAT.Mode_by_I$coefficients[2,2]`$, z = $`r -STAT.Mode_by_I$coefficients[2,3]`$, p = $`r STAT.Mode_by_I$coefficients[2,4]`$, Figure 2D) via an effect on the stay transitions of the HMM (external-to-external and internal-to-internal, Supplemental Figure S3D).

### Comment 6

**It would be helpful to clearly define all the statistics somewhere. While the writing is generally clear and the figures appear to support the claims, the statistics reported in the main text are difficult to comprehend. Here are some examples but the authors need to check the manuscript for other examples:**

**Line 73: Importantly, S-ketamine caused perception to shift toward st (0.45±0.08). Is 0.45 the increase in beta_s due to S-ketamine?**

**Line 105:  S-ketamine did not alter the weights of the two-state GLM-HMM (Figure 2C), but increased the probability of external at the expense of internal mode (1.01 ± 0.03). What is 1.01 here? It cannot be the change in probability.**

**Line 117: Scz patients spent more time in external mode (0.52±0.03). Is it 0.52 seconds, minutes, or something else?**

**Line 136: healthy participants were more confident in their choices (0.72 ± 0.07). What is 0.72?**

We apologize for the lack of clarity. The above numbers refer to the estimate ($\beta$) from the mixed effects models. We now report the mixed effects model estimates as $\beta$ without any subscript. All parameter estimates with subscript refer to posterior parameters (weights) from the GLM-HMM. We have added this information to the method section: 

- Mixed effects models are reported with the estimate ($\beta$ without subscript), followed by the T- or z-statistic for linear and logistic models, respectively. Please note that parameter estimates with subscripts refer exclusively to the GLM-HMM weights (see Computational modeling) associated with the external input ($\beta_S$), the constant bias ($\beta_B$), and the previous experience ($\beta_P$).

### Comment 7

**For the benefit of the readership, I would encourage the authors to try to put their results in the broader context of the literature on psychosis, clearly identifying points of agreement or departure from prior studies that examine psychosis from alternative theoretical perspectives e.g., circular inference and strong priors (e.g., Corlett et al. 2019; Schmack et al., 2021; Cassidy et al. 2018; Bansal et al. 2021…)**

We would like to thank the reviewer for this suggestion. Our initial version was written in a short format. We have now included an extensive Dicussion section, and place our findings in the broader context of predictive processing and circular inference: 

- These findings bear similarity with prior work on perceptual illusions, where prior knowledge biases perception in ways that may be adaptive in natural environments but reduce perceptual accuracy in experimental settings[@Notredame2014; @costa_systematic_2023]: Weak predictions may therefore explain why people with Scz are, for example, less susceptible to the hollow-mask illusion, where knowledge about faces is thought to induce the experience of a convex face on the concave surface of a human mask[@keane_reduced_2013], the Ebbinghaus illusion, where larger circles make a smaller central circle appear bigger[@Silverstein2013], or the force-matching illusion, where humans apply less force when matching an externally applied force with their own[@shergill_evidence_2005].

- Our findings therefore align with the canonical predictive processing account of psychosis[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018]. According to this model, NMDAR hypofunction[@Stein2020] and Scz[@weilnhammer_psychotic_2020] are associated with weak priors that cause erratic inferences in perception and cognition, ultimately leading to psychotic symptoms such as delusions and hallucinations. At the same time, they seem at odds with the observation that psychotic experiences, and in particular false alarms that serve as an experimental proxy for hallucinations, correlate with strong priors[@cassidy_perceptual_2018; @schmack_striatal_2021; @bansal_association_2022]. So far, attempts to reconcile these disparate sets of findings suggest that priors may vary in strength depending on the phase of psychotic illness, with weak priors in early stages and strong priors in later stages, or depending on their position within the cognitive hierarchy, with weak priors at the perceptual level and strong priors at the cognitive level[@Sterzer2018]. As an alternative to predictive processing, circular inference accounts of Scz posit that psychotic symptoms depend on an over-counting of sensory data that are reverberated multiple times due to an imbalance of excitation and inhibition in feedforward-feedback loops of the cortical hierarchy[@Jardri2016; @Jardri2017].

- In line with the general principles of predictive processing, the GLM-HMM proposed here predicts the experiences $y_t$ in a weighted integration the external input $\beta_S \times s_t$ with internal predictions that embody the temporal autocorrelation of natural environments and are defined by the preceding experiences $\beta_p \times y_{t-1}$. The critical advance provided by the GLM-HMM is that the model allows for dynamic changes in the balance between external and internal sources of information ($\Delta_{S-P} = \beta_S - \beta_P$). In the data presented here, the GLM-HMM revealed that the general shift of perception toward the external input and away from internal predictions observed under S-ketamine and in Scz is in fact driven by changes in the balance between two opposing modes of inference: an external mode, during which priors are weak, and an internal mode, during which priors are strong. The failures of perceptual inference, which are hypothesized to characterize Scz[@fletcher_perceiving_2009; @Adams2013; @Sterzer2018], may thus be transient and recurring.

- To our knowledge, our results are the first to uncover a neural mechanism underlying the slow, task-related fluctuations in perceptual inference observed in both humans and mice[@laquitaine_switching_2018; @roy_extracting_2021; @ashwood_mice_2022; @weilnhammer_sensory_2023]. In the context of Scz, this extends previous predictive processing accounts by suggesting an alternative explanation for the apparent discrepancy between strong and weak priors: an imbalance between the modes may cause the brain to make erratic inferences during the external mode, when the influence of previously learned priors is weak, generating a distorted or inaccurate model of the world, which is then used maladaptively during the internal mode, when priors are strong[@weilnhammer_dynamic_2024]. Furthermore, the dynamic nature of between-mode transitions illustrates how constant and potentially heritable dysfunctions of the NMDAR, such as GRIN2A mutations in Scz[@harrison_grin2a_2023], may produce symptoms of psychosis that are recurrent and transient in nature.

### Comment 8

**The task details and some of the metrics are difficult to find. What is response time? Is the confidence information collapsed to get a binary response for fitting the models?**

We apologize for the lack of clarity. For structure-from-motion stimuli like those used in this study, switches are most likely to occur at overlapping configurations of the stimulus[@Pastukhov2012; @weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021] (i.e., when the bands that compose the stimulus overlap, see Supplemental Video S1-2). Following previous approaches[@weilnhammer_predictive_2017; @weilnhammer_psychotic_2020;  @weilnhammer_active_2021], we define response times $r_t$ as the time between a button-press that indicates a change in the perceived direction of rotation of the stimulus, and the time of the preceding overlapping configuration of the stimulus. The validity of this approach is supported by the non-uniform distribution of $r_t$ over the inter-overlap interval (Supplemental Figure S2A and S4A). 

We have added the information on $r_t$ to the Method section:

- For structure-from-motion stimuli like those used in this study, changes in experience occur at overlapping configurations of the stimulus[@Pastukhov2012; @weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021] (i.e., when the bands that compose the stimulus overlap; see Supplemental Video S1-2). Following previous approaches[@weilnhammer_predictive_2017; @weilnhammer_psychotic_2020; @weilnhammer_active_2021], we defined response times $r_t$ as the time between a button press that indicates a change in the perceived direction of rotation and the time of the preceding overlapping configuration of the stimulus.

Confidence was obtained in two levels for each direction of rotation (high versus low confidence for rotation of the front surface to the left and to the right). In addition, the participants were instructed to use the space bar when they could not perceive any direction of rotation (mixed perception). Overlaps associated with mixed perception were rare ($`r 100*sum(u_Data$Confidence == -2)/nrow(Data)`$%) and excluded from further analyses. GLM-HMMs were fitted based on the binary direction of rotation, irrespective of whether the experience was made at high or low confidence. This allowed us to use confidence as an independent variable for model validation (see comment 2, reviewer 3).

We have added this information to the Method section:

- Participants were naive to the potential ambiguity in the visual display, passively experienced the stimulus and reported changes in their perception alongside their confidence via button-presses on a standard USB keyboard (right middle-finger on d: rotation of the front-surface to the right at high confidence; right index-finger on f: rotation of the front-surface to the right at low confidence; left middle-finger on k: rotation of the front-surface to the left at high confidence; left index-finger on j: rotation of the front-surface to the left at low confidence; thumb on space bar: unclear direction of rotation). Unclear perceptual states occurred at a rate of `r mean(Uncertainty$rate, na.rm = TRUE)` ± `r sd(Uncertainty$rate, na.rm = TRUE)/sqrt(length(Uncertainty$rate))` and were excluded from further analyses.

- The GLM-HMM generates a perceptual decision variable $P(y_t = 1)$ that is defined by a weighted integration of the external stimulus ($\beta_S \times s_t$), the previous experience ($\beta_P \times y_{t-1}$), and a constant bias ($\beta_P \times 1$). The weights are obtained by fitting the GLM-HMM to the sequence of experiences $y$, irrespective of whether the experience $y$ was made at high or low confidence. This allowed us to test whether the predictions of the two-state GLM-HMM would generalize to a metacognitive reports on perception: To validate our model, we tested whether the perceptual decision variable $P(y_t = 1)$ predicted not only the binary contents of experience $y_t$ (which the GLM-HMM was fitted to), but also perceptual confidence $c_t$ (which the GLM-HMM was not fitted to). To do so, we correlated $c_t$ (as reported by the participants) with the posterior certainty $C_t$ (as provided by the GLM-HMM) at each overlap. The posterior certainty $C_t$ is given by log probability of the actual experience $y$, given the decision variable $P(y_t = 1)$


### Comment 9

**Can the authors show more information on subjective effects of ketamine on arousal, etc.? It seems like there are some temporal dynamics of the effects (probability of external mode) that could speak to broad effects on arousal: early effects on ketamine and later effects perhaps related to fatigue exaggerated in patients. It would be good to present more time-resolved data to rule out this alternative explanation in terms of general arousal/attention/task-engagement.**

We would thank the reviewer for raising the question whether changes in mode could be driven by changes in arousal/attention/fatigue/task-engagement, with high arousal/attention/fatigue/task-engagement corresponding to external mode, and low arousal/attention/fatigue/task-engagement corresponding to internal mode. Three observations speak against the alternative hypotheses to the dynamics of mode can be reduced completely to the dynamics of arousal/attention/fatigue/task-engagement: 

(i) Time-resolved subjective reports on internal state in the S-ketamine experiment: While external mode was more prevalent under S-ketamine, participants reported reduced wakefulness under S-ketamine (Supplemental Figure S6). The effect of S-ketamine on mode remained significant when controlling for wakefulness (p = $`r STAT.mode_controlled_Q1$coefficients[2,4]`$). 
We did not find a significant effect of time on the probability of the external mode ($\beta$ = $`r STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  STAT.Mode_by_time$coefficients[2,2]`$, z = $`r STAT.Mode_by_time$coefficients[2,3]`$, p = $`r STAT.Mode_by_time$coefficients[2,4]`$) or on wakefulness ($\beta$ = $`r STAT.Q1_Time_Intervention$coefficients[2,1]`$ ± $`r  STAT.Q1_Time_Intervention$coefficients[2,2]`$, z = $`r STAT.Q1_Time_Intervention$coefficients[2,3]`$, p = $`r STAT.Q1_Time_Intervention$coefficients[2,4]`$). In sum, these results provide strong evidence against the alternative hypothesis that the effect of ketamine on mode is mediated by the effect of ketamine on wakefulness. 

(ii) Response times in the S-ketamine and the Scz study: Due to the observation that transition occur at specific overlapping configurations of the stimulus, our paradigm allows for the calculation of response times $r_t$ (interval between the time of a buttonpress that indicates a change in experience, and the preceding overlap). $r_t$ can provide an indirect measure of task engagement, with longer $r_t$[@yamashita_variable_2021] and higher RT variability in non-engaged states[@kucyi_spontaneous_2016; @yamashita_variable_2021]. We did not find a significant effect of mode on $r_t$ in the S-ketamine experiment ($\beta$ = $`r STAT.RT_by_STPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_STPM$coefficients[6,2]`$, z = $`r STAT.RT_by_STPM$coefficients[6,3]`$, p = $`r STAT.RT_by_STPM$coefficients[6,4]`$) or in the case-control study ($\beta$ = $`r STAT.RT_by_SGPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_SGPM$coefficients[6,2]`$, z = $`r STAT.RT_by_SGPM$coefficients[6,3]`$, p = $`r STAT.RT_by_SGPM$coefficients[6,4]`$). Likewise, response time variability did not differ significantly between modes in the S-ketamine intervention (V = `r variability_rt$statistic`, p = `r variability_rt$p.value`) or between groups in the case-control study (W = `r S_variability_rt$statistic`, p = `r S_variability_rt$p.value`). 

(iii) Differences in fatigue between S-ketamine and placebo, and between patients diagnosed with Scz and healthy controls: Fatigue is an additional important global factor that may confound our analysis of mode. If there is a relevant effect of fatigue, one would expect fatigue to increase over the course of an experimental session (main effect of time). This should be more pronounced under S-ketamine (time-by-intervention interaction) and/or in patients with Scz (time-by-group interaction). In the S-ketamine intervention, we found no main effect of time ($\beta$ = $`r STAT.RT_by_time$coefficients[2,1]`$ ± $`r  STAT.RT_by_time$coefficients[2,2]`$, z = $`r STAT.RT_by_time$coefficients[2,3]`$, p = $`r STAT.RT_by_time$coefficients[2,4]`$) and no time-by-intervention interaction ($\beta$ = $`r STAT.RT_by_time$coefficients[4,1]`$ ± $`r  S_STAT.RT_by_time$coefficients[4,2]`$, z = $`r STAT.RT_by_time$coefficients[4,3]`$, p = $`r STAT.RT_by_time$coefficients[4,4]`$). Likewise, in the case-control study, we found no main effect of time ($\beta$ = $`r S_STAT.RT_by_time$coefficients[2,1]`$ ± $`r  S_STAT.RT_by_time$coefficients[2,2]`$, z = $`r S_STAT.RT_by_time$coefficients[2,3]`$, p = $`r S_STAT.RT_by_time$coefficients[2,4]`$) and no time-by-intervention ($\beta$ = $`r S_STAT.RT_by_time$coefficients[4,1]`$ ± $`r  S_STAT.RT_by_time$coefficients[4,2]`$, z = $`r S_STAT.RT_by_time$coefficients[4,3]`$, p = $`r S_STAT.RT_by_time$coefficients[4,4]`$). In contradiction to the natural dynamic of fatigue in psychophysical experiments, which *increases* over time, internal mode decreased over time ($\beta$ = $`r -S_STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  S_STAT.Mode_by_time$coefficients[2,2]`$, z = $`r -S_STAT.Mode_by_time$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[2,4]`$), with a stronger effect in patients ($\beta$ = $`r -S_STAT.Mode_by_time$coefficients[4,1]`$ ± $`r S_STAT.Mode_by_time$coefficients[4,2]`$, z = $`r -S_STAT.Mode_by_time$coefficients[4,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[4,4]`$).

In sum, our analysis of time-resolved subjective reports on wakefulness (which were only available for the S-ketamine intervention) and the time-resolved analysis of RT (available for the S-ketamine and the case-control study) argue against the alternative hypothesis that the effects of S-ketamine and Scz are mediated by arousal or fatigue.  

In addition to our responses to Comment 3, Reviewer 3, we have added this paragraph to the result section:

- Second, we asked whether fluctuations in global brain states can provide an alternative explanation for external and internal modes. One could assume that mode alternations could in fact reflect dynamic states of arousal, with high arousal and engaged behavior corresponding to the external mode, and low arousal and disengaged behavior corresponding to the internal mode. Our time-resolved assessment of internal states revealed reduced wakefulness (Q1) under S-ketamine (Supplemental Figure S6). This observation is clearly incompatible with the hypothesis that changes in the dynamics of mode are driven by low arousal under S-ketamine, since NMDAR antagonism increased the prevalence of the external mode, leading to increase in perceptual performance. When controlling for dynamic changes in wakefulness (Q1), subjective intoxication (Q2) and nervousness (Q3), the effect of S-ketamine on mode (p = $`r STAT.mode_controlled_Q1$coefficients[2,4]`$) and the effect of mode on $\Delta_{S-P}$ remained significant (p = $`r STAT.delta_mode_controlled$coefficients[2,5]`$). We observed no additional effects of or interactions with Q1-3 that could explain the observed relations between S-ketamine, mode, and $\Delta_{S-P}$.

- In addition to the time-resolved subjective reports on wakefulness obtained under S-ketamine and placebo (Supplemental Figure S6), response times ($r_t$) can provide an indirect measure of task engagement, with longer $r_t$ and higher RT variability as indicators of fatigue or disengagement[@kucyi_spontaneous_2016; @yamashita_variable_2021]. We found no significant effect of mode on $r_t$ in either the S-ketamine experiment ($\beta$ = $`r STAT.RT_by_STPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_STPM$coefficients[6,2]`$, z = $`r STAT.RT_by_STPM$coefficients[6,3]`$, p = $`r STAT.RT_by_STPM$coefficients[6,4]`$) or in the case-control study ($\beta$ = $`r STAT.RT_by_SGPM$coefficients[6,1]`$ ± $`r  STAT.RT_by_SGPM$coefficients[6,2]`$, z = $`r STAT.RT_by_SGPM$coefficients[6,3]`$, p = $`r STAT.RT_by_SGPM$coefficients[6,4]`$). $r_t$ variability did not differ significantly between modes in the S-ketamine intervention (V = `r variability_rt$statistic`, p = `r variability_rt$p.value`) or in the case-control study (W = `r S_variability_rt$statistic`, p = `r S_variability_rt$p.value`). In both experiments, there was no main effect of time on $r_t$ (S-ketamine intervention: $\beta$ = $`r STAT.RT_by_time$coefficients[2,1]`$ ± $`r STAT.RT_by_time$coefficients[2,2]`$, T($`r STAT.RT_by_time$coefficients[2,3]`$) = $`r STAT.RT_by_time$coefficients[2,4]`$, p = $`r STAT.RT_by_time$coefficients[2,5]`$; case-control study: $\beta$ = $`r S_STAT.RT_by_time$coefficients[2,1]`$ ± $`r S_STAT.RT_by_time$coefficients[2,2]`$, T($`r S_STAT.RT_by_time$coefficients[2,3]`$) = $`r S_STAT.RT_by_time$coefficients[2,4]`$, p = $`r S_STAT.RT_by_time$coefficients[2,5]`$). We observed no time-by-intervention interaction ($\beta$ = $`r STAT.RT_by_time$coefficients[4,1]`$ ± $`r STAT.RT_by_time$coefficients[4,2]`$, T($`r STAT.RT_by_time$coefficients[4,3]`$) = $`r STAT.RT_by_time$coefficients[4,4]`$, p = $`r STAT.RT_by_time$coefficients[4,5]`$) nor a time-by-group interaction ($\beta$ = $`r S_STAT.RT_by_time$coefficients[4,1]`$ ± $`r S_STAT.RT_by_time$coefficients[4,2]`$, T($`r S_STAT.RT_by_time$coefficients[4,3]`$) = $`r S_STAT.RT_by_time$coefficients[4,4]`$, p = $`r S_STAT.RT_by_time$coefficients[4,5]`$), suggesting that interventions and groups did not differ with respect to fatigue.

- Contrary to the natural dynamic of fatigue in psychophysical experiments, which increases over time, we observed no effect of time on the balance between modes in the S-ketamine experiment ($\beta$ = $`r STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  STAT.Mode_by_time$coefficients[2,2]`$, z = $`r STAT.Mode_by_time$coefficients[2,3]`$, p = $`r STAT.Mode_by_time$coefficients[2,4]`$, Figure 2D). In the case-control study, external mode even became more prevalent over time ($\beta$ = $`r S_STAT.Mode_by_time$coefficients[2,1]`$ ± $`r  S_STAT.Mode_by_time$coefficients[2,2]`$, z = $`r S_STAT.Mode_by_time$coefficients[2,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[2,4]`$), with a stronger effect in patients ($\beta$ = $`r -S_STAT.Mode_by_time$coefficients[4,1]`$ ± $`r S_STAT.Mode_by_time$coefficients[4,2]`$, z = $`r -S_STAT.Mode_by_time$coefficients[4,3]`$, p = $`r S_STAT.Mode_by_time$coefficients[4,4]`$, Figure 2H). 

- Furthermore, we found no evidence that external and internal modes reflect behavioral strategies that depend on task difficulty, such as using internal predictions only when the sensory information is unreliable: Individual stereodisparity thresholds were not correlated with inter-individual differences in mode (Supplemental Figure S6). Within participants, the balance between external and internal mode was only marginally modulated by the SAR of the stimulus (Figure 2D and H).

- In sum, these findings suggest that the effect of S-ketamine on mode, and the effects of mode on the integration of external inputs with internal predictions ($\Delta_{S-P}$), are unlikely to be mediated by dynamic changes in arousal, fatigue, task engagement, or task difficulty. Rather, they indicate the NMDAR hypofunction under S-ketamine and in Scz has a direct impact on perceptual processing via its effect on mode.

### Comment 10

**There are some typos: Figure 2C, G: Caption refers to Delta_(S-P), but the figure panels are labeled Delta_(P-S)** 

Thanks, we corrected the typo. 

**Line 136: During external mode, healthy participants were more confident in their choices (…) and scored higher on the Clinician-Administered-Dissociative-States-Scale (…). Given the known association of psychosis with elevated confidence and dissociative symptoms, intervals of external mode may thus reflect the computational correlate of individual psychotic experiences. Do the authors mean patients rather than healthy participants?**

We only have confidence and CADS in the S-ketamine experiment. We now provide a more nuanced treatment of the relation of mode to traits and states (see Comment 4, Reviewer 3). We have revised this sentence as follows: 

Despite its positive effect on perceptual accuracy, external mode was associated with higher levels of dissociation in the S-ketamine experiment as measured by  *Clinician-Administered-Dissociative-States-Scale*[@mertens_clinician-administered_2022] (CADSS, $\beta$ = $`r STAT.CADSS_Mode_Intervention$coefficients[2,1]`$ ± $`r STAT.CADSS_Mode_Intervention$coefficients[2,2]`$, T($`r STAT.CADSS_Mode_Intervention$coefficients[2,3]`$) = $`r STAT.CADSS_Mode_Intervention$coefficients[2,4]`$, p = $`r STAT.CADSS_Mode_Intervention$coefficients[2,5]`$, Supplemental Figure S6B). 


\newpage
# References